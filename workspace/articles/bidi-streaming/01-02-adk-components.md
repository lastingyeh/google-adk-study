æ­¡è¿å›åˆ°é€™ä»½æ·±åº¦æŠ€è¡“ç­†è¨˜ã€‚æˆ‘æ˜¯ä½ å€‘çš„è³‡æ·±æŠ€è¡“å°å¸«ã€‚

åœ¨ç†è§£äº†é›™å‘ä¸²æµï¼ˆBidi-streamingï¼‰çš„é‹ä½œæœ¬è³ªå¾Œï¼Œæˆ‘å€‘å¿…é ˆé€²å…¥å¯¦é©—å®¤ï¼Œæ‹†è§£é©…å‹•é€™ä¸€åˆ‡çš„ã€Œç©æœ¨ã€ã€‚åœ¨æ›´å¤§çš„æ ¸å¿ƒæŠ€è¡“è„ˆçµ¡ä¸‹ï¼ŒGoogle çš„ä»£ç†ç¨‹å¼é–‹ç™¼å¥—ä»¶ï¼ˆADKï¼‰ä¸¦éå–®ä¸€å·¥å…·ï¼Œè€Œæ˜¯ä¸€å¥—ç²¾å¯†çš„æ¶æ§‹é«”ç³»ã€‚å®ƒå°‡è¤‡é›œçš„ WebSocket ç®¡ç†ã€ç‹€æ…‹æŒä¹…åŒ–èˆ‡å·¥å…·ç·¨æ’ï¼Œè§£æ§‹æˆæ•¸å€‹å…·å‚™æ˜ç¢ºè·è²¬çš„**æ ¸å¿ƒçµ„ä»¶**ã€‚

é€™å ‚èª²ï¼Œæˆ‘å€‘å°‡æ·±åº¦å‰–æé€™äº›çµ„ä»¶å¦‚ä½•åœ¨æ¶æ§‹ä¸­å„å¸å…¶è·ã€‚

---

### ğŸ“Œ ADK æ¶æ§‹çµ„ä»¶å­¸ç¿’åœ°åœ–

1.  **å››å¤§æ ¸å¿ƒåŸºçŸ³**ï¼š`Agent`ã€`Runner`ã€`LiveRequestQueue` èˆ‡ `RunConfig` çš„è·è²¬é‚Šç•Œã€‚
2.  **åŸ·è¡Œæ…‹çš„éˆé­‚ï¼šInvocationContext**ï¼šè§£æ§‹å°è©±ç‹€æ…‹çš„éš±å½¢è¼‰é«”ã€‚
3.  **æŒä¹…åŒ–å±¤ï¼šSessionService**ï¼šè·¨è¶Šé€£ç·šé™åˆ¶çš„è¨˜æ†¶ç®¡ç†ã€‚
4.  **çµ„ä»¶äº’å‹•é‚è¼¯**ï¼šå¾åˆå§‹åŒ–åˆ°äº‹ä»¶å¾ªç’°çš„å¯¦æˆ°æµå‘ã€‚

---

### ä¸€ã€ ADK çµ„ä»¶è·è²¬å°ç…§è¡¨

åœ¨æ¶æ§‹è¨­è¨ˆä¸­ï¼Œæœ€é‡è¦çš„ä¸€é»æ˜¯å€åˆ†ã€Œå…¨åŸŸå…±äº«ï¼ˆStatelessï¼‰ã€èˆ‡ã€Œæœƒè©±ç‰¹å®šï¼ˆStatefulï¼‰ã€çš„çµ„ä»¶ã€‚é€™ç›´æ¥å½±éŸ¿äº†ç³»çµ±çš„æ“´å±•æ€§èˆ‡è³‡æºç®¡ç†ã€‚

| çµ„ä»¶åç¨± | è·è²¬å®šç¾© | ç”Ÿå‘½é€±æœŸèˆ‡ç‹€æ…‹ |
| :--- | :--- | :--- |
| **Agent** | å®šç¾© AI çš„äººæ ¼ã€æ¨¡å‹ã€ç‰¹å®šæŒ‡ä»¤èˆ‡å¯ç”¨å·¥å…·ã€‚ | **ç„¡ç‹€æ…‹ä¸”å¯é‡ç”¨**ï¼šå•Ÿå‹•æ™‚å»ºç«‹ä¸€æ¬¡ï¼Œä¾›æ‰€æœ‰é€£ç·šå…±äº«ã€‚ |
| **Runner** | åŸ·è¡Œå¼•æ“ï¼Œè² è²¬ç·¨æ’å°è©±ã€ç®¡ç†ç‹€æ…‹ä¸¦æä¾› `run_live()` ä»‹é¢ã€‚ | **å…¨åŸŸå…±äº«**ï¼šåœ¨æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚å»ºç«‹ä¸€æ¬¡ï¼Œç®¡ç†å¤šå€‹ä¸¦è¡Œæœƒè©±ã€‚ |
| **LiveRequestQueue** | è¨Šæ¯éšŠåˆ—ï¼Œç·©è¡æ–‡å­—ã€éŸ³è¨Šèˆ‡æ§åˆ¶è¨Šè™Ÿã€‚ | **æœƒè©±ç‰¹å®šä¸”æœ‰ç‹€æ…‹**ï¼šæ¯å€‹å°è©±å¿…é ˆæ–°å»ºï¼Œä¸”çµæŸæ™‚å¿…é ˆé—œé–‰ã€‚ |
| **RunConfig** | å®£å‘Šå¼é…ç½®ï¼Œå®šç¾©å›æ‡‰æ¨¡æ…‹ï¼ˆTEXT/AUDIOï¼‰ã€VAD èˆ‡æ¢å¾©åŠŸèƒ½ã€‚ | **æœƒè©±ç‰¹å®š**ï¼šå¯é‡å°ä¸åŒä½¿ç”¨è€…æˆ–æƒ…å¢ƒé€²è¡Œå®¢è£½åŒ–é…ç½®ã€‚ |

---

### äºŒã€ æ ¸å¿ƒçµ„ä»¶æ·±åº¦è§£æï¼šå¾ã€Œå®šç¾©ã€åˆ°ã€ŒåŸ·è¡Œã€

#### 1. Agentï¼šAI çš„å¤§è…¦
Agent æ˜¯æ‡‰ç”¨çš„æ ¸å¿ƒï¼Œå®ƒä¸ç®¡ç†é€£ç·šï¼Œåªè² è²¬å®šç¾©ã€Œè©²åšä»€éº¼ã€ã€‚æ‚¨å¯ä»¥é…ç½®ç‰¹å®šçš„æ¨¡å‹ï¼ˆå¦‚åŸç”ŸéŸ³è¨Šæ¨¡å‹ï¼‰èˆ‡å·¥å…·ï¼ˆå¦‚ Google æœå°‹ï¼‰ã€‚

#### 2. LiveRequestQueueï¼šä¸Šæ¸¸è¨Šæ¯çš„å®ˆè­·è€…
é€™æ˜¯ ADK æœ€é—œéµçš„æŠ½è±¡ä¹‹ä¸€ã€‚å®ƒæ˜¯ä¸€å€‹åŸ·è¡Œç·’å®‰å…¨çš„éåŒæ­¥éšŠåˆ—ï¼Œå°‡è¤‡é›œçš„ WebSocket å‚³è¼¸ç°¡åŒ–ç‚ºç°¡å–®çš„ API æ–¹æ³•ï¼š
*   `send_content()`ï¼šç™¼é€æ–‡å­—å›åˆã€‚
*   `send_realtime()`ï¼šç™¼é€éŸ³è¨Š/å½±åƒ/è¦–è¨Š Blobã€‚
*   `close()`ï¼šç™¼é€å„ªé›…é—œé–‰è¨Šè™Ÿã€‚

#### 3. Runner èˆ‡ run_live()ï¼šå°è©±çš„æŒ‡æ®å®¶
Runner è² è²¬å°‡æ‰€æœ‰çµ„ä»¶çµ„åˆåœ¨ä¸€èµ·ã€‚`run_live()` æ˜¯ä¸€å€‹**éåŒæ­¥ç”¢ç”Ÿå™¨**ï¼Œå®ƒå°‡åº•å±¤ Live API çš„äº‹ä»¶è½‰åŒ–ç‚ºæ‡‰ç”¨ç¨‹å¼å¯ä»¥è¼•é¬†éæ­·çš„ `Event` ç‰©ä»¶ã€‚

#### 4. InvocationContextï¼šéš±å½¢çš„åŸ·è¡Œç‹€æ…‹å®¹å™¨
**é€™ä»£è¡¨ä»€éº¼ï¼Ÿ** åœ¨å…§éƒ¨ï¼Œæ¯æ¬¡å‘¼å« `run_live()` éƒ½æœƒå»ºç«‹ä¸€å€‹ `InvocationContext`ã€‚å®ƒæ˜¯éš¨å°è©±ç§»å‹•çš„ã€Œç­†è¨˜æœ¬ã€ï¼Œè¨˜éŒ„äº† `invocation_id`ã€ç•¶å‰ `session` ç‹€æ…‹ä»¥åŠå·¥å…·åŸ·è¡Œé€²åº¦ã€‚é›–ç„¶é–‹ç™¼è€…é€šå¸¸ä¸ç›´æ¥æ“ä½œå®ƒï¼Œä½†å®ƒæ˜¯å¯¦ç¾å¤šä»£ç†ç¨‹å¼åˆ‡æ›èˆ‡ç‹€æ…‹æŒä¹…åŒ–çš„æŠ€è¡“é—œéµã€‚

---

### ä¸‰ã€ é‚è¼¯å…·è±¡åŒ–ï¼šçµ„ä»¶äº’å‹•æ™‚åºåœ–

ç•¶æ‚¨å•Ÿå‹•ä¸€å€‹é›™å‘ä¸²æµæœå‹™æ™‚ï¼Œå„çµ„ä»¶çš„äº’å‹•é‚è¼¯å¦‚ä¸‹ï¼š

```mermaid
graph TD
    A[App Startup] --> B(Create Agent & Runner)
    B --> C{WebSocket Connection}
    C --> D[Initialize Session via SessionService]
    D --> E[Create RunConfig & LiveRequestQueue]
    E --> F[Call runner.run_live]
    F --> G[Upstream: LiveRequestQueue.send_realtime]
    F --> H[Downstream: runner.run_live Yields Events]
    G --> I[Live API]
    I --> H
    H --> J[Session Termination: queue.close]
```
*(åƒè€ƒä¾†æºï¼š)*

---

### å››ã€ ä»£ç¢¼å³çœŸç†ï¼šçµ„ä»¶çµ„åˆå¯¦æˆ°

åœ¨ä¾†æºè³‡æ–™çš„ FastAPI ç¯„ä¾‹ä¸­ï¼Œæˆ‘å€‘å¯ä»¥æ¸…æ™°çœ‹åˆ°é€™å››å¤§çµ„ä»¶æ˜¯å¦‚ä½•å”åŒå·¥ä½œçš„ï¼š

```python
# [å°å¸«é»è©•]ï¼šPhase 1 - å…¨åŸŸåˆå§‹åŒ–
# å»ºç«‹ SessionService èˆ‡ Runnerï¼Œé€™åœ¨æ‰€æœ‰ä½¿ç”¨è€…é–“å…±äº«
session_service = InMemorySessionService()
runner = Runner(app_name=APP_NAME, agent=agent, session_service=session_service)

@app.websocket("/ws/{user_id}/{session_id}")
async def websocket_endpoint(websocket: WebSocket, user_id: str, session_id: str):
    await websocket.accept()

    # [å°å¸«é»è©•]ï¼šPhase 2 - æœƒè©±ç‰¹å®šåˆå§‹åŒ–
    # 1. æ ¹æ“šæ¨¡å‹é¡å‹æ±ºå®š RunConfig (æ¨¡æ…‹ã€è‡ªå‹•æ¢å¾©)
    run_config = RunConfig(
        streaming_mode=StreamingMode.BIDI,
        response_modalities=["AUDIO"] if is_native_audio else ["TEXT"],
        session_resumption=types.SessionResumptionConfig()
    )

    # 2. ç²å–æœƒè©±èˆ‡å»ºç«‹ç‰¹å®šçš„ LiveRequestQueue
    await session_service.get_session(app_name=APP_NAME, user_id=user_id, session_id=session_id)
    live_request_queue = LiveRequestQueue() # æ¯å€‹å°è©±å¿…é ˆæ˜¯ä¸€å€‹æ–°éšŠåˆ—

    # [å°å¸«é»è©•]ï¼šPhase 3 - åŸ·è¡Œæ…‹ç·¨æ’
    # Runner.run_live() å°‡æ‰€æœ‰çµ„ä»¶ä¸²æ¥ï¼Œå•Ÿå‹•å°è©±æµ
    async for event in runner.run_live(
        user_id=user_id,
        session_id=session_id,
        live_request_queue=live_request_queue,
        run_config=run_config,
    ):
        await websocket.send_text(event.model_dump_json(exclude_none=True))
```

---

### äº”ã€ çŸ¥è­˜æ”¶æ–‚èˆ‡å¯¦æˆ°ç¸½çµ

åœ¨æ¶æ§‹å±¤é¢ï¼ŒADK çš„è¨­è¨ˆç†å¿µæ˜¯**é—œæ³¨é»åˆ†é›¢ (Separation of Concerns)**ï¼š
*   **å‰ç«¯/é€šè¨Šå±¤ (WebSocket/FastAPI)**ï¼šè™•ç†èˆ‡å®¢æˆ¶ç«¯çš„é€£ç·šã€‚
*   **æ¶æ§‹å±¤ (ADK)**ï¼šç®¡ç†ä¸²æµç·¨æ’ã€ç‹€æ…‹æŒä¹…åŒ–èˆ‡å·¥å…·è‡ªå‹•åŸ·è¡Œã€‚
*   **æ™ºæ…§å±¤ (Live API)**ï¼šè™•ç†å¯¦éš›çš„å¤šæ¨¡æ…‹ AI æ¨è«–ã€‚

**é—œéµå°å¸«å»ºè­°ï¼š**
*   **åˆ‡å‹¿é‡è¤‡ä½¿ç”¨ LiveRequestQueue**ï¼šä¾†æºè³‡æ–™æ˜ç¢ºè­¦å‘Šï¼Œé‡è¤‡ä½¿ç”¨æœƒå°è‡´è¨Šæ¯æ’åºå•é¡Œèˆ‡ç‹€æ…‹æå£ã€‚
*   **å–„ç”¨ SessionService**ï¼šå¦‚æœæ‚¨éœ€è¦é–‹ç™¼å…·å‚™ã€Œè¨˜æ†¶èƒ½åŠ›ã€çš„å•†æ¥­æ‡‰ç”¨ç¨‹å¼ï¼Œè«‹æ¨æ£„ `InMemorySessionService`ï¼Œæ”¹ç”¨ `DatabaseSessionService`ã€‚
*   **ç†è§£ InvocationContext**ï¼šç•¶æ‚¨é–‹ç™¼è‡ªå®šç¾©å·¥å…·æˆ–å›å‘¼æ™‚ï¼Œé€™å€‹ä¸Šä¸‹æ–‡å°è±¡å°‡æ˜¯æ‚¨å­˜å–å·¥ä½œéšæ®µç‹€æ…‹èˆ‡æ§åˆ¶å°è©±æµç¨‹çš„æœ€å¼·æ­¦å™¨ã€‚

#ADKArchitecture #RunnerComponent #LiveRequestQueue #AgentFramework #InvocationContext

**å»¶ä¼¸æ€è€ƒï¼š** åœ¨å¤šä»£ç†ç¨‹å¼çš„å·¥ä½œæµä¸­ï¼Œ`SequentialAgent` å¦‚ä½•åˆ©ç”¨é€™äº›çµ„ä»¶å¯¦ç¾é€æ˜çš„äº¤æ¥ï¼Ÿç­”æ¡ˆåœ¨æ–¼åŒä¸€å€‹ `LiveRequestQueue` æœƒæŒçºŒç‚ºåºåˆ—ä¸­çš„æ‰€æœ‰ä»£ç†ç¨‹å¼æœå‹™ã€‚