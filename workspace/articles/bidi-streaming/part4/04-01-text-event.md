æ­¡è¿ä¾†åˆ°é€™å ‚æ·±åº¦æŠ€è¡“å¯¦æˆ°èª²ã€‚æˆ‘æ˜¯ä½ å€‘çš„è³‡æ·±æŠ€è¡“å°å¸«ã€‚

åœ¨ **ADK é›™å‘ä¸²æµ (Bidi-streaming)** çš„ä¸–ç•Œè£¡ï¼Œã€Œä¸‹æ¸¸ (Downstream)ã€çš„è™•ç†æ•ˆèƒ½ç›´æ¥æ±ºå®šäº†ä½¿ç”¨è€…å° AI æ™ºæ…§æ„Ÿçš„è©•åƒ¹ã€‚å¦‚æœèªªä¸Šæ¸¸æ˜¯ AI çš„ã€Œè€³æœµã€ï¼Œé‚£ä¸‹æ¸¸å°±æ˜¯å®ƒçš„ã€Œè¡¨æƒ…èˆ‡ç¯€å¥ã€ã€‚ä»Šå¤©æˆ‘å€‘è¦è¨è«–çš„ **æ–‡å­—äº‹ä»¶æ¨™è¨˜ï¼ˆPartial/Turn_complete/Interruptedï¼‰**ï¼Œæ­£æ˜¯æ§åˆ¶é€™äº›ç¯€å¥ã€å¯¦ç¾é¡äººäº’å‹•çš„æ ¸å¿ƒæ©Ÿåˆ¶ã€‚

### ğŸ“Œ æ–‡å­—äº‹ä»¶ç‹€æ…‹ç®¡ç†å­¸ç¿’åœ°åœ–

1.  **ä¸‹æ¸¸æ ¸å¿ƒæ©Ÿåˆ¶**ï¼šè§£æ `run_live()` éåŒæ­¥ç”¢ç”Ÿå™¨èˆ‡ `Event` å®¹å™¨ã€‚
2.  **æ¨™è¨˜æ·±åº¦è§£ç¢¼**ï¼šè§£æ§‹ `Partial`ã€`Turn_complete` èˆ‡ `Interrupted` çš„æŠ€è¡“ç´°ç¯€ã€‚
3.  **å ´æ™¯é©…å‹•æ•™å­¸**ï¼šé€éå°è©±å ´æ™¯æŒæ¡ UI ç‹€æ…‹è½‰æ›çš„é‚è¼¯ã€‚
4.  **ä»£ç¢¼å³çœŸç†**ï¼šå‰–æ `downstream_task` å¦‚ä½•å°‡æ¨™è¨˜è½‰åŒ–ç‚ºç”¨æˆ¶ç«¯æŒ‡ä»¤ã€‚

---

### ä¸€ã€ ä¸‹æ¸¸çš„æ ¸å¿ƒï¼š`run_live()` èˆ‡ Event å®¹å™¨

åœ¨ ADK ä¸­ï¼Œä¸‹æ¸¸è™•ç†æ˜¯é€é `runner.run_live()` å¯¦ä½œçš„ã€‚é€™æ˜¯ä¸€å€‹**éåŒæ­¥ç”¢ç”Ÿå™¨**ï¼Œå®ƒä¸é€²è¡Œå…§éƒ¨ç·©è¡ï¼Œä¸€æ—¦æ¨¡å‹ç”¢ç”Ÿè³‡æ–™ï¼Œå®ƒå°±ç«‹å³ã€Œæ»´æµã€å‡ºä¸€å€‹ `Event` ç‰©ä»¶ã€‚

é€™äº› `Event` å°è±¡å…·å‚™çµ±ä¸€çš„æ¬„ä½ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸‰å€‹å¸ƒæ—æ¨™è¨˜ï¼ˆFlagsï¼‰å°±æ˜¯æˆ‘å€‘ä»Šå¤©çš„é‡é»ï¼š`partial`ã€`turn_complete` èˆ‡ `interrupted`ã€‚

#### ğŸ’¡ é‚è¼¯å…·è±¡åŒ–ï¼šæ–‡å­—äº‹ä»¶æ¨™è¨˜çŸ©é™£
ç†è§£é€™äº›æ¨™è¨˜çš„çµ„åˆï¼Œèƒ½è®“ä½ ç²¾æº–æ§åˆ¶ UI çš„ç‹€æ…‹è½‰æ›ï¼š

| å°è©±æƒ…å¢ƒ               | `turn_complete` | `interrupted` | `partial` | æ‚¨çš„æ‡‰ç”¨ç¨‹å¼æ‡‰...                          |
| :--------------------- | :-------------- | :------------ | :-------- | :----------------------------------------- |
| **å›æ‡‰ä¸­ï¼ˆå¢é‡å€å¡Šï¼‰** | False           | False         | True      | ç¹¼çºŒå‘ˆç¾ä¸²æµæ–‡å­—ç¢ç‰‡ã€‚                     |
| **æ­£å¸¸å®Œæˆå›æ‡‰**       | True            | False         | False     | å•Ÿç”¨ä½¿ç”¨è€…è¼¸å…¥ï¼Œé¡¯ç¤ºã€Œå°±ç·’ã€ç‹€æ…‹ã€‚         |
| **å›æ‡‰ä¸­é€”è¢«ä¸­æ–·**     | False           | True          | (ä¸è¨ˆ)    | ç«‹å³åœæ­¢éŸ³è¨Šæ’­æ”¾ï¼Œæ¸…é™¤ UI ä¸Šçš„è¼¸å…¥æŒ‡ç¤ºå™¨ã€‚ |
| **å¥å­çµæŸä½†æœªå®Œ**     | False           | False         | False     | ç²å¾—è©²æ®µè½å®Œæ•´æ–‡å­—ï¼Œå¯ç”¨æ–¼æŒä¹…åŒ–ç´€éŒ„ã€‚     |

---

### äºŒã€ å ´æ™¯é©…å‹•æ•™å­¸ï¼šæ¨™è¨˜åœ¨å¯¦æˆ°ä¸­çš„åƒ¹å€¼

æˆ‘å€‘é€éä¸‰å€‹ã€Œå¯¦éš›é–‹ç™¼å ´æ™¯ã€çš„å°è©±ï¼Œå°‡é€™äº›æŠ½è±¡æ¨™è¨˜è½‰åŒ–ç‚ºå…·é«”çš„è§£æ±ºæ–¹æ¡ˆã€‚

#### åœºæ™¯ 1ï¼šå¦‚ä½•å¯¦ç¾æµæš¢çš„å³æ™‚æ‰“å­—æ©Ÿæ•ˆæœï¼Ÿ
**å•ï¼š** ã€Œæˆ‘è©²å¦‚ä½•å€åˆ†å‚³é€²ä¾†çš„æ–‡å­—æ˜¯ã€æ–°ç¢ç‰‡ã€é‚„æ˜¯ã€æ•´æ®µæ–‡å­—ã€ï¼Ÿã€
**è§£æï¼š** é€™ä»£è¡¨ä½ éœ€è¦ç†è§£ `partial` çš„èªæ„ã€‚
*   **é—œéµåœ¨æ–¼**ï¼šç•¶ `partial=True` æ™‚ï¼Œæ–‡å­—æ˜¯ **å¢é‡ (Incremental)** çš„ç¢ç‰‡ï¼›ç•¶ `partial=False` æ™‚ï¼Œæ–‡å­—æ˜¯è©²å›æ‡‰æ®µè½çš„ **å®Œæ•´åˆä½µ (Merged)** å…§å®¹ã€‚
*   **å°å¸«å»ºè­°**ï¼šå¦‚æœä½ è¦åšä¸²æµ UIï¼Œè«‹è™•ç† `partial=True`ï¼›å¦‚æœä½ åªéœ€è¦åœ¨è³‡æ–™åº«å„²å­˜æœ€çµ‚å°è©±ï¼Œè«‹å¿½ç•¥ True ä¸¦åƒ…ç›£è½ `partial=False` çš„äº‹ä»¶ã€‚

#### åœºæ™¯ 2ï¼šAI æ­£åœ¨èªªè©±æ™‚ï¼Œä½¿ç”¨è€…çªç„¶æ’å˜´æ€éº¼è¾¦ï¼Ÿ
**å•ï¼š** ã€Œå¦‚æœæ¨¡å‹æ­£åœ¨ç”¢ç”Ÿé•·ç¯‡å¤§è«–ï¼Œä½¿ç”¨è€…çªç„¶èªªï¼šã€åœï¼æˆ‘æƒ³æ›å€‹è©±é¡Œã€ï¼Œæˆ‘è©²æ€éº¼è™•ç†ï¼Ÿã€
**è§£æï¼š** é€™æ˜¯é›™å‘ä¸²æµæœ€é©å‘½æ€§çš„åŠŸèƒ½ï¼š**éŸ¿æ‡‰å¼ä¸­æ–· (Responsive Interruption)**ã€‚
*   æ­¤æ™‚ä¸‹æ¸¸æœƒç”¢ç”Ÿä¸€å€‹ `interrupted=True` çš„äº‹ä»¶ã€‚é€™ä»£è¡¨ä»€éº¼ï¼Ÿé€™æ˜¯ä¸€å€‹æŒ‡ä»¤ï¼Œè¦æ±‚ä½ ç«‹å³åœæ­¢ç”¨æˆ¶ç«¯çš„éŸ³è¨Šæ’­æ”¾ä¸¦ç§»é™¤è¼¸å…¥æŒ‡ç¤ºå™¨ã€‚
*   **åº•å±¤æ©Ÿåˆ¶**ï¼šç•¶åµæ¸¬åˆ°ä¸­æ–·æ™‚ï¼Œæ¨¡å‹æœƒè‡ªå‹•æ’ç©ºï¼ˆFlushï¼‰éŸ³è¨Šå¿«å–ï¼Œç¢ºä¿èˆŠå›æ‡‰ä¸æœƒèˆ‡æ–°è©±é¡Œé‡ç–Šã€‚

#### åœºæ™¯ 3ï¼šä½•æ™‚è©²è®“éº¥å…‹é¢¨é‡æ–°ç™¼å…‰ï¼ˆå•Ÿç”¨è¼¸å…¥ï¼‰ï¼Ÿ
**å•ï¼š** ã€Œæˆ‘æ€éº¼çŸ¥é“æ¨¡å‹ä»€éº¼æ™‚å€™ã€å¾¹åº•èªªå®Œã€äº†ï¼Ÿæ˜¯ä¸€çœ‹åˆ°æ–‡å­—çµæŸå°±è¡Œå—ï¼Ÿã€
**è§£æï¼š** ä¸è¡Œï¼Œä½ å¿…é ˆå°‹æ‰¾ `turn_complete=True`ã€‚
*   **é—œéµåœ¨æ–¼**ï¼šåˆä½µå¾Œçš„æ–‡å­—äº‹ä»¶ï¼ˆ`partial=False`ï¼‰é€šå¸¸æœƒæ—©æ–¼ `turn_complete` ç”¢ç”Ÿã€‚
*   `turn_complete` æ¨™è¨˜æœƒåœ¨æ¨¡å‹å®Œæ•´å›æ‡‰çš„æœ€æœ«ç«¯ï¼Œä»¥ä¸€å€‹**ç¨ç«‹çš„äº‹ä»¶**å‡ºç¾ã€‚é€™æ‰æ˜¯ä½ å°‡ UI åˆ‡æ›å›ã€Œæº–å‚™è¼¸å…¥ã€ç‹€æ…‹çš„æœ€ä½³æ™‚æ©Ÿã€‚

---

### ä¸‰ã€ ä»£ç¢¼å³çœŸç†ï¼šä¸‹æ¸¸ä»»å‹™å¯¦ä½œè§£æ

æˆ‘å€‘ä¾†çœ‹ä¾†æºè³‡æ–™ä¸­ `bidi-demo` çš„æ ¸å¿ƒå¯¦ä½œã€‚é€™æ®µä»£ç¢¼å±•ç¤ºäº†å¦‚ä½•éæ­·ç”¢ç”Ÿå™¨ä¸¦å°‡å¸¶æœ‰æ¨™è¨˜çš„äº‹ä»¶ç™¼å¾€å‰ç«¯ã€‚

```python
# [å°å¸«é»è©•]ï¼šé€™æ˜¯ Phase 3 çš„ä¸‹æ¸¸æ ¸å¿ƒä»»å‹™ã€‚
# run_live() æ˜¯éåŒæ­¥ç”¢ç”Ÿå™¨ï¼Œå®ƒè®“å°è©±ä»¥ã€Œäº‹ä»¶ã€çš„å½¢å¼å³æ™‚æµå‹•ã€‚

async def downstream_task() -> None:
    """å¾ run_live() æ¥æ”¶ Event ä¸¦é€é WebSocket å‚³é€çµ¦å®¢æˆ¶ç«¯ã€‚"""

    # éæ­· run_live() ç”¢ç”Ÿçš„æ¯ä¸€å€‹ Event å°è±¡
    async for event in runner.run_live(
        user_id=user_id,
        session_id=session_id,
        live_request_queue=live_request_queue,
        run_config=run_config,
    ):
        # [æ ¸å¿ƒé‡é»]ï¼šä½¿ç”¨ Pydantic çš„åºåˆ—åŒ–èƒ½åŠ›ã€‚
        # exclude_none=True èƒ½éæ¿¾æ‰æ‰€æœ‰ None æ¬„ä½ï¼Œæœ€å°åŒ– payloadã€‚
        # æ­¤ JSON å­—ä¸²åŒ…å« partial, turn_complete, interrupted ç­‰æ‰€æœ‰æ¨™è¨˜ã€‚
        event_json = event.model_dump_json(exclude_none=True, by_alias=True)

        logger.debug(f"[SERVER] Event: {event_json}")

        # å°‡äº‹ä»¶å³æ™‚æ¨å‘ WebSocket ç”¨æˆ¶ç«¯é€²è¡Œ UI æ›´æ–°
        await websocket.send_text(event_json)

    logger.debug("run_live() generator completed")
```

---

### å››ã€ çŸ¥è­˜å»¶ä¼¸èˆ‡æ”¶æ–‚

æ–‡å­—æ¨™è¨˜ä¸åƒ…åƒ…æ˜¯ç‚ºäº† UI é¡¯ç¤ºï¼Œå®ƒå€‘é‚„æ¶‰åŠè³‡æ–™çš„**æŒä¹…åŒ–é‚è¼¯**ã€‚

*   **è‡ªå‹•ç´¯ç©**ï¼šä½ ä¸éœ€è¦æ‰‹å‹•æ‹¼æ¹Šæ–‡å­—ç¢ç‰‡çš„å…§å®¹ã€‚ADK å…§éƒ¨çš„ `StreamingResponseAggregator` æœƒè‡ªå‹•ç‚ºä½ è™•ç†ç´¯ç©éç¨‹ã€‚ç•¶ä½ æ”¶åˆ° `partial=False` çš„äº‹ä»¶æ™‚ï¼Œæ–‡å­—æ¬„ä½å·²ç¶“åŒ…å«äº†ä¹‹å‰æ‰€æœ‰ç¢ç‰‡çš„ç¸½å’Œã€‚
*   **ä½œè€…èªæ„**ï¼šåœ¨é€™äº›äº‹ä»¶ä¸­ï¼Œå¦‚æœ `author` æ˜¯ä»£ç†ç¨‹å¼åç¨±ï¼Œå®ƒä»£è¡¨æ¨¡å‹çš„è¼¸å‡ºï¼›è‹¥äº‹ä»¶åŒ…å«ä½¿ç”¨è€…èªéŸ³çš„è½‰éŒ„é€å­—ç¨¿ï¼ˆéœ€å•Ÿç”¨è½‰éŒ„åŠŸèƒ½ï¼‰ï¼Œå…¶ `author` æœƒè¢«æ­¸å› ç‚º "user"ã€‚
*   **å„ªé›…çµ‚æ­¢**ï¼šç•¶åµæ¸¬åˆ° `turn_complete=True` ä¸”ä½¿ç”¨è€…æ–·é–‹é€£ç·šå¾Œï¼Œå‹™å¿…å‘¼å« `live_request_queue.close()`ï¼Œä»¥é‡‹æ”¾é›²ç«¯é…é¡ä¸¦é˜²æ­¢ã€Œæ®­å±æœƒè©±ã€ç”¢ç”Ÿã€‚

**å¯¦æˆ°ç¸½çµï¼š**
æŒæ¡é€™ä¸‰å€‹æ¨™è¨˜ï¼Œä½ å°±æ“æœ‰äº†æ§åˆ¶ AI ä»£ç†ç¨‹å¼ã€Œç¤¾äº¤ç¯€å¥ã€çš„èƒ½åŠ›ã€‚`partial` è®“æºé€šè®Šå¿«ï¼Œ`interrupted` è®“æºé€šè®Šè‡ªç„¶ï¼Œè€Œ `turn_complete` è®“æºé€šæœ‰å§‹æœ‰çµ‚ã€‚

ğŸ·ï¸ `bidi-streaming`, `text-events`, `event-processing`, `gemini-live-api`, `real-time-interaction`

---

[â† ä¸Šä¸€é ](./04-00-downstream.md) | [ä¸‹ä¸€é  â†’](./04-02-audio-event.md) | [èª²ç¨‹é¦–é  â†©](../COURSE_PLAN.md)