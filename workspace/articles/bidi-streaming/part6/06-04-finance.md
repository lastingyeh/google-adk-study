歡迎來到這堂針對金融領域的深度技術實作課。我是你們的資深技術導師。

在討論 ADK 的應用範例時，**金融服務與財富管理 (Financial Services and Wealth Management)** 被視為展現雙向串流價值的頂級場景。這不只是因為它需要極高的即時性，更因為金融決策往往依賴複雜的數據圖表與市場動態的即時交互。

### 📌 金融服務與財富管理實戰地圖

1.  **金融對話的範式轉換**：從「靜態報表」到「動態理財顧問」。
2.  **核心場景深潛**：市場趨勢討論、投資組合審查與交易模擬。
3.  **關鍵技術支撐**：多模態螢幕共享與串流工具（Streaming Tools）的結合。
4.  **代碼即真理**：解析如何實作即時金融事件監控。
5.  **知識收斂與總結**。

---

### 一、 場景驅動教學：重塑財富管理的互動邏輯

在金融服務中，雙向串流（Bidi-streaming）能將冷冰冰的數據轉化為具備「感知力」的專業建議。

#### 💡 場景 1：資產組合的即時診斷與「螢幕共享」
**提問：** 「當客戶想了解自己的投資組合績效時，AI 只能用說的嗎？」
**解析：**
**這代表什麼？** 在 ADK 的架構下，互動不再侷限於語音。
*   **關鍵在於：多模態螢幕共享 (Screen Sharing)**。代理程式可以主動共享其螢幕來顯示複雜的趨勢圖表與績效數據；同時，客戶也能共享自己的螢幕，指著特定的新聞文章詢問 AI。
*   **導師點評**：這種「雙向視覺交互」消除了金融溝通中的資訊不對稱，讓 AI 能真正「看到」客戶所關心的細節。

#### 💡 場景 2：市場衝擊的即時模擬
**提問：** 「如果市場突然發生重大事件（如科技股大跌），客戶如何快速得知對自己的影響？」
**解析：**
**關鍵在於：即時互動與數據接入**。
*   AI 代理程式可以透過訪問客戶的帳戶資料，即時模擬潛在交易對投資組合風險概況（Risk Profile）的影響。
*   **技術特點**：這依賴於 **工具整合 (Tool Integration)**。AI 在背景執行複雜計算，同時維持與客戶的自然對話。

#### 💡 場景 3：主動式股價監控 (Streaming Tools)
**提問：** 「我能讓 AI 主動在股價變動時通知我，並根據變化做出建議嗎？」
**解析：**
這就是 **串流工具 (Streaming Tools)** 的核心價值。
*   **行為模式**：工具會持續監控股票價格，並將中間結果串流回代理程式。當觸發特定條件時，代理程式會立即對此做出回應，主動向使用者報告變化。

---

### 二、 邏輯具象化：傳統金融 AI vs. ADK 財富管理代理

| 維度         | 傳統金融 AI (SSE/Token 級別) | ADK 雙向串流金融代理               |
| :----------- | :--------------------------- | :--------------------------------- |
| **交互速度** | 提問並等待完整回應           | 亞秒級延遲，支持隨時插嘴澄清       |
| **數據呈現** | 文字描述或靜態圖片           | **動態螢幕共享** 與即時圖表        |
| **監控模式** | 被動查詢                     | **主動串流監控** (Streaming Tools) |
| **決策輔助** | 靜態分析報告                 | **實時交易模擬** 與風險評估        |

---

### 三、 代碼即真理：金融監控與事件處理

在金融應用中，處理「串流更新」是核心。我們來看如何定義一個監控股價的**串流工具**，以及如何透過 `run_live()` 處理這些事件。

#### 1. 定義串流監控工具
**導師註解**：串流工具必須是 `async` 函數並回傳 `AsyncGenerator`。

```python
# [導師點評]：這允許工具在背景持續運作，並在股價變動時 yield 結果。
async def monitor_stock_price(symbol: str) -> AsyncGenerator[str, None]:
    """監控股價變化並將中間結果串流傳回給代理。"""
    while True:
        price = await fetch_realtime_price(symbol)
        # 關鍵在於：yield 的資料會立即被 ADK 捕獲並傳送給模型
        yield f"當前 {symbol} 的股價為 {price}"
        await asyncio.sleep(60) # 每分鐘監控一次
```

#### 2. 下游事件接收循環
**導師註解**：所有的工具執行結果都會透過 `run_live` 產生的 `Event` 物件傳回。

```python
# [導師點評]：這是下游任務的動脈，負責將 AI 的分析與工具回傳的數據送往客戶端。
async def downstream_task() -> None:
    async for event in runner.run_live(
        user_id=user_id,
        session_id=session_id,
        live_request_queue=live_request_queue,
        run_config=run_config,
    ):
        # 序列化事件並透過 WebSocket 發送給用戶端 UI
        event_json = event.model_dump_json(exclude_none=True, by_alias=True)
        await websocket.send_text(event_json)
```

---

### 四、 知識延伸與收斂：生產級金融代理的最後一哩路

在實作金融服務場景時，來源資料提醒我們有幾個進階配置必須考慮：

*   **會話恢復 (Session Resumption)**：理財諮詢往往耗時較長。啟用恢復功能可確保連線在網絡波動或平台 10 分鐘限制後能「透明地」重新連線，保留完整的對話上下文。
*   **上下文視窗壓縮**：對於長達數小時的財務規劃對話，這能實現「無限持續時間」，防止對話因 Token 耗盡而中斷。
*   **組合式工具調用 (CFC)**：當客戶問「如果我賣掉 A 股並買入 B 股，我的總體風險會如何變動？」時，CFC 允許模型並行執行多個工具並鏈接結果。

**實戰導向總結：**
金融服務不再是單向的「讀取報表」。透過 ADK 的 **多模態螢幕共享** 與 **串流工具**，你可以建構一個具備「眼睛」能看趨勢圖、具備「耳朵」能聽客戶焦慮、且能「主動執行」風險模擬的數位財富管家。

🏷️ `financial-services`, `wealth-management`, `streaming-tools`, `bidi-streaming`, `gemini-live-api`