# =============================================================================
# Conversation Agent é–‹ç™¼ç’°å¢ƒè¨­å®š (ä½¿ç”¨ uv)
# =============================================================================

.PHONY: help install dev dev-web dev-main debug test clean sync lock add remove init redis-up redis-down

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help

# å”åŠ©è³‡è¨Š
help:
	@echo "==============================================================================="
	@echo "| Conversation Agent é–‹ç™¼æŒ‡ä»¤ (ä½¿ç”¨ uv)                                     |"
	@echo "==============================================================================="
	@echo "| make init       - åˆå§‹åŒ– uv å°ˆæ¡ˆ                                         |"
	@echo "| make install    - å®‰è£å°ˆæ¡ˆä¾è³´ (åŸºæ–¼ pyproject.toml)                    |"
	@echo "| make sync       - åŒæ­¥ä¾è³´åˆ°è™›æ“¬ç’°å¢ƒ                                     |"
	@echo "| make lock       - æ›´æ–°ä¾è³´é–å®šæª”æ¡ˆ                                       |"
	@echo "| make add PKG    - æ–°å¢ä¾è³´å¥—ä»¶                                           |"
	@echo "| make remove PKG - ç§»é™¤ä¾è³´å¥—ä»¶                                           |"
	@echo "| make dev        - å•Ÿå‹• CLI å°è©±æ¨¡å¼ (adk run)                           |"
	@echo "| make dev-web    - å•Ÿå‹• Web é–‹ç™¼ä¼ºæœå™¨ (adk web)                         |"
	@echo "| make dev-main   - ä½¿ç”¨ Redis Session å•Ÿå‹• Web æ¨¡å¼                      |"
	@echo "| make debug      - å•Ÿå‹•åµéŒ¯æ¨¡å¼ï¼ˆæ”¯æ´ VS Code é™„åŠ åµéŒ¯ï¼‰                  |"
	@echo "| make redis-up   - å•Ÿå‹• Redis æœå‹™                                        |"
	@echo "| make redis-down - åœæ­¢ Redis æœå‹™                                        |"
	@echo "| make test       - åŸ·è¡Œæ¸¬è©¦                                               |"
	@echo "| make clean      - æ¸…ç†æš«å­˜æª”æ¡ˆ                                           |"
	@echo "==============================================================================="

# åˆå§‹åŒ– uv å°ˆæ¡ˆ
init:
	@echo "ğŸš€ åˆå§‹åŒ– uv å°ˆæ¡ˆ..."
	uv init --no-readme --no-workspace
	@echo "âœ… uv å°ˆæ¡ˆåˆå§‹åŒ–å®Œæˆ"

# å®‰è£ä¾è³´ï¼ˆä½¿ç”¨ uvï¼‰
install:
	@echo "ğŸ“¦ ä½¿ç”¨ uv å®‰è£å°ˆæ¡ˆä¾è³´..."
	uv add google-adk
	@echo "âœ… ä¾è³´å®‰è£å®Œæˆ"

# åŒæ­¥ä¾è³´åˆ°è™›æ“¬ç’°å¢ƒ
sync:
	@echo "ğŸ”„ åŒæ­¥ä¾è³´åˆ°è™›æ“¬ç’°å¢ƒ..."
	uv sync
	@echo "âœ… ä¾è³´åŒæ­¥å®Œæˆ"

# æ›´æ–°ä¾è³´é–å®šæª”æ¡ˆ
lock:
	@echo "ğŸ”’ æ›´æ–°ä¾è³´é–å®šæª”æ¡ˆ..."
	uv lock
	@echo "âœ… é–å®šæª”æ¡ˆæ›´æ–°å®Œæˆ"

# æ–°å¢ä¾è³´å¥—ä»¶
add:
	@echo "â• æ–°å¢ä¾è³´å¥—ä»¶..."
	@if [ -z "$(PKG)" ]; then \
		echo "âŒ è«‹æŒ‡å®šå¥—ä»¶åç¨±ï¼šmake add PKG=package-name"; \
		exit 1; \
	fi
	uv add $(PKG)
	@echo "âœ… å¥—ä»¶ $(PKG) å·²æ–°å¢"

# ç§»é™¤ä¾è³´å¥—ä»¶
remove:
	@echo "â– ç§»é™¤ä¾è³´å¥—ä»¶..."
	@if [ -z "$(PKG)" ]; then \
		echo "âŒ è«‹æŒ‡å®šå¥—ä»¶åç¨±ï¼šmake remove PKG=package-name"; \
		exit 1; \
	fi
	uv remove $(PKG)
	@echo "âœ… å¥—ä»¶ $(PKG) å·²ç§»é™¤"

# å•Ÿå‹• CLI å°è©±æ¨¡å¼
dev:
	@echo "ğŸš€ å•Ÿå‹• ADK CLI å°è©±æ¨¡å¼..."
	@echo "ğŸ’¬ ç›´æ¥åœ¨çµ‚ç«¯æ©Ÿä¸­èˆ‡ Agent å°è©±"
	@echo "ğŸ“ æ¸¬è©¦é …ç›®ï¼šåŸºæœ¬å°è©±ã€ç‹€æ…‹è¨˜æ†¶ã€æ¨¡å¼åˆ‡æ› (#think)ã€å®‰å…¨é˜²è­·"
	@echo "ğŸ›‘ è¼¸å…¥ 'exit' æˆ–æŒ‰ Ctrl+C é€€å‡º"
	@echo ""
	uv run adk run backend/agents

# å•Ÿå‹• Web é–‹ç™¼ä¼ºæœå™¨
dev-web:
	@echo "ğŸš€ å•Ÿå‹• ADK Web é–‹ç™¼ä¼ºæœå™¨..."
	@echo "ğŸ“± é–‹å•Ÿ http://localhost:8000 ä¸¦é¸æ“‡ 'agents'"
	@echo "ğŸ›‘ æŒ‰ä¸‹ Ctrl+C åœæ­¢ä¼ºæœå™¨"
	@echo ""
	uv run adk web backend

# ä½¿ç”¨ Redis Session å•Ÿå‹• Web é–‹ç™¼ä¼ºæœå™¨
dev-main:
	@echo "ğŸš€ å•Ÿå‹• ADK Web é–‹ç™¼ä¼ºæœå™¨ (ä½¿ç”¨ Redis Session)..."
	@echo "ğŸ“± é–‹å•Ÿ http://localhost:8000 ä¸¦é¸æ“‡ 'agents'"
	@echo "ğŸ’¾ æœƒè©±è³‡æ–™å°‡å„²å­˜åœ¨ Redis (24å°æ™‚ TTL)"
	@echo "ğŸ›‘ æŒ‰ä¸‹ Ctrl+C åœæ­¢ä¼ºæœå™¨"
	@echo ""
	uv run python backend/main.py web backend --session_service_uri=redis://localhost:6379/0

# å•Ÿå‹•åµéŒ¯æ¨¡å¼
debug:
	@echo "==============================================================================="
	@echo "| ğŸ› å•Ÿå‹•åµéŒ¯æ¨¡å¼                                                          |"
	@echo "==============================================================================="
	@echo "| ğŸ“ ä¼ºæœå™¨ä½å€ï¼šhttp://localhost:8000                                      |"
	@echo "| ğŸ” Debugger ç›£è½ï¼š5678                                                   |"
	@echo "| ğŸ”— VS Code é€£æ¥ï¼šæŒ‰ F5 é¸æ“‡ 'Debug ADK Web'                            |"
	@echo "| ğŸ”„ ç†±é‡è¼‰ï¼šå•Ÿç”¨                                                          |"
	@echo "| ğŸ’¡ æç¤ºï¼šåœ¨ VS Code ä¸­è¨­å®šä¸­æ–·é»å¾Œé–‹å§‹åµéŒ¯                              |"
	@echo "==============================================================================="
	uv run python -m debugpy --listen 5678 --wait-for-client -m google.adk.cli web backend --port 8000

# åŸ·è¡Œæ¸¬è©¦
test:
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	@echo "âš ï¸  æ³¨æ„ï¼šè«‹å…ˆå»ºç«‹æ¸¬è©¦æª”æ¡ˆ"
	uv run pytest tests/ -v --tb=short

# å®‰è£é–‹ç™¼ä¾è³´
install-dev:
	@echo "ğŸ”§ å®‰è£é–‹ç™¼ä¾è³´..."
	uv add --dev pytest debugpy
	@echo "âœ… é–‹ç™¼ä¾è³´å®‰è£å®Œæˆ"

# å•Ÿå‹• Redis æœå‹™
redis-up:
	@echo "ğŸ”´ å•Ÿå‹• Redis æœå‹™..."
	docker-compose up -d redis-adk-not-chat-gpt
	@echo "âœ… Redis å·²å•Ÿå‹•åœ¨ localhost:6379"

# åœæ­¢ Redis æœå‹™
redis-down:
	@echo "ğŸ›‘ åœæ­¢ Redis æœå‹™..."
	docker-compose stop redis-adk-not-chat-gpt
	@echo "âœ… Redis å·²åœæ­¢"

# æ¸…ç†æš«å­˜æª”æ¡ˆ
clean:
	@echo "ğŸ§¹ æ¸…ç†æš«å­˜æª”æ¡ˆ..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".uv" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# é¡¯ç¤ºå°ˆæ¡ˆè³‡è¨Š
info:
	@echo "ğŸ“Š å°ˆæ¡ˆè³‡è¨Šï¼š"
	@echo "Python ç‰ˆæœ¬ï¼š$(shell uv python version 2>/dev/null || echo 'æœªå®‰è£')"
	@echo "uv ç‰ˆæœ¬ï¼š$(shell uv --version 2>/dev/null || echo 'æœªå®‰è£')"
	@echo "è™›æ“¬ç’°å¢ƒï¼š$(shell uv venv list 2>/dev/null || echo 'æœªå»ºç«‹')"

# é–‹ç™¼æ¨¡å¼çš„åˆ¥å
run: dev
setup: init install-dev