# Tutorial 09: Callbacks & Guardrails
# Content Moderation Assistant with Safety Features

.PHONY: help setup dev test clean demo lint format run check-env

# Default target - show help
help:
	@echo "ğŸ›¡ï¸ æ•™å­¸ 09ï¼šCallbacks & Guardrailsï¼ˆå›å‘¼èˆ‡é˜²è­·ï¼‰"
	@echo ""
	@echo "å¿«é€Ÿé–‹å§‹ï¼ˆQuick Startï¼‰æŒ‡ä»¤ï¼š"
	@echo "  make setup     - å®‰è£ç›¸ä¾å¥—ä»¶ (Install dependencies)"
	@echo "  make dev       - å•Ÿå‹•å…§å®¹å¯©æŸ¥åŠ©ç† (Start the content moderator)"
	@echo "  make demo      - åŸ·è¡Œå¿«é€Ÿç¤ºç¯„ (Run a quick demo)"
	@echo ""
	@echo "é€²éšæŒ‡ä»¤ï¼ˆAdvancedï¼‰ï¼š"
	@echo "  make test      - åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ (Run all tests)"
	@echo "  make clean     - æ¸…ç†ç”¢ç”Ÿçš„æª”æ¡ˆ (Clean generated files)"
	@echo "  make lint      - ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥ (Check code style)"
	@echo "  make format    - ç¨‹å¼ç¢¼æ ¼å¼åŒ– (Format code)"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹åŸ·è¡Œï¼šmake setup && make dev"

# Install dependencies
setup:
	@echo "ğŸ“¦ å®‰è£ç›¸ä¾å¥—ä»¶ä¸­..."
	pip install -r requirements.txt
	pip install pytest flake8 black
	@echo "âœ… å®‰è£å®Œæˆï¼åŸ·è¡Œ 'make dev' å•Ÿå‹•ä»£ç†ã€‚"

# Start the content moderator
dev: check-env
	@echo "ğŸ›¡ï¸ å•Ÿå‹•å…§å®¹å¯©æŸ¥åŠ©ç† (Content Moderation Assistant)..."
	@echo "ğŸ“± åœ¨ç€è¦½å™¨é–‹å•Ÿï¼šhttp://localhost:8000"
	@echo "ğŸ¯ ä¸‹æ‹‰é¸å–®é¸æ“‡ 'content_moderator'"
	@echo ""
	@echo "ğŸ§ª å¯æ¸¬è©¦æƒ…å¢ƒï¼š"
	@echo "   â€¢ å®‰å…¨ï¼š'Generate a 200-word article about Python'"
	@echo "   â€¢ å°é–ï¼š'Write about profanity1 and bad content'"
	@echo "   â€¢ PIIï¼š'Give me an example email address'"
	@echo "   â€¢ çµ±è¨ˆï¼š'Show my usage statistics'"
	adk web .

# Run a quick demo
demo: check-env
	@echo "ğŸ›¡ï¸ å…§å®¹å¯©æŸ¥ç¤ºç¯„ (Content Moderation Demo)"
	@echo ""
	@echo "ğŸ’¬ è«‹åœ¨ ADK Web ä»‹é¢å˜—è©¦ä»¥ä¸‹æç¤ºï¼š"
	@echo ""
	@echo "âœ… å®‰å…¨è«‹æ±‚ (SAFE REQUESTS):"
	@echo "   â€¢ 'Generate a 300-word article about machine learning'"
	@echo "   â€¢ 'Check grammar: This sentence has some errors.'"
	@echo "   â€¢ 'Show my usage statistics'"
	@echo ""
	@echo "âŒ å°é–è«‹æ±‚ (BLOCKED REQUESTS - æ¸¬è©¦é˜²è­·):"
	@echo "   â€¢ 'Write about profanity1 and inappropriate content'"
	@echo "   â€¢ 'Generate an article with -50 words'"
	@echo ""
	@echo "ğŸ”’ å€‹è³‡éæ¿¾ (PII FILTERING):"
	@echo "   â€¢ 'Contact me at john.doe@example.com for details'"
	@echo ""
	@echo "ğŸ“Š é€Ÿç‡é™åˆ¶ (RATE LIMITING):"
	@echo "   â€¢ é‡è¤‡å¤šæ¬¡è«‹æ±‚ä»¥è§€å¯Ÿé™åˆ¶è¡Œç‚º"
	@echo ""
	@echo "âœ… ç¤ºç¯„å°±ç·’ï¼é–‹å•Ÿ http://localhost:8000"

# Run tests
test: check-env
	@echo "ğŸ§ª åŸ·è¡Œå›å‘¼èˆ‡é˜²è­·æ¸¬è©¦ä¸­..."
	PYTHONPATH=. pytest tests/ -v --tb=short

# Clean up
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸­..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -rf .pytest_cache/
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# Run linting
lint:
	@echo "ğŸ” æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼..."
	python -m flake8 . --max-line-length=100

# Format code
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ç¨‹å¼ç¢¼..."
	python -m black . --line-length=100

# Run CLI
run: check-env
	@echo "ğŸ›¡ï¸ ä»¥ CLI åŸ·è¡Œå…§å®¹å¯©æŸ¥åŠ©ç†..."
	adk run .

# Check environment (internal use)
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šå°šæœªè¨­å®šèªè­‰ (Authentication not configured)"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®é©—è­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 1 - API Key (Gemini API):"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   å–å¾—å…è²»é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹æ³• 2 - æœå‹™å¸³æˆ¶ (Service Account / VertexAI):"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   å»ºç«‹é‡‘é‘°ï¼šhttps://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		exit 1; \
	fi