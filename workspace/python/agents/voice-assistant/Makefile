# æ•™å­¸ 15ï¼šLive API èˆ‡éŸ³è¨Š - å³æ™‚èªéŸ³äº’å‹•
# ç”¨æ–¼é–‹ç™¼ã€æ¸¬è©¦å’ŒèªéŸ³åŠ©ç†ç¤ºç¯„çš„ Makefile

.PHONY: help setup dev test clean
.PHONY: lint format validate
.PHONY: live_env_check live_smoke live_models_doc live_access_help

# é è¨­ç’°å¢ƒè®Šæ•¸ï¼ŒæŒ‡å®šè¨—ç®¡ Gemini Live é è¦½ç‰ˆçš„å€åŸŸã€‚
# å°æ–¼ Vertex AIï¼šgemini-2.0-flash-live-preview-04-09 (ä¾†è‡ªå®˜æ–¹ ADK ç¯„ä¾‹)
export VOICE_ASSISTANT_LIVE_MODEL ?= gemini-2.0-flash-live-preview-04-09
export GOOGLE_CLOUD_PROJECT ?= saas-app-001
export GOOGLE_GENAI_USE_VERTEXAI ?= 1
export GOOGLE_CLOUD_LOCATION ?= us-central1
export GOOGLE_GENAI_VERTEXAI_LOCATION ?= $(GOOGLE_CLOUD_LOCATION)

# é è¨­ç›®æ¨™ - é¡¯ç¤ºèªªæ˜
help:
	@echo "ğŸ™ï¸  æ•™å­¸ 15ï¼šLive API èˆ‡éŸ³è¨Š - å³æ™‚èªéŸ³äº’å‹•"
	@echo ""
	@echo "ğŸ“‹ å¿«é€Ÿå…¥é–€ï¼š"
	@echo "  make setup    # å®‰è£ä¾è³´å¥—ä»¶"
	@echo "  make dev      # å•Ÿå‹• ADK ç¶²é ä»‹é¢ (âœ… å»ºè­°ç”¨æ–¼ Live API)"
	@echo "  make test     # åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶"
	@echo ""
	@echo "ğŸ”§ è¨ºæ–·èˆ‡è¨­å®šï¼š"
	@echo "  make live_env_check    # é©—è­‰ Vertex AI Live API è¨­å®š"
	@echo "  make live_models_list  # åˆ—å‡ºæ‚¨å°ˆæ¡ˆä¸­å¯ç”¨çš„ Live API æ¨¡å‹"
	@echo "  make check_audio       # æª¢æŸ¥éŸ³è¨Šè£ç½®æ˜¯å¦å¯ç”¨"
	@echo "  make live_smoke        # å¿«é€Ÿçš„ Vertex Live é€£ç·šç…™éœ§æ¸¬è©¦"
	@echo "  make live_models_doc   # é¡¯ç¤ºæ”¯æ´çš„ Live API æ¨¡å‹æ–‡ä»¶"
	@echo "  make live_access_help  # è«‹æ±‚å•Ÿç”¨ Gemini Live API çš„æ­¥é©Ÿ"
	@echo ""
	@echo "ğŸ§¹ ç¶­è­·ï¼š"
	@echo "  make clean    # ç§»é™¤å¿«å–æª”æ¡ˆå’Œç”¢ç‰©"
	@echo "  make lint     # æª¢æŸ¥ç¨‹å¼ç¢¼å“è³ª"
	@echo "  make format   # ä½¿ç”¨ black æ ¼å¼åŒ–ç¨‹å¼ç¢¼"
	@echo "  make validate # åŸ·è¡Œå®Œæ•´çš„é©—è­‰å¥—ä»¶"
	@echo ""
	@echo "ğŸ“– æ•™å­¸ï¼šhttps://github.com/raphaelmansuy/adk_training/tree/main/tutorial_implementation/tutorial15"

# è¨­å®šç’°å¢ƒ
setup:
	@echo "ğŸ“¦ æ­£åœ¨è¨­å®šæ•™å­¸ 15 çš„ç’°å¢ƒ..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… è¨­å®šå®Œæˆï¼"
	@echo "ğŸ’¡ å¾ŒçºŒæ­¥é©Ÿï¼š"
	@echo "   1. å°‡ .env.example è¤‡è£½ç‚º .envï¼šcp .env.example .env"
	@echo "   2. è¨­å®š Vertex AI æ†‘è­‰ï¼š"
	@echo "      export GOOGLE_GENAI_USE_VERTEXAI=1"
	@echo "      export GOOGLE_CLOUD_PROJECT=your-project"
	@echo "      export GOOGLE_CLOUD_LOCATION=us-central1"
	@echo "      export VOICE_ASSISTANT_LIVE_MODEL=gemini-2.0-flash-live-preview-04-09"
	@echo "   3. åŸ·è¡Œ 'make dev' å•Ÿå‹• ADK ç¶²é ä»‹é¢"
	@echo "   4. é–‹å•Ÿ http://localhost:8000 ä¸¦é¸æ“‡ 'voice_assistant'"

# å•Ÿå‹• ADK ç¶²é ä»‹é¢ (å»ºè­°ç”¨æ–¼ Live API)
dev:
	@echo "ğŸŒ æ­£åœ¨å•Ÿå‹• ADK ç¶²é ä»‹é¢..."
	@echo "âœ… é€™æ˜¯ Live API é›™å‘ä¸²æµçš„æœ‰æ•ˆæ–¹æ³•"
	@echo ""
	@echo "ğŸ“‹ å…ˆæ±ºæ¢ä»¶ï¼š"
	@echo "   â€¢ Vertex AIï¼šè¨­å®š GOOGLE_GENAI_USE_VERTEXAI=1"
	@echo "   â€¢ å°ˆæ¡ˆï¼šè¨­å®š GOOGLE_CLOUD_PROJECT=your-project"
	@echo "   â€¢ å€åŸŸï¼šè¨­å®š GOOGLE_CLOUD_LOCATION=us-central1"
	@echo "   â€¢ æ¨¡å‹ï¼šè¨­å®š VOICE_ASSISTANT_LIVE_MODEL=gemini-2.0-flash-live-preview-04-09"
	@echo ""
	@echo "ğŸ¯ ä½¿ç”¨æ–¹å¼ï¼š"
	@echo "   1. åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ http://localhost:8000"
	@echo "   2. å¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ 'voice_assistant'"
	@echo "   3. é»æ“ŠéŸ³è¨Š/éº¥å…‹é¢¨æŒ‰éˆ• (ğŸ¤)"
	@echo "   4. é–‹å§‹è¼¸å…¥æˆ–èªªè©±"
	@echo ""
	@echo "ğŸš€ æ­£åœ¨å•Ÿå‹•ä¼ºæœå™¨..."
	adk web

# åŸ·è¡Œæ¸¬è©¦
test:
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶..."
	pytest tests/ -v --cov=voice_assistant --cov-report=term-missing
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼"

# ç”¨æ–¼ Live API è¨ºæ–·çš„ç’°å¢ƒè¼”åŠ©å·¥å…·
live_env_check:
	@echo "ğŸ©º æ­£åœ¨é©—è­‰ Vertex Live ç’°å¢ƒ..."
	@if [ -z "$$GOOGLE_GENAI_USE_VERTEXAI" ]; then \
		echo "   âŒ GOOGLE_GENAI_USE_VERTEXAI æœªè¨­å®šã€‚è«‹å°‡å…¶åŒ¯å‡º (å€¼ç‚º 1) ä»¥ä½¿ç”¨ Live APIã€‚"; \
		echo "   ğŸ‘‰ ç¯„ä¾‹ï¼šexport GOOGLE_GENAI_USE_VERTEXAI=1"; \
		exit 1; \
	fi
	@if [ -z "$$GOOGLE_CLOUD_PROJECT" ]; then \
		echo "   âŒ GOOGLE_CLOUD_PROJECT ç¼ºå°‘ã€‚è«‹è¨­å®šæ‚¨çš„ Vertex å°ˆæ¡ˆ IDã€‚"; \
		echo "   ğŸ‘‰ ç¯„ä¾‹ï¼šexport GOOGLE_CLOUD_PROJECT=your-project"; \
		exit 1; \
	fi
	@if [ -z "$$GOOGLE_CLOUD_LOCATION" ]; then \
		echo "   â„¹ï¸  GOOGLE_CLOUD_LOCATION æœªè¨­å®šã€‚é è¨­ç‚º us-central1ã€‚"; \
	fi
	@if [ -z "$$VOICE_ASSISTANT_LIVE_MODEL" ]; then \
		echo "   âŒ VOICE_ASSISTANT_LIVE_MODEL æœªè¨­å®šã€‚è«‹é¸æ“‡æ”¯æ´çš„ Live API æ¨¡å‹ã€‚"; \
		echo "   ğŸ‘‰ æ–‡ä»¶ï¼šhttps://ai.google.dev/gemini-api/docs/live#before_you_begin_building"; \
		exit 1; \
	fi
	@echo "   â€¢ Live æ¨¡å‹ï¼š$$VOICE_ASSISTANT_LIVE_MODEL"
	@python -m scripts.validate_live_model
	@echo "   âœ… åµæ¸¬åˆ° Vertex Live çš„å…ˆæ±ºæ¢ä»¶ã€‚"

audio_deps_check:
	@echo "ğŸ§ æ­£åœ¨æª¢æŸ¥æœ¬æ©ŸéŸ³è¨Šä¾è³´å¥—ä»¶..."
	@python scripts/check_audio_deps.py

live_smoke: live_env_check
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œ Vertex Live ç…™éœ§æ¸¬è©¦ (æ–‡å­—å‚™æ´)..."
	@python scripts/smoke_test.py

live_models_doc:
	@echo "ğŸ“š æ”¯æ´çš„ Live API æ¨¡å‹ (å®˜æ–¹æ–‡ä»¶)ï¼š"
	@echo "   åŠç´šè¯ (Half-cascade)ï¼šgemini-live-2.5-flash-preview, gemini-2.0-flash-live-001"
	@echo "   åŸç”ŸéŸ³è¨Š (é è¨­)ï¼šgemini-live-2.5-flash-preview-native-audio,"
	@echo "                gemini-2.5-flash-native-audio-preview-09-2025, gemini-2.5-flash-preview-native-audio-dialog,"
	@echo "                gemini-2.5-flash-exp-native-audio-thinking-dialog"
	@echo "   æ–‡ä»¶ï¼šhttps://ai.google.dev/gemini-api/docs/live#before_you_begin_building"
	@echo "   å€åŸŸå¯ç”¨æ€§å„ä¸ç›¸åŒï¼›è«‹åƒé–± https://cloud.google.com/vertex-ai/generative-ai/docs/models/gemini/2-5-flash-live-api"

live_access_help:
	@python -m scripts.live_access_help

live_models_list:
	@echo "ğŸ“¡ æ­£åœ¨æŸ¥è©¢ Vertex AI ä»¥å–å¾—å¯å­˜å–çš„ Live API æ¨¡å‹..."
	@if [ -z "$$GOOGLE_GENAI_USE_VERTEXAI" ]; then \
		echo "   âŒ GOOGLE_GENAI_USE_VERTEXAI æœªè¨­å®šã€‚è«‹å°‡å…¶åŒ¯å‡ºä»¥ä½¿ç”¨ Vertex AIã€‚"; \
		echo "   ğŸ‘‰ ç¯„ä¾‹ï¼šexport GOOGLE_GENAI_USE_VERTEXAI=1"; \
		exit 1; \
	fi
	@if [ -z "$$GOOGLE_CLOUD_PROJECT" ]; then \
		echo "   âŒ GOOGLE_CLOUD_PROJECT ç¼ºå°‘ã€‚è«‹è¨­å®šæ‚¨çš„ Vertex å°ˆæ¡ˆ IDã€‚"; \
		echo "   ğŸ‘‰ ç¯„ä¾‹ï¼šexport GOOGLE_CLOUD_PROJECT=your-project"; \
		exit 1; \
	fi
	@python -m scripts.list_live_models

# ç¨‹å¼ç¢¼å“è³ª
lint:
	@echo "ğŸ” æ­£åœ¨åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥..."
	@command -v ruff >/dev/null 2>&1 && ruff check voice_assistant/ tests/ || echo "âš ï¸  ruff æœªå®‰è£ (å¯é¸)"
	@command -v mypy >/dev/null 2>&1 && mypy voice_assistant/ || echo "âš ï¸  mypy æœªå®‰è£ (å¯é¸)"
	@command -v flake8 >/dev/null 2>&1 && flake8 voice_assistant/ tests/ || echo "âš ï¸  flake8 æœªå®‰è£ (å¯é¸)"
	@echo "âœ… Lint æª¢æŸ¥å®Œæˆï¼"

format:
	@echo "ğŸ¨ æ­£åœ¨æ ¼å¼åŒ–ç¨‹å¼ç¢¼..."
	@command -v black >/dev/null 2>&1 && black voice_assistant/ tests/ || echo "âš ï¸  black æœªå®‰è£ (å¯é¸)"
	@echo "âœ… ç¨‹å¼ç¢¼æ ¼å¼åŒ–å®Œæˆï¼"

# å…¨é¢é©—è­‰
validate: lint test
	@echo "âœ… å®Œæ•´é©—è­‰å®Œæˆï¼"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†å¿«å–æª”æ¡ˆå’Œç”¢ç‰©..."
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".coverage" -exec rm -rf {} +
	find . -type f -name ".coverage" -delete
	find . -type f -name "coverage.xml" -delete
	@echo "âœ… æ¸…ç†å®Œæˆï¼"
