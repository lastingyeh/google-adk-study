.PHONY: help setup install dev test clean demo docs lint format
.PHONY: test-unit test-int clean-stores demo-upload demo-search demo-workflow

# è¼¸å‡ºé¡è‰²
BOLD := \033[1m
BLUE := \033[34m
GREEN := \033[32m
YELLOW := \033[33m
RESET := \033[0m

help:
	@printf "\n$(BOLD)$(BLUE)Policy Navigator - æ•™å­¸ 37$(RESET)\n"
	@printf "$(BOLD)File Search Store ç®¡ç†ç³»çµ±$(RESET)\n\n"

	@printf "$(BOLD)ğŸš€ é–‹å§‹ä½¿ç”¨$(RESET)\n"
	@printf "  $(GREEN)setup$(RESET)              å®‰è£ç›¸ä¾å¥—ä»¶ä¸¦è¨­å®šç’°å¢ƒ\n"
	@printf "  $(GREEN)dev$(RESET)                å•Ÿå‹•äº’å‹•å¼ ADK ç¶²é ä»‹é¢\n\n"

	@printf "$(BOLD)ğŸ“¦ é–‹ç™¼$(RESET)\n"
	@printf "  $(GREEN)install$(RESET)            ä»¥é–‹ç™¼æ¨¡å¼å®‰è£å¥—ä»¶\n"
	@printf "  $(GREEN)lint$(RESET)               åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ (ruff + black + mypy)\n"
	@printf "  $(GREEN)format$(RESET)             ä½¿ç”¨ black å’Œ ruff è‡ªå‹•æ ¼å¼åŒ–ç¨‹å¼ç¢¼\n"
	@printf "  $(GREEN)test$(RESET)               åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦è¨ˆç®—è¦†è“‹ç‡\n"
	@printf "  $(GREEN)test-unit$(RESET)          åƒ…åŸ·è¡Œå–®å…ƒæ¸¬è©¦\n"
	@printf "  $(GREEN)test-int$(RESET)           åƒ…åŸ·è¡Œæ•´åˆæ¸¬è©¦\n\n"

	@printf "$(BOLD)ğŸ¯ å±•ç¤º (Demos)$(RESET)\n"
	@printf "  $(GREEN)demo$(RESET)               åŸ·è¡Œæ‰€æœ‰å±•ç¤º (ä¸Šå‚³ â†’ æœå°‹)\n"
	@printf "  $(GREEN)demo-upload$(RESET)        å±•ç¤ºï¼šä¸Šå‚³æ”¿ç­–åˆ° File Search Store\n"
	@printf "  $(GREEN)demo-search$(RESET)        å±•ç¤ºï¼šæœå°‹ä¸¦æª¢ç´¢æ”¿ç­–\n"
	@printf "  $(GREEN)demo-workflow$(RESET)      å±•ç¤ºï¼šå®Œæ•´ç«¯å°ç«¯å·¥ä½œæµç¨‹\n\n"

	@printf "$(BOLD)ğŸ§¹ æ¸…ç†$(RESET)\n"
	@printf "  $(GREEN)clean$(RESET)              ç§»é™¤å¿«å–ã€__pycache__ã€è¦†è“‹ç‡å ±å‘Š\n"
	@printf "  $(GREEN)clean-stores$(RESET)       åˆªé™¤æ‰€æœ‰ File Search Store (âš ï¸  é‡æ–°é–‹å§‹)\n\n"

	@printf "$(BOLD)ğŸ“š åƒè€ƒè³‡æ–™$(RESET)\n"
	@printf "  $(GREEN)docs$(RESET)               æª¢è¦–æ–‡ä»¶\n"
	@printf "  $(GREEN)help$(RESET)               é¡¯ç¤ºæ­¤èªªæ˜è¨Šæ¯\n\n"

setup: install
	@printf "\n$(GREEN)âœ“ ç’°å¢ƒè¨­å®šå®Œæˆ$(RESET)\n\n"
	@printf "$(BOLD)ä¸‹ä¸€æ­¥ï¼š$(RESET)\n"
	@printf "  1. è¤‡è£½ .env.example åˆ° .env\n"
	@printf "       $(BLUE)cp .env.example .env$(RESET)\n\n"
	@printf "  2. å°‡æ‚¨çš„ GOOGLE_API_KEY æ–°å¢åˆ° .env\n\n"
	@printf "  3. åŸ·è¡Œäº’å‹•å¼ç¶²é ä»‹é¢\n"
	@printf "       $(BLUE)make dev$(RESET)\n\n"
	@printf "$(BOLD)ç¬¬ä¸€æ¬¡è¨­å®šï¼Ÿ$(RESET)\n"
	@printf "  åŸ·è¡Œä¸Šå‚³å±•ç¤ºä»¥å»ºç«‹ä¸¦å¡«å…¥ File Search Storeï¼š\n"
	@printf "       $(BLUE)make demo-upload$(RESET)\n\n"

install:
	@printf "$(BOLD)æ­£åœ¨å®‰è£ç›¸ä¾å¥—ä»¶...$(RESET)\n"
	pip install -e . > /dev/null 2>&1
	pip install -r requirements.txt > /dev/null 2>&1
	@printf "$(GREEN)âœ“ å®‰è£å®Œæˆ$(RESET)\n"

dev:
	@printf "\n$(BOLD)ğŸš€ æ­£åœ¨å•Ÿå‹• ADK ç¶²é ä»‹é¢...$(RESET)\n\n"
	@printf "$(BLUE)http://localhost:8000$(RESET)\n\n"
	@printf "ä»‹é¢å³å°‡åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­é–‹å•Ÿã€‚\n"
	@printf "æŒ‰ Ctrl+C åœæ­¢ä¼ºæœå™¨ã€‚\n\n"
	adk web

test:
	@printf "\n$(BOLD)æ­£åœ¨åŸ·è¡Œæ¸¬è©¦ä¸¦è¨ˆç®—è¦†è“‹ç‡...$(RESET)\n\n"
	pytest tests/ -v --cov=policy_navigator --cov-report=html
	@printf "\n$(GREEN)âœ“ æ‰€æœ‰æ¸¬è©¦é€šéï¼$(RESET)\n"
	@printf "$(BLUE)è¦†è“‹ç‡å ±å‘Šï¼šhtmlcov/index.html$(RESET)\n\n"

test-unit:
	@printf "$(BOLD)æ­£åœ¨åŸ·è¡Œå–®å…ƒæ¸¬è©¦...$(RESET)\n\n"
	pytest tests/ -v -k "not integration" --cov=policy_navigator
	@printf "\n$(GREEN)âœ“ å–®å…ƒæ¸¬è©¦å®Œæˆ$(RESET)\n\n"

test-int:
	@printf "$(BOLD)æ­£åœ¨åŸ·è¡Œæ•´åˆæ¸¬è©¦...$(RESET)\n\n"
	pytest tests/ -v -k "integration" --cov=policy_navigator
	@printf "\n$(GREEN)âœ“ æ•´åˆæ¸¬è©¦å®Œæˆ$(RESET)\n\n"

clean:
	@printf "$(BOLD)æ­£åœ¨æ¸…ç† artifacts...$(RESET)\n"
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete
	@printf "$(GREEN)âœ“ æ¸…ç†å®Œæˆ$(RESET)\n"
	@printf "  å·²ç§»é™¤ï¼š__pycache__, *.pyc, .egg-info, .pytest_cache, coverage reports\n\n"

clean-stores:
	@printf "\n$(BOLD)$(YELLOW)âš ï¸  è­¦å‘Šï¼šæ­£åœ¨åˆªé™¤æ‰€æœ‰ File Search Store...$(RESET)\n"
	@printf "é€™å°‡è®“æ‚¨å¾å®Œå…¨ä¹¾æ·¨çš„ç‹€æ…‹é‡æ–°é–‹å§‹ã€‚\n\n"
	@read -p "æ‚¨ç¢ºå®šå—ï¼Ÿ(è¼¸å…¥ 'yes' ç¢ºèª)ï¼š " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		printf "$(YELLOW)æ­£åœ¨åˆªé™¤ File Search Store...$(RESET)\n"; \
		python scripts/cleanup_stores.py; \
		printf "$(GREEN)âœ“ æ¸…ç†å®Œæˆ$(RESET)\n\n"; \
	else \
		printf "$(BLUE)å·²å–æ¶ˆ$(RESET)\n\n"; \
	fi

demo: demo-upload demo-search
	@printf "$(GREEN)âœ“ æ‰€æœ‰å±•ç¤ºå®Œæˆï¼$(RESET)\n"
	@printf "ä¸‹ä¸€æ­¥ï¼šå˜—è©¦ $(BLUE)make demo-workflow$(RESET) é€²è¡Œå®Œæ•´ç«¯å°ç«¯å·¥ä½œæµç¨‹\n\n"

demo-upload:
	@printf "\n$(BOLD)ğŸ“¤ å±•ç¤ºï¼šä¸Šå‚³æ”¿ç­–åˆ° File Search$(RESET)\n"
	@printf "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)\n\n"
	python demos/demo_upload.py
	@printf "\n$(GREEN)âœ“ ä¸Šå‚³å±•ç¤ºå®Œæˆ$(RESET)\n\n"

demo-search:
	@printf "\n$(BOLD)ğŸ” å±•ç¤ºï¼šæœå°‹ä¸¦æª¢ç´¢æ”¿ç­–$(RESET)\n"
	@printf "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)\n\n"
	python demos/demo_search.py
	@printf "\n$(GREEN)âœ“ æœå°‹å±•ç¤ºå®Œæˆ$(RESET)\n\n"

demo-workflow:
	@printf "\n$(BOLD)ğŸ”„ å±•ç¤ºï¼šå®Œæ•´ç«¯å°ç«¯å·¥ä½œæµç¨‹$(RESET)\n"
	@printf "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)\n\n"
	python demos/demo_full_workflow.py
	@printf "\n$(GREEN)âœ“ å·¥ä½œæµç¨‹å±•ç¤ºå®Œæˆ$(RESET)\n\n"

lint:
	@printf "$(BOLD)æ­£åœ¨åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥...$(RESET)\n\n"
	@printf "$(YELLOW)æ­£åœ¨ä½¿ç”¨ ruff æª¢æŸ¥...$(RESET)\n"
	ruff check policy_navigator tests
	@printf "$(GREEN)âœ“ Ruff é€šé$(RESET)\n\n"
	@printf "$(YELLOW)æ­£åœ¨ä½¿ç”¨ black æª¢æŸ¥æ ¼å¼...$(RESET)\n"
	black --check policy_navigator tests
	@printf "$(GREEN)âœ“ Black æª¢æŸ¥é€šé$(RESET)\n\n"
	@printf "$(YELLOW)æ­£åœ¨ä½¿ç”¨ mypy é€²è¡Œå‹åˆ¥æª¢æŸ¥...$(RESET)\n"
	mypy policy_navigator --ignore-missing-imports
	@printf "$(GREEN)âœ“ MyPy é€šé$(RESET)\n\n"
	@printf "$(GREEN)âœ“ æ‰€æœ‰å“è³ªæª¢æŸ¥é€šéï¼$(RESET)\n\n"

format:
	@printf "$(BOLD)æ­£åœ¨è‡ªå‹•æ ¼å¼åŒ–ç¨‹å¼ç¢¼...$(RESET)\n\n"
	black policy_navigator tests
	ruff check --fix policy_navigator tests
	@printf "$(GREEN)âœ“ æ ¼å¼åŒ–å®Œæˆ$(RESET)\n\n"

docs:
	@printf "\n$(BOLD)ğŸ“š æ–‡ä»¶$(RESET)\n\n"
	@printf "$(YELLOW)å¯ç”¨æ–‡ä»¶ï¼š$(RESET)\n"
	@printf "  â€¢ $(BLUE)README.md$(RESET) - å°ˆæ¡ˆæ¦‚è¦½èˆ‡å¿«é€Ÿå…¥é–€\n"
	@printf "  â€¢ $(BLUE)docs/architecture.md$(RESET) - ç³»çµ±è¨­è¨ˆèˆ‡å…ƒä»¶\n"
	@printf "  â€¢ $(BLUE)docs/roi_calculator.md$(RESET) - ä¼æ¥­ ROI åˆ†æ\n"
	@printf "  â€¢ $(BLUE)docs/deployment_guide.md$(RESET) - ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²\n\n"
	@printf "$(YELLOW)æ­£åœ¨é–‹å•Ÿ README.md...$(RESET)\n\n"
	open README.md || xdg-open README.md

.DEFAULT_GOAL := help
