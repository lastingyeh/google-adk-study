.PHONY: help setup dev test clean demo lint install slack-dev slack-deploy slack-test

help:
	@echo "ğŸ“š èª²ç¨‹ 33: Slack æ©Ÿå™¨äººèˆ‡ ADK æ•´åˆ"
	@echo ""
	@echo "æ ¸å¿ƒæŒ‡ä»¤:"
	@echo "  make setup              - å®‰è£ä¾è³´ä¸¦è¨­å®šç’°å¢ƒ"
	@echo "  make dev                - å•Ÿå‹• ADK ç¶²é ä»‹é¢é€²è¡Œé–‹ç™¼"
	@echo "  make test               - åŸ·è¡Œæ¸¬è©¦å¥—ä»¶"
	@echo "  make test-coverage      - åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š"
	@echo "  make demo               - é¡¯ç¤ºç¯„ä¾‹æç¤ºèˆ‡ä½¿ç”¨æ–¹å¼"
	@echo "  make lint               - åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥ (linting)"
	@echo "  make clean              - æ¸…é™¤å¿«å–æª”æ¡ˆèˆ‡ç”¢ç‰©"
	@echo ""
	@echo "Slack æ•´åˆæŒ‡ä»¤:"
	@echo "  make slack-dev          - ä»¥ Socket Mode åŸ·è¡Œæ©Ÿå™¨äºº (é–‹ç™¼æ¨¡å¼)"
	@echo "  make slack-deploy       - éƒ¨ç½²è‡³ Cloud Run (ç”Ÿç”¢ç’°å¢ƒ)"
	@echo "  make slack-test         - æ¸¬è©¦ Slack æ•´åˆ"
	@echo ""

setup:
	@echo "ğŸ”§ æ­£åœ¨è¨­å®šèª²ç¨‹ 33..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… è¨­å®šå®Œæˆï¼"
	@echo ""
	@echo "ğŸ“ ä¸‹ä¸€æ­¥ï¼š"
	@echo "   1. è¤‡è£½ support_bot/.env.example åˆ° support_bot/.env"
	@echo "   2. å°‡æ‚¨çš„ Slack token å’Œ Google API key æ–°å¢è‡³ support_bot/.env"
	@echo "   3. åŸ·è¡Œ 'make dev' é–‹å§‹é–‹ç™¼"

dev:
	@echo "ğŸš€ æ­£åœ¨å•Ÿå‹• ADK ç¶²é é–‹ç™¼ä»‹é¢..."
	@echo "ğŸ“Œ è«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ http://localhost:8000"
	@echo ""
	adk web

test:
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦..."
	pytest tests/ -v --tb=short

test-coverage:
	@echo "ğŸ“Š æ­£åœ¨åŸ·è¡Œæ¸¬è©¦èˆ‡è¦†è“‹ç‡å ±å‘Š..."
	pytest tests/ -v --cov=support_bot --cov-report=term-missing

demo:
	@echo "ğŸ“– Support Bot - ä½¿ç”¨ç¯„ä¾‹"
	@echo ""
	@echo "æ”¯æ´æ©Ÿå™¨äººæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š"
	@echo ""
	@echo "1. ğŸ” çŸ¥è­˜åº«æœå°‹"
	@echo "   - æœå°‹å…¬å¸æ”¿ç­–"
	@echo "   - å°‹æ‰¾ IT æ”¯æ´è³‡è¨Š"
	@echo "   - å–å¾—ä¼‘å‡èˆ‡é ç«¯å·¥ä½œæ”¿ç­–"
	@echo ""
	@echo "2. ğŸ« æ”¯æ´å·¥å–®å»ºç«‹"
	@echo "   - ç‚ºè¤‡é›œå•é¡Œå»ºç«‹å·¥å–®"
	@echo "   - è¨­å®šå„ªå…ˆé †åº (ä½, ä¸€èˆ¬, é«˜, ç·Šæ€¥)"
	@echo "   - é€éå”¯ä¸€ ID è¿½è¹¤å·¥å–®"
	@echo ""
	@echo "ç¯„ä¾‹æŸ¥è©¢ï¼š"
	@echo "  â€¢ 'How do I reset my password?' (å¦‚ä½•é‡è¨­å¯†ç¢¼ï¼Ÿ)"
	@echo "  â€¢ 'What is the vacation policy?' (ä¼‘å‡æ”¿ç­–æ˜¯ä»€éº¼ï¼Ÿ)"
	@echo "  â€¢ 'I need help with VPN setup' (æˆ‘éœ€è¦ VPN è¨­å®šå”åŠ©)"
	@echo "  â€¢ 'Create a ticket for my laptop issue' (ç‚ºæˆ‘çš„ç­†é›»å•é¡Œå»ºç«‹å·¥å–®)"
	@echo ""
	@echo "åŸ·è¡Œ 'make dev' åœ¨ ADK ç¶²é ä»‹é¢æ¸¬è©¦é€™äº›æŸ¥è©¢ï¼"
	@echo ""

lint:
	@echo "ğŸ” æ­£åœ¨åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥..."
	python -m pylint support_bot/ || true
	python -m flake8 support_bot/ || true
	@echo "âœ… æª¢æŸ¥å®Œæˆ"

clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†..."
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .eggs -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.pyc" -delete
	rm -rf build/ dist/ *.egg-info/
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

slack-dev:
	@echo "ğŸš€ ä»¥ Socket Mode å•Ÿå‹• Support Bot (é–‹ç™¼æ¨¡å¼)..."
	@echo ""
	@if [ ! -f support_bot/.env ]; then \
		echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° support_bot/.env æª”æ¡ˆï¼"; \
		echo ""; \
		echo "ğŸ“ è‹¥è¦è¨­å®šæ‚¨çš„æ©Ÿå™¨äººï¼š"; \
		echo "   1. è¤‡è£½ç’°å¢ƒè®Šæ•¸ç¯„æœ¬ï¼š"; \
		echo "      cp support_bot/.env.example support_bot/.env"; \
		echo ""; \
		echo "   2. ç·¨è¼¯ support_bot/.env ä¸¦å¡«å…¥æ‚¨çš„ Slack tokenï¼š"; \
		echo "      SLACK_BOT_TOKEN=xoxb-..."; \
		echo "      SLACK_APP_TOKEN=xapp-..."; \
		echo "      GOOGLE_API_KEY=..."; \
		echo ""; \
		echo "   3. å¾ https://api.slack.com/apps å–å¾— token"; \
		echo ""; \
		exit 1; \
	fi
	@echo "ğŸ“‹ å·²å¾ support_bot/.env è¼‰å…¥è¨­å®š"
	@echo ""
	@echo "ğŸ”— æ­£åœ¨ä»¥ Socket Mode é€£ç·šè‡³ Slack..."
	@echo "ğŸ’¡ æ©Ÿå™¨äººé‹ä½œä¸­ï¼è©¦è‘—åœ¨ Slack è¼¸å…¥ï¼š"
	@echo ""
	@echo "   @Support Bot help"
	@echo "   @Support Bot What is the password reset procedure?"
	@echo "   @Support Bot Create a ticket for my issue"
	@echo ""
	@echo "â¹ï¸  æŒ‰ Ctrl+C åœæ­¢"
	@echo ""
	python -m support_bot.bot_dev

slack-deploy:
	@echo "ğŸš€ Cloud Run ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½² (é è¨­å®‰å…¨æ¨¡å¼)"
	@echo ""
	@echo "ğŸ“‹ é æ¼”æ¨¡å¼ (Dry-run)ï¼šåƒ…åˆ—å°æ­¥é©Ÿã€‚"
	@echo ""
	@echo "å…ˆæ±ºæ¢ä»¶ï¼š"
	@echo "  â€¢ gcloud CLI å·²é©—è­‰ (gcloud auth login)"
	@echo "  â€¢ Docker å·²å®‰è£ä¸¦é‹ä½œä¸­"
	@echo "  â€¢ PROJECT å’Œ REGION ç’°å¢ƒè®Šæ•¸å·²è¨­å®š"
	@echo ""
	@echo "æ­¥é©Ÿï¼š"
	@echo "  1. å»ºç½®ï¼šdocker build -t gcr.io/[PROJECT]/support-bot:latest ."
	@echo "  2. æ¨é€ï¼šdocker push gcr.io/[PROJECT]/support-bot:latest"
	@echo "  3. éƒ¨ç½²ï¼šgcloud run deploy (åŒ…å«æ˜ åƒæª”èˆ‡ secrets)"
	@echo "  4. Slackï¼šæ›´æ–° Event Subscription URL è‡³ https://[SERVICE_URL]/slack/events"
	@echo ""
	@echo "è‹¥è¦å®‰å…¨åœ°åŸ·è¡Œæ­¤éƒ¨ç½²ï¼š"
	@echo "  â€¢ è¨­å®š PROJECT å’Œ REGIONï¼š"
	@echo "      export PROJECT=your-gcp-project"
	@echo "      export REGION=us-central1"
	@echo "  â€¢ å»ºç«‹ secrets (ä¸€æ¬¡æ€§)ï¼š"
	@echo "      echo -n $$SLACK_BOT_TOKEN | gcloud secrets create SLACK_BOT_TOKEN --data-file=-"
	@echo "      echo -n $$SLACK_APP_TOKEN | gcloud secrets create SLACK_APP_TOKEN --data-file=-"
	@echo "  â€¢ åŸ·è¡Œéƒ¨ç½²è…³æœ¬ï¼š"
	@echo "      bash scripts/deploy_cloud_run.sh"
	@echo ""
	@echo "æˆ–æ‰‹å‹•ä¾ç…§ README.md ä¸­çš„ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²ç« ç¯€æ“ä½œ"

slack-test:
	@echo "ğŸ§ª æ­£åœ¨æ¸¬è©¦ Slack æ•´åˆ..."
	@echo ""
	@echo "æ¸¬è©¦é …ç›®ï¼š"
	@echo "   âœ“ Agent imports"
	@echo "   âœ“ Tool functionality"
	@echo "   âœ“ Slack compatibility"
	@echo ""
	@echo "æ­£åœ¨åŸ·è¡Œæ¸¬è©¦..."
	pytest tests/ -v -k "test_" --tb=short
	@echo ""
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šéï¼"

# é‡é»æ‘˜è¦ (Makefile)
# - æ ¸å¿ƒæ¦‚å¿µï¼šè‡ªå‹•åŒ–ç®¡ç†é–‹ç™¼ã€æ¸¬è©¦èˆ‡éƒ¨ç½²æµç¨‹çš„è…³æœ¬ã€‚
# - é—œéµæŠ€è¡“ï¼šMake, pip, pytest, Docker, Google Cloud SDKã€‚
# - é‡è¦çµè«–ï¼šé€éæ¨™æº–åŒ–æŒ‡ä»¤ç°¡åŒ–äº†é‡è¤‡æ€§ä»»å‹™ï¼Œç¢ºä¿é–‹ç™¼ç’°å¢ƒèˆ‡éƒ¨ç½²æµç¨‹çš„ä¸€è‡´æ€§ã€‚
# - è¡Œå‹•é …ç›®ï¼šé–‹ç™¼è€…æ‡‰å„ªå…ˆä½¿ç”¨ make æŒ‡ä»¤ä¾†åŸ·è¡Œä»»å‹™ï¼Œè€Œéæ‰‹å‹•è¼¸å…¥è¤‡é›œæŒ‡ä»¤ã€‚
