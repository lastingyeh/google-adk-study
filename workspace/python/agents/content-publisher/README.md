# 教學 06：多代理系統 - 內容發布系統

本實作展示了複雜的多代理編排，結合了巢狀工作流程中的順序代理和並行代理。內容發布系統運行並行研究管道（新聞、社群、專家），然後透過順序優化（撰寫、編輯、格式化）創建內容。

## 概述

內容發布系統展示了：

- **巢狀代理編排**：並行代理內部的順序代理
- **多階段工作流程**：並行研究 → 順序內容創建
- **狀態管理**：巢狀代理層之間的複雜資料流
- **生產就緒架構**：真實世界的內容生成管道

## 架構 可參考[連結](agent_architecture.md)

```
使用者查詢：「撰寫關於 AI 在醫療保健中的文章」
  ↓
┌─────────────────────────────────────────────────────────┐
│  階段 1：並行研究（3 條順序管道）                            │
├─────────────────────────────────────────────────────────┤
│  新聞管道：    取得 → 摘要 → 新聞摘要                        │
│  社群管道：    監控 → 分析 → 社群洞察                        │ ← 全部同時
│  專家管道：    尋找 → 提取 → 專家引述                        │   執行！
└─────────────────────────────────────────────────────────┘
  ↓（等待全部 3 個完成）
┌─────────────────────────────────────────────────────────┐
│  階段 2：順序內容創建                                      │
├─────────────────────────────────────────────────────────┤
│  作家：    結合所有研究 → 文章草稿                           │
│  編輯：    審查草稿 → 編輯後文章                             │ ← 一次
│  格式化器：添加 markdown → 發布文章                         │   一個
└─────────────────────────────────────────────────────────┘
  ↓
最終輸出：可發布的文章！
```

## 快速開始

1. **安裝依賴項：**

   ```bash
   make setup
   ```

2. **配置 API 金鑰：**

   ```bash
   cp content_publisher/.env.example content_publisher/.env
   # 編輯 content_publisher/.env 並添加您的 Google AI API 金鑰
   ```

3. **啟動開發伺服器：**

   ```bash
   make dev
   ```

4. **開啟 [http://localhost:8000](http://localhost:8000)** 並選擇 "content_publisher"

## 範例提示

嘗試這些提示以查看多代理編排的實際運作：

- `"撰寫關於人工智慧在醫療保健中的文章"`
- `"創建關於可再生能源採用的文章"`
- `"撰寫關於遠距工作的未來"`
- `"創建解釋量子運算突破的文章"`

## 運作原理

### 階段 1：並行研究

系統同時運行三條研究管道：

- **新聞管道**：取得當前文章 → 摘要重點
- **社群管道**：監控趨勢 → 分析情緒
- **專家管道**：尋找觀點 → 提取引述

### 階段 2：順序內容創建

所有研究完成後，透過順序優化創建內容：

- **作家**：將所有研究綜合成文章草稿
- **編輯**：改善清晰度、流暢度和影響力
- **格式化器**：添加發布格式和結構

### 效能優勢

- **無編排**：約 90 秒（9 個代理順序執行）
- **使用多代理編排**：約 35 秒（6 個研究代理並行 + 3 個創建代理順序）
- **加速**：透過複雜的並行處理快約 2.6 倍

## 實作細節

### 代理結構

```python
# 研究管道（順序代理）
news_pipeline = SequentialAgent(
  name="NewsPipeline",
  sub_agents=[news_fetcher, news_summarizer]
)

social_pipeline = SequentialAgent(
  name="SocialPipeline",
  sub_agents=[social_monitor, sentiment_analyzer]
)

expert_pipeline = SequentialAgent(
  name="ExpertPipeline",
  sub_agents=[expert_finder, quote_extractor]
)

# 並行研究階段
parallel_research = ParallelAgent(
  name="ParallelResearch",
  sub_agents=[news_pipeline, social_pipeline, expert_pipeline]
)

# 順序內容創建
content_publishing_system = SequentialAgent(
  name="ContentPublishingSystem",
  sub_agents=[
    parallel_research,  # 階段 1：研究
    article_writer,     # 階段 2：撰寫
    article_editor,     # 階段 3：編輯
    article_formatter   # 階段 4：格式化
  ]
)
```

### 狀態流

1. **並行研究**儲存到狀態：
   - `news_summary`（來自新聞管道）
   - `social_insights`（來自社群管道）
   - `expert_quotes`（來自專家管道）

2. **順序創建**從狀態讀取：
   - 作家：`{news_summary}`、`{social_insights}`、`{expert_quotes}`
   - 編輯：`{draft_article}`
   - 格式化器：`{edited_article}`

## 測試

執行完整測試套件：

```bash
make test
```

測試涵蓋：

- ✅ 個別代理配置（9 個代理）
- ✅ 順序管道結構（3 條管道）
- ✅ 並行研究編排
- ✅ 完整系統整合
- ✅ 狀態管理和資料流
- ✅ 匯入驗證和模組結構
- ✅ 專案檔案組織

## 開發

### 專案結構

```
tutorial06/
├── content_publisher/           # 代理實作
│   ├── __init__.py             # 套件初始化
│   ├── agent.py                # 多代理系統定義
│   └── .env.example            # 環境範本
├── tests/                      # 完整測試套件
│   ├── __init__.py
│   ├── test_agent.py           # 代理和管道測試（57 個測試）
│   ├── test_imports.py         # 匯入驗證測試
│   └── test_structure.py       # 專案結構測試
├── requirements.txt            # Python 依賴項
├── Makefile                   # 開發命令
└── README.md                  # 本文件
```

### 關鍵檔案

- **`content_publisher/agent.py`**：完整的多代理編排
- **`tests/test_agent.py`**：57 個完整測試
- **`Makefile`**：`make setup`、`make test`、`make dev`、`make demo` 命令

## 學習成果

完成本教學後，您將理解：

- ✅ **巢狀代理編排**：並行代理內的順序代理
- ✅ **多階段工作流程**：並行研究 + 順序創建
- ✅ **複雜狀態管理**：巢狀架構中的資料流
- ✅ **生產架構**：真實世界的內容生成模式
- ✅ **效能優化**：策略性並行化以提升速度

## 真實世界應用

此多代理模式非常適合：

- **內容平台**：研究 → 撰寫 → 編輯 → 發布
- **資料分析**：收集資料（並行）→ 處理 → 綜合 → 報告
- **電子商務**：產品研究 + 定價 + 評論（並行）→ 比較 → 推薦
- **客戶支援**：分類 → 研究解決方案 → 起草 → 審查 → 回應
- **財務分析**：市場資料 + 新聞 + 情緒（並行）→ 分析 → 報告
- **程式碼生成**：設計 + 實作 + 測試 + 文件 + 審查

## 疑難排解

### 常見問題

**「並行階段中的代理似乎是順序的」**

- 檢查事件標籤以了解實際開始時間
- 可能受到 API 速率限制

**「作家缺少研究資料」**

- 驗證管道代理是否設定了 `output_key`
- 檢查作家指令中的 `{key}` 語法

**「巢狀代理除錯複雜」**

- 首先單獨測試每條管道
- 使用事件標籤追蹤執行流程
- 添加描述性代理名稱

### 除錯模式

啟用詳細日誌：

```bash
ADK_LOG_LEVEL=DEBUG make dev
```

## 下一步

- **教學 07**：迴圈代理 - 反覆優化以提升品質
- **進階模式**：錯誤處理、條件路由、動態管道
- **生產部署**：擴展多代理系統以實現高吞吐量應用

## 貢獻

本實作遵循既定的教學模式：

1. **先有可運作的程式碼**：文件之前先完成實作
2. **完整測試**：57+ 個測試涵蓋所有功能
3. **使用者友善設定**：簡單的 `make setup && make dev` 工作流程
4. **清晰文件**：逐步指南和架構說明

## 連結

- **教學**：[教學 06：多代理系統](../../docs/tutorial/06_multi_agent_systems.md)
- **ADK 文件**：google.github.io/adk-docs/
- **上一個教學**：[教學 05 實作](../tutorial05/)