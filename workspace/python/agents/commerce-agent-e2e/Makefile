# Commerce Agent E2E - ç«¯åˆ°ç«¯å¯¦ä½œæ•™å­¸
# å…·å‚™ç”Ÿç”¢åŠ›ç­‰ç´šã€åŒ…å«æœƒè©±æŒä¹…æ€§çš„å¤šç”¨æˆ¶å•†å‹™åŠ©ç†

.PHONY: help setup dev dev-sqlite test test-guide demo demo-sqlite clean check-env setup-vertex-ai

# é è¨­ç›®æ¨™
help:
	@echo "ğŸ›ï¸  Commerce Agent E2E - ç«¯åˆ°ç«¯å¯¦ä½œ"
	@echo ""
	@echo "å¿«é€Ÿé–‹å§‹æŒ‡ä»¤ï¼š"
	@echo "  make setup              - å®‰è£ç›¸ä¾å¥—ä»¶ä¸¦è¨­å®šå¥—ä»¶"
	@echo "  make setup-vertex-ai    - è¨­å®š Vertex AI é©—è­‰"
	@echo "  make test               - åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶ (å–®å…ƒã€æ•´åˆã€e2e)"
	@echo "  make test-guide         - æŸ¥çœ‹ä½¿ç”¨ä½¿ç”¨è€…èº«åˆ†é€²è¡Œæ¸¬è©¦çš„æŒ‡å—"
	@echo "  make dev                - å•Ÿå‹•å¸¶æœ‰ ADK ç‹€æ…‹çš„é–‹ç™¼ UI (é è¨­)"
	@echo "  make dev-sqlite         - å•Ÿå‹•å¸¶æœ‰ SQLite æŒä¹…æ€§çš„é–‹ç™¼ UI"
	@echo "  make demo               - é¡¯ç¤ºå±•ç¤ºæƒ…å¢ƒ"
	@echo "  make demo-sqlite        - åŸ·è¡Œ SQLite æŒä¹…æ€§å±•ç¤ºè…³æœ¬"
	@echo ""
	@echo "é€²éšæŒ‡ä»¤ï¼š"
	@echo "  make clean              - æ¸…ç†ç”¢ç”Ÿçš„æª”æ¡ˆ"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹åŸ·è¡Œï¼šmake setup-vertex-ai && make setup && make dev"
	@echo ""
	@echo "æœƒè©±æŒä¹…æ€§é¸é …ï¼š"
	@echo "  â€¢ ADK ç‹€æ…‹ (é è¨­)ï¼š        ç°¡å–®ï¼Œé–‹ç®±å³ç”¨"
	@echo "  â€¢ SQLite (dev-sqlite)ï¼š   æŒä¹…æ€§ï¼Œé‡å•Ÿå¾Œä»å­˜åœ¨"

# å®‰è£ç›¸ä¾å¥—ä»¶
setup: check-env
	@echo "ğŸ“¦ å®‰è£ç›¸ä¾å¥—ä»¶ä¸­..."
	pip install -r requirements.txt
	pip install -e .
	@echo ""
	@echo "åˆå§‹åŒ–è³‡æ–™åº«..."
	python3 -c "from commerce_agent import init_database; init_database(); print('âœ… è³‡æ–™åº«å·²åˆå§‹åŒ–')"
	@echo ""
	@echo "âœ… è¨­å®šå®Œæˆï¼"
	@echo ""
	@echo "ä¸‹ä¸€æ­¥ï¼š"
	@echo "  1. åŸ·è¡Œæ¸¬è©¦ï¼šmake test"
	@echo "  2. å•Ÿå‹•ä»£ç†äººï¼šmake dev"
	@echo "  3. æ‰“é–‹ç€è¦½å™¨ï¼šhttp://localhost:8000"

# è¨­å®š Vertex AI é©—è­‰ (åœ¨ setup ä¹‹å‰åŸ·è¡Œ)
setup-vertex-ai:
	@bash scripts/setup-vertex-ai.sh

# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
test: check-env
	@echo "ğŸ§ª åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶..."
	@echo ""
	pytest tests/ -v \
		--tb=short \
		--cov=commerce_agent \
		--cov-report=html \
		--cov-report=term
	@echo ""
	@echo "âœ… æ¸¬è©¦å®Œæˆï¼è¦†è“‹ç‡å ±å‘Šï¼šhtmlcov/index.html"

# é¡¯ç¤ºä½¿ç”¨è€…èº«åˆ†æ¸¬è©¦æŒ‡å—
test-guide:
	@echo ""
	@echo "ğŸ“– ä½¿ç”¨ç‰¹å®šä½¿ç”¨è€…èº«åˆ†é€²è¡Œæ¸¬è©¦"
	@echo ""
	@echo "âš ï¸  é‡è¦ï¼š'adk web' UI æ²’æœ‰ User ID/Session ID çš„é¢æ¿"
	@echo "    ç€è¦½å™¨ä»‹é¢ä½¿ç”¨å›ºå®šçš„é è¨­ä½¿ç”¨è€… IDï¼š'user'"
	@echo ""
	@echo "è¦ä½¿ç”¨ç‰¹å®šä½¿ç”¨è€… (alice, bob ç­‰) é€²è¡Œæ¸¬è©¦ï¼Œè«‹ä½¿ç”¨ API ç«¯é»ï¼š"
	@echo ""
	@echo "1ï¸âƒ£  ç‚º Alice å»ºç«‹æœƒè©±ï¼š"
	@echo "  curl -X POST http://localhost:8000/apps/commerce_agent/users/alice/sessions/s1 \\"
	@echo "    -H 'Content-Type: application/json' -d '{\"state\": {}}'"
	@echo ""
	@echo "2ï¸âƒ£  ä»¥ Alice èº«åˆ†ç™¼é€è¨Šæ¯ï¼š"
	@echo "  curl -X POST http://localhost:8000/run -H 'Content-Type: application/json' -d '{"
	@echo "    \"app_name\": \"commerce_agent\","
	@echo "    \"user_id\": \"alice\","
	@echo "    \"session_id\": \"s1\","
	@echo "    \"new_message\": {"
	@echo "      \"role\": \"user\","
	@echo "      \"parts\": [{\"text\": \"I want running shoes under 150 euros\"}]"
	@echo "    }"
	@echo "  }'"
	@echo ""
	@echo "3ï¸âƒ£  ç‚º Bob å»ºç«‹æœƒè©±ï¼š"
	@echo "  curl -X POST http://localhost:8000/apps/commerce_agent/users/bob/sessions/s2 \\"
	@echo "    -H 'Content-Type: application/json' -d '{\"state\": {}}'"
	@echo ""
	@echo "4ï¸âƒ£  ä»¥ Bob èº«åˆ†ç™¼é€è¨Šæ¯ï¼š"
	@echo "  curl -X POST http://localhost:8000/run -H 'Content-Type: application/json' -d '{"
	@echo "    \"app_name\": \"commerce_agent\","
	@echo "    \"user_id\": \"bob\","
	@echo "    \"session_id\": \"s2\","
	@echo "    \"new_message\": {"
	@echo "      \"role\": \"user\","
	@echo "      \"parts\": [{\"text\": \"I am into cycling. Budget 200 euros\"}]"
	@echo "    }"
	@echo "  }'"
	@echo ""
	@echo "5ï¸âƒ£  é©—è­‰éš”é›¢ - æª¢æŸ¥ Alice çš„åå¥½ï¼š"
	@echo "  curl -X POST http://localhost:8000/run -H 'Content-Type: application/json' -d '{"
	@echo "    \"app_name\": \"commerce_agent\","
	@echo "    \"user_id\": \"alice\","
	@echo "    \"session_id\": \"s1\","
	@echo "    \"new_message\": {"
	@echo "      \"role\": \"user\","
	@echo "      \"parts\": [{\"text\": \"What are my preferences?\"}]"
	@echo "    }"
	@echo "  }'"
	@echo ""
	@echo "é æœŸï¼šä»£ç†äººé¡¯ç¤ºè·‘æ­¥ (è€Œä¸æ˜¯é¨è¡Œ) âœ…"
	@echo ""
	@echo "ğŸ“„ å®Œæ•´æ–‡ä»¶ï¼š"
	@echo "   docs/TESTING_WITH_USER_IDENTITIES.md"
	@echo ""
	@echo "æˆ–æ‰“é–‹æŒ‡å—ï¼š"
	@if command -v less >/dev/null 2>&1; then \
		less docs/TESTING_WITH_USER_IDENTITIES.md; \
	elif command -v more >/dev/null 2>&1; then \
		more docs/TESTING_WITH_USER_IDENTITIES.md; \
	else \
		cat docs/TESTING_WITH_USER_IDENTITIES.md; \
	fi

# å•Ÿå‹•é–‹ç™¼ UI (é è¨­ - ä½¿ç”¨ ADK ç‹€æ…‹)
dev: check-env
	@echo "ğŸ¤– æ­£åœ¨å•Ÿå‹•å•†å‹™ä»£ç†äºº..."
	@echo ""
	@if [ ! -z "$$GOOGLE_API_KEY" ]; then \
		echo "âš ï¸  å–æ¶ˆè¨­å®š GOOGLE_API_KEY ä»¥ä½¿ç”¨ Vertex AI..."; \
		unset GOOGLE_API_KEY; \
	fi
	@if [ ! -z "$$GEMINI_API_KEY" ]; then \
		echo "âš ï¸  å–æ¶ˆè¨­å®š GEMINI_API_KEY ä»¥ä½¿ç”¨ Vertex AI..."; \
		unset GEMINI_API_KEY; \
	fi
	@echo ""
	@echo "ğŸ“± åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ http://localhost:8000"
	@echo "ğŸ¯ å¾ä»£ç†äººä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ 'commerce_agent'"
	@echo ""
	@echo "ğŸ’¾ æœƒè©±æŒä¹…æ€§ï¼šADK ç‹€æ…‹ (user: å‰ç¶´)"
	@echo "   - åå¥½åœ¨ä¸åŒèª¿ç”¨é–“æŒçºŒå­˜åœ¨"
	@echo "   - æ‡‰ç”¨ç¨‹å¼é‡å•Ÿæ™‚æœƒè©±éºå¤±"
	@echo ""
	@echo "ğŸ’¡ æƒ³è¦è·¨é‡å•Ÿçš„æŒä¹…æ€§ï¼Ÿè«‹ä½¿ç”¨ï¼šmake dev-sqlite"
	@echo ""
	@echo "æ¸¬è©¦æƒ…å¢ƒï¼š"
	@echo "  â€¢ ä½¿ç”¨è€… 'alice', é‹å‹•ï¼š'running' â†’ å°‹æ‰¾æ…¢è·‘é‹"
	@echo "  â€¢ ä½¿ç”¨è€… 'bob', é‹å‹•ï¼š'cycling' â†’ æ¨è–¦é¨è¡Œè£å‚™"
	@echo "  â€¢ æ˜‚è²´ç‰©å“æ¸¬è©¦ â†’ å˜—è©¦è¶…é â‚¬100 çš„ç”¢å“"
	@echo ""
	unset GOOGLE_API_KEY GEMINI_API_KEY; adk web

# å•Ÿå‹•å¸¶æœ‰ SQLite æœƒè©±æŒä¹…æ€§çš„é–‹ç™¼ UI
dev-sqlite: check-env
	@echo "ğŸ¤– æ­£åœ¨å•Ÿå‹•å¸¶æœ‰ SQLite æœƒè©±æŒä¹…æ€§çš„å•†å‹™ä»£ç†äºº"
	@echo ""
	@if [ ! -z "$$GOOGLE_API_KEY" ]; then \
		echo "âš ï¸  å–æ¶ˆè¨­å®š GOOGLE_API_KEY ä»¥ä½¿ç”¨ Vertex AI..."; \
		unset GOOGLE_API_KEY; \
	fi
	@if [ ! -z "$$GEMINI_API_KEY" ]; then \
		echo "âš ï¸  å–æ¶ˆè¨­å®š GEMINI_API_KEY ä»¥ä½¿ç”¨ Vertex AI..."; \
		unset GEMINI_API_KEY; \
	fi
	@echo ""
	@echo "ğŸ“± åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ http://localhost:8000"
	@echo "ğŸ¯ å¾ä»£ç†äººä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ 'commerce_agent'"
	@echo ""
	@echo "ğŸ’¾ æœƒè©±æŒä¹…æ€§ï¼šSQLite è³‡æ–™åº«"
	@echo "   - ä¿ç•™å®Œæ•´çš„å°è©±æ­·å²è¨˜éŒ„"
	@echo "   - æœƒè©±åœ¨æ‡‰ç”¨ç¨‹å¼é‡å•Ÿå¾Œä»ç„¶å­˜åœ¨ âœ…"
	@echo "   - è³‡æ–™åº«ï¼š./commerce_sessions.db"
	@echo ""
	@echo "ğŸ” æª¢æŸ¥è³‡æ–™åº«ï¼š"
	@echo "   sqlite3 commerce_sessions.db"
	@echo "   > .tables"
	@echo "   > SELECT * FROM sessions;"
	@echo ""
	@echo "æ¸¬è©¦æƒ…å¢ƒï¼š"
	@echo "  1. èˆ‡ä»£ç†äººèŠå¤©"
	@echo "  2. åœæ­¢ä¼ºæœå™¨ (Ctrl+C)"
	@echo "  3. é‡å•Ÿï¼šmake dev-sqlite"
	@echo "  4. æ‚¨çš„æœƒè©±è³‡æ–™ä»ç„¶å­˜åœ¨ï¼ âœ…"
	@echo ""
	unset GOOGLE_API_KEY GEMINI_API_KEY; adk web --session_service_uri "sqlite:///./commerce_sessions.db?mode=wal"

# é¡¯ç¤ºå±•ç¤ºæƒ…å¢ƒ
demo:
	@echo ""
	@echo "ğŸ“‹ å•†å‹™ä»£ç†äºº E2E å±•ç¤ºæƒ…å¢ƒ"
	@echo ""
	@echo "åœ¨ä½¿ç”¨ make dev (æˆ– make dev-sqlite) å•Ÿå‹•å¾ŒåŸ·è¡Œé€™äº›"
	@echo ""
	@echo "------- æƒ…å¢ƒ 1ï¼šæ–°ç”¨æˆ¶è¨­å®š -------"
	@echo "User ID: athlete_1"
	@echo "Session ID: session_1"
	@echo ""
	@echo "1. è¼¸å…¥ï¼š'My favorite sport is running' (æˆ‘æœ€å–œæ­¡çš„é‹å‹•æ˜¯è·‘æ­¥)"
	@echo "   â†’ ä»£ç†äººå­¸ç¿’æ‚¨çš„åå¥½"
	@echo ""
	@echo "2. è¼¸å…¥ï¼š'Find running shoes under â‚¬100' (å°‹æ‰¾ 100 æ­å…ƒä»¥ä¸‹çš„æ…¢è·‘é‹)"
	@echo "   â†’ ä»£ç†äººæœå°‹ Decathlon"
	@echo ""
	@echo "3. è¼¸å…¥ï¼š'Add the Kalenji shoes to my favorites' (å°‡ Kalenji é‹åŠ å…¥æˆ‘çš„æœ€æ„›)"
	@echo "   â†’ ä»£ç†äººå„²å­˜è‡³æ‚¨çš„å€‹äººè³‡æ–™"
	@echo ""
	@echo "------- æƒ…å¢ƒ 2ï¼šå›è¨ªå®¢æˆ¶ -------"
	@echo "User ID: athlete_1 (åŒä¸€ä½ä½¿ç”¨è€…)"
	@echo "Session ID: session_2 (æ–°æœƒè©±ï¼ŒåŒä¸€ä½ä½¿ç”¨è€…)"
	@echo ""
	@echo "1. è¼¸å…¥ï¼š'What do you know about me?' (ä½ å°æˆ‘æœ‰ä»€éº¼äº†è§£ï¼Ÿ)"
	@echo "   â†’ ä»£ç†äººå¬å›åå¥½ (è·‘æ­¥)"
	@echo ""
	@echo "2. è¼¸å…¥ï¼š'Recommend something based on my history' (æ ¹æ“šæˆ‘çš„æ­·å²è¨˜éŒ„æ¨è–¦ä¸€äº›æ±è¥¿)"
	@echo "   â†’ ä»£ç†äººå»ºè­°èˆ‡è·‘æ­¥ç›¸é—œçš„ç”¢å“"
	@echo ""
	@echo "------- æƒ…å¢ƒ 3ï¼šå¤šç”¨æˆ¶éš”é›¢ -------"
	@echo "User ID: cyclist_1"
	@echo "Session ID: session_1"
	@echo ""
	@echo "1. è¼¸å…¥ï¼š'I'm into cycling' (æˆ‘å–œæ­¡é¨è¡Œ)"
	@echo "2. è¼¸å…¥ï¼š'Find cycling gear' (å°‹æ‰¾é¨è¡Œè£å‚™)"
	@echo ""
	@echo "ç„¶å¾Œåˆ‡æ›ï¼š"
	@echo "User ID: athlete_1 (å›åˆ°è·‘è€…)"
	@echo ""
	@echo "3. è¼¸å…¥ï¼š'What are my preferences?' (æˆ‘çš„åå¥½æ˜¯ä»€éº¼ï¼Ÿ)"
	@echo "   â†’ ä»£ç†äººé¡¯ç¤º RUNNING (è·‘æ­¥) (é¨è¡Œè¢«éš±è—)"
	@echo ""
	@echo "------- æƒ…å¢ƒ 4ï¼šæ˜‚è²´ç‰©å“ç¢ºèª -------"
	@echo "è¼¸å…¥ï¼š'Find high-end running shoes over â‚¬200' (å°‹æ‰¾è¶…é 200 æ­å…ƒçš„é«˜ç´šæ…¢è·‘é‹)"
	@echo "   â†’ ä»£ç†äººæ‡‰è¦æ±‚ç¢ºèª"
	@echo ""
	@echo "âœ… æ‰€æœ‰æƒ…å¢ƒçš†å±•ç¤ºäº†é—œéµåŠŸèƒ½ï¼"
	@echo ""

# åŸ·è¡Œ SQLite æŒä¹…æ€§å±•ç¤º (ç¨‹å¼åŒ–)
demo-sqlite: check-env
	@echo "ğŸš€ åŸ·è¡Œ SQLite æœƒè©±æŒä¹…æ€§å±•ç¤º"
	@echo ""
	@echo "æ­¤è…³æœ¬å±•ç¤ºï¼š"
	@echo "  âœ… ä½¿ç”¨ SQLite çš„ DatabaseSessionService"
	@echo "  âœ… æœƒè©±å»ºç«‹èˆ‡æª¢ç´¢"
	@echo "  âœ… è·¨ 'é‡å•Ÿ' çš„ç‹€æ…‹æŒä¹…æ€§"
	@echo "  âœ… å¤šç”¨æˆ¶éš”é›¢"
	@echo "  âœ… å°è©±æ­·å²è¨˜éŒ„ä¿å­˜"
	@echo ""
	@echo "æŒ‰ Ctrl+C éš¨æ™‚åœæ­¢"
	@echo ""
	python runner_with_sqlite.py

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸­..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name ".pytest_cache" -delete
	find . -type d -name ".coverage" -delete
	find . -type d -name "htmlcov" -delete
	find . -type d -name "*.egg-info" -delete
	rm -f .coverage
	rm -f commerce_agent_sessions.db
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# æª¢æŸ¥ç’°å¢ƒ (å…§éƒ¨ä½¿ç”¨)
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šé©—è­‰æœªè¨­å®š"; \
		echo ""; \
		echo "æ­¤ä»£ç†äººéœ€è¦ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®é©—è­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "âœ… æ¨è–¦ - Vertex AI (Service Account):"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   è¨­å®šæŒ‡å—ï¼šlog/20250124_173000_vertex_ai_setup_guide.md"; \
		echo ""; \
		echo "âš ï¸  ä¸æ¨è–¦ - Gemini API (æœå°‹å—é™):"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   åœ¨æ­¤ç²å–é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"; \
		echo ""; \
		exit 1; \
	fi
