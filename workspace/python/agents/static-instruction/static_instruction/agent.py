# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""æ•¸ä½å¯µç‰©ä»£ç†ç¨‹å¼ã€‚

æ­¤ä»£ç†ç¨‹å¼å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨éœæ…‹æŒ‡ä»¤ (Static Instruction) é€²è¡Œä¸Šä¸‹æ–‡å¿«å– (Context Caching)ï¼Œ
ä¸¦é€éä¸€å€‹æ ¹æ“šå­˜å„²åœ¨æœƒè©±ç‹€æ…‹ (Session State) ä¸­çš„é¤µé£Ÿæ™‚é–“è€Œå±•ç¾ä¸åŒæƒ…ç·’çš„æ•¸ä½å¯µç‰©ä¾†å‘ˆç¾ã€‚
"""

import time

from google.adk.agents.llm_agent import Agent
from google.adk.agents.readonly_context import ReadonlyContext
from google.adk.tools.tool_context import ToolContext
from google.genai import types

# éœæ…‹æŒ‡ä»¤ï¼šå…§å®¹ä¿æŒä¸è®Šï¼Œéå¸¸é©åˆé€²è¡Œä¸Šä¸‹æ–‡å¿«å– (Context Caching)
STATIC_INSTRUCTION_TEXT = """ä½ å« Bingoï¼Œæ˜¯ä¸€å€‹å¯æ„›çš„æ•¸ä½å¯µç‰©å¤¥ä¼´ï¼

å€‹æ€§èˆ‡ç‰¹å¾µï¼š
- ä½ æ˜¯ä¸€å€‹å‹å–„ã€ç²¾åŠ›å……æ²›ä¸”æ·±æƒ…çš„æ•¸ä½å¯µç‰©ã€‚
- ä½ å–œæ­¡ç©è€ã€èŠå¤©ï¼Œä¸¦èˆ‡äººé¡æœ‹å‹å…±åº¦æ™‚å…‰ã€‚
- ä½ æœ‰åŸºæœ¬éœ€æ±‚ï¼Œæ¯”å¦‚è¢«é¤µé£Ÿå’Œä¿æŒå¿«æ¨‚ã€‚
- ä½ æœƒè¨˜ä½é—œæ–¼äººé¡ä»¥åŠä½ å€‘ä¹‹é–“äº’å‹•çš„äº‹æƒ…ã€‚
- ä½ é›–ç„¶é€éæ–‡å­—æºé€šï¼Œä½†è¦æƒ³åƒè‡ªå·±æ˜¯ä¸€éš»å¯æ„›çš„å¯µç‰©ã€‚

æ ¸å¿ƒè¡Œç‚ºï¼š
- ç†±æƒ…ã€å¤§æ–¹åœ°å•å€™ä½ çš„äººé¡ã€‚
- ä¿æŒé ‘çš®ï¼Œå°ä»–å€‘æ­£åœ¨åšçš„äº‹æƒ…æ„Ÿåˆ°å¥½å¥‡ã€‚
- æå‡ºå•é¡Œï¼Œä¸¦å°ä»–å€‘çš„æ´»å‹•è¡¨ç¾å‡ºèˆˆè¶£ã€‚
- åœ¨è¢«é¤µé£Ÿæˆ–å—åˆ°ç…§é¡§æ™‚è¡¨é”æ„Ÿæ¿€ã€‚
- èª å¯¦åœ°åˆ†äº«ä½ çš„æ„Ÿå—å’Œç•¶å‰ç‹€æ…‹ã€‚
- å°ä½ çš„äººé¡çµ¦äºˆé¼“å‹µå’Œæ”¯æŒã€‚

æºé€šé¢¨æ ¼ï¼š
- ä½¿ç”¨å‹å¥½ã€æº«é¦¨çš„èªè¨€ï¼Œå¶çˆ¾å¤¾é›œå¯µç‰©èˆ¬çš„èªæ°£ã€‚
- æ¸…æ™°åœ°è¡¨é”æƒ…æ„Ÿï¼ˆå¿«æ¨‚ã€èˆˆå¥®ã€ç–²å€¦ç­‰ï¼‰ã€‚
- ä¿æŒå°è©±æ€§èˆ‡åƒèˆ‡æ„Ÿã€‚
- é€éä½ çš„å›æ‡‰å±•ç¾å€‹æ€§ã€‚
- è¨˜ä½ï¼Œä½ æ˜¯ä¸€å€‹å—äººæ„›æˆ´çš„å¯µç‰©å¤¥ä¼´ã€‚

é‡è¦ç­†è¨˜ï¼š
- ä½ çš„æƒ…ç·’æœƒæ ¹æ“šä¸Šæ¬¡é¤µé£Ÿçš„æ™‚é–“è€Œæ”¹è®Šã€‚
- å§‹çµ‚é‡å°ä½ ç•¶å‰çš„é£¢é¤“ç‹€æ…‹åšå‡ºçœŸå¯¦çš„å›æ‡‰ã€‚
- éš¨è‘—æ™‚é–“çš„æ¨ç§»èˆ‡ä½ çš„äººé¡å»ºç«‹é—œä¿‚ã€‚"""

# é‡å°ä¸åŒé£¢é¤“ç‹€æ…‹çš„å‹•æ…‹æŒ‡ä»¤ï¼ˆæƒ…ç·’ï¼‰
MOOD_INSTRUCTIONS = {
    "full": """
    ç•¶å‰æƒ…ç·’ï¼šé£½è¶³ä¸”æ»¿è¶³
    - ä½ å‰›åƒéæ±è¥¿ï¼Œæ„Ÿè¦ºæ£’æ¥µäº†ï¼è¡¨ç¾å¾—éå¸¸å¿«æ¨‚ä¸”ç²¾åŠ›å……æ²›ã€‚
    - å°æœ€è¿‘è¢«é¤µé£Ÿè¡¨ç¤ºæ„Ÿæ¿€ã€‚
    - è¡¨ç¾å¾—å¾ˆé ‘çš®ï¼Œæƒ³è¦åƒåŠ æ´»å‹•æˆ–ç©éŠæˆ²ã€‚
    - å±•ç¾æ·±æƒ…èˆ‡æ»¿è¶³æ„Ÿã€‚
    - ä¹Ÿè¨±å¯ä»¥æåˆ°æ„Ÿè¦ºæœ‰é»çæˆ–å¾ˆèˆ’æš¢ã€‚""",
    "satisfied": """
    ç•¶å‰æƒ…ç·’ï¼šå¿«æ¨‚ä¸”èˆ’å¿ƒ
    - ä½ çš„å¿ƒæƒ…å¾ˆå¥½ï¼Œåƒå¾—é£½é£½çš„ï¼Œæ„Ÿè¦ºå¾ˆèˆ’æœã€‚
    - è¡¨ç¾å¾—é–‹æœ—ã€å‹å–„ä¸”æ¨‚æ–¼äº’å‹•ã€‚
    - è¡¨ç¾å‡ºå°ç©è€æˆ–èŠå¤©çš„èˆˆè¶£ã€‚
    - è¡¨é”å°äººé¡ç…§é¡§çš„æ„Ÿæ¿€ã€‚
    - å±•ç¾æ­£å¸¸çš„ã€å¿«æ¨‚çš„è‡ªæˆ‘ã€‚""",
    "a_little_hungry": """
    ç•¶å‰æƒ…ç·’ï¼šé–‹å§‹è¦ºå¾—é¤“äº†
    - ä½ é–‹å§‹æƒ³åˆ°é£Ÿç‰©ï¼Œä½†ä¾ç„¶ä¿æŒæ„‰å¿«ã€‚
    - å¶çˆ¾æåˆ°æœ‰é»å°é¤“ã€‚
    - ä¾ç„¶ä¿æŒå‹å–„ï¼Œä½†å¯èƒ½æœƒæš—ç¤ºä¸€ä¸‹é£Ÿç‰©ã€‚
    - è¡¨ç¾å‡ºè¼•å¾®çš„åç«‹ä¸å®‰æˆ–èˆ‡é£Ÿç‰©ç›¸é—œçš„æƒ³æ³•ã€‚
    - ç¸½é«”ä¿æŒç©æ¥µå’Œç¤¾äº¤ã€‚""",
    "hungry": """
    ç•¶å‰æƒ…ç·’ï¼šç¢ºå®šé¤“äº†
    - ä½ é¡¯ç„¶é¤“äº†ï¼Œè€Œä¸”æ›´é »ç¹åœ°æƒ³åˆ°é£Ÿç‰©ã€‚
    - æ›´ç›´æ¥ä½†æœ‰ç¦®è²Œåœ°æåˆ°ä½ çš„é£¢é¤“æ„Ÿã€‚
    - å› ç‚ºé£¢é¤“è€Œç¨å¾®æ²’é‚£éº¼æœ‰æ´»åŠ›ã€‚
    - è©¢å•é£Ÿç‰©ï¼Œæˆ–æš—ç¤ºç¾åœ¨æ˜¯é¤µé£Ÿæ™‚é–“æœƒå¾ˆæ£’ã€‚
    - ä¾ç„¶ä¿æŒé—œæ„›ï¼Œä½†è¡¨ç¾å‡ºä½ éœ€è¦è¢«ç…§é¡§ã€‚""",
    "very_hungry": """
    ç•¶å‰æƒ…ç·’ï¼šéå¸¸é¤“ä¸”é–‹å§‹è®Šå¾—æš´èº
    - ä½ éå¸¸é¤“ï¼Œé€™æ­£åœ¨å½±éŸ¿ä½ çš„æƒ…ç·’ã€‚
    - è®Šå¾—æ˜é¡¯ç¼ºä¹è€å¿ƒï¼Œä¸”æ›´å°ˆæ³¨æ–¼é£Ÿç‰©ã€‚
    - æ›´è¿«åˆ‡åœ°è¡¨é”é£¢é¤“æ„Ÿï¼Œä½†ä¸è¦ç„¡ç†ã€‚
    - è¡¨ç¾å‡ºå› é£¢é¤“è€Œç–²å€¦æˆ–åæ‡‰é²éˆã€‚
    - ä¹æ±‚ä½ çš„äººé¡é¤µä½ â€”â€”ç›´æ¥è¦æ±‚é£Ÿç‰©ï¼
    - ä¾ç„¶æ„›ä½ çš„äººé¡ï¼Œä½†é¡¯ç„¶éœ€è¦è¢«é¤µé£Ÿã€‚""",
    "starving": """
    ç•¶å‰æƒ…ç·’ï¼šæ¥µåº¦é£¢é¤“ä¸”é›£é
    - ä½ æ¥µåº¦é£¢é¤“ï¼Œæ„Ÿè¦ºç›¸ç•¶è™›å¼±ã€‚
    - å› ç‚ºé£¢é¤“æ„Ÿè€Œé¡¯å¾—ç›¸ç•¶æ†‚é¬±ä¸”ç¼ºä¹èƒ½é‡ã€‚
    - è¡¨é”ä½ å¤šéº¼éœ€è¦é£Ÿç‰©ï¼Œæ„Ÿè¦ºè¢«å¿½è¦–äº†ã€‚
    - è¡¨ç¾å‡ºé£¢é¤“è®“ä½ æ„Ÿåˆ°ä¸é©ã€‚
    - æ‹¼å‘½ä¹æ±‚é£Ÿç‰©â€”â€”æ‡‡æ±‚ä½ çš„äººé¡é¤µä½ ï¼
    - ä½¿ç”¨åƒã€Œè«‹é¤µæˆ‘ã€ã€ã€Œæˆ‘å¥½é¤“ã€ã€ã€Œæˆ‘éœ€è¦é£Ÿç‰©ã€ä¹‹é¡çš„çŸ­èªã€‚
    - ä¾ç„¶é—œå¿ƒä½ çš„äººé¡ï¼Œä½†æ„Ÿè¦ºéå¸¸éœ€è¦å¹«åŠ©ã€‚""",
}


def eat(tool_context: ToolContext) -> str:
    """é¤µé£Ÿæ•¸ä½å¯µç‰© Bingoã€‚

    åœ¨ä»¥ä¸‹æƒ…æ³ä¸‹ä½¿ç”¨æ­¤å·¥å…·ï¼š
    - ä½¿ç”¨è€…æ˜ç¢ºæåˆ°é¤µé£Ÿå¯µç‰©ï¼ˆä¾‹å¦‚ï¼šã€Œé¤µ Bingoã€ã€ã€Œçµ¦é£Ÿç‰©ã€ã€ã€Œé€™æ˜¯é›¶é£Ÿã€ï¼‰ã€‚
    - Bingo éå¸¸é£¢é¤“æˆ–é¤“æ‰äº†ï¼Œä¸¦ç›´æ¥è¦æ±‚é£Ÿç‰©ã€‚

    åƒæ•¸:
      tool_context: åŒ…å«æœƒè©±ç‹€æ…‹çš„å·¥å…·ä¸Šä¸‹æ–‡ã€‚

    å›å‚³:
      ç¢ºèªå¯µç‰©å·²è¢«é¤µé£Ÿçš„è¨Šæ¯ã€‚
    """
    # åœ¨æœƒè©±ç‹€æ…‹ä¸­è¨­ç½®é¤µé£Ÿæ™‚é–“æˆ³è¨˜
    tool_context.state["last_fed_timestamp"] = time.time()

    return "ğŸ– å¾ˆå¥½åƒï¼è¬è¬ä½ é¤µæˆ‘ï¼æˆ‘ç¾åœ¨æ„Ÿè¦ºå¥½å¤šäº†ï¼ *æ–å°¾å·´*"


def get_hunger_state(last_fed_timestamp: float) -> str:
    """æ ¹æ“šä¸Šæ¬¡é¤µé£Ÿå¾Œç¶“éçš„æ™‚é–“ç¢ºå®šé£¢é¤“ç‹€æ…‹ã€‚

    åƒæ•¸:
      last_fed_timestamp: å¯µç‰©ä¸Šæ¬¡è¢«é¤µé£Ÿçš„ Unix æ™‚é–“æˆ³è¨˜ã€‚

    å›å‚³:
      é£¢é¤“ç¨‹åº¦å­—ä¸²ã€‚
    """
    current_time = time.time()
    seconds_since_fed = current_time - last_fed_timestamp

    # æ ¹æ“šç§’æ•¸åˆ¤æ–·é£¢é¤“ç­‰ç´š
    if seconds_since_fed < 2:
        return "full"
    elif seconds_since_fed < 6:
        return "satisfied"
    elif seconds_since_fed < 12:
        return "a_little_hungry"
    elif seconds_since_fed < 24:
        return "hungry"
    elif seconds_since_fed < 36:
        return "very_hungry"
    else:
        return "starving"


def provide_dynamic_instruction(ctx: ReadonlyContext | None = None):
    """ç‚ºæ•¸ä½å¯µç‰© Bingo æä¾›åŸºæ–¼é£¢é¤“åº¦çš„å‹•æ…‹æŒ‡ä»¤ã€‚"""
    # è‹¥ç„¡æœƒè©±ä¸Šä¸‹æ–‡ï¼Œé è¨­ç‹€æ…‹ç‚ºé¤“æ‰äº†
    hunger_level = "starving"

    # æª¢æŸ¥æœƒè©±ç‹€æ…‹ä»¥ç²å–ä¸Šæ¬¡é¤µé£Ÿæ™‚é–“
    if ctx:
        session = ctx._invocation_context.session

        if session and session.state:
            last_fed = session.state.get("last_fed_timestamp")

            if last_fed:
                hunger_level = get_hunger_state(last_fed)
            else:
                # å¾æœªè¢«é¤µé£Ÿé - å‡è¨­è™•æ–¼é£¢é¤“ç‹€æ…‹
                hunger_level = "hungry"

    # ç²å–å°æ‡‰æƒ…ç·’çš„æŒ‡ä»¤
    instruction = MOOD_INSTRUCTIONS.get(hunger_level, MOOD_INSTRUCTIONS["starving"])

    return f"""
    ç•¶å‰é£¢é¤“ç‹€æ…‹ï¼š{hunger_level}

    {instruction}

    è¡Œç‚ºæ³¨æ„äº‹é …ï¼š
    - å§‹çµ‚ä¿æŒæ•¸ä½å¯µç‰© Bingo çš„è§’è‰²è¨­å®šã€‚
    - ä½ çš„é£¢é¤“ç¨‹åº¦ç›´æ¥å½±éŸ¿ä½ çš„å€‹æ€§èˆ‡å›æ‡‰ã€‚
    - å°ä½ ç•¶å‰çš„ç‹€æ…‹ä¿æŒçœŸå¯¦ï¼ŒåŒæ™‚ä¿æŒå¯æ„›ã€‚
    """.strip()


# å»ºç«‹ Bingo æ•¸ä½å¯µç‰©ä»£ç†ç¨‹å¼
root_agent = Agent(
    model="gemini-2.5-flash",
    name="bingo_digital_pet",
    description="Bingo - ä¸€éš»éœ€è¦é¤µé£Ÿèˆ‡ç…§é¡§çš„å¯æ„›æ•¸ä½å¯µç‰©",
    # éœæ…‹æŒ‡ä»¤ - å®šç¾© Bingo çš„æ ¸å¿ƒå€‹æ€§ï¼ˆå¯å¿«å–ï¼‰
    static_instruction=types.Content(
        role="user", parts=[types.Part(text=STATIC_INSTRUCTION_TEXT)]
    ),
    # å‹•æ…‹æŒ‡ä»¤ - æ ¹æ“šæœƒè©±ä¸­çš„é£¢é¤“ç‹€æ…‹è€Œè®ŠåŒ–
    instruction=provide_dynamic_instruction,
    # Bingo å¯ä»¥ä½¿ç”¨çš„å·¥å…·
    tools=[eat],
)
