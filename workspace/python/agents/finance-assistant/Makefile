# æ•™å­¸ 02ï¼šå‡½å¼å·¥å…· - è²¡å‹™åŠ©ç†ä»£ç†
# ç”¨æ–¼å¿«é€Ÿå…¥é–€çš„ç°¡æ˜“ Makefile

# .PHONY ç”¨æ–¼å®£å‘Šå½ç›®æ¨™ï¼Œé¿å…èˆ‡åŒåæª”æ¡ˆè¡çª
.PHONY: help setup dev parallel-demo test clean demo

# é è¨­ç›®æ¨™ - é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
# ç•¶ç›´æ¥åŸ·è¡Œ `make` æ™‚ï¼ŒæœƒåŸ·è¡Œæ­¤ç›®æ¨™
help:
	@echo "ğŸš€ æ•™å­¸ 02ï¼šå‡½å¼å·¥å…· - è²¡å‹™åŠ©ç†ä»£ç†"
	@echo ""
	@echo "å¿«é€Ÿå…¥é–€æŒ‡ä»¤:"
	@echo "  make setup     - å®‰è£å°ˆæ¡ˆæ‰€éœ€çš„ä¾è³´å¥—ä»¶"
	@echo "  make dev       - å•Ÿå‹•è²¡å‹™åŠ©ç†ä»£ç†"
	@echo "  make demo      - åŸ·è¡Œä¸€å€‹å¿«é€Ÿçš„è¨ˆç®—å±•ç¤º"
	@echo ""
	@echo "é€²éšæŒ‡ä»¤:"
	@echo "  make parallel-demo  - å•Ÿå‹•å¹³è¡ŒåŸ·è¡Œå±•ç¤º"
	@echo "  make test           - åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make clean          - æ¸…ç†ç”Ÿæˆçš„æš«å­˜æª”æ¡ˆ"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿ è«‹åŸ·è¡Œ: make setup && make dev"

# å®‰è£ä¾è³´å¥—ä»¶
# è®€å– requirements.txt æª”æ¡ˆä¸¦å®‰è£å…¶ä¸­å®šç¾©çš„ Python å¥—ä»¶
setup:
	@echo "ğŸ“¦ æ­£åœ¨å®‰è£ä¾è³´å¥—ä»¶..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… å®‰è£å®Œæˆï¼ è«‹åŸ·è¡Œ 'make dev' ä¾†å•Ÿå‹•ä»£ç†ã€‚"

# å•Ÿå‹•ä¸»è¦çš„è²¡å‹™åŠ©ç†
# `check-env` æ˜¯ä¸€å€‹ä¾è³´ï¼Œæœƒå…ˆæª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®š
dev: check-env
	@echo "ğŸ¤– æ­£åœ¨å•Ÿå‹•è²¡å‹™åŠ©ç†..."
	@echo "å¯ç”¨çš„ä»£ç†: finance_assistant, parallel_finance_assistant"
	@echo "è«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ http://localhost:8000"
	adk web

# å•Ÿå‹•å¹³è¡ŒåŸ·è¡Œå±•ç¤º
# é€™å€‹å±•ç¤ºæœƒç¤ºç¯„ ADK å¦‚ä½•åŒæ™‚åŸ·è¡Œå¤šå€‹å·¥å…·
parallel-demo: check-env
	@echo "âš¡ æ­£åœ¨å•Ÿå‹•å¹³è¡ŒåŸ·è¡Œå±•ç¤º..."
	@echo "æ­¤å±•ç¤ºå°‡ç¤ºç¯„ ADK å¦‚ä½•åŒæ™‚åŸ·è¡Œå¤šå€‹å·¥å…·"
	@echo "è«‹åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ http://localhost:8000"
	adk web

# åŸ·è¡Œä¸€å€‹å¿«é€Ÿçš„è²¡å‹™è¨ˆç®—å±•ç¤º
# é€™å€‹ç›®æ¨™æœƒç›´æ¥å‘¼å« Python è…³æœ¬ä¾†åŸ·è¡Œä¸‰å€‹è²¡å‹™è¨ˆç®—ç¯„ä¾‹
demo: check-env
	@echo "ğŸ§® æ­£åœ¨åŸ·è¡Œè²¡å‹™è¨ˆç®—å±•ç¤º..."
	@echo ""
	@echo "ğŸ’° è¤‡åˆ©è¨ˆç®—ï¼šæœ¬é‡‘ $$10,000ï¼Œå¹´åˆ©ç‡ 6%ï¼Œç‚ºæœŸ 5 å¹´"
	@python -c "from finance_assistant.agent import calculate_compound_interest; result = calculate_compound_interest(10000, 0.06, 5); print(result['report'])"
	@echo ""
	@echo "ğŸ  è²¸æ¬¾æœˆä»˜é‡‘è¨ˆç®—ï¼šè²¸æ¬¾ $$300,000ï¼Œå¹´åˆ©ç‡ 4.5%ï¼Œç‚ºæœŸ 30 å¹´"
	@python -c "from finance_assistant.agent import calculate_loan_payment; result = calculate_loan_payment(300000, 0.045, 30); print(result['report'])"
	@echo ""
	@echo "ğŸ¯ æ¯æœˆå„²è“„ç›®æ¨™è¨ˆç®—ï¼šç›®æ¨™ $$50,000ï¼Œ3 å¹´å…§é”æˆï¼Œå¹´åˆ©ç‡ 5%"
	@python -c "from finance_assistant.agent import calculate_monthly_savings; result = calculate_monthly_savings(50000, 3, 0.05); print(result['report'])"
	@echo ""
	@echo "âœ… å±•ç¤ºå®Œæˆï¼ ç¾åœ¨æ‚¨å¯ä»¥å˜—è©¦åŸ·è¡Œ: make dev"

# åŸ·è¡Œæ¸¬è©¦
# ä½¿ç”¨ pytest å·¥å…·ä¾†åŸ·è¡Œ tests/ ç›®éŒ„ä¸‹çš„æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹
test: check-env
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦..."
	pytest tests/ -v --tb=short

# æ¸…ç†å°ˆæ¡ˆç›®éŒ„
# åˆªé™¤ Python ç·¨è­¯ç”¢ç”Ÿçš„ .pyc æª”æ¡ˆã€__pycache__ ç›®éŒ„ä»¥åŠ pytest çš„å¿«å–
clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -rf .pytest_cache/
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸ (å…§éƒ¨ä½¿ç”¨)
# é€™å€‹ç›®æ¨™ç”¨æ–¼ç¢ºèª Google API çš„èªè­‰è³‡è¨Šæ˜¯å¦å·²è¨­å®š
# å¦‚æœ GOOGLE_API_KEY æˆ– GOOGLE_APPLICATION_CREDENTIALS æœªè¨­å®šï¼Œå°‡æœƒé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦ä¸­æ­¢åŸ·è¡Œ
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šèªè­‰æœªè¨­å®š"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®èªè­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 1 - API é‡‘é‘° (Gemini API):"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   è«‹è‡³æ­¤è™•å–å¾—å…è²»é‡‘é‘°: https://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹æ³• 2 - æœå‹™å¸³æˆ¶ (VertexAI):"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   è«‹è‡³æ­¤è™•å»ºç«‹æ†‘è­‰: https://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		exit 1; \
	fi