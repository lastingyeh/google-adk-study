# ==============================================================================
# å®‰è£èˆ‡è¨­å®š
# ==============================================================================

# ä½¿ç”¨ uv å¥—ä»¶ç®¡ç†å™¨å®‰è£ç›¸ä¾æ€§
install:
	@command -v uv >/dev/null 2>&1 || { echo "uv å°šæœªå®‰è£ã€‚æ­£åœ¨å®‰è£ uv..."; curl -LsSf https://astral.sh/uv/0.8.13/install.sh | sh; source $HOME/.local/bin/env; }
	uv sync

# ==============================================================================
# Playground ç›®æ¨™
# ==============================================================================

# å•Ÿå‹•æœ¬åœ°é–‹ç™¼ Playground
playground:
	@echo "==============================================================================="
	@echo "| ğŸš€ å•Ÿå‹•æ‚¨çš„ä»£ç† Playground...                                        |"
	@echo "|                                                                             |"
	@echo "| ğŸ’¡ å˜—è©¦è©¢å•ï¼šæ‰€æœ‰è¡¨æ ¼å¿…é ˆæœ‰ DATA_OWNER æ¨™ç±¤ã€‚                     |"
	@echo "|                                                                             |"
	@echo "| ğŸ” é‡è¦ï¼šé¸æ“‡ 'policy_as_code_agent' è³‡æ–™å¤¾ä»¥èˆ‡æ‚¨çš„ä»£ç†äº’å‹•ã€‚          |"
	@echo "==============================================================================="
	uv run adk web . --port 8501 --reload_agents

# ==============================================================================
# æœ¬åœ°é–‹ç™¼å‘½ä»¤
# ==============================================================================

# å•Ÿå‹•å…·æœ‰ç†±é‡è¼‰åŠŸèƒ½çš„æœ¬åœ°é–‹ç™¼ä¼ºæœå™¨
local-backend:
	uv run uvicorn policy_as_code_agent.fast_api_app:app --host localhost --port 8000 --reload

# å•Ÿå‹•å…·æœ‰ debug æ¨¡å¼çš„æœ¬åœ°å¾Œç«¯ä¼ºæœå™¨
# ç”¨æ³•ï¼šmake debug-backend [PORT=8000] - ä»¥ debug æ¨¡å¼å•Ÿå‹•å¾Œç«¯ï¼Œå¯æŒ‡å®šåŸ è™Ÿ
debug-backend:
	@echo "==============================================================================="
	@echo "| ğŸ› å•Ÿå‹•å¾Œç«¯ Debug æ¨¡å¼...                                             |"
	@echo "| ğŸ“ ä¼ºæœå™¨ä½å€ï¼šhttp://localhost:$(or $(PORT),8000)                           |"
	@echo "| ğŸ” Debugger ç›£è½ï¼š5678                                                   |"
	@echo "| ğŸ”„ ç†±é‡è¼‰ï¼šå•Ÿç”¨                                                            |"
	@echo "==============================================================================="
	uv run --with debugpy python -m debugpy --listen 5678 --wait-for-client -m uvicorn policy_as_code_agent.fast_api_app:app --host localhost --port $(or $(PORT),8000) --reload

# å•Ÿå‹• debug æ¨¡å¼çš„æœ¬åœ°é–‹ç™¼ä¼ºæœå™¨
# ç”¨æ³•ï¼šmake debug [PORT=8501] - ä»¥ debug æ¨¡å¼å•Ÿå‹•ï¼Œå¯æŒ‡å®šåŸ è™Ÿ
debug-playground:
	@echo "==============================================================================="
	@echo "| ğŸ› å•Ÿå‹• Debug æ¨¡å¼...                                                  |"
	@echo "| ğŸ“ ä¼ºæœå™¨ä½å€ï¼šhttp://localhost:$(or $(PORT),8501)                           |"
	@echo "| ğŸ” æ—¥èªŒç´šåˆ¥ï¼šDEBUG                                                        |"
	@echo "| ğŸ”„ ç†±é‡è¼‰ï¼šå•Ÿç”¨                                                            |"
	@echo "==============================================================================="
	uv run --with debugpy python -m debugpy --listen 5678 --wait-for-client -m google.adk.cli web . --port $(or $(PORT),8501) --reload_agents

# ==============================================================================
# å¾Œç«¯éƒ¨ç½²ç›®æ¨™
# ==============================================================================

# é ç«¯éƒ¨ç½²ä»£ç†
# ç”¨æ³•ï¼šmake deploy [IAP=true] [PORT=8080] - è¨­å®š IAP=true å•Ÿç”¨ Identity-Aware Proxyï¼ŒPORT æŒ‡å®šå®¹å™¨åŸ 
deploy:
	PROJECT_ID=$$(gcloud config get-value project) && \
	gcloud beta run deploy pack-policy-as-code \
		--source . \
		--memory "4Gi" \
		--project $$PROJECT_ID \
		--region "us-central1" \
		--no-allow-unauthenticated \
		--no-cpu-throttling \
		--labels "created-by=adk" \
		--update-build-env-vars "AGENT_VERSION=$(shell awk -F'"' '/^version = / {print $$2}' pyproject.toml || echo '0.0.0')" \
		--update-env-vars \
		"COMMIT_SHA=$(shell git rev-parse HEAD)" \
		$(if $(IAP),--iap) \
		$(if $(PORT),--port=$(PORT))

# èˆ‡ 'make deploy' çš„åˆ¥åï¼Œæä¾›å‘å¾Œç›¸å®¹æ€§
backend: deploy

# ==============================================================================
# Docker æ˜ åƒç®¡ç†
# ==============================================================================

# å»ºç½® Docker æ˜ åƒ
# ç”¨æ³•ï¼šmake docker-build [TAG=custom-tag] - å»ºç½® Docker æ˜ åƒï¼Œå¯æŒ‡å®šè‡ªè¨‚æ¨™ç±¤
docker-build:
	@echo "==============================================================================="
	@echo "| ğŸ³ å»ºç½® Docker æ˜ åƒ...                                                |"
	@echo "==============================================================================="
	PROJECT_ID=$$(gcloud config get-value project) && \
	REGION="us-central1" && \
	REPOSITORY_NAME="pack-policy-as-code-repo" && \
	CONTAINER_NAME="pack-policy-as-code" && \
	AGENT_VERSION=$$(awk -F'"' '/^version = / {print $$2}' pyproject.toml || echo '0.0.1') && \
	COMMIT_SHA=$$(git rev-parse HEAD) && \
	IMAGE_TAG="$${REGION}-docker.pkg.dev/$${PROJECT_ID}/$${REPOSITORY_NAME}/$${CONTAINER_NAME}:$${COMMIT_SHA}" && \
	IMAGE_LATEST="$${REGION}-docker.pkg.dev/$${PROJECT_ID}/$${REPOSITORY_NAME}/$${CONTAINER_NAME}:latest" && \
	docker build \
		--build-arg COMMIT_SHA=$${COMMIT_SHA} \
		--build-arg AGENT_VERSION=$${AGENT_VERSION} \
		-t $(or $(TAG),$$CONTAINER_NAME:local) \
		-t $${IMAGE_TAG} \
		-t $${IMAGE_LATEST} \
		.

# æ¨é€ Docker æ˜ åƒè‡³ Artifact Registry
# ç”¨æ³•ï¼šmake docker-push - æ¨é€æ˜ åƒåˆ° Artifact Registry
docker-push:
	@echo "==============================================================================="
	@echo "| ğŸ“¤ æ¨é€ Docker æ˜ åƒè‡³ Artifact Registry...                           |"
	@echo "==============================================================================="
	PROJECT_ID=$$(gcloud config get-value project) && \
	REGION="us-central1" && \
	REPOSITORY_NAME="pack-policy-as-code-repo" && \
	CONTAINER_NAME="pack-policy-as-code" && \
	COMMIT_SHA=$$(git rev-parse HEAD) && \
	IMAGE_TAG="$${REGION}-docker.pkg.dev/$${PROJECT_ID}/$${REPOSITORY_NAME}/$${CONTAINER_NAME}:$${COMMIT_SHA}" && \
	IMAGE_LATEST="$${REGION}-docker.pkg.dev/$${PROJECT_ID}/$${REPOSITORY_NAME}/$${CONTAINER_NAME}:latest" && \
	docker push $${IMAGE_TAG} && \
	docker push $${IMAGE_LATEST}

# æœ¬åœ°æ¸¬è©¦ Docker æ˜ åƒ
# ç”¨æ³•ï¼šmake docker-run [PORT=8080] [TAG=image-tag] - åœ¨æœ¬åœ°å•Ÿå‹• Docker å®¹å™¨
docker-run:
	@echo "==============================================================================="
	@echo "| ğŸš€ å•Ÿå‹• Docker å®¹å™¨...                                                 |"
	@echo "| ğŸ“ æœå‹™ä½å€ï¼šhttp://localhost:$(or $(PORT),8080)                           |"
	@echo "==============================================================================="
	PROJECT_ID=$$(gcloud config get-value project) && \
	REGION="us-central1" && \
	CONTAINER_NAME="pack-policy-as-code" && \
	docker run -p $(or $(PORT),8080):8080 \
		-e GOOGLE_CLOUD_PROJECT=$${PROJECT_ID} \
		-e GOOGLE_CLOUD_LOCATION=$${REGION} \
		-v ~/.config/gcloud:/root/.config/gcloud:ro \
		$(or $(TAG),$${CONTAINER_NAME}:local)

# åœæ­¢ä¸¦æ¸…ç† Docker å®¹å™¨
# ç”¨æ³•ï¼šmake docker-clean - åœæ­¢æ‰€æœ‰å®¹å™¨ä¸¦æ¸…ç†æ˜ åƒ
docker-clean:
	@echo "==============================================================================="
	@echo "| ğŸ§¹ æ¸…ç† Docker å®¹å™¨èˆ‡æ˜ åƒ...                                          |"
	@echo "==============================================================================="
	CONTAINER_NAME="pack-policy-as-code" && \
	docker stop $$(docker ps -q --filter ancestor=$${CONTAINER_NAME}:local) 2>/dev/null || true && \
	docker rm $$(docker ps -aq --filter ancestor=$${CONTAINER_NAME}:local) 2>/dev/null || true && \
	echo "âœ… æ¸…ç†å®Œæˆ"

# å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒï¼ˆçµ„åˆæŒ‡ä»¤ï¼‰
# ç”¨æ³•ï¼šmake docker-publish - å»ºç½®ä¸¦æ¨é€æ˜ åƒåˆ° Artifact Registry
docker-publish: docker-build docker-push
	@echo "âœ… Docker æ˜ åƒå·²æˆåŠŸå»ºç½®ä¸¦æ¨é€è‡³ Artifact Registry"

# ==============================================================================
# Artifact Registry ç®¡ç†
# ==============================================================================

# å»ºç«‹ Artifact Registry å„²å­˜åº«
# ç”¨æ³•ï¼šmake create-artifact-repo [REGION=us-central1] [REPO_NAME=pack-policy-as-code-repo]
create-artifact-repo:
	@echo "==============================================================================="
	@echo "| ğŸ“¦ å»ºç«‹ Artifact Registry å„²å­˜åº«...                                   |"
	@echo "==============================================================================="
	PROJECT_ID=$$(gcloud config get-value project) && \
	REGION="$(or $(REGION),us-central1)" && \
	REPOSITORY_NAME="$(or $(REPO_NAME),pack-policy-as-code-repo)" && \
	gcloud artifacts repositories create $${REPOSITORY_NAME} \
		--repository-format=docker \
		--location=$${REGION} \
		--description="Policy as Code Agent å®¹å™¨å„²å­˜åº«" \
		--project=$${PROJECT_ID} && \
	echo "âœ… å„²å­˜åº« $${REPOSITORY_NAME} å·²å»ºç«‹æ–¼ $${REGION}"

# åˆ—å‡º Artifact Registry æ˜ åƒ
# ç”¨æ³•ï¼šmake list-artifact-images [REGION=us-central1] [REPO_NAME=pack-policy-as-code-repo]
list-artifact-images:
	PROJECT_ID=$$(gcloud config get-value project) && \
	REGION="$(or $(REGION),us-central1)" && \
	REPOSITORY_NAME="$(or $(REPO_NAME),pack-policy-as-code-repo)" && \
	gcloud artifacts docker images list \
		$${REGION}-docker.pkg.dev/$${PROJECT_ID}/$${REPOSITORY_NAME} \
		--project=$${PROJECT_ID}

# è¨­å®š Docker èªè­‰
# ç”¨æ³•ï¼šmake docker-auth [REGION=us-central1]
docker-auth:
	@echo "==============================================================================="
	@echo "| ğŸ” è¨­å®š Docker èªè­‰...                                                 |"
	@echo "==============================================================================="
	REGION="$(or $(REGION),us-central1)" && \
	gcloud auth configure-docker $${REGION}-docker.pkg.dev && \
	echo "âœ… Docker èªè­‰å·²è¨­å®šå®Œæˆ"

# ==============================================================================
# åŸºç¤è¨­æ–½è¨­å®š
# ==============================================================================

# ä½¿ç”¨ Terraform è¨­å®šé–‹ç™¼ç’°å¢ƒè³‡æº
setup-dev-env:
	PROJECT_ID=$$(gcloud config get-value project) && \
	(cd deployment/terraform/dev && terraform init && terraform apply --var-file vars/env.tfvars --var dev_project_id=$$PROJECT_ID --auto-approve)

# ä½¿ç”¨ Terraform éŠ·æ¯€é–‹ç™¼ç’°å¢ƒè³‡æº
# ç”¨æ³•ï¼šmake destroy-dev-env - éŠ·æ¯€é–‹ç™¼ç’°å¢ƒä¸­ç”± Terraform å»ºç«‹çš„æ‰€æœ‰è³‡æº
destroy-dev-env:
	@echo "==============================================================================="
	@echo "| âš ï¸  è­¦å‘Šï¼šå³å°‡éŠ·æ¯€é–‹ç™¼ç’°å¢ƒè³‡æº                                          |"
	@echo "| æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰ç”± Terraform ç®¡ç†çš„è³‡æº                                   |"
	@echo "==============================================================================="
	@read -p "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ(yes/no): " confirm && [ "$$confirm" = "yes" ] || (echo "å·²å–æ¶ˆæ“ä½œ" && exit 1)
	PROJECT_ID=$$(gcloud config get-value project) && \
	(cd deployment/terraform/dev && terraform init && terraform destroy --var-file vars/env.tfvars --var dev_project_id=$$PROJECT_ID --auto-approve)

# ä½¿ç”¨ Terraform è¨­å®šæ­£å¼ç’°å¢ƒè³‡æºï¼ˆåŒ…å« CI/CDã€Stagingã€Productionï¼‰
# ç”¨æ³•ï¼šmake setup-prod-env - è¨­å®šå®Œæ•´çš„æ­£å¼ç’°å¢ƒåŸºç¤è¨­æ–½
setup-prod-env:
	@echo "==============================================================================="
	@echo "| ğŸ—ï¸  è¨­å®šæ­£å¼ç’°å¢ƒåŸºç¤è¨­æ–½...                                            |"
	@echo "| åŒ…å«ï¼šCI/CD Pipelineã€Staging ç’°å¢ƒã€Production ç’°å¢ƒ                      |"
	@echo "==============================================================================="
	(cd deployment/terraform && terraform init && terraform apply --var-file vars/env.tfvars)

# ä½¿ç”¨ Terraform éŠ·æ¯€æ­£å¼ç’°å¢ƒè³‡æº
# ç”¨æ³•ï¼šmake destroy-prod-env - éŠ·æ¯€æ­£å¼ç’°å¢ƒä¸­ç”± Terraform å»ºç«‹çš„æ‰€æœ‰è³‡æº
destroy-prod-env:
	@echo "==============================================================================="
	@echo "| âš ï¸  è­¦å‘Šï¼šå³å°‡éŠ·æ¯€æ­£å¼ç’°å¢ƒè³‡æº                                          |"
	@echo "| æ­¤æ“ä½œå°‡åˆªé™¤ CI/CDã€Stagingã€Production æ‰€æœ‰è³‡æº                         |"
	@echo "==============================================================================="
	@read -p "ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿè¼¸å…¥å°ˆæ¡ˆ ID ä»¥ç¢ºèª: " project_confirm && \
	CURRENT_PROJECT=$$(gcloud config get-value project) && \
	[ "$$project_confirm" = "$$CURRENT_PROJECT" ] || (echo "âŒ å°ˆæ¡ˆ ID ä¸ç¬¦ï¼Œå·²å–æ¶ˆæ“ä½œ" && exit 1) && \
	(cd deployment/terraform && terraform init && terraform destroy --var-file vars/env.tfvars)

# æª¢è¦– Terraform åŸ·è¡Œè¨ˆåŠƒï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
# ç”¨æ³•ï¼šmake terraform-plan-dev - æª¢è¦–é–‹ç™¼ç’°å¢ƒçš„ Terraform è®Šæ›´è¨ˆåŠƒ
terraform-plan-dev:
	PROJECT_ID=$$(gcloud config get-value project) && \
	(cd deployment/terraform/dev && terraform init && terraform plan --var-file vars/env.tfvars --var dev_project_id=$$PROJECT_ID)

# æª¢è¦– Terraform åŸ·è¡Œè¨ˆåŠƒï¼ˆæ­£å¼ç’°å¢ƒï¼‰
# ç”¨æ³•ï¼šmake terraform-plan-prod - æª¢è¦–æ­£å¼ç’°å¢ƒçš„ Terraform è®Šæ›´è¨ˆåŠƒ
terraform-plan-prod:
	(cd deployment/terraform && terraform init && terraform plan --var-file vars/env.tfvars)

# ==============================================================================
# æ¸¬è©¦èˆ‡ç¨‹å¼ç¢¼å“è³ª
# ==============================================================================

# åŸ·è¡Œå–®å…ƒèˆ‡æ•´åˆæ¸¬è©¦
test:
	uv sync --dev
	uv run pytest tests/unit && uv run pytest tests/integration

# åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ (codespell, ruff, mypy)
lint:
	uv sync --dev --extra lint
	uv run codespell
	uv run ruff check . --diff
	uv run ruff format . --check --diff
	uv run mypy .