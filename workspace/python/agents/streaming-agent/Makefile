# æ•™å­¸ 14ï¼šä½¿ç”¨ Server-Sent Events (SSE) çš„ä¸²æµä»£ç†
# ç”¨æ–¼é–‹ç™¼ã€æ¸¬è©¦å’Œå±•ç¤ºæŒ‡ä»¤çš„ Makefile

.PHONY: setup dev test demo clean help
.PHONY: basic_demo modes_demo chat_demo advanced_demo aggregator_demo
.PHONY: fastapi_demo client_demo all_demos

# é è¨­ç›®æ¨™ - é¡¯ç¤ºå¹«åŠ©
help:
	@echo "ğŸš€ æ•™å­¸ 14ï¼šä½¿ç”¨ Server-Sent Events (SSE) çš„ä¸²æµä»£ç†"
	@echo ""
	@echo "ğŸ“‹ å¿«é€Ÿå…¥é–€ï¼š"
	@echo "  make setup    # å®‰è£ä¾è³´"
	@echo "  make demo     # åŸ·è¡Œä¸»è¦å±•ç¤º"
	@echo ""
	@echo "ğŸ¯ é–‹ç™¼æŒ‡ä»¤ï¼š"
	@echo "  make setup    # å®‰è£ä¾è³´èˆ‡å¥—ä»¶"
	@echo "  make dev      # å•Ÿå‹• ADK ç¶²é ä»‹é¢ (éœ€è¦ GOOGLE_API_KEY)"
	@echo "  make test     # åŸ·è¡Œç¶œåˆæ¸¬è©¦å¥—ä»¶"
	@echo ""
	@echo "ğŸª å±•ç¤ºæŒ‡ä»¤ï¼š"
	@echo "  make demo           # åŸ·è¡Œä¸»è¦ä¸²æµå±•ç¤º"
	@echo "  make basic_demo     # åŸºæœ¬ä¸²æµå¯¦ä½œ"
	@echo "  make modes_demo     # StreamingMode è¨­å®š"
	@echo "  make chat_demo      # äº’å‹•å¼èŠå¤©æ‡‰ç”¨ç¨‹å¼"
	@echo "  make advanced_demo  # é€²éšä¸²æµæ¨¡å¼"
	@echo "  make aggregator_demo # å›æ‡‰èšåˆå±•ç¤º"
	@echo "  make fastapi_demo   # FastAPI SSE ä¼ºæœå™¨è³‡è¨Š"
	@echo "  make client_demo    # SSE å®¢æˆ¶ç«¯å±•ç¤ºè³‡è¨Š"
	@echo "  make all_demos      # ä¾åºåŸ·è¡Œæ‰€æœ‰å±•ç¤º"
	@echo ""
	@echo "ğŸ§¹ ç¶­è­·ï¼š"
	@echo "  make clean    # ç§»é™¤å¿«å–æª”æ¡ˆèˆ‡ç”¢ç‰©"
	@echo ""
	@echo "ğŸ“– æ•™å­¸ï¼šhttps://github.com/raphaelmansuy/adk_training/tree/main/tutorial_implementation/tutorial14"

# è¨­å®šç’°å¢ƒ
setup:
	@echo "ğŸ“¦ æ­£åœ¨è¨­å®šæ•™å­¸ 14 ç’°å¢ƒ..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… è¨­å®šå®Œæˆï¼"
	@echo "ğŸ’¡ å¾ŒçºŒæ­¥é©Ÿï¼š"
	@echo "   1. å°‡ streaming_agent/.env.example è¤‡è£½ç‚º .env"
	@echo "   2. åœ¨ .env ä¸­åŠ å…¥æ‚¨çš„ GOOGLE_API_KEY"
	@echo "   3. åŸ·è¡Œ 'make demo' ä¾†è§€çœ‹ä¸²æµçš„å¯¦éš›é‹ä½œï¼"

# å•Ÿå‹• ADK ç¶²é ä»‹é¢
dev:
	@echo "ğŸŒ æ­£åœ¨å•Ÿå‹• ADK ç¶²é ä»‹é¢..."
	@echo "ğŸ”‘ è«‹ç¢ºä¿æ‚¨å·²åœ¨ç’°å¢ƒä¸­è¨­å®š GOOGLE_API_KEY"
	@echo "ğŸ“± åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­è¨ªå• http://localhost:8000"
	adk web streaming_agent

# åŸ·è¡Œæ¸¬è©¦
test:
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œç¶œåˆæ¸¬è©¦å¥—ä»¶..."
	pytest tests/ -v --cov=streaming_agent --cov-report=term-missing
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼"

# ä¸»è¦å±•ç¤º (åŸºæœ¬ä¸²æµ)
demo:
	@echo "ğŸ¬ æ­£åœ¨åŸ·è¡Œä¸»è¦ä¸²æµå±•ç¤º..."
	python demos/basic_streaming_demo.py
	@echo "âœ… å±•ç¤ºå®Œæˆï¼"

# å€‹åˆ¥å±•ç¤ºæŒ‡ä»¤
basic_demo:
	@echo "ğŸ¯ æ­£åœ¨åŸ·è¡ŒåŸºæœ¬ä¸²æµå±•ç¤º..."
	@echo "   å±•ç¤ºä½¿ç”¨ Runner.run_async() çš„åŸºæœ¬ä¸²æµ"
	python demos/basic_streaming_demo.py
	@echo "âœ… åŸºæœ¬å±•ç¤ºå®Œæˆï¼"

modes_demo:
	@echo "ğŸ”„ æ­£åœ¨åŸ·è¡Œä¸²æµæ¨¡å¼å±•ç¤º..."
	@echo "   é¡¯ç¤ºä¸åŒçš„ StreamingMode è¨­å®š (SSE, NONE)"
	python demos/streaming_modes_demo.py
	@echo "âœ… æ¨¡å¼å±•ç¤ºå®Œæˆï¼"

chat_demo:
	@echo "ğŸ’¬ æ­£åœ¨åŸ·è¡Œä¸²æµèŠå¤©æ‡‰ç”¨ç¨‹å¼..."
	@echo "   å…·æœ‰å³æ™‚ä¸²æµå›æ‡‰çš„äº’å‹•å¼èŠå¤©"
	@echo "   æŒ‰ Ctrl+C é€€å‡º"
	python demos/streaming_chat_app.py
	@echo "âœ… èŠå¤©å±•ç¤ºå®Œæˆï¼"

advanced_demo:
	@echo "âš¡ æ­£åœ¨åŸ·è¡Œé€²éšä¸²æµæ¨¡å¼å±•ç¤º..."
	@echo "   å±•ç¤ºï¼šèšåˆã€é€²åº¦æŒ‡ç¤ºå™¨ã€å¤šé‡è¼¸å‡ºã€è¶…æ™‚"
	python demos/advanced_patterns_demo.py
	@echo "âœ… é€²éšå±•ç¤ºå®Œæˆï¼"

aggregator_demo:
	@echo "ğŸ“Š æ­£åœ¨åŸ·è¡Œä¸²æµèšåˆå™¨å±•ç¤º..."
	@echo "   é¡¯ç¤ºå›æ‡‰èšåˆèˆ‡å€å¡Šåˆ†æ"
	python demos/streaming_aggregator_demo.py
	@echo "âœ… èšåˆå™¨å±•ç¤ºå®Œæˆï¼"

fastapi_demo:
	@echo "ğŸš€ FastAPI SSE å±•ç¤ºè¨­å®šèªªæ˜"
	@echo "======================================"
	@echo "æ­¤å±•ç¤ºèªªæ˜å¦‚ä½•ä½¿ç”¨ä¸²æµ SSE å»ºç«‹ Web APIã€‚"
	@echo ""
	@echo "ğŸ“¦ å®‰è£é¡å¤–ä¾è³´ï¼š"
	@echo "   pip install fastapi uvicorn"
	@echo ""
	@echo "ğŸš€ å•Ÿå‹• FastAPI ä¼ºæœå™¨ï¼š"
	@echo "   python -m uvicorn demos.fastapi_sse_demo:app --reload --host 0.0.0.0 --port 8000"
	@echo ""
	@echo "ğŸŒ åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿï¼š"
	@echo "   http://localhost:8000/docs     - äº’å‹•å¼ API æ–‡ä»¶"
	@echo "   http://localhost:8000/client   - å…§å»ºæ¸¬è©¦å®¢æˆ¶ç«¯"
	@echo ""
	@echo "ğŸ§ª æ¸¬è©¦ä¸²æµç«¯é»ï¼š"
	@echo "   curl \"http://localhost:8000/chat/stream?query=Hello%20world\""
	@echo ""
	@echo "ğŸ’¡ ä¼ºæœå™¨åŒ…å«ï¼š"
	@echo "   â€¢ RESTful èŠå¤©ç«¯é»"
	@echo "   â€¢ Server-Sent Events ä¸²æµ"
	@echo "   â€¢ å…§å»º HTML æ¸¬è©¦å®¢æˆ¶ç«¯"
	@echo "   â€¢ ç”¨æ–¼ Web æ‡‰ç”¨ç¨‹å¼çš„ CORS æ¨™é ­"

client_demo:
	@echo "ğŸŒ SSE å®¢æˆ¶ç«¯å±•ç¤ºè¨­å®šèªªæ˜"
	@echo "===================================="
	@echo "æ­¤å±•ç¤ºé¡¯ç¤ºç”¨æ–¼ SSE é€£ç·šçš„å®¢æˆ¶ç«¯ JavaScriptã€‚"
	@echo ""
	@echo "ğŸ“‹ éœ€æ±‚ï¼š"
	@echo "   â€¢ FastAPI ä¼ºæœå™¨æ­£åœ¨åŸ·è¡Œ (è«‹åƒé–± 'make fastapi_demo')"
	@echo "   â€¢ ç¾ä»£ç¶²é ç€è¦½å™¨"
	@echo ""
	@echo "ğŸš€ å•Ÿå‹•æœ¬åœ°ç¶²é ä¼ºæœå™¨ï¼š"
	@echo "   python -m http.server 8080"
	@echo ""
	@echo "ğŸŒ åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿï¼š"
	@echo "   http://localhost:8080/demos/sse_client.html"
	@echo ""
	@echo "ğŸ’¡ åŠŸèƒ½ï¼š"
	@echo "   â€¢ å³æ™‚ SSE é€£ç·š"
	@echo "   â€¢ æ¼¸é€²å¼è¨Šæ¯é¡¯ç¤º"
	@echo "   â€¢ éŒ¯èª¤è™•ç†èˆ‡é‡æ–°é€£ç·š"
	@echo "   â€¢ ç°¡æ½”ã€éŸ¿æ‡‰å¼çš„ UI"
	@echo "   â€¢ è¼¸å…¥æŒ‡ç¤ºå™¨"

# ä¾åºåŸ·è¡Œæ‰€æœ‰å±•ç¤º
all_demos:
	@echo "ğŸª æ­£åœ¨åŸ·è¡Œæ‰€æœ‰ä¸²æµå±•ç¤º..."
	@echo "=================================="
	$(MAKE) basic_demo
	@echo ""
	$(MAKE) modes_demo
	@echo ""
	$(MAKE) advanced_demo
	@echo ""
	$(MAKE) aggregator_demo
	@echo ""
	$(MAKE) fastapi_demo
	@echo ""
	$(MAKE) client_demo
	@echo ""
	@echo "ğŸ‰ æ‰€æœ‰å±•ç¤ºå®Œæˆï¼"
	@echo "ğŸ’¡ å°ˆæ¥­æç¤ºï¼šä½¿ç”¨ 'make <demo_name>' åŸ·è¡Œå€‹åˆ¥å±•ç¤º"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†å¿«å–æª”æ¡ˆèˆ‡ç”¢ç‰©..."
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".coverage" -exec rm -rf {} +
	find . -type f -name ".coverage" -delete
	find . -type f -name "coverage.xml" -delete
	find . -type f -name "streaming_output.txt" -delete
	@echo "âœ… æ¸…ç†å®Œæˆï¼"
