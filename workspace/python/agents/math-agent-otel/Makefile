.PHONY: help setup test demo web jaeger-up jaeger-down clean

# Color output
BOLD := \033[1m
GREEN := \033[32m
BLUE := \033[34m
YELLOW := \033[33m
RESET := \033[0m

help:
	@echo ""
	@echo "$(BOLD)ğŸš€ OpenTelemetry + ADK + Jaeger$(RESET)"
	@echo ""
	@echo "$(BOLD)å¿«é€Ÿé–‹å§‹ (3 æ­¥é©Ÿ):$(RESET)"
	@echo "  1. $(GREEN)make setup$(RESET)      â€” å®‰è£ç›¸ä¾å¥—ä»¶"
	@echo "  2. $(GREEN)make jaeger-up$(RESET)  â€” å•Ÿå‹• Jaeger (è§€å¯Ÿè¿½è¹¤)"
	@echo "  3. $(GREEN)make web$(RESET)        â€” åœ¨ $(BLUE)http://localhost:8000$(RESET) å•Ÿå‹•äº’å‹•å¼èŠå¤©"
	@echo ""
	@echo "$(BOLD)ç„¶å¾Œ:$(RESET)"
	@echo "  â€¢ åœ¨ Web UI ä¸­è©¢å•ä»£ç†æ•¸å­¸å•é¡Œ"
	@echo "  â€¢ åœ¨ $(BLUE)http://localhost:16686$(RESET) çš„ Jaeger ä¸­æª¢è¦–è¿½è¹¤"
	@echo "  â€¢ ä½¿ç”¨ $(GREEN)make jaeger-down$(RESET) åœæ­¢ Jaeger"
	@echo ""
	@echo "$(BOLD)å…¶ä»–æŒ‡ä»¤:$(RESET)"
	@echo "  $(GREEN)make demo$(RESET)          â€” åŸ·è¡Œå¸¶æœ‰ç¯„ä¾‹æŸ¥è©¢çš„ç¤ºç¯„"
	@echo "  $(GREEN)make test$(RESET)          â€” åŸ·è¡Œ 42 å€‹å–®å…ƒæ¸¬è©¦"
	@echo "  $(GREEN)make clean$(RESET)         â€” ç§»é™¤å¿«å–æª”æ¡ˆ"
	@echo ""

setup:
	@echo "$(BOLD)ğŸ“¦ å®‰è£ç›¸ä¾å¥—ä»¶ä¸­...$(RESET)"
	pip install -r requirements.txt
	pip install -e .
	@echo "$(GREEN)âœ… å®Œæˆ$(RESET)"
	@echo ""

test:
	@echo "$(BOLD)ğŸ§ª åŸ·è¡Œæ¸¬è©¦ä¸­...$(RESET)"
	pytest tests/ -v --cov=math_agent --cov-report=term-missing
	@echo ""

demo:
	@echo "$(BOLD)ğŸ¤– åŸ·è¡Œç¤ºç¯„ä¸­...$(RESET)"
	@echo ""
	python -m math_agent.agent
	@echo ""

web:
	@echo "$(BOLD)ğŸŒ æ­£åœ¨ http://localhost:8000 å•Ÿå‹• Web UI$(RESET)"
	@echo "$(BOLD)ğŸ“Š é€é OTEL å°‡è¿½è¹¤åŒ¯å‡ºè‡³ http://localhost:16686 çš„ Jaeger$(RESET)"
	@echo ""
	OTEL_SERVICE_NAME=google-adk-math-agent \
	OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318 \
	OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf \
	OTEL_INSTRUMENTATION_GENAI_CAPTURE_MESSAGE_CONTENT=true \
	adk web .

jaeger-up:
	@echo "$(BOLD)ğŸš€ å•Ÿå‹• Jaeger ä¸­...$(RESET)"
	docker run -d --name jaeger \
		-e COLLECTOR_OTLP_ENABLED=true \
		-p 16686:16686 -p 4318:4318 \
		jaegertracing/all-in-one:latest > /dev/null 2>&1
	@echo "$(GREEN)âœ… Jaeger æ­£åœ¨ http://localhost:16686 åŸ·è¡Œ$(RESET)"
	@echo ""

jaeger-down:
	@echo "$(BOLD)ğŸ›‘ åœæ­¢ Jaeger ä¸­...$(RESET)"
	@docker stop jaeger > /dev/null 2>&1 && docker rm jaeger > /dev/null 2>&1 || true
	@echo "$(GREEN)âœ… Jaeger å·²åœæ­¢$(RESET)"
	@echo ""

clean:
	@echo "$(BOLD)ğŸ§¹ æ¸…ç†ä¸­...$(RESET)"
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	@echo "$(GREEN)âœ… å®Œæˆ$(RESET)"
	@echo ""
