# 教學 22: 模型選擇與最佳化框架
# 一個智慧代理程式，幫助您為您的使用情境選擇最佳的 AI 模型

.PHONY: help setup dev test test-cov clean demo benchmark compare-models
.PHONY: quick-start full-demo model-info

# 預設目標 - 顯示詳細說明
help:
	@echo "🚀 教學 22: 模型選擇與最佳化框架"
	@echo "🤖 一個推薦與比較 AI 模型的智慧代理程式"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎯 入門指南 (5 分鐘)"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  make setup          📦 安裝依賴套件 (2 分鐘)"
	@echo "  make dev            🚀 啟動互動式代理程式 (即時)"
	@echo "  make quick-start    ⚡ 一個指令完成設定與啟動 (3 分鐘)"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🧪 測試與驗證"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  make test           ✅ 執行所有測試 (30 秒)"
	@echo "  make test-cov       📊 執行測試並產出覆蓋率報告 (45 秒)"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎪 示範與範例"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  make demo           🎯 包含範例問題的互動式示範"
	@echo "  make benchmark      📈 執行自動化模型效能測試"
	@echo "  make compare-models 🔄 並排比較特定模型"
	@echo "  make model-info     ℹ️  顯示詳細的模型規格"
	@echo "  make full-demo      🎉 完整的體驗 (所有示範)"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🧹 維護"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  make clean          🗑️  移除快取檔案與建置產物"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📋 先決條件"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  • Python 3.9+"
	@echo "  • GOOGLE_API_KEY 環境變數"
	@echo "     💡 免費取得金鑰: https://aistudio.google.com/app/apikey"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "💡 快速入門工作流程"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  1️⃣  make setup          # 安裝所有東西"
	@echo "  2️⃣  make dev            # 啟動代理程式"
	@echo "  3️⃣  開啟 http://localhost:8000"
	@echo "  4️⃣  從下拉選單中選擇 'model_selector_agent'"
	@echo "  5️⃣  提問: '我應該使用哪個模型進行即時語音聊天?'"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎯 本教學內容"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  • 模型選擇策略與權衡"
	@echo "  • 跨模型的效能基準測試"
	@echo "  • AI 工作負載的成本最佳化"
	@echo "  • 真實世界的模型比較框架"
	@echo "  • 生產環境部署考量"

# 快速啟動: 一個指令完成 setup + dev
quick-start: setup dev

# 顯示進度指示的環境設定
setup:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📦 正在設定教學 22 環境"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "⏳ 正在安裝 Python 依賴套件..."
	pip install -r requirements.txt
	@echo "✅ Python 依賴套件已安裝"
	@echo ""
	@echo "⏳ 正在安裝 model_selector 套件..."
	pip install -e .
	@echo "✅ 套件安裝成功"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎉 設定完成!"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "💡 下一步:"
	@echo "   1. 設定 API 金鑰: export GOOGLE_API_KEY=your_key"
	@echo "   2. 執行: make dev"
	@echo "   3. 在瀏覽器中開啟 http://localhost:8000"
	@echo ""
	@echo "🔑 沒有 API 金鑰嗎?"
	@echo "   免費取得一個: https://aistudio.google.com/app/apikey"

# 啟動開發伺服器並提供引導式體驗
dev: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🤖 正在啟動模型選擇器代理程式"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📱 網頁介面: http://localhost:8000"
	@echo "🎯 代理程式名稱: model_selector_agent"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "💡 試試這些範例問題:"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎯 模型推薦:"
	@echo "  • '我應該使用哪個模型進行即時語音聊天?'"
	@echo "  • '哪個模型最適合複雜的推理任務?'"
	@echo "  • '為客戶支援聊天機器人推薦一個模型'"
	@echo "  • '哪個模型適合程式碼生成與除錯?'"
	@echo ""
	@echo "📊 模型比較:"
	@echo "  • '比較 gemini-2.5-flash 和 gemini-2.5-pro'"
	@echo "  • 'gemini-2.5-flash-lite 和 flash 有何不同?'"
	@echo "  • '告訴我速度和品質之間的權衡'"
	@echo ""
	@echo "💰 成本最佳化:"
	@echo "  • '哪個模型能提供最佳的性價比?'"
	@echo "  • '幫我為高流量的 API 呼叫選擇一個模型'"
	@echo "  • '對我的使用情境來說，哪個模型最符合成本效益?'"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎮 如何使用:"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  1. 在瀏覽器中開啟 http://localhost:8000"
	@echo "  2. 從下拉選單中選擇 'model_selector_agent'"
	@echo "  3. 輸入以上任何問題或描述您的使用情境"
	@echo "  4. 觀看代理程式分析並推薦最佳模型!"
	@echo ""
	@echo "💡 專業提示:"
	@echo "  • 具體說明您的使用情境 (延遲、成本、準確性需求)"
	@echo "  • 提及您預期的使用量"
	@echo "  • 詢問不同模型之間的權衡"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🚀 正在啟動伺服器..."
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	adk web

# 執行所有測試並提供詳細輸出
test: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🧪 正在執行測試套件"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "⏳ 正在執行所有測試..."
	pytest tests/ -v --tb=short
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "✅ 測試套件執行完畢"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "💡 測試驗證:"
	@echo "   • 模型選擇邏輯"
	@echo "   • 效能基準測試"
	@echo "   • 成本最佳化演算法"
	@echo "   • 代理程式回應格式"

# 執行測試並產出覆蓋率報告
test-cov: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📊 正在執行包含覆蓋率分析的測試"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "⏳ 正在執行測試並分析程式碼覆蓋率..."
	pytest tests/ --cov=model_selector --cov-report=html --cov-report=term-missing
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📈 已產生覆蓋率報告"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📁 HTML 報告: htmlcov/index.html"
	@echo "💡 在瀏覽器中開啟 HTML 檔案以進行詳細的覆蓋率分析"
	@echo ""
	@echo "🎯 覆蓋範圍包括:"
	@echo "   • 模型選擇演算法"
	@echo "   • 基準測試函式"
	@echo "   • 成本計算邏輯"
	@echo "   • 代理程式回應生成"

# 包含引導式體驗的互動式示範
demo: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎯 模型選擇代理程式 - 互動式示範"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo ""
	@echo "🎪 此示範透過引導式範例展示代理程式的功能"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📋 示範情境:"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "1️⃣  🎯 模型推薦:"
	@echo "   • 即時語音應用"
	@echo "   • 複雜推理任務"
	@echo "   • 客戶支援聊天機器人"
	@echo "   • 程式碼生成與除錯"
	@echo ""
	@echo "2️⃣  📊 效能比較:"
	@echo "   • 速度與準確性的權衡"
	@echo "   • 成本與效能分析"
	@echo "   • 模型能力矩陣"
	@echo ""
	@echo "3️⃣  💰 成本最佳化:"
	@echo "   • 最佳性價比"
	@echo "   • 高流量 API 最佳化"
	@echo "   • 預算考量下的推薦"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🚀 如何執行示範:"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  1. 在另一個終端機中執行: make dev"
	@echo "  2. 在瀏覽器中開啟 http://localhost:8000"
	@echo "  3. 從下拉選單中選擇 'model_selector_agent'"
	@echo "  4. 嘗試在 'make dev' 期間顯示的問題"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "⚡ 獨立基準測試模式:"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "正在執行自動化模型比較..."
	python -m model_selector.agent

# 執行自動化模型效能基準測試
benchmark: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📈 模型效能基準測試"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "⏳ 正在執行全面的模型基準測試..."
	@echo "   這可能需要幾分鐘的時間..."
	@echo ""
	python -c "\
from model_selector.agent import benchmark_models; \
print('🏃 正在執行基準測試套件...'); \
results = benchmark_models(); \
print('✅ 基準測試完成!'); \
print('📊 結果已儲存至 benchmark_results.json'); \
"

# 並排比較特定模型
compare-models: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🔄 模型比較工具"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📊 正在跨關鍵維度比較 Gemini 模型..."
	@echo ""
	python -c 'from model_selector.agent import compare_models_detailed; print("🔍 正在分析模型差異..."); comparison = compare_models_detailed(); print("✅ 比較完成!"); print("📋 主要發現:"); [print("   • " + finding) for finding in comparison.get("key_findings", [])]'

# 顯示詳細的模型規格
model-info: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "ℹ️  GEMINI 模型規格"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo ""
	python model_specs.py

# 完整體驗 - 執行所有示範
full-demo: check-env
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎉 完整的模型選擇體驗"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎪 這將執行所有的示範與基準測試"
	@echo "   預計時間: 5-10 分鐘"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "📋 您將會看到:"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "  1. 🤖 互動式代理程式功能"
	@echo "  2. 📈 自動化效能基準測試"
	@echo "  3. 🔄 詳細的模型比較"
	@echo "  4. ℹ️  完整的模型規格"
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🚀 正在開始完整示範..."
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo ""
	@echo "步驟 1/4: 互動式示範說明"
	$(MAKE) demo
	@echo ""
	@echo "步驟 2/4: 正在執行基準測試..."
	$(MAKE) benchmark
	@echo ""
	@echo "步驟 3/4: 模型比較..."
	$(MAKE) compare-models
	@echo ""
	@echo "步驟 4/4: 模型規格..."
	$(MAKE) model-info
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🎉 完整體驗結束!"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "💡 您學到了:"
	@echo "   • 如何為不同使用情境選擇 AI 模型"
	@echo "   • Gemini 模型的效能特性"
	@echo "   • 模型選擇的成本效益分析"
	@echo "   • 生產環境部署考量"
	@echo ""
	@echo "🚀 準備好開始建置了嗎? 請查看 model_selector/ 中的原始碼"

# 清理快取檔案與建置產物
clean:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🧹 正在清理快取檔案與產物"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "⏳ 正在移除快取檔案..."
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .coverage -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name htmlcov -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	find . -type f -name "benchmark_results.json" -delete 2>/dev/null || true
	find . -type f -name "comparison_results.json" -delete 2>/dev/null || true
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "✅ 清理完成"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "🗑️  已移除:"
	@echo "   • Python 快取檔案 (__pycache__, *.pyc)"
	@echo "   • 測試產物 (.pytest_cache, .coverage)"
	@echo "   • 建置產物 (*.egg-info)"
	@echo "   • 產生的報告 (htmlcov/, benchmark_results.json)"
	@echo ""
	@echo "💡 您的原始碼與設定檔皆被保留"

# 檢查環境 (內部使用)
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "❌ 錯誤: 未設定驗證"; \
		echo ""; \
		echo "請選擇以下其中一種驗證方式:"; \
		echo ""; \
		echo "🔑 方法 1 - API 金鑰 (Gemini API):"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   免費取得金鑰: https://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "🔐 方法 2 - 服務帳號 (VertexAI):"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   建立憑證: https://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		exit 1; \
	fi
