# æ•™å­¸ 23ï¼šç”Ÿç”¢éƒ¨ç½²å¯¦ä½œ
# ç”¨æ–¼é–‹ç™¼ã€æ¸¬è©¦å’Œéƒ¨ç½²æŒ‡å—çš„ Makefile

.PHONY: help setup dev test demo clean check-env server server-docs
.PHONY: demo-info demo-scenarios demo-deployment

# é è¨­ç›®æ¨™ - é¡¯ç¤ºèªªæ˜
help:
	@echo "ğŸš€ æ•™å­¸ 23ï¼šç”Ÿç”¢éƒ¨ç½²å¯¦ä½œ"
	@echo ""
	@echo "ğŸ“‹ å¿«é€Ÿé–‹å§‹ï¼š"
	@echo "  make setup    # å®‰è£ç›¸ä¾å¥—ä»¶"
	@echo "  make demo     # é¡¯ç¤ºéƒ¨ç½²ç­–ç•¥"
	@echo ""
	@echo "ğŸ¯ é–‹ç™¼æŒ‡ä»¤ï¼š"
	@echo "  make setup    # å®‰è£ç›¸ä¾å¥—ä»¶å’Œå¥—ä»¶"
	@echo "  make dev      # å•Ÿå‹• ADK ç¶²é ä»‹é¢ï¼ˆéœ€è¦ GOOGLE_API_KEYï¼‰"
	@echo "  make test     # åŸ·è¡Œå…¨é¢æ¸¬è©¦å¥—ä»¶"
	@echo ""
	@echo "ğŸª æ¼”ç¤ºæŒ‡ä»¤ï¼š"
	@echo "  make demo               # é¡¯ç¤ºæ‰€æœ‰éƒ¨ç½²è³‡è¨Šï¼ˆé è¨­ï¼‰"
	@echo "  make demo-info          # éƒ¨ç½²æ¦‚å¿µèˆ‡æœ€ä½³å¯¦å‹™"
	@echo "  make demo-scenarios     # çœŸå¯¦ä¸–ç•Œéƒ¨ç½²æƒ…å¢ƒ"
	@echo "  make demo-deployment    # éƒ¨ç½²æŒ‡ä»¤åƒè€ƒ"
	@echo ""
	@echo "ğŸŒ ä¼ºæœå™¨æŒ‡ä»¤ï¼š"
	@echo "  make server             # å•Ÿå‹•è‡ªè¨‚ FastAPI ä¼ºæœå™¨"
	@echo "  make server-docs        # é¡¯ç¤º FastAPI æ–‡ä»¶è³‡è¨Š"
	@echo ""
	@echo "ğŸ§¹ ç¶­è­·ï¼š"
	@echo "  make clean    # ç§»é™¤å¿«å–æª”æ¡ˆå’Œç”¢ç‰©"
	@echo ""
	@echo "ğŸ“– äº†è§£æ›´å¤šï¼šhttps://github.com/raphaelmansuy/adk_training/tree/main/docs/tutorial/23_production_deployment.md"

# è¨­å®šç’°å¢ƒ
setup:
	@echo "ğŸ“¦ è¨­å®šæ•™å­¸ 23 ç’°å¢ƒ..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… è¨­å®šå®Œæˆï¼"
	@echo ""
	@echo "ğŸ’¡ ä¸‹ä¸€æ­¥ï¼š"
	@echo "   1. è¨­å®šæ‚¨çš„ API é‡‘é‘°ï¼šexport GOOGLE_API_KEY=your_api_key"
	@echo "   2. å˜—è©¦æ¼”ç¤ºï¼š        make demo"
	@echo "   3. åŸ·è¡Œæ¸¬è©¦ï¼š        make test"
	@echo "   4. å•Ÿå‹•é–‹ç™¼ï¼š        make dev"
	@echo ""
	@echo "ğŸ”‘ åœ¨æ­¤å–å¾—å…è²» API é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"

# å•Ÿå‹• ADK ç¶²é ä»‹é¢
dev: check-env
	@echo "ğŸ¤– å•Ÿå‹•ç”Ÿç”¢éƒ¨ç½²ä»£ç†..."
	@echo "ğŸŒ åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ http://localhost:8000"
	@echo "ğŸ¯ å¾ä¸‹æ‹‰å¼é¸å–®é¸æ“‡ 'production_deployment_agent'"
	@echo ""
	@echo "ğŸ’¬ å˜—è©¦é€™äº›æç¤ºï¼š"
	@echo "   â€¢ 'What deployment options are available?' (æœ‰å“ªäº›éƒ¨ç½²é¸é …ï¼Ÿ)"
	@echo "   â€¢ 'How do I deploy to Cloud Run?' (å¦‚ä½•éƒ¨ç½²åˆ° Cloud Runï¼Ÿ)"
	@echo "   â€¢ 'What are best practices for production?' (ç”Ÿç”¢ç’°å¢ƒçš„æœ€ä½³å¯¦å‹™æ˜¯ä»€éº¼ï¼Ÿ)"
	@echo "   â€¢ 'Show me health check configuration' (é¡¯ç¤ºå¥åº·æª¢æŸ¥è¨­å®š)"
	@echo ""
	adk web

# åŸ·è¡Œæ¸¬è©¦
test: check-env
	@echo "ğŸ§ª åŸ·è¡Œå…¨é¢æ¸¬è©¦å¥—ä»¶..."
	pytest tests/ -v --cov=production_agent --cov-report=term-missing
	@echo ""
	@echo "âœ… æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼"

# ä¸»è¦æ¼”ç¤º - é¡¯ç¤ºæ‰€æœ‰éƒ¨ç½²è³‡è¨Š
demo: demo-info demo-deployment demo-scenarios

# æ¼”ç¤ºï¼šéƒ¨ç½²æ¦‚å¿µèˆ‡æœ€ä½³å¯¦å‹™
demo-info:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ğŸ“š ç”Ÿç”¢éƒ¨ç½²æ¦‚å¿µ"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ¯ éƒ¨ç½²ç­–ç•¥ï¼š"
	@echo "   â€¢ æœ¬åœ°é–‹ç™¼ (Local Development)ï¼šå¿«é€Ÿæ¸¬è©¦èˆ‡è¿­ä»£"
	@echo "   â€¢ API ä¼ºæœå™¨ (API Server)ï¼šå°‡ä»£ç†å…¬é–‹ç‚º REST ç«¯é»"
	@echo "   â€¢ Cloud Runï¼šç„¡ä¼ºæœå™¨å®¹å™¨éƒ¨ç½²"
	@echo "   â€¢ Agent Engineï¼šè¨—ç®¡ä¼æ¥­ç´šéƒ¨ç½²"
	@echo "   â€¢ GKEï¼šç”¨æ–¼å¯æ“´å±•éƒ¨ç½²çš„ Kubernetes"
	@echo ""
	@echo "ğŸ”’ æœ€ä½³å¯¦å‹™ï¼š"
	@echo "   â€¢ å®‰å…¨æ€§ï¼šä½¿ç”¨æœå‹™å¸³æˆ¶ï¼Œè€Œé API é‡‘é‘°"
	@echo "   â€¢ ç›£æ§ï¼šè¿½è¹¤æŒ‡æ¨™èˆ‡éŒ¯èª¤"
	@echo "   â€¢ å¥åº·æª¢æŸ¥ï¼šå¯¦ä½œå­˜æ´»æ¢é‡ (liveness probes)"
	@echo "   â€¢ å¯æ“´å±•æ€§ï¼šé‡å°è² è¼‰ä½¿ç”¨è‡ªå‹•æ“´å±•"
	@echo "   â€¢ å¯é æ€§ï¼šå¯¦ä½œé‡è©¦èˆ‡é€¾æ™‚"
	@echo ""
	@echo "ğŸ“Š é—œéµæŒ‡æ¨™ï¼š"
	@echo "   â€¢ è«‹æ±‚å»¶é²èˆ‡ååé‡"
	@echo "   â€¢ éŒ¯èª¤ç‡èˆ‡é¡å‹"
	@echo "   â€¢ è³‡æºä½¿ç”¨é‡ï¼ˆCPUã€è¨˜æ†¶é«”ã€ç¶²è·¯ï¼‰"
	@echo "   â€¢ æ­£å¸¸é‹è¡Œæ™‚é–“èˆ‡å¯ç”¨æ€§"
	@echo ""

# æ¼”ç¤ºï¼šçœŸå¯¦ä¸–ç•Œéƒ¨ç½²æƒ…å¢ƒ
demo-scenarios:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ğŸ¬ éƒ¨ç½²æƒ…å¢ƒ"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“ æƒ…å¢ƒ 1ï¼šåˆå§‹é–‹ç™¼"
	@echo "   ç›®æ¨™ï¼šå¿«é€Ÿè¿­ä»£ä»£ç†é‚è¼¯"
	@echo "   æŒ‡ä»¤ï¼šmake dev"
	@echo "   å·¥å…·ï¼šADK Web UI é€²è¡Œæ¸¬è©¦"
	@echo ""
	@echo "ğŸ“ æƒ…å¢ƒ 2ï¼šæœ¬åœ°æ¸¬è©¦"
	@echo "   ç›®æ¨™ï¼šå°‡ä»£ç†ä½œç‚º REST API é€²è¡Œæ¸¬è©¦"
	@echo "   æŒ‡ä»¤ï¼šmake server"
	@echo "   ç«¯é»ï¼šhttp://localhost:8000/invoke"
	@echo ""
	@echo "ğŸ“ æƒ…å¢ƒ 3ï¼šCloud Run ä¸Šçš„ç”Ÿç”¢ç’°å¢ƒ"
	@echo "   ç›®æ¨™ï¼šéƒ¨ç½²åˆ°ç„¡ä¼ºæœå™¨ç’°å¢ƒ"
	@echo "   æ­¥é©Ÿï¼š"
	@echo "      1. å»ºç«‹ Docker æ˜ åƒæª”"
	@echo "      2. æ¨é€åˆ° Google Container Registry"
	@echo "      3. ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤éƒ¨ç½²ï¼šadk deploy cloud_run"
	@echo ""
	@echo "ğŸ“ æƒ…å¢ƒ 4ï¼šä¼æ¥­ç´šéƒ¨ç½²"
	@echo "   ç›®æ¨™ï¼šä½¿ç”¨ Google çš„è¨—ç®¡ Agent Engine"
	@echo "   æŒ‡ä»¤ï¼šadk deploy agent_engine"
	@echo "   åŠŸèƒ½ï¼šå®Œæ•´ç›£æ§ã€æ“´å±•ã€å®‰å…¨æ€§"
	@echo ""

# æ¼”ç¤ºï¼šéƒ¨ç½²æŒ‡ä»¤åƒè€ƒ
demo-deployment:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "âš™ï¸  éƒ¨ç½²æŒ‡ä»¤åƒè€ƒ"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ  æœ¬åœ°é–‹ç™¼ï¼š"
	@echo "   adk web                           # å•Ÿå‹• ADK ç¶²é  UI"
	@echo "   adk api_server                    # åœ¨æœ¬åœ°å•Ÿå‹• API ä¼ºæœå™¨"
	@echo ""
	@echo "â˜ï¸  é›²ç«¯éƒ¨ç½²ï¼š"
	@echo "   adk deploy cloud_run --project PROJECT --region REGION"
	@echo "      éƒ¨ç½²åˆ° Google Cloud Runï¼ˆç„¡ä¼ºæœå™¨ï¼‰"
	@echo ""
	@echo "ğŸ¤– è¨—ç®¡éƒ¨ç½²ï¼š"
	@echo "   adk deploy agent_engine --project PROJECT --region REGION"
	@echo "      éƒ¨ç½²åˆ° Google çš„è¨—ç®¡ Agent Engine"
	@echo ""
	@echo "ğŸ³ Kubernetes éƒ¨ç½²ï¼š"
	@echo "   adk deploy gke                    # éƒ¨ç½²åˆ° GKE å¢é›†"
	@echo ""
	@echo "ğŸ’¡ ç¯„ä¾‹ï¼šéƒ¨ç½²åˆ° us-central1 çš„ Cloud Run"
	@echo "   adk deploy cloud_run --project my-project --region us-central1"
	@echo ""

# å•Ÿå‹•è‡ªè¨‚ FastAPI ä¼ºæœå™¨
server: check-env
	@echo "ğŸš€ å•Ÿå‹•ç”Ÿç”¢éƒ¨ç½² FastAPI ä¼ºæœå™¨..."
	@echo ""
	@echo "ğŸ“ ä¼ºæœå™¨è©³ç´°è³‡è¨Šï¼š"
	@echo "   â€¢ URLï¼šhttp://localhost:8000"
	@echo "   â€¢ æ–‡ä»¶ï¼šhttp://localhost:8000/docs"
	@echo "   â€¢ å¥åº·ç‹€æ…‹ï¼šhttp://localhost:8000/health"
	@echo ""
	@echo "ğŸ¯ ç¯„ä¾‹è«‹æ±‚ï¼š"
	@echo "   # å¥åº·æª¢æŸ¥"
	@echo "   curl http://localhost:8000/health"
	@echo ""
	@echo "   # èª¿ç”¨ä»£ç†"
	@echo "   curl -X POST http://localhost:8000/invoke \\  "
	@echo "     -H 'Content-Type: application/json' \\"
	@echo "     -d '{\"query\": \"What are deployment options?\"}'"
	@echo ""
	@echo "æŒ‰ Ctrl+C åœæ­¢ä¼ºæœå™¨"
	@echo ""
	python -m uvicorn production_agent.server:app --reload

# é¡¯ç¤º FastAPI æ–‡ä»¶è³‡è¨Š
server-docs:
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "ğŸ“š FASTAPI ä¼ºæœå™¨æ–‡ä»¶"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸš€ å•Ÿå‹•ä¼ºæœå™¨ï¼š"
	@echo "   make server"
	@echo ""
	@echo "ğŸ“– å­˜å–æ–‡ä»¶ï¼š"
	@echo "   â€¢ Swagger UIï¼šhttp://localhost:8000/docs"
	@echo "   â€¢ ReDocï¼šhttp://localhost:8000/redoc"
	@echo ""
	@echo "ğŸ”Œ API ç«¯é»ï¼š"
	@echo ""
	@echo "   GET /health"
	@echo "      æª¢æŸ¥ä¼ºæœå™¨å¥åº·ç‹€æ…‹èˆ‡é‹è¡Œæ™‚é–“"
	@echo "      å‚³å›ï¼šuptime (ç§’), request_count, status"
	@echo ""
	@echo "   POST /invoke"
	@echo "      èª¿ç”¨ç”Ÿç”¢éƒ¨ç½²ä»£ç†"
	@echo "      Body: { \"query\": \"your prompt here\" }"
	@echo "      å‚³å›ï¼š{ \"response\": \"...\", \"status\": \"success\" }"
	@echo ""
	@echo "   GET /"
	@echo "      API æ ¹ç›®éŒ„è³‡è¨Š"
	@echo ""
	@echo "ğŸ’¡ Python ç¯„ä¾‹ï¼š"
	@echo "   import requests"
	@echo "   response = requests.post("
	@echo "       'http://localhost:8000/invoke',"
	@echo "       json={'query': 'What deployment options are available?'}"
	@echo "   )"
	@echo "   print(response.json()['response'])"
	@echo ""

# æ¸…ç†å¿«å–æª”æ¡ˆ
clean:
	@echo "ğŸ§¹ æ¸…ç†å¿«å–æª”æ¡ˆå’Œç”¢ç‰©..."
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type f -name "*.pyd" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .coverage -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name .coverage -delete 2>/dev/null || true
	find . -type f -name coverage.xml -delete 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# æª¢æŸ¥ç’°å¢ƒï¼ˆå…§éƒ¨ä½¿ç”¨ï¼‰
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šæœªè¨­å®šé©—è­‰"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹ä¸€ç¨®é©—è­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 1 - API é‡‘é‘° (Gemini API)ï¼š"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   åœ¨æ­¤å–å¾—å…è²»é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹æ³• 2 - æœå‹™å¸³æˆ¶ (VertexAI)ï¼š"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   åœ¨æ­¤å»ºç«‹æ†‘è­‰ï¼šhttps://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		exit 1; \
	fi
