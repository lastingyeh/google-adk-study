# Makefile for genmedia-agent ADK project
# æ ¹æ“š README.md ç”Ÿæˆçš„è‡ªå‹•åŒ–æ§‹å»ºå’ŒåŸ·è¡Œè…³æœ¬

.PHONY: help install-mcp setup sync dev debug server-imagen clean check-env

# é è¨­ç›®æ¨™ï¼šé¡¯ç¤ºå¹«åŠ©è¨Šæ¯
help:
	@echo "å¯ç”¨çš„ Make ç›®æ¨™ï¼š"
	@echo "  make install-mcp    - å®‰è£ MCP Servers for Genmedia å·¥å…·"
	@echo "  make setup          - åˆå§‹åŒ–å°ˆæ¡ˆç’°å¢ƒ (uv sync)"
	@echo "  make check-env      - æª¢æŸ¥ .env æª”æ¡ˆæ˜¯å¦å­˜åœ¨"
	@echo "  make dev            - å•Ÿå‹• ADK Developer UI (adk web)"
	@echo "  make debug          - å•Ÿå‹• VSCode é™¤éŒ¯æ¨¡å¼"
	@echo "  make server-imagen  - åœ¨èƒŒæ™¯å•Ÿå‹• Imagen MCP Server (SSE)"
	@echo "  make sync           - åŒæ­¥ Go workspace ä¾è³´"
	@echo "  make clean          - æ¸…ç†è‡¨æ™‚æª”æ¡ˆ"
	@echo "  make all            - å®Œæ•´è¨­å®šä¸¦å•Ÿå‹• (install-mcp + setup + dev)"

# MCP ä¼ºæœå™¨ç›¸é—œè·¯å¾‘
MCP_GO_DIR := vertex-ai-creative-studio/experiments/mcp-genmedia/mcp-genmedia-go
GO_BIN := $(shell go env GOPATH)/bin

# å®‰è£ MCP Servers for Genmedia å·¥å…·
install-mcp:
	@echo "ğŸ“¦ å®‰è£ MCP Servers for Genmedia..."
	@if ! command -v go > /dev/null 2>&1; then \
		echo "âŒ éŒ¯èª¤: æ‰¾ä¸åˆ° Goï¼Œè«‹å…ˆå®‰è£ Go"; \
		exit 1; \
	fi
	@cd $(MCP_GO_DIR) && go work sync
	@cd $(MCP_GO_DIR) && go install ./mcp-imagen-go ./mcp-veo-go ./mcp-chirp3-go ./mcp-avtool-go ./mcp-gemini-go ./mcp-lyria-go
	@echo "âœ… MCP ä¼ºæœå™¨å·²å®‰è£è‡³: $(GO_BIN)"
	@echo "ğŸ’¡ æç¤º: è«‹ç¢ºä¿ $(GO_BIN) åœ¨æ‚¨çš„ PATH ä¸­"
	@echo "   åŸ·è¡Œ: export PATH=\"$(GO_BIN):\$$PATH\""

# åŒæ­¥ Go workspace ä¾è³´
sync:
	@echo "ğŸ”„ åŒæ­¥ Go workspace ä¾è³´..."
	@cd $(MCP_GO_DIR) && go work sync
	@echo "âœ… ä¾è³´åŒæ­¥å®Œæˆ"

# æª¢æŸ¥ .env æª”æ¡ˆ
check-env:
	@if [ ! -f genmedia_agent/.env ]; then \
		echo "âš ï¸  è­¦å‘Š: æ‰¾ä¸åˆ° .env æª”æ¡ˆ"; \
		echo ""; \
		echo "è«‹åœ¨ genmedia_agent/.env å»ºç«‹ç’°å¢ƒè®Šæ•¸æª”æ¡ˆï¼ŒåŒ…å«:"; \
		echo "  GOOGLE_CLOUD_PROJECT=\"your-project-id\""; \
		echo "  GOOGLE_CLOUD_LOCATION=\"us-central1\""; \
		echo "  GOOGLE_GENAI_USE_VERTEXAI=\"True\""; \
		echo ""; \
		exit 1; \
	else \
		echo "âœ… .env æª”æ¡ˆå­˜åœ¨"; \
	fi

# åˆå§‹åŒ–å°ˆæ¡ˆç’°å¢ƒ
setup: check-env
	@echo "ğŸ”§ åˆå§‹åŒ–å°ˆæ¡ˆç’°å¢ƒ..."
	@uv sync
	@echo "âœ… å°ˆæ¡ˆç’°å¢ƒè¨­å®šå®Œæˆ"

# å•Ÿå‹• ADK Developer UI
dev: check-env
	@echo "ğŸš€ å•Ÿå‹• ADK Developer UI..."
	@uv sync
	@. .venv/bin/activate && adk web

# å•Ÿå‹• VSCode é™¤éŒ¯æ¨¡å¼
debug: check-env
	@echo "ğŸ› å•Ÿå‹• VSCode é™¤éŒ¯æ¨¡å¼ (ç›£è½åŸ : 5678)..."
	@uv run --with debugpy python -m debugpy --listen 5678 --wait-for-client -m google.adk.cli web . --port 8000 --reload_agents

# åœ¨èƒŒæ™¯å•Ÿå‹• Imagen MCP Server (SSE å”å®š)
server-imagen:
	@echo "ğŸ–¼ï¸  å•Ÿå‹• Imagen MCP Server (SSE)..."
	@export PROJECT_ID=$$(gcloud config get project 2>/dev/null || echo "das-idp-lab") && \
	if [ -z "$$PROJECT_ID" ]; then \
		echo "âŒ éŒ¯èª¤: ç„¡æ³•å–å¾— Google Cloud å°ˆæ¡ˆ ID"; \
		exit 1; \
	fi; \
	echo "ä½¿ç”¨å°ˆæ¡ˆ ID: $$PROJECT_ID"; \
	$(GO_BIN)/mcp-imagen-go --transport sse

# æ¸…ç†è‡¨æ™‚æª”æ¡ˆ
clean:
	@echo "ğŸ§¹ æ¸…ç†è‡¨æ™‚æª”æ¡ˆ..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®Œæ•´è¨­å®šæµç¨‹
all: install-mcp setup
	@echo ""
	@echo "âœ¨ è¨­å®šå®Œæˆï¼"
	@echo ""
	@echo "ä¸‹ä¸€æ­¥ï¼š"
	@echo "  1. åŸ·è¡Œ 'make server-imagen' åœ¨å¦ä¸€å€‹çµ‚ç«¯å•Ÿå‹• Imagen ä¼ºæœå™¨"
	@echo "  2. åŸ·è¡Œ 'make dev' å•Ÿå‹• ADK Developer UI"
	@echo "  æˆ–"
	@echo "  åŸ·è¡Œ 'make debug' å•Ÿå‹•é™¤éŒ¯æ¨¡å¼"
