# æ•™å­¸ 10ï¼šè©•ä¼°èˆ‡æ¸¬è©¦ - å®¢æˆ¶æ”¯æ´ä»£ç†
# ADK ä»£ç†çš„å…¨é¢è©•ä¼°æ¡†æ¶

.PHONY: help setup dev test test-cov eval clean demo

# é è¨­ç›®æ¨™ - é¡¯ç¤ºèªªæ˜
help:
	@echo "ğŸš€ æ•™å­¸ 10ï¼šè©•ä¼°èˆ‡æ¸¬è©¦ - å®¢æˆ¶æ”¯æ´ä»£ç†"
	@echo ""
	@echo "å¿«é€Ÿé–‹å§‹æŒ‡ä»¤:"
	@echo "  make setup     - å®‰è£ç›¸ä¾å¥—ä»¶"
	@echo "  make dev       - å•Ÿå‹•å®¢æˆ¶æ”¯æ´ä»£ç†"
	@echo "  make demo      - é¡¯ç¤ºç¤ºç¯„æç¤ºèˆ‡ç”¨æ³•"
	@echo ""
	@echo "é€²éšæŒ‡ä»¤:"
	@echo "  make test      - åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make test-cov  - åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿæ¶µè“‹ç‡å ±å‘Š"
	@echo "  make eval      - åŸ·è¡Œè©•ä¼°æ¸¬è©¦"
	@echo "  make clean     - æ¸…ç†ç”¢ç”Ÿçš„æª”æ¡ˆ"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨? åŸ·è¡Œ: make setup && make dev"

# è¨­å®šç’°å¢ƒ
setup:
	@echo "ğŸ“¦ å®‰è£ç›¸ä¾å¥—ä»¶ä¸­..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… è¨­å®šå®Œæˆ! åŸ·è¡Œ 'make dev' å•Ÿå‹•ä»£ç†ã€‚"

# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
dev: check-env
	@echo "ğŸ¤– å•Ÿå‹•å®¢æˆ¶æ”¯æ´ä»£ç†ä¸­..."
	@echo "ğŸ“± åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ http://localhost:8000"
	@echo "ğŸ¯ å¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ 'support_agent'"
	@echo ""
	@echo "ğŸ’¡ è©¦è©¦é€™äº›æ”¯æ´å ´æ™¯:"
	@echo "   â€¢ 'How do I reset my password?' (å¦‚ä½•é‡è¨­å¯†ç¢¼?)"
	@echo "   â€¢ 'My account is locked, help!' (æˆ‘çš„å¸³è™Ÿè¢«é–å®šäº†,æ•‘å‘½!)"
	@echo "   â€¢ 'What's your refund policy?' (ä½ å€‘çš„é€€æ¬¾æ”¿ç­–æ˜¯ä»€éº¼?)"
	@echo "   â€¢ 'Check status of ticket TICK-12345678' (æŸ¥è©¢å·¥å–® TICK-12345678 çš„ç‹€æ…‹)"
	@echo ""
	adk web

# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
test: check-env
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦ä¸­..."
	pytest tests/ -v --tb=short

# åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿæ¶µè“‹ç‡å ±å‘Š
test-cov: check-env
	@echo "ğŸ“Š åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿæ¶µè“‹ç‡å ±å‘Šä¸­..."
	pytest tests/ --cov=support_agent --cov-report=html
	@echo "ğŸ“ˆ æ¶µè“‹ç‡å ±å‘Šå·²ç”¢ç”Ÿæ–¼ htmlcov/"

# åŸ·è¡Œè©•ä¼°æ¸¬è©¦
eval: check-env
	@echo "ğŸ” åŸ·è¡Œè©•ä¼°æ¸¬è©¦ä¸­..."
	@echo "ğŸ“‹ æ¸¬è©¦ç°¡å–®å ´æ™¯ä¸­..."
	adk eval support_agent tests/simple.test.json
	@echo "ğŸ« æ¸¬è©¦å·¥å–®å»ºç«‹ä¸­..."
	adk eval support_agent tests/ticket_creation.test.json
	@echo "ğŸ—ï¸  æ¸¬è©¦è¤‡é›œå ´æ™¯ä¸­..."
	adk eval support_agent tests/complex.evalset.json
	@echo "âœ… æ‰€æœ‰è©•ä¼°å®Œæˆ!"

# é¡¯ç¤ºç¤ºç¯„æç¤º
demo:
	@echo "ğŸ¯ å®¢æˆ¶æ”¯æ´ä»£ç†ç¤ºç¯„"
	@echo ""
	@echo "è©¦è©¦é€™äº›æ”¯æ´å ´æ™¯:"
	@echo "1. 'How do I reset my password?' (å¦‚ä½•é‡è¨­å¯†ç¢¼?)"
	@echo "2. 'My account is locked, help!' (æˆ‘çš„å¸³è™Ÿè¢«é–å®šäº†,æ•‘å‘½!)"
	@echo "3. 'What's your refund policy?' (ä½ å€‘çš„é€€æ¬¾æ”¿ç­–æ˜¯ä»€éº¼?)"
	@echo "4. 'Check status of ticket TICK-12345678' (æŸ¥è©¢å·¥å–® TICK-12345678 çš„ç‹€æ…‹)"
	@echo ""
	@echo "ğŸ’¡ åŸ·è¡Œ: make dev"
	@echo "ğŸ”¬ åŸ·è¡Œ: make eval  (é€²è¡Œè‡ªå‹•åŒ–æ¸¬è©¦)"

# æ¸…ç†å¿«å–æª”æ¡ˆ
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸­..."
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .coverage -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name htmlcov -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆ!"

# æª¢æŸ¥ç’°å¢ƒ (å…§éƒ¨ä½¿ç”¨)
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤: æœªé…ç½®èº«ä»½é©—è­‰"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®èº«ä»½é©—è­‰æ–¹æ³•:"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 1 - API é‡‘é‘° (Gemini API):"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   åœ¨æ­¤å–å¾—å…è²»é‡‘é‘°: https://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹æ³• 2 - æœå‹™å¸³æˆ¶ (VertexAI):"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   åœ¨æ­¤å»ºç«‹æ†‘è­‰: https://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		exit 1; \
	fi