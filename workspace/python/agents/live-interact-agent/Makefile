# ==============================================================================
# å®‰è£èˆ‡è¨­å®š (Installation & Setup)
# ==============================================================================

# ä½¿ç”¨ uv å¥—ä»¶ç®¡ç†å™¨å®‰è£ä¾è³´é …ç›®
# é€™å€‹ç›®æ¨™æœƒå…ˆæª¢æŸ¥ 'uv' æŒ‡ä»¤æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œå®ƒæœƒè‡ªå‹•ä¸‹è¼‰ä¸¦å®‰è£ uvã€‚
# æ¥è‘—ï¼Œå®ƒæœƒä½¿ç”¨ 'uv sync' ä¾†åŒæ­¥ Python è™›æ“¬ç’°å¢ƒä¸­çš„ä¾è³´é …ç›®ï¼Œ
# ç„¶å¾Œé€²å…¥ 'frontend' ç›®éŒ„ä¸¦åŸ·è¡Œ 'npm install' ä¾†å®‰è£å‰ç«¯çš„ Node.js ä¾è³´é …ç›®ã€‚
install:
	@command -v uv >/dev/null 2>&1 || { echo "uv is not installed. Installing uv..."; curl -LsSf https://astral.sh/uv/0.8.13/install.sh | sh; source $HOME/.local/bin/env; }
	uv sync && (cd frontend && npm install)

# ==============================================================================
# éŠæ¨‚å ´ç›®æ¨™ (Playground Targets)
# ==============================================================================

# å•Ÿå‹•æœ¬åœ°é–‹ç™¼éŠæ¨‚å ´
# é€™å€‹ç›®æ¨™æœƒå…ˆåŸ·è¡Œ 'build-frontend-if-needed' ä¾†ç¢ºä¿å‰ç«¯å·²ç¶“è¢«å»ºç½®ã€‚
# æ¥è‘—ï¼Œå®ƒæœƒå°å‡ºä¸€å€‹æ­¡è¿æ©«å¹…ï¼Œæä¾›è¨ªå• URL å’Œä½¿ç”¨æç¤ºã€‚
# æœ€å¾Œï¼Œå®ƒä½¿ç”¨ 'uv run' å•Ÿå‹• uvicorn ä¼ºæœå™¨ä¾†é‹è¡Œ FastAPI æ‡‰ç”¨ç¨‹å¼ï¼Œ
# ä¸¦é–‹å•Ÿ --reload é¸é …ï¼Œä»¥ä¾¿åœ¨ç¨‹å¼ç¢¼è®Šæ›´æ™‚è‡ªå‹•é‡å•Ÿä¼ºæœå™¨ã€‚
playground: build-frontend-if-needed
	@echo "==============================================================================="
	@echo "| ğŸš€ æ­£åœ¨å•Ÿå‹•æ‚¨çš„ä»£ç†éŠæ¨‚å ´...                                        |"
	@echo "|                                                                             |"
	@echo "| ğŸŒ è«‹ç”±æ­¤è¨ªå•æ‚¨çš„æ‡‰ç”¨ç¨‹å¼: http://localhost:8000                               |"
	@echo "| ğŸ’¡ è©¦è‘—å•å•: What's the weather in San Francisco?                         |"
	@echo "|                                                                             |"
	@echo "| ğŸ” é‡è¦æç¤º: è«‹é¸æ“‡ 'app' è³‡æ–™å¤¾èˆ‡æ‚¨çš„ä»£ç†äº’å‹•ã€‚          |"
	@echo "==============================================================================="
	uv run uvicorn app.fast_api_app:app --host localhost --port 8000 --reload

# ==============================================================================
# æœ¬åœ°é–‹ç™¼æŒ‡ä»¤ (Local Development Commands)
# ==============================================================================

# å•Ÿå‹•å…·æœ‰ç†±é‡è¼‰åŠŸèƒ½çš„æœ¬åœ°é–‹ç™¼ä¼ºæœå™¨
# é€™å€‹ç›®æ¨™å°ˆé–€ç”¨æ–¼å•Ÿå‹•å¾Œç«¯ API ä¼ºæœå™¨ï¼Œä¸¦å•Ÿç”¨ç†±é‡è¼‰åŠŸèƒ½ã€‚
# ç•¶æ‚¨åªå°ˆæ³¨æ–¼å¾Œç«¯é–‹ç™¼æ™‚ï¼Œé€™éå¸¸æœ‰ç”¨ã€‚
local-backend:
	uv run uvicorn app.fast_api_app:app --host localhost --port 8000 --reload

# ==============================================================================
# ADK Live æŒ‡ä»¤ (ADK Live Commands)
# ==============================================================================

# ç‚ºç”Ÿç”¢ç’°å¢ƒå»ºç½®å‰ç«¯
# é€™å€‹ç›®æ¨™æœƒé€²å…¥ 'frontend' ç›®éŒ„ä¸¦åŸ·è¡Œ 'npm run build' æŒ‡ä»¤ï¼Œ
# é€™é€šå¸¸æœƒå°‡ React/Vue/etc. å°ˆæ¡ˆæ‰“åŒ…æˆéœæ…‹çš„ HTML/CSS/JS æª”æ¡ˆã€‚
build-frontend:
	(cd frontend && npm run build)

# åƒ…åœ¨éœ€è¦æ™‚å»ºç½®å‰ç«¯ (æ¢ä»¶å¼å»ºç½®)
# é€™æ˜¯ä¸€å€‹å„ªåŒ–éçš„ç›®æ¨™ï¼Œå®ƒæœƒæª¢æŸ¥å¹¾ç¨®æƒ…æ³ä¾†æ±ºå®šæ˜¯å¦éœ€è¦é‡æ–°å»ºç½®å‰ç«¯ï¼š
# 1. å¦‚æœ 'frontend/build' ç›®éŒ„æˆ– 'frontend/build/index.html' æª”æ¡ˆä¸å­˜åœ¨ï¼Œå‰‡é€²è¡Œå»ºç½®ã€‚
# 2. å¦‚æœ 'frontend/package.json' (ä¾è³´å®šç¾©æª”) æˆ–ä»»ä½• 'frontend/src' ä¸‹çš„åŸå§‹ç¢¼æª”æ¡ˆæ¯”å»ºç½®å¥½çš„ 'index.html' é‚„è¦æ–°ï¼Œå‰‡é‡æ–°å»ºç½®ã€‚
# 3. å¦‚æœä»¥ä¸Šæ¢ä»¶éƒ½ä¸æ»¿è¶³ï¼Œå‰‡è·³éå»ºç½®ï¼Œå› ç‚ºç›®å‰çš„å»ºç½®æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚
build-frontend-if-needed:
	@if [ ! -d "frontend/build" ] || [ ! -f "frontend/build/index.html" ]; then \
		echo "æœªæ‰¾åˆ°æˆ–ä¸å®Œæ•´çš„å‰ç«¯å»ºç½®ç›®éŒ„ã€‚æ­£åœ¨å»ºç½®..."; \
		$(MAKE) build-frontend; \
	elif [ "frontend/package.json" -nt "frontend/build/index.html" ] || \
		 find frontend/src -newer frontend/build/index.html 2>/dev/null | head -1 | grep -q .; then \
		echo "å‰ç«¯åŸå§‹ç¢¼æª”æ¡ˆæ¯”å»ºç½®ç‰ˆæœ¬æ–°ã€‚æ­£åœ¨é‡æ–°å»ºç½®..."; \
		$(MAKE) build-frontend; \
	else \
		echo "å‰ç«¯å»ºç½®å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚è·³éå»ºç½®..."; \
	fi

# ==============================================================================
# å¾Œç«¯éƒ¨ç½²ç›®æ¨™ (Backend Deployment Targets)
# ==============================================================================

# é ç«¯éƒ¨ç½²ä»£ç†
# ä½¿ç”¨æ–¹å¼: make deploy [IAP=true] [PORT=8080] - è¨­å®š IAP=true ä»¥å•Ÿç”¨ Identity-Aware Proxyï¼ŒPORT ç”¨æ–¼æŒ‡å®šå®¹å™¨ç«¯å£
# é€™å€‹ç›®æ¨™æœƒåŸ·è¡Œä¸€ç³»åˆ— 'gcloud' æŒ‡ä»¤ä¾†å°‡æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²åˆ° Google Cloud Runã€‚
# - PROJECT_ID: å¾ gcloud è¨­å®šä¸­ç²å–ç•¶å‰çš„å°ˆæ¡ˆ IDã€‚
# - gcloud beta run deploy: éƒ¨ç½²æœå‹™ï¼Œåç¨±ç‚º 'live-interact-agent'ã€‚
# - --source .: ä½¿ç”¨ç•¶å‰ç›®éŒ„ä½œç‚ºåŸå§‹ç¢¼é€²è¡Œå»ºç½®ã€‚
# - --memory, --region, --no-allow-unauthenticated, --no-cpu-throttling, --labels: è¨­å®š Cloud Run æœå‹™çš„å„ç¨®é…ç½®ã€‚
# - --update-build-env-vars: åœ¨å»ºç½®éšæ®µè¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œä¾‹å¦‚å¾ pyproject.toml è®€å– AGENT_VERSIONã€‚
# - --update-env-vars: åœ¨é‹è¡Œéšæ®µè¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œä¾‹å¦‚ç›®å‰çš„ git COMMIT_SHAã€‚
# - $(if $(IAP),--iap): å¦‚æœåŸ·è¡Œ make æ™‚å‚³å…¥äº† IAP=trueï¼Œå‰‡æ·»åŠ  --iap æ——æ¨™ã€‚
# - $(if $(PORT),--port=$(PORT)): å¦‚æœåŸ·è¡Œ make æ™‚å‚³å…¥äº† PORT è®Šæ•¸ï¼Œå‰‡è¨­å®šå®¹å™¨ç«¯å£ã€‚
deploy:
	PROJECT_ID=$$(gcloud config get-value project) && \
	gcloud beta run deploy live-interact-agent \
		--source . \
		--memory "4Gi" \
		--project $$PROJECT_ID \
		--region "us-central1" \
		--no-allow-unauthenticated \
		--no-cpu-throttling \
		--labels "created-by=adk" \
		--update-build-env-vars "AGENT_VERSION=$(shell awk -F'"' '/^version = / {print $$2}' pyproject.toml || echo '0.0.0')" \
		--update-env-vars \
		"COMMIT_SHA=$(shell git rev-parse HEAD)" \
		$(if $(IAP),--iap) \
		$(if $(PORT),--port=$(PORT))

# 'make deploy' çš„åˆ¥åï¼Œç”¨æ–¼å‘å¾Œç›¸å®¹
backend: deploy

# ==============================================================================
# åŸºç¤è¨­æ–½è¨­å®š (Infrastructure Setup)
# ==============================================================================

# ä½¿ç”¨ Terraform è¨­å®šé–‹ç™¼ç’°å¢ƒè³‡æº
# é€™å€‹ç›®æ¨™æœƒé€²å…¥ 'deployment/terraform/dev' ç›®éŒ„ï¼Œ
# åˆå§‹åŒ– Terraform ('terraform init')ï¼Œç„¶å¾Œæ‡‰ç”¨é…ç½® ('terraform apply') ä¾†å»ºç«‹æˆ–æ›´æ–° Google Cloud ä¸Šçš„åŸºç¤è¨­æ–½ã€‚
# å®ƒæœƒå°‡ç•¶å‰çš„ gcloud å°ˆæ¡ˆ ID ä½œç‚ºè®Šæ•¸å‚³éçµ¦ Terraformã€‚
setup-dev-env:
	PROJECT_ID=$$(gcloud config get-value project) && \
	(cd deployment/terraform/dev && terraform init && terraform apply --var-file vars/env.tfvars --var dev_project_id=$$PROJECT_ID --auto-approve)

# ==============================================================================
# æ¸¬è©¦èˆ‡ç¨‹å¼ç¢¼å“è³ª (Testing & Code Quality)
# ==============================================================================

# åŸ·è¡Œå–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦
# é€™å€‹ç›®æ¨™æœƒå…ˆä½¿ç”¨ 'uv sync --dev' å®‰è£é–‹ç™¼ç”¨çš„ä¾è³´é …ç›®ã€‚
# ç„¶å¾Œï¼Œå®ƒæœƒåˆ†åˆ¥åŸ·è¡Œ 'tests/unit' å’Œ 'tests/integration' ç›®éŒ„ä¸‹çš„ pytest æ¸¬è©¦ã€‚
test:
	uv sync --dev
	uv run pytest tests/unit && uv run pytest tests/integration

# åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ (codespell, ruff, mypy)
# é€™å€‹ç›®æ¨™æœƒå®‰è£ 'lint' ç›¸é—œçš„ä¾è³´é …ç›®ã€‚
# æ¥è‘—ï¼Œå®ƒæœƒä¾åºåŸ·è¡Œï¼š
# - codespell: æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­çš„æ‹¼å¯«éŒ¯èª¤ã€‚
# - ruff check: æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼å’Œå¸¸è¦‹éŒ¯èª¤ï¼Œä¸¦é¡¯ç¤ºå·®ç•°ã€‚
# - ruff format: æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼æ˜¯å¦ç¬¦åˆè¦ç¯„ï¼Œä¸¦é¡¯ç¤ºå·®ç•°ã€‚
# - mypy: é€²è¡Œéœæ…‹é¡å‹æª¢æŸ¥ã€‚
lint:
	uv sync --dev --extra lint
	uv run codespell
	uv run ruff check . --diff
	uv run ruff format . --check --diff
	uv run mypy .