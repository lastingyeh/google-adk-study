"""
å®˜æ–¹ ADK A2A å”èª¿å™¨ä»£ç† - ä»£ç†å°ä»£ç†ï¼ˆAgent-to-Agentï¼‰é€šè¨Š

æœ¬ç¯„ä¾‹å±•ç¤ºäº†ä½¿ç”¨ RemoteA2aAgent çš„å®˜æ–¹ ADK æ–¹æ³•ä¾†é€²è¡Œåˆ†æ•£å¼ä»£ç†å”èª¿ï¼Œ
ä»¥æ¶ˆè²»é€é 'adk api_server --a2a' å…¬é–‹çš„é ç«¯ä»£ç†ã€‚

### ç¨‹å¼ç¢¼æµç¨‹è¨»è§£

#### æ ¸å¿ƒåŠŸèƒ½
æœ¬è…³æœ¬å®šç¾©äº†ä¸€å€‹åç‚º `a2a_orchestrator` çš„ä¸­å¤®å”èª¿ä»£ç†ã€‚
æ­¤ä»£ç†è² è²¬ç®¡ç†ä¸¦å§”æ´¾ä»»å‹™çµ¦ä¸‰å€‹é ç«¯çš„ç‰¹åŒ–å­ä»£ç†ï¼š
1.  `research_specialist`ï¼šè² è²¬ç¶²è·¯ç ”ç©¶èˆ‡äº‹å¯¦æŸ¥æ ¸ã€‚
2.  `data_analyst`ï¼šè² è²¬è³‡æ–™åˆ†æèˆ‡æ´å¯Ÿç”Ÿæˆã€‚
3.  `content_writer`ï¼šè² è²¬å…§å®¹å‰µä½œèˆ‡æ‘˜è¦æ’°å¯«ã€‚

#### é‹ä½œæµç¨‹
1.  **åˆå§‹åŒ–**ï¼šè…³æœ¬é¦–å…ˆåŒ¯å…¥å¿…è¦çš„ ADK æ¨¡çµ„ï¼Œä¸¦ç‚ºä¸‰å€‹é ç«¯ä»£ç†å»ºç«‹ `RemoteA2aAgent` å¯¦ä¾‹ã€‚æ¯å€‹é ç«¯ä»£ç†éƒ½é€éå…¶ `agent_card` URL é€²è¡Œè­˜åˆ¥ï¼Œè©² URL æŒ‡å‘ä¸€å€‹æè¿°ä»£ç†èƒ½åŠ›çš„ JSON æª”æ¡ˆã€‚
2.  **å·¥å…·å®šç¾©**ï¼šå®šç¾©äº†å…©å€‹è¼”åŠ©å·¥å…·ï¼š
    - `check_agent_availability`ï¼šç”¨æ–¼æª¢æŸ¥é ç«¯ä»£ç†æ˜¯å¦åœ¨ç·šä¸Šä¸”å¯æ­£å¸¸é€šè¨Šã€‚
    - `log_coordination_step`ï¼šç”¨æ–¼åœ¨å”èª¿éç¨‹ä¸­è¨˜éŒ„æ¯å€‹æ­¥é©Ÿï¼Œæ–¹ä¾¿è¿½è¹¤èˆ‡é™¤éŒ¯ã€‚
3.  **å”èª¿å™¨è¨­å®š**ï¼š
    - `root_agent` (å”èª¿å™¨) è¢«è¨­å®šç‚ºä½¿ç”¨ `gemini-2.0-flash` æ¨¡å‹ã€‚
    - `instruction` åƒæ•¸æä¾›äº†è©³ç´°çš„æç¤ºï¼ŒæŒ‡å°å”èª¿å™¨å¦‚ä½•æ ¹æ“šä»»å‹™é¡å‹å°‡å·¥ä½œå§”æ´¾çµ¦æ­£ç¢ºçš„å­ä»£ç†ã€‚
    - `sub_agents` åƒæ•¸å°‡ä¸‰å€‹é ç«¯ä»£ç†è¨»å†Šç‚ºå”èª¿å™¨çš„å­ä»£ç†ï¼Œä½¿å…¶èƒ½å¤ ç›´æ¥å‘¼å«å®ƒå€‘ã€‚
    - `tools` åƒæ•¸å°‡ä¸Šè¿°å®šç¾©çš„è¼”åŠ©å·¥å…·æä¾›çµ¦å”èª¿å™¨ä½¿ç”¨ã€‚
4.  **åŸ·è¡Œ**ï¼šç•¶å”èª¿å™¨æ”¶åˆ°ä¸€å€‹æŸ¥è©¢æ™‚ï¼Œå®ƒæœƒæ ¹æ“šå…¶æŒ‡ç¤ºåˆ†ææŸ¥è©¢å…§å®¹ï¼Œæ±ºå®šéœ€è¦å“ªå€‹ï¼ˆæˆ–å“ªäº›ï¼‰å­ä»£ç†çš„æŠ€èƒ½ï¼Œç„¶å¾Œå°‡ç›¸æ‡‰çš„å­ä»»å‹™å§”æ´¾å‡ºå»ã€‚ä¾‹å¦‚ï¼Œä¸€å€‹éœ€è¦ç ”ç©¶å’Œå¯«ä½œçš„æŸ¥è©¢æœƒå…ˆè¢«é€åˆ° `research_specialist`ï¼Œå…¶çµæœå†äº¤çµ¦ `content_writer` é€²è¡Œè™•ç†ã€‚
"""

# åŒ¯å…¥ ADK æ ¸å¿ƒæ¨¡çµ„
from google.adk.agents import Agent
from google.adk.agents.remote_a2a_agent import RemoteA2aAgent, AGENT_CARD_WELL_KNOWN_PATH
from google.adk.tools import FunctionTool
from google.genai import types


def check_agent_availability(agent_name: str, base_url: str) -> dict:
    """
    æª¢æŸ¥é ç«¯ A2A ä»£ç†æ˜¯å¦å¯ç”¨ã€‚

    æ­¤å‡½å¼æœƒå‘é ç«¯ä»£ç†çš„ agent-card URL ç™¼é€ä¸€å€‹ HTTP GET è«‹æ±‚ï¼Œ
    ä»¥ç¢ºèªä»£ç†ä¼ºæœå™¨æ˜¯å¦æ­£åœ¨é‹è¡Œä¸”å¯å­˜å–ã€‚

    Args:
        agent_name: è¦æª¢æŸ¥çš„ä»£ç†åç¨±ã€‚
        base_url: é ç«¯ä»£ç†çš„åŸºç¤ URL (ä¾‹å¦‚ http://localhost:8001)ã€‚

    Returns:
        ä¸€å€‹åŒ…å«æª¢æŸ¥ç‹€æ…‹ã€å¯ç”¨æ€§èˆ‡è©³ç´°å ±å‘Šçš„å­—å…¸ã€‚
    """
    try:
        # åŒ¯å…¥ requests å‡½å¼åº«ä»¥ç™¼é€ HTTP è«‹æ±‚
        import requests
        # çµ„åˆä»£ç†å¡ç‰‡çš„å®Œæ•´ URL
        card_url = f"{base_url}{AGENT_CARD_WELL_KNOWN_PATH}"
        # ç™¼é€ GET è«‹æ±‚ï¼Œä¸¦è¨­å®š 5 ç§’è¶…æ™‚ä»¥é¿å…ç„¡é™ç­‰å¾…
        response = requests.get(card_url, timeout=5)

        # å¦‚æœå›æ‡‰ç‹€æ…‹ç¢¼ç‚º 200 (OK)ï¼Œè¡¨ç¤ºä»£ç†å¯ç”¨
        if response.status_code == 200:
            return {
                "status": "success",
                "available": True,
                "report": f"ä»£ç† {agent_name} å¯ç”¨",
                "agent_card": response.json()  # å›å‚³ä»£ç†çš„èƒ½åŠ›æè¿°æª”
            }
        else:
            # å¦‚æœç‹€æ…‹ç¢¼ä¸æ˜¯ 200ï¼Œè¡¨ç¤ºä»£ç†æœ‰å•é¡Œ
            return {
                "status": "error",
                "available": False,
                "report": f"ä»£ç† {agent_name} å›å‚³ç‹€æ…‹ {response.status_code}"
            }
    except Exception as e:
        # æ•æ‰è«‹æ±‚éç¨‹ä¸­çš„ä»»ä½•ä¾‹å¤–ç‹€æ³ (ä¾‹å¦‚ç¶²è·¯éŒ¯èª¤ã€è¶…æ™‚)
        return {
            "status": "error",
            "available": False,
            "report": f"æª¢æŸ¥ {agent_name} å¤±æ•—ï¼š{str(e)}"
        }


def log_coordination_step(step: str, agent_name: str = "") -> dict:
    """
    è¨˜éŒ„å”èª¿æ­¥é©Ÿä»¥ä¾›è¿½è¹¤ã€‚

    åœ¨è¤‡é›œçš„å¤šä»£ç†å·¥ä½œæµç¨‹ä¸­ï¼Œæ­¤å‡½å¼æä¾›äº†ä¸€å€‹ç°¡å–®çš„æ–¹æ³•ä¾†è¨˜éŒ„
    å”èª¿å™¨åœ¨æ¯å€‹éšæ®µçš„è¡Œç‚ºï¼Œæ–¹ä¾¿é–‹ç™¼è€…è¿½è¹¤æµç¨‹ã€‚

    Args:
        step: æè¿°ç›®å‰æ­¥é©Ÿçš„å­—ä¸²ã€‚
        agent_name: (å¯é¸) æ­¤æ­¥é©Ÿæ¶‰åŠçš„ä»£ç†åç¨±ã€‚

    Returns:
        ä¸€å€‹åŒ…å«æˆåŠŸç‹€æ…‹èˆ‡æ—¥èªŒè¨Šæ¯çš„å­—å…¸ã€‚
    """
    message = f"ğŸ¯ {step}"
    if agent_name:
        message += f" èˆ‡ {agent_name}"
    print(message)  # åœ¨ä¼ºæœå™¨æ§åˆ¶å°ä¸­å°å‡ºæ—¥èªŒ

    # å›å‚³ä¸€å€‹åŒ…å«æˆåŠŸç‹€æ…‹èˆ‡æ—¥èªŒè¨Šæ¯çš„å­—å…¸ï¼Œè®“ä»£ç†çŸ¥é“æ“ä½œå·²å®Œæˆ
    return {
        "status": "success",
        "report": message,
        "step": step,
        "agent": agent_name
    }


# --- é ç«¯ä»£ç†å®šç¾© ---
# ä½¿ç”¨å®˜æ–¹ ADK RemoteA2aAgent é¡åˆ¥ä¾†å¯¦ä¾‹åŒ–é ç«¯ä»£ç†ã€‚
# æ¯å€‹å¯¦ä¾‹éƒ½ä»£è¡¨ä¸€å€‹ç¨ç«‹é‹è¡Œçš„é ç«¯æœå‹™ã€‚
# `agent_card` URL æŒ‡å‘é ç«¯ä»£ç†ä¼ºæœå™¨è‡ªå‹•ç”¢ç”Ÿçš„ .well-known/agent-card.jsonï¼Œ
# ADK æœƒä½¿ç”¨é€™å€‹æª”æ¡ˆä¾†äº†è§£é ç«¯ä»£ç†çš„èƒ½åŠ›ã€‚

research_agent = RemoteA2aAgent(
    name="research_specialist",
    description="é€²è¡Œç¶²è·¯ç ”ç©¶èˆ‡äº‹å¯¦æŸ¥æ ¸",
    # æŒ‡å®šç ”ç©¶ä»£ç†çš„ agent-card ä½ç½®
    agent_card=f"http://localhost:8001{AGENT_CARD_WELL_KNOWN_PATH}"
)

analysis_agent = RemoteA2aAgent(
    name="data_analyst",
    description="åˆ†æè³‡æ–™ä¸¦ç”¢ç”Ÿæ´å¯Ÿ",
    # æŒ‡å®šåˆ†æä»£ç†çš„ agent-card ä½ç½®
    agent_card=f"http://localhost:8002{AGENT_CARD_WELL_KNOWN_PATH}"
)

content_agent = RemoteA2aAgent(
    name="content_writer",
    description="å»ºç«‹æ›¸é¢å…§å®¹èˆ‡æ‘˜è¦",
    # æŒ‡å®šå…§å®¹ä»£ç†çš„ agent-card ä½ç½®
    agent_card=f"http://localhost:8003{AGENT_CARD_WELL_KNOWN_PATH}"
)

# --- ä¸»è¦å”èª¿å™¨ä»£ç† ---
# ä½¿ç”¨å®˜æ–¹ ADK æ¨¡å¼å®šç¾©ä¸»è¦å”èª¿å™¨ä»£ç† (root_agent)ã€‚
# é€™å€‹ä»£ç†æ˜¯æ•´å€‹ç³»çµ±çš„æ ¸å¿ƒï¼Œè² è²¬æ¥æ”¶ä½¿ç”¨è€…è«‹æ±‚ä¸¦å”èª¿å­ä»£ç†å®Œæˆä»»å‹™ã€‚
root_agent = Agent(
    model="gemini-2.0-flash",
    name="a2a_orchestrator",
    description="ä½¿ç”¨å®˜æ–¹ ADK A2A å”èª¿å¤šå€‹é ç«¯ç‰¹åŒ–ä»£ç†",
    instruction="""
    æ‚¨æ˜¯ä¸€å€‹å”èª¿ä»£ç†ï¼Œä½¿ç”¨å®˜æ–¹çš„ä»£ç†å°ä»£ç†ï¼ˆA2Aï¼‰å”å®šä¾†å”èª¿ç‰¹åŒ–çš„é ç«¯ä»£ç†ã€‚

    **å¯ç”¨çš„é ç«¯ä»£ç† (å­ä»£ç†):**

    1. **research_specialist**: ç”¨æ–¼ç¶²è·¯ç ”ç©¶ã€äº‹å¯¦æŸ¥æ ¸ã€æ™‚äº‹ã€‚
    2. **data_analyst**: ç”¨æ–¼è³‡æ–™åˆ†æã€çµ±è¨ˆã€æ´å¯Ÿã€‚
    3. **content_writer**: ç”¨æ–¼å…§å®¹å‰µä½œã€æ‘˜è¦ã€å¯«ä½œã€‚

    **å®˜æ–¹ ADK A2A å·¥ä½œæµç¨‹:**
    1. æ ¹æ“šä½¿ç”¨è€…è«‹æ±‚çš„æ€§è³ªï¼Œåˆ†æä¸¦æ±ºå®šéœ€è¦å“ªå€‹å­ä»£ç†ã€‚
    2. å°‡ç ”ç©¶ä»»å‹™å§”æ´¾çµ¦ research_specialist å­ä»£ç†ã€‚
    3. å°‡åˆ†æä»»å‹™å§”æ´¾çµ¦ data_analyst å­ä»£ç†ã€‚
    4. å°‡å…§å®¹å‰µä½œä»»å‹™å§”æ´¾çµ¦ content_writer å­ä»£ç†ã€‚
    5. ä½¿ç”¨ log_coordination_step å·¥å…·ä¾†è¿½è¹¤å”èª¿éç¨‹çš„æ¯ä¸€æ­¥ã€‚
    6. (å¯é¸) ä½¿ç”¨ check_agent_availability å·¥å…·ä¾†é©—è­‰ä»£ç†åœ¨å§”æ´¾å‰çš„ç‹€æ…‹ã€‚

    é ç«¯ä»£ç†æ˜¯ä½¿ç”¨ uvicorn + to_a2a() å…¬é–‹çš„ï¼Œä¸¦åœ¨æ‚¨çš„å”èª¿å·¥ä½œæµç¨‹ä¸­ä½œç‚ºå­ä»£ç†ç„¡ç¸«åœ°é‹ä½œã€‚

    åœ¨æ‚¨çš„å›æ‡‰ä¸­ï¼Œå‹™å¿…æ¸…æ¥šåœ°è§£é‡‹æ‚¨è¦å°‡ä»»å‹™å§”æ´¾çµ¦å“ªå€‹é ç«¯ä»£ç†ä»¥åŠé€™éº¼åšçš„åŸå› ã€‚
    """,
    # å°‡ä¸Šé¢å®šç¾©çš„é ç«¯ä»£ç†å¯¦ä¾‹è¨»å†Šç‚ºå”èª¿å™¨çš„å­ä»£ç†ã€‚
    # é€™ä½¿å¾—å”èª¿å™¨å¯ä»¥ç›´æ¥å‘¼å«å®ƒå€‘ï¼Œå°±åƒå‘¼å«æœ¬åœ°å‡½å¼ä¸€æ¨£ã€‚
    sub_agents=[research_agent, analysis_agent, content_agent],
    # æä¾›å”èª¿å™¨åœ¨é‹ä½œæ™‚å¯ä»¥ä½¿ç”¨çš„è¼”åŠ©å·¥å…·ã€‚
    tools=[
        FunctionTool(check_agent_availability),
        FunctionTool(log_coordination_step)
    ],
    # è¨­å®šå…§å®¹ç”Ÿæˆåƒæ•¸ï¼Œä»¥æ§åˆ¶æ¨¡å‹çš„è¼¸å‡ºè¡Œç‚º
    generate_content_config=types.GenerateContentConfig(
        temperature=0.5,  # è¼ƒä½çš„æº«åº¦ç”¢ç”Ÿæ›´å…·æ±ºå®šæ€§çš„å›æ‡‰
        max_output_tokens=2048  # è¨­å®šæœ€å¤§è¼¸å‡º token æ•¸é‡
    )
)
