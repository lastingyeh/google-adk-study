# æ•™å­¸ 17ï¼šAgent-to-Agent é€šè¨Š - ADK å®˜æ–¹å¯¦ä½œ
# ç”¨æ–¼è¨­å®šã€é–‹ç™¼ã€æ¸¬è©¦èˆ‡å±•ç¤ºçš„ Makefile
# å·²æ›´æ–°ç‚ºä½¿ç”¨ Google ADK å®˜æ–¹æ¨¡å¼èˆ‡ adk api_server æŒ‡ä»¤

.PHONY: help setup dev test demo clean lint format start-agents stop-agents check-agents

# é è¨­ç›®æ¨™
help:
	@printf "\nğŸš€ æ•™å­¸ 17ï¼šAgent-to-Agent é€šè¨Š (å®˜æ–¹ ADK)\n\n"
	@printf "å¯ç”¨æŒ‡ä»¤ï¼š\n"
	@printf "  %-15s %s\n" "setup" "å®‰è£ä¾è³´å¥—ä»¶ä¸¦è¨­å®šç’°å¢ƒ"
	@printf "  %-15s %s\n" "start-agents" "å•Ÿå‹•æ‰€æœ‰é ç«¯ A2A agents (å®˜æ–¹ ADK)"
	@printf "  %-15s %s\n" "stop-agents" "åœæ­¢æ‰€æœ‰åŸ·è¡Œä¸­çš„ agents (æ¸…é™¤)"
	@printf "  %-15s %s\n" "check-agents" "æª¢æŸ¥ agent ç‹€æ…‹èˆ‡å¯ç”¨æ€§"
	@printf "  %-15s %s\n" "dev" "å•Ÿå‹• ADK ç¶²ç«™ä»‹é¢"
	@printf "  %-15s %s\n" "test" "åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦"
	@printf "  %-15s %s\n" "demo" "é¡¯ç¤ºæ•™å­¸ç¸½è¦½èˆ‡ç¯„ä¾‹"
	@printf "  %-15s %s\n" "clean" "æ¸…é™¤å¿«å–æª”æ¡ˆèˆ‡ç”¢ç‰©"
	@printf "  %-15s %s\n" "lint" "åŸ·è¡Œç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥"
	@printf "  %-15s %s\n" "format" "ä½¿ç”¨ black èˆ‡ isort æ ¼å¼åŒ–ç¨‹å¼ç¢¼"
	@printf "\n"

# è¨­å®šç’°å¢ƒ
setup:
	@printf "ğŸ“¦ æ­£åœ¨è¨­å®šæ•™å­¸ 17 ç’°å¢ƒ...\n"
	@pip install -r requirements.txt || { printf "âŒ å®‰è£ requirements å¤±æ•—\n"; exit 1; }
	@pip install -e . || { printf "âŒ å®‰è£ä¸»è¦å¥—ä»¶å¤±æ•—\n"; exit 1; }
	@printf "âœ… è¨­å®šå®Œæˆï¼\n"
	@printf "ğŸ“‹ Google ADK ç‰ˆæœ¬ï¼š$(shell pip show google-adk | grep Version | cut -d' ' -f2)\n"
	@printf "ğŸ’¡ è«‹å°‡ a2a_orchestrator/.env.example è¤‡è£½ç‚º .env ä¸¦åŠ å…¥æ‚¨çš„ API é‡‘é‘°ã€‚\n"

# é–‹ç™¼æ¨¡å¼ - å•Ÿå‹• ADK ç¶²ç«™ä»‹é¢
dev:
	@printf "ğŸŒ æ­£åœ¨å•Ÿå‹• ADK ç¶²ç«™ä»‹é¢...\n"
	@printf "   é–‹å•Ÿï¼šhttp://localhost:8000\n"
	@printf "   å¾ agent ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ï¼š'a2a_orchestrator'\n\n"
	@adk web

# åŸ·è¡Œæ¸¬è©¦
test:
	@printf "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦...\n"
	@pytest tests/ -v --tb=short

# å±•ç¤º - é¡¯ç¤ºç¯„ä¾‹ç”¨æ³•
demo:
	@printf "\nğŸ¯ æ•™å­¸ 17ï¼šAgent-to-Agent é€šè¨Š (å®˜æ–¹ ADK)\n\n"
	@printf "æœ¬æ•™å­¸å±•ç¤ºä½¿ç”¨å®˜æ–¹ Google ADK é€²è¡Œåˆ†æ•£å¼ agent çš„å”èª¿ä½œæ¥­ã€‚\n\n"
	@printf "ğŸ”§ ä¸»è¦åŠŸèƒ½ï¼š\n"
	@printf "  â€¢ ç”¨æ–¼ A2A é€šè¨Šçš„å®˜æ–¹ RemoteA2aAgent\n"
	@printf "  â€¢ é€é .well-known/agent-card.json é€²è¡Œ Agent æ¢ç´¢\n"
	@printf "  â€¢ å…·æœ‰è‡ªå‹•å§”æ´¾åŠŸèƒ½çš„å­ agent æ¨¡å¼\n"
	@printf "  â€¢ ä¸‰å€‹ä½¿ç”¨å®˜æ–¹ ADK æ¨¡å¼çš„ç‰¹åŒ–é ç«¯ agents\n\n"
	@printf "ğŸ¤– é ç«¯ Agentsï¼š\n"
	@printf "  ğŸ“š ç ”ç©¶ï¼šhttp://localhost:8001 (ç¶²è·¯æœå°‹ã€äº‹å¯¦æŸ¥æ ¸)\n"
	@printf "  ğŸ“Š åˆ†æï¼šhttp://localhost:8002 (è³‡æ–™åˆ†æã€æ´å¯Ÿ)\n"
	@printf "  âœï¸  å…§å®¹ï¼šhttp://localhost:8003 (å…§å®¹å‰µä½œã€æ ¼å¼åŒ–)\n\n"
	@printf "ğŸ’¡ ç¯„ä¾‹æŸ¥è©¢ï¼š\n"
	@printf "  â€¢ 'ç ”ç©¶é‡å­è¨ˆç®—çš„ç™¼å±•ä¸¦å»ºç«‹æ‘˜è¦'\n"
	@printf "  â€¢ 'åˆ†æé›»å‹•è»Šå¸‚å ´è¶¨å‹¢'\n"
	@printf "  â€¢ 'ç‚ºæˆ‘å€‘çš„äººå·¥æ™ºæ…§å¹³å°å»ºç«‹æŠ€è¡“æ–‡ä»¶'\n\n"
	@printf "ğŸš€ å¿«é€Ÿå…¥é–€ï¼š\n"
	@printf "  1. make setup\n"
	@printf "  2. å°‡ .env.example è¤‡è£½ç‚º .env + åŠ å…¥ GOOGLE_API_KEY\n"
	@printf "  3. make start-agents  (å•Ÿå‹•å®˜æ–¹ ADK A2A ä¼ºæœå™¨)\n"
	@printf "  4. make check-agents  (é©—è­‰é€šè¨Šæ˜¯å¦æ­£å¸¸)\n"
	@printf "  5. make dev          (å•Ÿå‹• ADK ç¶²ç«™ä»‹é¢)\n\n"
	@printf "ğŸ”§ ç®¡ç†æŒ‡ä»¤ï¼š\n"
	@printf "  â€¢ make check-agents  (é©—è­‰æ‰€æœ‰ agents æ˜¯å¦æ­£åœ¨åŸ·è¡Œ)\n"
	@printf "  â€¢ make stop-agents   (æ¸…é™¤ä¸¦é—œæ©Ÿ)\n"
	@printf "  â€¢ ./start_a2a_servers.sh  (ç›´æ¥ä½¿ç”¨è…³æœ¬)\n"
	@printf "  â€¢ ./stop_a2a_servers.sh   (ç›´æ¥æ¸…é™¤)\n\n"
	@printf "âœ¨ å®˜æ–¹ ADK å¯¦ä½œï¼š\n"
	@printf "  â€¢ ä½¿ç”¨ google.adk.agents çš„ RemoteA2aAgent é¡åˆ¥\n"
	@printf "  â€¢ ç”¨æ–¼å…¬é–‹ agents çš„å®˜æ–¹ to_a2a() å‡½å¼\n"
	@printf "  â€¢ è‡ªå‹•ç”¢ç”Ÿçš„ .well-known/agent-card.json\n"
	@printf "  â€¢ ç”¨æ–¼ A2A ä¼ºæœå™¨çš„ uvicorn + to_a2a() æ¨¡å¼\n\n"

# æ¸…ç†
clean:
	@printf "ğŸ§¹ æ­£åœ¨æ¸…ç†...\n"
	@find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type f -name ".coverage" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".adk_cache" -exec rm -rf {} + 2>/dev/null || true
	@rm -f .agent_pids 2>/dev/null || true
	@printf "âœ… æ¸…ç†å®Œæˆã€‚\n"

# ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
lint:
	@printf "ğŸ” æ­£åœ¨åŸ·è¡Œç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥...\n"
	@flake8 a2a_orchestrator tests --max-line-length=100 || { printf "âŒ ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥å¤±æ•—\n"; exit 1; }
	@printf "âœ… ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥é€šé (æ ¼å¼å¯èƒ½éœ€è¦æ³¨æ„)ã€‚\n"

# ç¨‹å¼ç¢¼æ ¼å¼åŒ–
format:
	@printf "ğŸ¨ æ­£åœ¨æ ¼å¼åŒ–ç¨‹å¼ç¢¼...\n"
	@isort a2a_orchestrator tests || { printf "âŒ åŒ¯å…¥æ’åºå¤±æ•—\n"; exit 1; }
	@black a2a_orchestrator tests || { printf "âŒ Black æ ¼å¼åŒ–å¤±æ•—\n"; exit 1; }
	@printf "âœ… ç¨‹å¼ç¢¼æ ¼å¼åŒ–å®Œæˆã€‚\n"

# ä½¿ç”¨å®˜æ–¹ ADK æŒ‡ä»¤å•Ÿå‹•é ç«¯ A2A agents
start-agents:
	@printf "ğŸš€ æ­£åœ¨ä½¿ç”¨å®˜æ–¹ ADK ä¼ºæœå™¨å•Ÿå‹•é ç«¯ A2A agents...\n"
	@./start_a2a_servers.sh

# ä½¿ç”¨å®˜æ–¹ ADK æ¸…ç†åŠŸèƒ½åœæ­¢é ç«¯ agents
stop-agents:
	@printf "ğŸ›‘ æ­£åœ¨ä»¥æ¸…é™¤ä¸¦é—œæ©Ÿçš„æ–¹å¼åœæ­¢é ç«¯ A2A agents...\n"
	@./stop_a2a_servers.sh

# æª¢æŸ¥ agent ç‹€æ…‹èˆ‡å¯ç”¨æ€§
check-agents:
	@printf "ğŸ” æ­£åœ¨æª¢æŸ¥ A2A agent ç‹€æ…‹...\n\n"
	@printf "ğŸ”¬ ç ”ç©¶ Agent (8001): "
	@curl -s http://localhost:8001/.well-known/agent-card.json | jq -r '.name' 2>/dev/null || printf "âŒ ç„¡å›æ‡‰\n"
	@printf "ğŸ“Š åˆ†æ Agent (8002): "
	@curl -s http://localhost:8002/.well-known/agent-card.json | jq -r '.name' 2>/dev/null || printf "âŒ ç„¡å›æ‡‰\n"
	@printf "âœï¸  å…§å®¹ Agent (8003):  "
	@curl -s http://localhost:8003/.well-known/agent-card.json | jq -r '.name' 2>/dev/null || printf "âŒ ç„¡å›æ‡‰\n"
	@printf "\nğŸ’¡ å¦‚æœ agents æ²’æœ‰å›æ‡‰ï¼Œè«‹åŸ·è¡Œ 'make start-agents'\n"
