# æ•™å­¸ 30ï¼šNext.js ADK æ•´åˆ
# ç”¨æ–¼ç®¡ç†å¾Œç«¯å’Œå‰ç«¯çš„ Makefile

.PHONY: help setup setup-backend setup-frontend dev dev-backend dev-frontend test clean demo

# é è¨­ç›®æ¨™ - é¡¯ç¤ºèªªæ˜
help:
	@echo "ğŸš€ æ•™å­¸ 30ï¼šNext.js ADK æ•´åˆ"
	@echo ""
	@echo "å¿«é€Ÿå…¥é–€æŒ‡ä»¤ï¼š"
	@echo "  make setup          - å®‰è£æ‰€æœ‰ç›¸ä¾å¥—ä»¶ (å¾Œç«¯ + å‰ç«¯)"
	@echo "  make dev            - å•Ÿå‹•å¾Œç«¯å’Œå‰ç«¯ä¼ºæœå™¨"
	@echo "  make dev-backend    - åƒ…å•Ÿå‹•å¾Œç«¯ä¼ºæœå™¨"
	@echo "  make dev-frontend   - åƒ…å•Ÿå‹•å‰ç«¯ä¼ºæœå™¨"
	@echo "  make demo           - é¡¯ç¤ºç¤ºç¯„æç¤ºå’Œç”¨æ³•"
	@echo ""
	@echo "é€²éšæŒ‡ä»¤ï¼š"
	@echo "  make test           - åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make clean          - æ¸…ç†ç”¢ç”Ÿçš„æª”æ¡ˆ"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹åŸ·è¡Œï¼šmake setup && make dev"
	@echo ""
	@echo "æ¶æ§‹ï¼š"
	@echo "  å¾Œç«¯ï¼šPython FastAPI + ADK agent (åŸ è™Ÿ 8000)"
	@echo "  å‰ç«¯ï¼šNext.js 15 + CopilotKit (åŸ è™Ÿ 3000)"

# å®‰è£æ‰€æœ‰ç›¸ä¾å¥—ä»¶
setup: setup-backend setup-frontend
	@echo "âœ… è¨­å®šå®Œæˆï¼"
	@echo ""
	@echo "å¾ŒçºŒæ­¥é©Ÿï¼š"
	@echo "  1. è¨­å®š API é‡‘é‘°ï¼šcp agent/.env.example agent/.env"
	@echo "  2. ç·¨è¼¯ agent/.env ä¸¦åŠ å…¥æ‚¨çš„ GOOGLE_API_KEY"
	@echo "  3. åŸ·è¡Œï¼šmake dev"

# å®‰è£å¾Œç«¯ç›¸ä¾å¥—ä»¶
setup-backend:
	@echo "ğŸ“¦ æ­£åœ¨å®‰è£å¾Œç«¯ç›¸ä¾å¥—ä»¶..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… å¾Œç«¯è¨­å®šå®Œæˆï¼"

# å®‰è£å‰ç«¯ç›¸ä¾å¥—ä»¶
setup-frontend:
	@echo "ğŸ“¦ æ­£åœ¨å®‰è£å‰ç«¯ç›¸ä¾å¥—ä»¶..."
	@if [ ! -d "nextjs_frontend/node_modules" ]; then \
		cd nextjs_frontend && npm install; \
	else \
		echo "å‰ç«¯ç›¸ä¾å¥—ä»¶å·²å®‰è£ã€‚åŸ·è¡Œ 'make clean' ä»¥é‡æ–°å®‰è£ã€‚"; \
	fi
	@echo "âœ… å‰ç«¯è¨­å®šå®Œæˆï¼"

# åŒæ™‚å•Ÿå‹•å¾Œç«¯å’Œå‰ç«¯
dev:
	@echo "ğŸš€ æ­£åœ¨å•Ÿå‹•å¾Œç«¯å’Œå‰ç«¯ä¼ºæœå™¨..."
	@echo ""
	@echo "é€™å°‡é–‹å•Ÿå…©å€‹çµ‚ç«¯æ©Ÿï¼š"
	@echo "  çµ‚ç«¯æ©Ÿ 1ï¼šå¾Œç«¯ (http://localhost:8000)"
	@echo "  çµ‚ç«¯æ©Ÿ 2ï¼šå‰ç«¯ (http://localhost:3000)"
	@echo ""
	@echo "æŒ‰ Ctrl+C åœæ­¢å…©å€‹ä¼ºæœå™¨"
	@echo ""
	@$(MAKE) dev-parallel

# å¹³è¡Œå•Ÿå‹•å¾Œç«¯å’Œå‰ç«¯ (å…§éƒ¨ä½¿ç”¨)
dev-parallel: check-env
	@trap 'kill 0' EXIT; \
	(cd agent && python agent.py) & \
	(cd nextjs_frontend && npm run dev) & \
	wait

# åƒ…å•Ÿå‹•å¾Œç«¯ä¼ºæœå™¨
dev-backend: check-env
	@echo "ğŸ¤– æ­£åœ¨å•Ÿå‹•å¾Œç«¯ä¼ºæœå™¨..."
	@echo "ğŸ“± ä¼ºæœå™¨ï¼šhttp://localhost:8000"
	@echo "ğŸ“š API æ–‡ä»¶ï¼šhttp://localhost:8000/docs"
	@echo "ğŸ’¬ CopilotKit ç«¯é»ï¼šhttp://localhost:8000/api/copilotkit"
	@echo ""
	cd agent && python agent.py

# åƒ…å•Ÿå‹•å‰ç«¯ä¼ºæœå™¨
dev-frontend:
	@echo "ğŸŒ æ­£åœ¨å•Ÿå‹•å‰ç«¯ä¼ºæœå™¨..."
	@echo "ğŸ“± åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ http://localhost:3000"
	@echo ""
	@echo "âš ï¸  è«‹ç¢ºèªå¾Œç«¯æ­£åœ¨åŸ è™Ÿ 8000 åŸ·è¡Œ"
	@echo "    åœ¨å¦ä¸€å€‹çµ‚ç«¯æ©ŸåŸ·è¡Œï¼šmake dev-backend"
	@echo ""
	cd nextjs_frontend && npm run dev

# åŸ·è¡Œæ¸¬è©¦
test: check-env
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦..."
	pytest tests/ -v --tb=short

# åŸ·è¡Œç¤ºç¯„
demo: check-env
	@echo "ğŸ’¬ ç¤ºç¯„ï¼šå®¢æˆ¶æ”¯æ´ä»£ç†äºº (Customer Support Agent)"
	@echo ""
	@echo "=================================="
	@echo "åœ¨èŠå¤©ä»‹é¢ä¸­å˜—è©¦é€™äº›æç¤ºï¼š"
	@echo "=================================="
	@echo ""
	@echo "ğŸ“š çŸ¥è­˜åº«æŸ¥è©¢ï¼š"
	@echo "  â€¢ 'ä½ çš„é€€æ¬¾æ”¿ç­–æ˜¯ä»€éº¼ï¼Ÿ (What is your refund policy?)'"
	@echo "  â€¢ 'é‹é€éœ€è¦å¤šä¹…ï¼Ÿ (How long does shipping take?)'"
	@echo "  â€¢ 'å‘Šè¨´æˆ‘é—œæ–¼ä¿å›ºçš„è³‡è¨Š (Tell me about your warranty)'"
	@echo "  â€¢ 'æˆ‘è¦å¦‚ä½•é‡è¨­å¯†ç¢¼ï¼Ÿ (How do I reset my password?)'"
	@echo ""
	@echo "ğŸ“¦ è¨‚å–®ç‹€æ…‹ï¼š"
	@echo "  â€¢ 'æª¢æŸ¥è¨‚å–® ORD-12345 çš„ç‹€æ…‹'"
	@echo "  â€¢ 'è¨‚å–® ORD-67890 çš„ç‹€æ…‹å¦‚ä½•ï¼Ÿ'"
	@echo "  â€¢ 'è¿½è¹¤æˆ‘çš„è¨‚å–® ORD-11111'"
	@echo ""
	@echo "ğŸ« æ”¯æ´å·¥å–®ï¼š"
	@echo "  â€¢ 'æˆ‘çš„ç”¢å“åœ¨ 2 å€‹æœˆå¾Œåœæ­¢é‹ä½œ'"
	@echo "  â€¢ 'æˆ‘éœ€è¦å”åŠ©è§£æ±ºå¸³å–®å•é¡Œ'"
	@echo "  â€¢ 'ç‚ºå¸³æˆ¶å­˜å–å•é¡Œå»ºç«‹å·¥å–®'"
	@echo ""
	@echo "=================================="
	@echo ""
	@echo "ä½¿ç”¨èªªæ˜ï¼š"
	@echo "  1. å•Ÿå‹•ä¼ºæœå™¨ï¼šmake dev"
	@echo "  2. é–‹å•Ÿ http://localhost:3000"
	@echo "  3. è¼¸å…¥ä¸Šè¿°ä»»ä½•æç¤º"
	@echo "  4. è§€çœ‹ä»£ç†äººè‡ªå‹•ä½¿ç”¨å·¥å…·ï¼"
	@echo ""
	@echo "æ¶æ§‹ï¼š"
	@echo "  ä½¿ç”¨è€… â†’ Next.js (åŸ è™Ÿ 3000) â†’ FastAPI (åŸ è™Ÿ 8000) â†’ ADK Agent â†’ Gemini"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .pytest_cache/
	cd nextjs_frontend && rm -rf .next/ node_modules/.cache/ || true
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# æª¢æŸ¥ç’°å¢ƒ (å…§éƒ¨ä½¿ç”¨)
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šæœªè¨­å®šé©—è­‰"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®é©—è­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 1 - API é‡‘é‘° (Gemini API)ï¼š"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   åœ¨ä»¥ä¸‹ç¶²å€å–å¾—å…è²»é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹æ³• 2 - æœå‹™å¸³æˆ¶ (VertexAI)ï¼š"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   åœ¨ä»¥ä¸‹ç¶²å€å»ºç«‹æ†‘è­‰ï¼šhttps://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		exit 1; \
	fi

# é‡é»æ‘˜è¦
# - **æ ¸å¿ƒæ¦‚å¿µ**ï¼šç”¨æ–¼ç®¡ç†å¾Œç«¯ (FastAPI) å’Œå‰ç«¯ (Next.js) ä¼ºæœå™¨çš„ Makefileï¼Œæ”¯æ´å®¢æˆ¶æ”¯æ´ä»£ç†äººæ•™å­¸å°ˆæ¡ˆã€‚
# - **é—œéµæŠ€è¡“**ï¼šMake, Python (pip), Node.js (npm), FastAPI, Next.jsã€‚
# - **é‡è¦çµè«–**ï¼šæä¾›äº†ä¸€çµ„æ¨™æº–åŒ–æŒ‡ä»¤ä¾†ç°¡åŒ–å®‰è£ (`make setup`)ã€é–‹ç™¼ (`make dev`)ã€æ¸¬è©¦ (`make test`) å’Œæ¸…ç† (`make clean`) æµç¨‹ã€‚
# - **è¡Œå‹•é …ç›®**ï¼šç„¡ã€‚
