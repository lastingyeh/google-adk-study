# æ•™å­¸ï¼šGEPA (éºå‚³æ¼”ç®—æ³•-å¸•é›·æ‰˜æç¤ºæœ€ä½³åŒ–)
# ç”¨æ–¼ç®¡ç†æ­¤æ•™å­¸çš„ Makefile

.PHONY: help setup dev test demo real-demo clean check

# é è¨­ç›®æ¨™ - é¡¯ç¤ºèªªæ˜
help:
	@echo "ğŸ§¬ GEPA æœ€ä½³åŒ–æ•™å­¸"
	@echo ""
	@echo "å¿«é€Ÿå…¥é–€æŒ‡ä»¤ï¼š"
	@echo "  make setup          - å®‰è£ä¾è³´å¥—ä»¶"
	@echo "  make dev            - å•Ÿå‹• ADK ç¶²ç«™ä»‹é¢"
	@echo "  make demo           - é¡¯ç¤ºæ¨¡æ“¬çš„ GEPA å±•ç¤º (2 åˆ†é˜)"
	@echo "  make real-demo      - åŸ·è¡Œå¸¶æœ‰ LLM åæ€çš„çœŸå¯¦ GEPA"
	@echo ""
	@echo "é–‹ç™¼æŒ‡ä»¤ï¼š"
	@echo "  make test           - åŸ·è¡Œæ¸¬è©¦"
	@echo "  make check          - åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥"
	@echo ""
	@echo "æ¸…ç†ï¼š"
	@echo "  make clean          - ç§»é™¤ç”Ÿæˆçš„æª”æ¡ˆ"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹åŸ·è¡Œï¼šmake setup && make demo"
	@echo "ğŸš€ éœ€è¦é€²è¡ŒçœŸå¯¦æœ€ä½³åŒ–ï¼Ÿè«‹åŸ·è¡Œï¼šmake real-demo"

# å®‰è£ä¾è³´å¥—ä»¶
setup:
	@echo "ğŸ“¦ å®‰è£ä¾è³´å¥—ä»¶ä¸­..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… è¨­å®šå®Œæˆï¼"
	@echo ""
	@echo "å¾ŒçºŒæ­¥é©Ÿï¼š"
	@echo "  1. è¨­å®š API é‡‘é‘°ï¼šcp gepa_agent/.env.example gepa_agent/.env"
	@echo "  2. ç·¨è¼¯ gepa_agent/.env ä¸¦åŠ å…¥æ‚¨çš„ GOOGLE_API_KEY"
	@echo "  3. åŸ·è¡Œï¼šmake dev"

# å•Ÿå‹• ADK ç¶²ç«™ä»‹é¢
dev: check-env
	@echo "ğŸš€ å•Ÿå‹• ADK ç¶²ç«™ä»‹é¢ä¸­..."
	@echo "ğŸ“± é–‹å•Ÿ http://localhost:8000 ä¸¦é¸æ“‡ 'gepa_agent'"
	@echo "æŒ‰ä¸‹ Ctrl+C ä»¥åœæ­¢"
	@echo ""
	adk web

# åŸ·è¡Œæ¸¬è©¦
test:
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦ä¸­..."
	pytest tests/ -v --tb=short -x

# åŸ·è¡ŒåŒ…å«è¦†è“‹ç‡çš„æ¸¬è©¦
test-coverage:
	@echo "ğŸ“Š åŸ·è¡ŒåŒ…å«è¦†è“‹ç‡çš„æ¸¬è©¦ä¸­..."
	pytest tests/ -v --cov=gepa_agent --cov-report=html --cov-report=term
	@echo ""
	@echo "ğŸ“ˆ è¦†è“‹ç‡å ±å‘Šå·²ç”Ÿæˆæ–¼ htmlcov/index.html"

# é¡¯ç¤º GEPA æ¼”åŒ–éç¨‹çš„å±•ç¤ºæç¤º
demo:
	@echo "ğŸ§¬ åŸ·è¡Œ GEPA æ¼”åŒ–å±•ç¤ºä¸­..."
	@echo ""
	python gepa_demo.py

# åŸ·è¡Œå¸¶æœ‰å¯¦éš› LLM åæ€å’Œæ¼”åŒ–çš„çœŸå¯¦ GEPA
real-demo: check-env
	@echo "ğŸ§¬ åŸ·è¡ŒçœŸå¯¦ GEPA æ¼”åŒ–å±•ç¤ºä¸­..."
	@echo ""
	@echo "æ­¤å±•ç¤ºä½¿ç”¨å¯¦éš›çš„ LLM å‘¼å«é€²è¡Œåæ€èˆ‡æ¼”åŒ–ã€‚"
	@echo "æ‚¨å°‡æœƒè¢«æ”¶å– API å‘¼å«è²»ç”¨ (æ¯æ¬¡åŸ·è¡Œç´„ $0.05-$0.10)ã€‚"
	@echo ""
	python gepa_real_demo.py

# åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
check:
	@echo "ğŸ” åŸ·è¡Œç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ä¸­..."
	@echo ""
	@echo "åŸ·è¡Œ ruff..."
	ruff check gepa_agent tests
	@echo "âœ“ ruff é€šé"
	@echo ""
	@echo "åŸ·è¡Œ black..."
	black --check gepa_agent tests
	@echo "âœ“ black é€šé"
	@echo ""
	@echo "åŸ·è¡Œ mypy..."
	mypy gepa_agent
	@echo "âœ“ mypy é€šé"
	@echo ""
	@echo "âœ… æ‰€æœ‰æª¢æŸ¥çš†å·²é€šéï¼"

# æ ¼å¼åŒ–ç¨‹å¼ç¢¼
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ç¨‹å¼ç¢¼ä¸­..."
	black gepa_agent tests
	ruff check --fix gepa_agent tests
	@echo "âœ… æ ¼å¼åŒ–å®Œæˆï¼"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸­..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/
	rm -rf htmlcov/
	rm -rf .coverage
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šæœªè¨­å®šé©—è­‰"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®é©—è­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹å¼ 1 - API é‡‘é‘° (Gemini API)ï¼š"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   è«‹è‡³æ­¤è™•å–å¾—å…è²»é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹å¼ 2 - æœå‹™å¸³è™Ÿ (VertexAI)ï¼š"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo ""; \
		exit 1; \
	fi
