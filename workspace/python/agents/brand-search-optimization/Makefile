.PHONY: help install setup test eval run clean format lint all deploy

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# é¢œè‰²è¾“å‡º
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[0;33m
NC := \033[0m # No Color

# ============================================================================
# å¸®åŠ©ä¿¡æ¯
# ============================================================================

help:
	@echo "$(BLUE)=== å“ç‰Œæœå°‹å„ªåŒ– (Brand Search Optimization) ===$(NC)"
	@echo ""
	@echo "$(GREEN)å¯ç”¨å‘½ä»¤:$(NC)"
	@echo "  $(YELLOW)make install$(NC)         - å®‰è£å°ˆæ¡ˆä¾è³´ï¼ˆä½¿ç”¨ Poetryï¼‰"
	@echo "  $(YELLOW)make setup$(NC)           - å®Œæ•´è¨­å®šï¼šå®‰è£ä¾è³´ + å¡«å…¥ BigQuery è³‡æ–™"
	@echo "  $(YELLOW)make test$(NC)            - åŸ·è¡Œå–®å…ƒæ¸¬è©¦"
	@echo "  $(YELLOW)make eval$(NC)            - åŸ·è¡Œè©•ä¼°æ¸¬è©¦ï¼ˆéœ€è¦ adk å·¥å…·ï¼‰"
	@echo "  $(YELLOW)make run$(NC)             - åŸ·è¡Œä¸»ç¨‹å¼"
	@echo "  $(YELLOW)make deploy-create$(NC)   - å»ºç«‹ä¸¦éƒ¨ç½²æ–°çš„é ç«¯ä»£ç†ç¨‹å¼"
	@echo "  $(YELLOW)make deploy-delete$(NC)   - åˆªé™¤ç¾æœ‰çš„é ç«¯ä»£ç†ç¨‹å¼"
	@echo "  $(YELLOW)make lint$(NC)            - åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥ï¼ˆéœ€è¦å®‰è£ lint å·¥å…·ï¼‰"
	@echo "  $(YELLOW)make format$(NC)          - æ ¼å¼åŒ–ç¨‹å¼ç¢¼ï¼ˆéœ€è¦å®‰è£ format å·¥å…·ï¼‰"
	@echo "  $(YELLOW)make clean$(NC)           - æ¸…ç†ç·¨è­¯æª”æ¡ˆå’Œå¿«å–"
	@echo "  $(YELLOW)make all$(NC)             - å®Œæ•´æµç¨‹ï¼šå®‰è£ + è¨­å®š + æ¸¬è©¦"
	@echo ""
	@echo "$(GREEN)ç’°å¢ƒè¨­å®š:$(NC)"
	@echo "  - è¤‡è£½ env.example ä¸¦å»ºç«‹ .env æª”æ¡ˆ"
	@echo "  - åŸ·è¡Œ 'gcloud auth application-default login' é€²è¡Œ Google Cloud èªè­‰"
	@echo "  - è¨­å®š GOOGLE_CLOUD_PROJECT å’Œ GOOGLE_CLOUD_LOCATION"
	@echo ""

# ============================================================================
# å®‰è£èˆ‡è¨­å®š
# ============================================================================

install:
	@echo "$(BLUE)ğŸ“¦ å®‰è£å°ˆæ¡ˆä¾è³´...$(NC)"
	poetry install

setup:
	@echo "$(BLUE)âš™ï¸  åŸ·è¡Œå®Œæ•´è¨­å®š...$(NC)"
	sh deployment/run.sh

# ============================================================================
# æ¸¬è©¦èˆ‡è©•ä¼°
# ============================================================================

test:
	@echo "$(BLUE)ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦...$(NC)"
	sh deployment/test.sh

eval:
	@echo "$(BLUE)ğŸ“Š åŸ·è¡Œè©•ä¼°æ¸¬è©¦...$(NC)"
	sh deployment/eval.sh

# ============================================================================
# åŸ·è¡Œ
# ============================================================================

run:
	@echo "$(BLUE)â–¶ï¸  åŸ·è¡Œä¸»ç¨‹å¼...$(NC)"
	poetry run python main.py

# ============================================================================
# éƒ¨ç½²
# ============================================================================

deploy-create:
	@echo "$(BLUE)ğŸš€ å»ºç«‹ä¸¦éƒ¨ç½²é ç«¯ä»£ç†ç¨‹å¼...$(NC)"
	@if [ -z "$(PROJECT)" ]; then \
		echo "$(YELLOW)éŒ¯èª¤: æœªæä¾› PROJECT ID$(NC)"; \
		echo "ç”¨æ³•: make deploy-create PROJECT=<your-project-id> LOCATION=<location> BUCKET=<bucket-name>"; \
		exit 1; \
	fi
	@if [ -z "$(LOCATION)" ]; then \
		echo "$(YELLOW)éŒ¯èª¤: æœªæä¾› LOCATION$(NC)"; \
		echo "ç”¨æ³•: make deploy-create PROJECT=<your-project-id> LOCATION=<location> BUCKET=<bucket-name>"; \
		exit 1; \
	fi
	@if [ -z "$(BUCKET)" ]; then \
		echo "$(YELLOW)éŒ¯èª¤: æœªæä¾› BUCKET$(NC)"; \
		echo "ç”¨æ³•: make deploy-create PROJECT=<your-project-id> LOCATION=<location> BUCKET=<bucket-name>"; \
		exit 1; \
	fi
	poetry run python -m deployment.deploy \
		--project_id=$(PROJECT) \
		--location=$(LOCATION) \
		--bucket=$(BUCKET) \
		--create

deploy-delete:
	@echo "$(BLUE)ğŸ—‘ï¸  åˆªé™¤é ç«¯ä»£ç†ç¨‹å¼...$(NC)"
	@if [ -z "$(PROJECT)" ]; then \
		echo "$(YELLOW)éŒ¯èª¤: æœªæä¾› PROJECT ID$(NC)"; \
		echo "ç”¨æ³•: make deploy-delete PROJECT=<your-project-id> LOCATION=<location> RESOURCE_ID=<resource-id>"; \
		exit 1; \
	fi
	@if [ -z "$(LOCATION)" ]; then \
		echo "$(YELLOW)éŒ¯èª¤: æœªæä¾› LOCATION$(NC)"; \
		echo "ç”¨æ³•: make deploy-delete PROJECT=<your-project-id> LOCATION=<location> RESOURCE_ID=<resource-id>"; \
		exit 1; \
	fi
	@if [ -z "$(RESOURCE_ID)" ]; then \
		echo "$(YELLOW)éŒ¯èª¤: æœªæä¾› RESOURCE_ID$(NC)"; \
		echo "ç”¨æ³•: make deploy-delete PROJECT=<your-project-id> LOCATION=<location> RESOURCE_ID=<resource-id>"; \
		exit 1; \
	fi
	poetry run python -m deployment.deploy \
		--project_id=$(PROJECT) \
		--location=$(LOCATION) \
		--resource_id=$(RESOURCE_ID) \
		--delete

# ============================================================================
# ç¨‹å¼ç¢¼å“è³ª
# ============================================================================

lint:
	@echo "$(BLUE)ğŸ” åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥...$(NC)"
	@command -v pylint >/dev/null 2>&1 || { echo "$(YELLOW)pylint æœªå®‰è£ï¼Œè«‹åŸ·è¡Œ: pip install pylint$(NC)"; exit 1; }
	pylint brand_search_optimization/

format:
	@echo "$(BLUE)âœ¨ æ ¼å¼åŒ–ç¨‹å¼ç¢¼...$(NC)"
	@command -v black >/dev/null 2>&1 || { echo "$(YELLOW)black æœªå®‰è£ï¼Œè«‹åŸ·è¡Œ: pip install black$(NC)"; exit 1; }
	black brand_search_optimization/ tests/

# ============================================================================
# æ¸…ç†
# ============================================================================

clean:
	@echo "$(BLUE)ğŸ§¹ æ¸…ç†ç·¨è­¯æª”æ¡ˆå’Œå¿«å–...$(NC)"
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name .mypy_cache -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	find . -type f -name ".DS_Store" -delete
	rm -rf dist/ build/ *.egg-info/
	@echo "$(GREEN)âœ“ æ¸…ç†å®Œæˆ$(NC)"

# ============================================================================
# ç¶œåˆç›®æ¨™
# ============================================================================

all: clean install setup test
	@echo ""
	@echo "$(GREEN)âœ“ æ‰€æœ‰æ­¥é©Ÿå®Œæˆï¼$(NC)"
	@echo "$(BLUE)å¯ä»¥åŸ·è¡Œä»¥ä¸‹å‘½ä»¤:$(NC)"
	@echo "  - make run     # åŸ·è¡Œä¸»ç¨‹å¼"
	@echo "  - make eval    # åŸ·è¡Œè©•ä¼°æ¸¬è©¦"
	@echo "  - make test    # åŸ·è¡Œå–®å…ƒæ¸¬è©¦"

# ============================================================================
# ç’°å¢ƒæª¢æŸ¥
# ============================================================================

check-env:
	@echo "$(BLUE)ğŸ” æª¢æŸ¥ç’°å¢ƒè¨­å®š...$(NC)"
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)âš ï¸  æœªæ‰¾åˆ° .env æª”æ¡ˆï¼Œè¤‡è£½ env.example...$(NC)"; \
		cp env.example .env; \
		echo "$(YELLOW)è«‹ç·¨è¼¯ .env æª”æ¡ˆä¸¦å¡«å…¥ç›¸é—œé…ç½®$(NC)"; \
	else \
		echo "$(GREEN)âœ“ .env æª”æ¡ˆå­˜åœ¨$(NC)"; \
	fi
	@if command -v gcloud &> /dev/null; then \
		echo "$(GREEN)âœ“ gcloud å·²å®‰è£$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  gcloud æœªå®‰è£ï¼Œè«‹åƒç…§ README.md é€²è¡Œå®‰è£$(NC)"; \
	fi
	@if command -v poetry &> /dev/null; then \
		echo "$(GREEN)âœ“ Poetry å·²å®‰è£$(NC)"; \
	else \
		echo "$(YELLOW)âš ï¸  Poetry æœªå®‰è£ï¼Œè«‹åƒç…§ README.md é€²è¡Œå®‰è£$(NC)"; \
	fi

# ============================================================================
# é–‹ç™¼è¼”åŠ©
# ============================================================================

.PHONY: shell
shell:
	@echo "$(BLUE)ğŸš å•Ÿå‹• Poetry shell...$(NC)"
	poetry shell

.PHONY: update
update:
	@echo "$(BLUE)ğŸ”„ æ›´æ–°ä¾è³´...$(NC)"
	poetry update

.PHONY: show-deps
show-deps:
	@echo "$(BLUE)ğŸ“‹ é¡¯ç¤ºä¾è³´åˆ—è¡¨...$(NC)"
	poetry show

.PHONY: add-dev-pkg
add-dev-pkg:
	@echo "$(BLUE)â• æ–°å¢é–‹ç™¼ä¾è³´$(NC)"
	@echo "ç”¨æ³•: make add-dev-pkg PKG=<package-name>"
	@if [ -z "$(PKG)" ]; then \
		echo "$(YELLOW)è«‹æŒ‡å®šå¥—ä»¶åç¨±: make add-dev-pkg PKG=pytest-cov$(NC)"; \
	else \
		poetry add --group dev $(PKG); \
	fi
