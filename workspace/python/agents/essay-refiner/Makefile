# æ•™å­¸ 07ï¼šå¾ªç’°ä»£ç† (Loop Agents) - è«–æ–‡ç²¾ç…‰ç³»çµ± (Essay Refinement System)
# ç”¨æ–¼é–‹ç™¼ã€æ¸¬è©¦å’Œéƒ¨ç½²çš„ Makefile

# å®šç¾©æ‰€æœ‰å½ç›®æ¨™ï¼Œç¢ºä¿é€™äº›å‘½ä»¤ä¸æœƒèˆ‡åŒåæ–‡ä»¶è¡çª
.PHONY: help setup install test test-verbose test-coverage dev run demo validate check clean reset

# é è¨­ç›®æ¨™ï¼šé¡¯ç¤ºä½¿ç”¨èªªæ˜
help:
	@echo "æ•™å­¸ 07ï¼šå¾ªç’°ä»£ç† - è«–æ–‡ç²¾ç…‰ç³»çµ±"
	@echo ""
	@echo "é–‹ç™¼å‘½ä»¤ï¼š"
	@echo "  make setup         å®‰è£ Python ä¾è³´å¥—ä»¶"
	@echo "  make test          åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶ (62 å€‹æ¸¬è©¦)"
	@echo "  make dev           å•Ÿå‹• ADK é–‹ç™¼ä¼ºæœå™¨"
	@echo "  make demo          å¿«é€Ÿç³»çµ±é©—è­‰"
	@echo "  make validate      å…¨é¢é©—è­‰"
	@echo ""
	@echo "æ¸¬è©¦å‘½ä»¤ï¼š"
	@echo "  make test-verbose  åŸ·è¡Œæ¸¬è©¦ä¸¦é¡¯ç¤ºè©³ç´°è¼¸å‡º"
	@echo "  make test-coverage åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š"
	@echo "  make check         ç¨‹å¼ç¢¼æª¢æŸ¥èˆ‡æ ¼å¼åŒ–æª¢æŸ¥"
	@echo ""
	@echo "æ¸…ç†å‘½ä»¤ï¼š"
	@echo "  make clean         ç§»é™¤å¿«å–æª”æ¡ˆå’Œç”¢ç‰©"
	@echo "  make reset         é‡ç½®åˆ°ä¹¾æ·¨ç‹€æ…‹"

# ============================================================
# å®‰è£èˆ‡ç’°å¢ƒè¨­å®š
# ============================================================
# æ­¤å€æ®µè² è²¬å®‰è£å°ˆæ¡ˆæ‰€éœ€çš„æ‰€æœ‰ä¾è³´å¥—ä»¶

# setup: ä¸»è¦å®‰è£ç›®æ¨™ï¼Œå§”æ´¾çµ¦ install
setup: install

# install: å®‰è£æ‰€æœ‰å¿…è¦çš„ Python å¥—ä»¶
# - google-adk: Google Agent Development Kit
# - pytest/pytest-cov: æ¸¬è©¦æ¡†æ¶èˆ‡è¦†è“‹ç‡å·¥å…·
# - black/flake8: ç¨‹å¼ç¢¼æ ¼å¼åŒ–èˆ‡æª¢æŸ¥å·¥å…·
install:
	@echo "ğŸ“¦ æ­£åœ¨å®‰è£ä¾è³´å¥—ä»¶..."
	pip install google-adk pytest pytest-cov black flake8
	pip install -e .

# ============================================================
# æ¸¬è©¦å‘½ä»¤
# ============================================================
# æä¾›å¤šç¨®æ¸¬è©¦åŸ·è¡Œæ–¹å¼ï¼ŒåŒ…å«åŸºæœ¬æ¸¬è©¦ã€è©³ç´°è¼¸å‡ºã€è¦†è“‹ç‡å ±å‘Š

# test: åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦å¥—ä»¶
# - åˆ‡æ›åˆ° tests ç›®éŒ„ä¸¦åŸ·è¡Œ pytest
# - ä½¿ç”¨ -v (verbose) é¡¯ç¤ºè©³ç´°è³‡è¨Š
# - ä½¿ç”¨ --tb=short ç°¡åŒ–éŒ¯èª¤è¿½è¹¤è¼¸å‡º
test:
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦å¥—ä»¶..."
	cd tests && python -m pytest test_agent.py -v --tb=short
	@echo "âœ… æ¸¬è©¦å¥—ä»¶åŸ·è¡Œå®Œæˆ"

# test-verbose: åŸ·è¡Œæ¸¬è©¦ä¸¦é¡¯ç¤ºæ‰€æœ‰è¼¸å‡º
# - åŠ ä¸Š -s åƒæ•¸ä»¥é¡¯ç¤º print() èªå¥
test-verbose:
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦ï¼ˆè©³ç´°è¼¸å‡ºï¼‰..."
	cd tests && python -m pytest test_agent.py -v -s

# test-coverage: åŸ·è¡Œæ¸¬è©¦ä¸¦ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
# - ç”Ÿæˆ HTML æ ¼å¼çš„è¦†è“‹ç‡å ±å‘Š
# - é¡¯ç¤ºæœªè¦†è“‹çš„ç¨‹å¼ç¢¼è¡Œ
test-coverage:
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦ä¸¦è¨ˆç®—è¦†è“‹ç‡..."
	cd tests && python -m pytest test_agent.py --cov=../essay_refiner --cov-report=html --cov-report=term-missing

# ============================================================
# é–‹ç™¼èˆ‡åŸ·è¡Œ
# ============================================================
# å•Ÿå‹• ADK é–‹ç™¼ä¼ºæœå™¨ä»¥é€²è¡Œäº’å‹•å¼é–‹ç™¼èˆ‡æ¸¬è©¦

# dev: é–‹ç™¼æ¨¡å¼çš„åˆ¥åï¼Œå§”æ´¾çµ¦ run
dev: run

# run: å•Ÿå‹• ADK Web ä¼ºæœå™¨
# - é¦–å…ˆæª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºè¨­å®š
# - å•Ÿå‹•å¾Œå¯åœ¨ http://localhost:8000 å­˜å–
run: check-env
	@echo "ğŸš€ æ­£åœ¨å•Ÿå‹• ADK é–‹ç™¼ä¼ºæœå™¨..."
	@echo "è«‹é–‹å•Ÿ http://localhost:8000 ä¸¦é¸æ“‡ 'essay_refiner'"
	adk web

# ============================================================
# é©—è­‰èˆ‡ç¤ºç¯„
# ============================================================
# æä¾›å¿«é€Ÿé©—è­‰å’Œå…¨é¢æ¸¬è©¦åŠŸèƒ½

# demo: å¿«é€Ÿç³»çµ±é©—è­‰
# - è¼‰å…¥ root_agent ä¸¦æª¢æŸ¥åŸºæœ¬é…ç½®
# - é©—è­‰ä»£ç†éšæ®µæ•¸é‡å’Œè¿­ä»£è¨­å®š
demo:
	@echo "ğŸ¯ æ­£åœ¨åŸ·è¡Œå¿«é€Ÿç³»çµ±é©—è­‰..."
	python -c "from essay_refiner.agent import root_agent; print(f'âœ… Root agent å·²è¼‰å…¥: {root_agent.name}'); print(f'âœ… æ“æœ‰ {len(root_agent.sub_agents)} å€‹éšæ®µ'); print(f'âœ… ç²¾ç…‰å¾ªç’°æœ€å¤šè¿­ä»£ {root_agent.sub_agents[1].max_iterations} æ¬¡'); print('âœ… è«–æ–‡ç²¾ç…‰ç³»çµ±æº–å‚™å°±ç·’ï¼')"

# validate: å…¨é¢é©—è­‰ç³»çµ±
# - æ¸¬è©¦æ‰€æœ‰æ¨¡çµ„åŒ¯å…¥
# - é©—è­‰ä»£ç†é…ç½®æ­£ç¢ºæ€§
# - æª¢æŸ¥å¾ªç’°çµæ§‹
# - ç¢ºèªå·¥å…·æ•´åˆ
# - åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
validate:
	@echo "ğŸ” æ­£åœ¨åŸ·è¡Œå…¨é¢é©—è­‰..."
	@echo "1. æ¸¬è©¦æ¨¡çµ„åŒ¯å…¥..."
	python -c "from essay_refiner.agent import root_agent, essay_refinement_system, refinement_loop, initial_writer, critic, refiner, exit_loop; print('âœ… æ‰€æœ‰åŒ¯å…¥æˆåŠŸ')"
	@echo "2. æ¸¬è©¦ä»£ç†é…ç½®..."
	python -c "from essay_refiner.agent import root_agent; assert root_agent.name == 'EssayRefinementSystem'; assert len(root_agent.sub_agents) == 2; print('âœ… ä»£ç†é…ç½®æœ‰æ•ˆ')"
	@echo "3. æ¸¬è©¦å¾ªç’°çµæ§‹..."
	python -c "from essay_refiner.agent import refinement_loop; assert refinement_loop.max_iterations == 5; assert len(refinement_loop.sub_agents) == 2; print('âœ… å¾ªç’°çµæ§‹æœ‰æ•ˆ')"
	@echo "4. æ¸¬è©¦å·¥å…·æ•´åˆ..."
	python -c "from essay_refiner.agent import refiner, exit_loop; assert len(refiner.tools) == 1; assert refiner.tools[0] == exit_loop; print('âœ… å·¥å…·æ•´åˆæœ‰æ•ˆ')"
	@echo "5. åŸ·è¡Œæ¸¬è©¦å¥—ä»¶..."
	make test
	@echo "ğŸ‰ æ‰€æœ‰é©—è­‰é€šéï¼"

# ============================================================
# ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
# ============================================================
# ä½¿ç”¨ flake8 å’Œ black é€²è¡Œç¨‹å¼ç¢¼å“è³ªèˆ‡æ ¼å¼æª¢æŸ¥

# check: åŸ·è¡Œ linting å’Œæ ¼å¼æª¢æŸ¥
# - flake8: æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼å’Œæ½›åœ¨éŒ¯èª¤
# - black: é©—è­‰ç¨‹å¼ç¢¼æ ¼å¼æ˜¯å¦ç¬¦åˆæ¨™æº–
check:
	@echo "ğŸ” æ­£åœ¨åŸ·è¡Œç¨‹å¼ç¢¼æª¢æŸ¥èˆ‡æ ¼å¼é©—è­‰..."
	flake8 essay_refiner tests --max-line-length=100 --ignore=E203,W503
	black --check essay_refiner tests

# ============================================================
# æ¸…ç†å‘½ä»¤
# ============================================================
# ç§»é™¤æš«å­˜æª”æ¡ˆã€å¿«å–å’Œç·¨è­¯ç”¢ç‰©

# clean: æ¸…ç†å¿«å–æª”æ¡ˆå’Œç”¢ç‰©
# - ç§»é™¤ __pycache__ ç›®éŒ„
# - ç§»é™¤ .pytest_cache ç›®éŒ„
# - ç§»é™¤è¦†è“‹ç‡ç›¸é—œæª”æ¡ˆ
# - ç§»é™¤ .pyc ç·¨è­¯æª”æ¡ˆ
clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†å¿«å–æª”æ¡ˆå’Œç”¢ç‰©..."
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type d -name .pytest_cache -exec rm -rf {} +
	find . -type d -name .coverage -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name ".coverage" -delete
	find . -type f -name "coverage.xml" -delete

# reset: é‡ç½®åˆ°ä¹¾æ·¨ç‹€æ…‹
# - åŸ·è¡Œ clean æ¸…ç†æ‰€æœ‰ç”¢ç‰©
# - ä¿ç•™åŸå§‹ç¢¼ä¸å—å½±éŸ¿
reset: clean
	@echo "ğŸ”„ æ­£åœ¨é‡ç½®åˆ°ä¹¾æ·¨ç‹€æ…‹..."
	@echo "æ³¨æ„ï¼šæ­¤æ“ä½œæœƒç§»é™¤æ‰€æœ‰ç”Ÿæˆçš„æª”æ¡ˆï¼Œä½†ä¿ç•™åŸå§‹ç¢¼"
	# å¦‚éœ€è¦ï¼Œå¯åœ¨æ­¤è™•åŠ å…¥é¡å¤–çš„é‡ç½®é‚è¼¯

# ============================================================
# ç’°å¢ƒæª¢æŸ¥ï¼ˆå…§éƒ¨ä½¿ç”¨ï¼‰
# ============================================================
# é©—è­‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸æ˜¯å¦å·²æ­£ç¢ºè¨­å®š
# æ”¯æ´å…©ç¨®èªè­‰æ–¹å¼ï¼šAPI Key æˆ– Service Account

# check-env: æª¢æŸ¥ Google API èªè­‰é…ç½®
# - æ–¹æ³• 1: GOOGLE_API_KEYï¼ˆé©ç”¨æ–¼ Gemini APIï¼‰
# - æ–¹æ³• 2: GOOGLE_APPLICATION_CREDENTIALSï¼ˆé©ç”¨æ–¼ VertexAIï¼‰
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šæœªé…ç½®èº«ä»½é©—è­‰"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®èº«ä»½é©—è­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 1 - API Keyï¼ˆGemini APIï¼‰ï¼š"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   åœ¨æ­¤è™•å–å¾—å…è²»é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹æ³• 2 - Service Accountï¼ˆVertexAIï¼‰ï¼š"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   åœ¨æ­¤è™•å»ºç«‹æ†‘è­‰ï¼šhttps://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		exit 1; \
	fi