# æ•™å­¸ 24: é€²éšå¯è§€æ¸¬æ€§èˆ‡ç›£æ§
# å…·æœ‰è‡ªè¨‚å¤–æ›ç¨‹å¼çš„ç”Ÿç”¢ç’°å¢ƒç›£æ§ Agent

.PHONY: help setup dev test clean demo deploy auth

# é è¨­ç›®æ¨™ - é¡¯ç¤ºèªªæ˜
help:
	@echo "ğŸš€ æ•™å­¸ 24: é€²éšå¯è§€æ¸¬æ€§èˆ‡ç›£æ§"
	@echo ""
	@echo "å¿«é€Ÿå…¥é–€æŒ‡ä»¤:"
	@echo "  make setup     - å®‰è£ä¾è³´é …"
	@echo "  make dev       - å•Ÿå‹•å¯è§€æ¸¬æ€§ Agent"
	@echo "  make demo      - é¡¯ç¤ºç¤ºç¯„æç¤ºå’Œç”¨æ³•"
	@echo ""
	@echo "é€²éšæŒ‡ä»¤:"
	@echo "  make test      - åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦"
	@echo "  make deploy    - éƒ¨ç½²åˆ° Cloud Run ä¸¦å•Ÿç”¨è¿½è¹¤"
	@echo "  make auth      - ä½¿ç”¨ Google Cloud é€²è¡Œé©—è­‰"
	@echo "  make clean     - æ¸…ç†ç”Ÿæˆçš„æª”æ¡ˆ"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨? åŸ·è¡Œ: make setup && make auth && make dev"

# å®‰è£ä¾è³´é …
setup:
	@echo "ğŸ“¦ æ­£åœ¨å®‰è£ä¾è³´é …..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… è¨­å®šå®Œæˆ! åŸ·è¡Œ 'make dev' å•Ÿå‹• Agentã€‚"

# å•Ÿå‹•å¯è§€æ¸¬æ€§ Agent
dev: check-env
	@echo "ğŸ¤– æ­£åœ¨å•Ÿå‹•å…·æœ‰ Cloud Tracing çš„å¯è§€æ¸¬æ€§ Agent..."
	@echo "ğŸ“± åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ http://localhost:8000"
	@echo "ğŸ¯ å¾ä¸‹æ‹‰é¸å–®ä¸­é¸æ“‡ 'observability_plugins_agent'"
	@echo "ğŸ“Š å˜—è©¦ä»¥ä¸‹æç¤º:"
	@echo "   â€¢ 'ä»€éº¼æ˜¯äººå·¥æ™ºæ…§?'"
	@echo "   â€¢ 'è§£é‡‹æ©Ÿå™¨å­¸ç¿’'"
	@echo "   â€¢ 'ä»€éº¼æ˜¯ç¥ç¶“ç¶²è·¯?'"
	@echo "ğŸ’¡ æª¢æŸ¥æ§åˆ¶å°ä»¥ç²å–å³æ™‚æŒ‡æ¨™å’Œç›£æ§æ•¸æ“š"
	@echo ""
	@echo "ğŸ” åœ¨ Google Cloud Console ä¸­æŸ¥çœ‹è¿½è¹¤:"
	@echo "   https://console.cloud.google.com/traces?project=saas-app-001"
	@echo ""
	@echo "ğŸ“‹ åœ¨ Google Cloud Console ä¸­æŸ¥çœ‹æ—¥èªŒ:"
	@echo "   https://console.cloud.google.com/logs/query?project=saas-app-001"
	@echo "   éæ¿¾æ¢ä»¶: resource.type=\"cloud_run_revision\" OR resource.type=\"agent_engine\""
	adk web --trace_to_cloud

# åŸ·è¡Œç›£æ§ç¤ºç¯„
demo: check-env
	@echo "ğŸ“Š é€²éšå¯è§€æ¸¬æ€§ç¤ºç¯„"
	@echo ""
	@echo "ğŸ’¬ åœ¨ ADK ç¶²é  UI ä¸­å˜—è©¦é€™äº›æç¤º:"
	@echo "   1. 'ä»€éº¼æ˜¯äººå·¥æ™ºæ…§?'"
	@echo "   2. 'ç”¨ç°¡å–®çš„è¡“èªè§£é‡‹æ©Ÿå™¨å­¸ç¿’'"
	@echo "   3. 'AI çš„æ‡‰ç”¨æœ‰å“ªäº›?'"
	@echo "   4. 'æ·±åº¦å­¸ç¿’å¦‚ä½•é‹ä½œ?'"
	@echo "   5. 'AI çš„æœªä¾†æ˜¯ä»€éº¼?'"
	@echo ""
	@echo "ğŸ“ˆ ç¤ºç¯„åŠŸèƒ½:"
	@echo "   â€¢ SaveFilesAsArtifactsPlugin - è‡ªå‹•å„²å­˜æª”æ¡ˆ"
	@echo "   â€¢ MetricsCollectorPlugin - è«‹æ±‚/å›æ‡‰æŒ‡æ¨™"
	@echo "   â€¢ AlertingPlugin - éŒ¯èª¤æª¢æ¸¬å’Œè­¦å ±"
	@echo "   â€¢ PerformanceProfilerPlugin - è©³ç´°æ•ˆèƒ½åˆ†æ"
	@echo ""
	@echo "ğŸ” è§€å¯Ÿæ§åˆ¶å°è¼¸å‡º:"
	@echo "   â€¢ è«‹æ±‚é–‹å§‹/å®Œæˆäº‹ä»¶"
	@echo "   â€¢ å»¶é²æ¸¬é‡"
	@echo "   â€¢ Token è¨ˆæ•¸"
	@echo "   â€¢ æˆåŠŸ/éŒ¯èª¤è¿½è¹¤"
	@echo ""
	@echo "âœ… ç¤ºç¯„æº–å‚™å°±ç·’! æ‰“é–‹ http://localhost:8000"

# ä½¿ç”¨ Google Cloud é€²è¡Œé©—è­‰
auth:
	@echo "ğŸ” æ­£åœ¨ä½¿ç”¨ Google Cloud é€²è¡Œé©—è­‰..."
	@echo "ğŸ“‹ é€™å°‡æ‰“é–‹ç€è¦½å™¨é€²è¡Œé©—è­‰"
	@echo "ğŸ”‘ é¸æ“‡æ‚¨çš„ Google å¸³æˆ¶ä¸¦æˆäºˆæ¬Šé™"
	@echo ""
	gcloud auth application-default login
	@echo ""
	@echo "âœ… é©—è­‰å®Œæˆ!"
	@echo "ğŸ’¡ ä¸‹ä¸€æ­¥:"
	@echo "   1. è¨­å®šæ‚¨çš„å°ˆæ¡ˆ: export GOOGLE_CLOUD_PROJECT=your-project-id"
	@echo "   2. è¨­å®šæ‚¨çš„å€åŸŸ: export GOOGLE_CLOUD_LOCATION=us-central1"
	@echo "   3. åŸ·è¡Œ: make deploy"

# éƒ¨ç½²åˆ° Cloud Run ä¸¦å•Ÿç”¨è¿½è¹¤
deploy: check-env
	@echo "ğŸš€ æ­£åœ¨å°‡å¯è§€æ¸¬æ€§ Agent éƒ¨ç½²åˆ° Cloud Run ä¸¦å•Ÿç”¨è¿½è¹¤..."
	@echo "ğŸ” è¿½è¹¤å°‡åœ¨ä»¥ä¸‹ä½ç½®å¯ç”¨:"
	@echo "   https://console.cloud.google.com/traces?project=saas-app-001"
	@echo ""
	@echo "ğŸ“‹ æ—¥èªŒå°‡åœ¨ä»¥ä¸‹ä½ç½®å¯ç”¨:"
	@echo "   https://console.cloud.google.com/logs/query?project=saas-app-001"
	@echo "   éæ¿¾æ¢ä»¶: resource.type=\"cloud_run_revision\""
	adk deploy cloud_run --project saas-app-001 --region us-central1 --trace_to_cloud observability_plugins_agent

# åŸ·è¡Œæ¸¬è©¦
test: check-env
	@echo "ğŸ§ª æ­£åœ¨åŸ·è¡Œæ¸¬è©¦..."
	pytest tests/ -v --tb=short --cov=observability_plugins_agent --cov-report=term-missing

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	rm -rf .pytest_cache/
	rm -rf .coverage
	rm -rf *.egg-info/
	@echo "âœ… æ¸…ç†å®Œæˆ!"

# æª¢æŸ¥ç’°å¢ƒ (å…§éƒ¨ä½¿ç”¨)
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ] && [ -z "$$GOOGLE_CLOUD_PROJECT" ]; then \
		echo "âŒ éŒ¯èª¤: æœªè¨­å®šé©—è­‰"; \
		echo ""; \
		echo "é¸æ“‡ä»¥ä¸‹é©—è­‰æ–¹æ³•ä¹‹ä¸€:"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 1 - API Key (Gemini API):"; \
		echo "   export GOOGLE_API_KEY=your_api_key_here"; \
		echo "   åœ¨ä»¥ä¸‹ä½ç½®ç²å–å…è²»é‡‘é‘°: https://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹æ³• 2 - Service Account (VertexAI):"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   export GOOGLE_CLOUD_LOCATION=us-central1"; \
		echo "   åœ¨ä»¥ä¸‹ä½ç½®å»ºç«‹æ†‘è­‰: https://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹æ³• 3 - Application Default Credentials (VertexAI):"; \
		echo "   gcloud auth application-default login"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   export GOOGLE_CLOUD_LOCATION=us-central1"; \
		echo ""; \
		exit 1; \
	fi

# é‡é»æ‘˜è¦
# - **æ ¸å¿ƒæ¦‚å¿µ**: è‡ªå‹•åŒ–æ§‹å»ºèˆ‡ç®¡ç†è…³æœ¬
# - **é—œéµæŠ€è¡“**: Make, CLI è‡ªå‹•åŒ–, é›²ç«¯éƒ¨ç½² (Cloud Run), æ¸¬è©¦ (pytest)
# - **è¡Œå‹•é …ç›®**: ä½¿ç”¨ `make setup` åˆå§‹åŒ–å°ˆæ¡ˆï¼Œ`make dev` é€²è¡Œé–‹ç™¼æ¸¬è©¦ï¼Œ`make deploy` éƒ¨ç½²è‡³ç”Ÿç”¢ç’°å¢ƒ
