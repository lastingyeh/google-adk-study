# MCP A2A Master Project
# Makefile for managing MCP Server and A2A Agents

.PHONY: help setup dev start stop clean test test-unit test-integration test-coverage test-watch demo kill-ports start-mcp start-host start-builder

# Default target - show help
help:
	@echo "ğŸš€ MCP A2A Master å°ˆæ¡ˆç®¡ç†"
	@echo ""
	@echo "å¿«é€Ÿé–‹å§‹æŒ‡ä»¤ (Quick Start):"
	@echo "  make setup        - å®‰è£ç›¸ä¾å¥—ä»¶ (Install dependencies)"
	@echo "  make start        - å•Ÿå‹•æ‰€æœ‰æœå‹™ (Start all services)"
	@echo "  make stop         - åœæ­¢æ‰€æœ‰æœå‹™ (Stop all services)"
	@echo "  make dev          - é–‹ç™¼æ¨¡å¼ï¼šå•Ÿå‹•æ‰€æœ‰æœå‹™ (Development mode)"
	@echo ""
	@echo "å€‹åˆ¥æœå‹™æ§åˆ¶ (Individual Services):"
	@echo "  make start-mcp    - åƒ…å•Ÿå‹• MCP Server (port 3000)"
	@echo "  make start-host   - åƒ…å•Ÿå‹• Host Agent (port 10000)"
	@echo "  make start-builder - åƒ…å•Ÿå‹• Website Builder (port 10001)"
	@echo "  make cmd          - å•Ÿå‹•å‘½ä»¤åˆ—ä»‹é¢ (Start CLI interface)"
	@echo ""
	@echo "é€²éšæŒ‡ä»¤ (Advanced):"
	@echo "  make kill-ports   - æ¸…ç†å ç”¨çš„ç«¯å£ (Clean up ports: 3000, 10000, 10001)"
	@echo "  make test         - åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ (Run all tests)"
	@echo "  make test-unit    - åŸ·è¡Œå–®å…ƒæ¸¬è©¦ (Run unit tests)"
	@echo "  make test-integration - åŸ·è¡Œæ•´åˆæ¸¬è©¦ (Run integration tests)"
	@echo "  make test-coverage - åŸ·è¡Œæ¸¬è©¦æ¶µè“‹ç‡åˆ†æ (Run test coverage)"
	@echo "  make demo         - åŸ·è¡Œç¤ºç¯„ (Run demo)"
	@echo "  make clean        - æ¸…ç†ç”¢ç”Ÿæª”æ¡ˆ (Clean up generated files)"
	@echo ""
	@echo "ğŸ’¡ ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Ÿè«‹ä¾åºåŸ·è¡Œ: make setup && make start"

# Install dependencies using uv
setup:
	@echo "ğŸ“¦ å®‰è£ç›¸ä¾å¥—ä»¶ä¸­..."
	@if ! command -v uv &> /dev/null; then \
		echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° uv æŒ‡ä»¤"; \
		echo "è«‹å…ˆå®‰è£ uv: https://github.com/astral-sh/uv"; \
		exit 1; \
	fi
	uv sync
	uv sync --extra dev
	@echo "âœ… å®‰è£å®Œæˆï¼åŸ·è¡Œ 'make start' å•Ÿå‹•æ‰€æœ‰æœå‹™ã€‚"

# Kill processes on specific ports
kill-ports:
	@echo "ğŸ§¹ æ¸…ç†å ç”¨çš„ç«¯å£..."
	@if lsof -ti:10000 > /dev/null 2>&1; then \
		echo "æ­£åœ¨é—œé–‰ port 10000 (Host Agent)..."; \
		lsof -ti:10000 | xargs kill -9; \
		echo "âœ… Port 10000 å·²é‡‹æ”¾"; \
	else \
		echo "âœ“ Port 10000 æœªè¢«å ç”¨"; \
	fi
	@if lsof -ti:10001 > /dev/null 2>&1; then \
		echo "æ­£åœ¨é—œé–‰ port 10001 (Website Builder)..."; \
		lsof -ti:10001 | xargs kill -9; \
		echo "âœ… Port 10001 å·²é‡‹æ”¾"; \
	else \
		echo "âœ“ Port 10001 æœªè¢«å ç”¨"; \
	fi
	@if lsof -ti:3000 > /dev/null 2>&1; then \
		echo "æ­£åœ¨é—œé–‰ port 3000 (MCP Server)..."; \
		lsof -ti:3000 | xargs kill -9; \
		echo "âœ… Port 3000 å·²é‡‹æ”¾"; \
	else \
		echo "âœ“ Port 3000 æœªè¢«å ç”¨"; \
	fi
	@echo "âœ… æ‰€æœ‰ç«¯å£æ¸…ç†å®Œæˆï¼"

# Stop all services
stop: kill-ports
	@echo "ğŸ›‘ æ‰€æœ‰æœå‹™å·²åœæ­¢"

# Start MCP Server only
start-mcp: check-env
	@echo "ğŸ”§ å•Ÿå‹• MCP Server (port 3000)..."
	@uv run ./mcp/servers/streamable_http_server.py &
	@echo "âœ… MCP Server å·²å•Ÿå‹•"
	@sleep 2

# Start Host Agent only
start-host: check-env
	@echo "ğŸ¤– å•Ÿå‹• Host Agent (port 10000)..."
	@uv run python3 -m agents.host_agent &
	@echo "âœ… Host Agent å·²å•Ÿå‹•"
	@sleep 2

# Start Website Builder only
start-builder: check-env
	@echo "ğŸŒ å•Ÿå‹• Website Builder (port 10001)..."
	@uv run python3 -m agents.website_builder_simple &
	@echo "âœ… Website Builder å·²å•Ÿå‹•"
	@sleep 2

# Start CLI interface
cmd: check-env
	@echo "ğŸ’» å•Ÿå‹•å‘½ä»¤åˆ—ä»‹é¢..."
	@uv run python3 -m app.cmd.cmd

# Start all services
start: check-env kill-ports
	@echo "========================================="
	@echo "ğŸš€ å•Ÿå‹•æ‰€æœ‰æœå‹™ (Starting All Services)"
	@echo "========================================="
	@echo ""
	@echo "[1/3] å•Ÿå‹• MCP Server..."
	@uv run ./mcp/servers/streamable_http_server.py &
	@echo "MCP Server PID: $$!"
	@sleep 5
	@echo ""
	@echo "[2/3] å•Ÿå‹• Host Agent Server..."
	@uv run python3 -m agents.host_agent &
	@echo "Host Agent Server PID: $$!"
	@sleep 5
	@echo ""
	@echo "[3/3] å•Ÿå‹• Website Builder Simple..."
	@uv run python3 -m agents.website_builder_simple &
	@echo "Website Builder Simple PID: $$!"
	@sleep 3
	@echo ""
	@echo "========================================="
	@echo "âœ… æ‰€æœ‰æœå‹™å·²å•Ÿå‹•ï¼"
	@echo "========================================="
	@echo ""
	@echo "ğŸ“± æœå‹™ç«¯å£è³‡è¨Šï¼š"
	@echo "  â€¢ MCP Server:        http://localhost:3000"
	@echo "  â€¢ Host Agent:        http://localhost:10000"
	@echo "  â€¢ Website Builder:   http://localhost:10001"
	@echo ""
	@echo "ğŸ›‘ åœæ­¢æœå‹™è«‹åŸ·è¡Œ: make stop"

# Development mode (alias for start)
dev: start

# Run a demo
demo: check-env
	@echo "ğŸ§ª åŸ·è¡Œ MCP A2A ç¤ºç¯„..."
	@echo ""
	@echo "ğŸ’¬ å¯å˜—è©¦ä»¥ä¸‹æ“ä½œï¼š"
	@echo "   â€¢ é€£æ¥åˆ° Host Agent (port 10000)"
	@echo "   â€¢ å‘¼å« Website Builder å»ºç«‹ç¶²ç«™"
	@echo "   â€¢ é€é MCP Server å­˜å–å·¥å…·"
	@echo ""
	@echo "âœ… ç¤ºç¯„å·²å°±ç·’ï¼"
	@echo "   MCP Server:      http://localhost:3000"
	@echo "   Host Agent:      http://localhost:10000"
	@echo "   Website Builder: http://localhost:10001"

# Run tests
test:
	@echo "ğŸ§ª åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦..."
	@uv run pytest tests/ -v --tb=short

# Run unit tests only
test-unit:
	@echo "ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."
	@uv run pytest tests/ -v -m unit --tb=short

# Run integration tests only
test-integration:
	@echo "ğŸ§ª åŸ·è¡Œæ•´åˆæ¸¬è©¦..."
	@uv run pytest tests/ -v -m integration --tb=short

# Run tests with coverage
test-coverage:
	@echo "ğŸ“Š åŸ·è¡Œæ¸¬è©¦æ¶µè“‹ç‡åˆ†æ..."
	@uv run pytest tests/ \
		--cov=agents \
		--cov=utilities \
		--cov-report=html \
		--cov-report=term \
		--cov-report=term-missing \
		-v
	@echo ""
	@echo "âœ… æ¶µè“‹ç‡å ±å‘Šå·²ç”¢ç”Ÿï¼"
	@echo "ğŸ“ HTML å ±å‘Šï¼šhtmlcov/index.html"
	@echo ""
	@echo "ğŸ’¡ é–‹å•Ÿå ±å‘Šï¼š"
	@echo "   open htmlcov/index.html"

# Watch mode for tests (requires pytest-watch)
test-watch:
	@echo "ğŸ‘€ æ¸¬è©¦ç›£çœ‹æ¨¡å¼..."
	@uv run ptw tests/ -- -v --tb=short

# Clean up generated files
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸­..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

# Check environment variables
check-env:
	@if [ -z "$$GOOGLE_API_KEY" ] && [ -z "$$GOOGLE_APPLICATION_CREDENTIALS" ]; then \
		echo "âŒ éŒ¯èª¤ï¼šå°šæœªè¨­å®šé©—è­‰è³‡è¨Š (Authentication not configured)"; \
		echo ""; \
		echo "è«‹é¸æ“‡ä»¥ä¸‹å…¶ä¸­ä¸€ç¨®é©—è­‰æ–¹å¼ï¼š"; \
		echo ""; \
		echo "ğŸ”‘ æ–¹å¼ 1 - API Key (Gemini API)ï¼š"; \
		echo "   export GOOGLE_API_KEY=ä½ çš„_API_Key"; \
		echo "   ç”³è«‹é‡‘é‘°ï¼šhttps://aistudio.google.com/app/apikey"; \
		echo ""; \
		echo "ğŸ” æ–¹å¼ 2 - Service Account (VertexAI)ï¼š"; \
		echo "   export GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json"; \
		echo "   export GOOGLE_CLOUD_PROJECT=your_project_id"; \
		echo "   å»ºç«‹æ†‘è­‰ï¼šhttps://console.cloud.google.com/iam-admin/serviceaccounts"; \
		echo ""; \
		echo "ğŸ’¡ æç¤ºï¼šå¯ä»¥è¤‡è£½ .env.example ç‚º .env ä¸¦å¡«å…¥ç›¸é—œè¨­å®š"; \
		echo ""; \
		exit 1; \
	fi
