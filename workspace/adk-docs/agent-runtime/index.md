# Runtime æ¦‚è¿°

ğŸ”” `æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 9 æ—¥`

ADK Runtime æ˜¯åœ¨ä½¿ç”¨è€…äº’å‹•æœŸé–“é©…å‹•æ‚¨çš„ä»£ç†æ‡‰ç”¨ç¨‹å¼çš„åº•å±¤å¼•æ“ã€‚å®ƒæ˜¯æ¥æ”¶æ‚¨å®šç¾©çš„ä»£ç† (agents)ã€å·¥å…· (tools) å’Œå›èª¿ (callbacks) ä¸¦å”èª¿å®ƒå€‘åŸ·è¡Œä»¥å›æ‡‰ä½¿ç”¨è€…è¼¸å…¥çš„ç³»çµ±ï¼Œç®¡ç†è³‡è¨Šæµã€ç‹€æ…‹è®Šæ›´ä»¥åŠèˆ‡å¤–éƒ¨æœå‹™ï¼ˆå¦‚ LLM æˆ–å„²å­˜é«”ï¼‰çš„äº’å‹•ã€‚

å°‡ Runtime è¦–ç‚ºæ‚¨çš„ä»£ç†æ‡‰ç”¨ç¨‹å¼çš„ **ã€Œå¼•æ“ã€**ã€‚æ‚¨å®šç¾©å„å€‹éƒ¨ä»¶ï¼ˆä»£ç†ã€å·¥å…·ï¼‰ï¼Œè€Œ Runtime å‰‡è² è²¬è™•ç†å®ƒå€‘å¦‚ä½•é€£æ¥ä¸¦å…±åŒé‹ä½œä»¥æ»¿è¶³ä½¿ç”¨è€…çš„è«‹æ±‚ã€‚

## æ ¸å¿ƒæ¦‚å¿µï¼šäº‹ä»¶è¿´åœˆ (Event Loop)

æœ¬è³ªä¸Šï¼ŒADK Runtime é‹ä½œæ–¼ **äº‹ä»¶è¿´åœˆ (Event Loop)** ä¹‹ä¸Šã€‚æ­¤è¿´åœˆä¿ƒé€²äº† `Runner` å…ƒä»¶èˆ‡æ‚¨å®šç¾©çš„ã€ŒåŸ·è¡Œé‚è¼¯ (Execution Logic)ã€ï¼ˆåŒ…å«æ‚¨çš„ä»£ç†ã€å®ƒå€‘é€²è¡Œçš„ LLM å‘¼å«ã€å›èª¿å’Œå·¥å…·ï¼‰ä¹‹é–“çš„ä¾†å›é€šè¨Šã€‚

![intro_components.png](https://google.github.io/adk-docs/assets/event-loop.png)

ç°¡å–®ä¾†èªªï¼š

1. `Runner` æ¥æ”¶ä½¿ç”¨è€…æŸ¥è©¢ä¸¦è«‹æ±‚ä¸» `Agent` é–‹å§‹è™•ç†ã€‚
2. `Agent`ï¼ˆåŠå…¶ç›¸é—œé‚è¼¯ï¼‰åŸ·è¡Œç›´åˆ°æœ‰äº‹é …éœ€è¦å ±å‘Šï¼ˆä¾‹å¦‚å›æ‡‰ã€ä½¿ç”¨å·¥å…·çš„è«‹æ±‚æˆ–ç‹€æ…‹è®Šæ›´ï¼‰â€”â€”ç„¶å¾Œå®ƒæœƒ **yieldï¼ˆç”¢å‡ºï¼‰** æˆ– **emitï¼ˆç™¼å‡ºï¼‰** ä¸€å€‹ `Event`ã€‚
3. `Runner` æ¥æ”¶æ­¤ `Event`ï¼Œè™•ç†ä»»ä½•ç›¸é—œçš„å‹•ä½œï¼ˆä¾‹å¦‚é€é `Services` å„²å­˜ç‹€æ…‹è®Šæ›´ï¼‰ï¼Œä¸¦å°‡äº‹ä»¶è½‰ç™¼å‡ºå»ï¼ˆä¾‹å¦‚è½‰ç™¼è‡³ä½¿ç”¨è€…ä»‹é¢ï¼‰ã€‚
4. åªæœ‰åœ¨ `Runner` è™•ç†å®Œäº‹ä»¶ *ä¹‹å¾Œ*ï¼Œ`Agent` çš„é‚è¼¯æ‰æœƒå¾æš«åœè™• **æ¢å¾© (resume)**ï¼Œæ­¤æ™‚å¯èƒ½çœ‹åˆ°ç”± Runner æäº¤çš„è®Šæ›´æ‰€ç”¢ç”Ÿçš„æ•ˆæœã€‚
5. æ­¤å¾ªç’°æœƒé‡è¤‡é€²è¡Œï¼Œç›´åˆ°ä»£ç†å°ç•¶å‰ä½¿ç”¨è€…æŸ¥è©¢æ²’æœ‰æ›´å¤šçš„äº‹ä»¶å¯ä»¥ç”¢å‡ºã€‚

æ­¤äº‹ä»¶é©…å‹•è¿´åœˆæ˜¯ ADK åŸ·è¡Œæ‚¨çš„ä»£ç†ç¨‹å¼ç¢¼çš„åŸºæœ¬æ¨¡å¼ã€‚

## æ ¸å¿ƒè„ˆå‹•ï¼šäº‹ä»¶è¿´åœˆ - å…§éƒ¨é‹ä½œ

äº‹ä»¶è¿´åœˆæ˜¯å®šç¾© `Runner` èˆ‡æ‚¨çš„è‡ªè¨‚ç¨‹å¼ç¢¼ï¼ˆä»£ç†ã€å·¥å…·ã€å›èª¿ï¼Œåœ¨è¨­è¨ˆæ–‡ä»¶ä¸­çµ±ç¨±ç‚ºã€ŒåŸ·è¡Œé‚è¼¯ã€æˆ–ã€Œé‚è¼¯å…ƒä»¶ã€ï¼‰ä¹‹é–“äº’å‹•çš„æ ¸å¿ƒé‹ä½œæ¨¡å¼ã€‚å®ƒå»ºç«‹äº†æ˜ç¢ºçš„è²¬ä»»åˆ†å·¥ï¼š

> [!NOTE]
    SDK èªè¨€ä¹‹é–“çš„å…·é«”æ–¹æ³•åç¨±å’Œåƒæ•¸åç¨±å¯èƒ½ç•¥æœ‰ä¸åŒï¼ˆä¾‹å¦‚ Python ä¸­çš„ `agent.run_async(...)`ï¼ŒGo ä¸­çš„ `agent.Run(...)`ï¼ŒJava å’Œ TypeScript ä¸­çš„ `agent.runAsync(...)`ï¼‰ã€‚è«‹åƒé–±ç‰¹å®šèªè¨€çš„ API æ–‡ä»¶ä»¥ç²å–è©³ç´°è³‡è¨Šã€‚

### Runner çš„è§’è‰²ï¼ˆå”èª¿è€…ï¼‰

`Runner` æ“”ä»»å–®æ¬¡ä½¿ç”¨è€…èª¿ç”¨ (invocation) çš„ä¸­å¤®å”èª¿è€…ã€‚å®ƒåœ¨è¿´åœˆä¸­çš„è·è²¬ç‚ºï¼š

1. **å•Ÿå‹• (Initiation)ï¼š** æ¥æ”¶æœ€çµ‚ä½¿ç”¨è€…çš„æŸ¥è©¢ (`new_message`) ä¸¦é€šå¸¸é€é `SessionService` å°‡å…¶é™„åŠ åˆ°å·¥ä½œéšæ®µæ­·å²è¨˜éŒ„ä¸­ã€‚
2. **å•Ÿå‹• (Kick-off)ï¼š** é€éå‘¼å«ä¸»ä»£ç†çš„åŸ·è¡Œæ–¹æ³•ï¼ˆä¾‹å¦‚ `agent_to_run.run_async(...)`ï¼‰ä¾†é–‹å§‹äº‹ä»¶ç”Ÿæˆéç¨‹ã€‚
3. **æ¥æ”¶èˆ‡è™•ç† (Receive & Process)ï¼š** ç­‰å¾…ä»£ç†é‚è¼¯ `yield` æˆ– `emit` ä¸€å€‹ `Event`ã€‚åœ¨æ”¶åˆ°äº‹ä»¶å¾Œï¼ŒRunner æœƒ **ç«‹å³è™•ç†** å®ƒã€‚é€™æ¶‰åŠï¼š
      * ä½¿ç”¨é…ç½®çš„ `Services` (`SessionService`, `ArtifactService`, `MemoryService`) ä¾†æäº¤ `event.actions` ä¸­æŒ‡ç¤ºçš„è®Šæ›´ï¼ˆå¦‚ `state_delta`, `artifact_delta`ï¼‰ã€‚
      * åŸ·è¡Œå…¶ä»–å…§éƒ¨ç°¿è¨˜å·¥ä½œã€‚
4. **å‘ä¸Šæ¸¸ç”¢ç”Ÿ (Yield Upstream)ï¼š** å°‡è™•ç†å¾Œçš„äº‹ä»¶è½‰ç™¼å‡ºå»ï¼ˆä¾‹å¦‚è½‰ç™¼è‡³å‘¼å«çš„æ‡‰ç”¨ç¨‹å¼æˆ– UI é€²è¡Œæ¸²æŸ“ï¼‰ã€‚
5. **è¿­ä»£ (Iterate)ï¼š** é€šçŸ¥ä»£ç†é‚è¼¯ï¼Œé‡å°å·²ç”¢å‡ºäº‹ä»¶çš„è™•ç†å·²å®Œæˆï¼Œå…è¨±å…¶æ¢å¾©ä¸¦ç”Ÿæˆ *ä¸‹ä¸€å€‹* äº‹ä»¶ã€‚

*æ¦‚å¿µæ€§ Runner è¿´åœˆï¼š*

<details>
<summary>ç¯„ä¾‹èªªæ˜</summary>

> Python

```py
# Runner ä¸»è¿´åœˆé‚è¼¯çš„ç°¡åŒ–è¦–åœ–
def run(new_query, ...) -> Generator[Event]:
    # 1. å°‡ new_query é™„åŠ åˆ°å·¥ä½œéšæ®µäº‹ä»¶æ­·å²è¨˜éŒ„ï¼ˆé€é SessionServiceï¼‰
    session_service.append_event(session, Event(author='user', content=new_query))

    # 2. é€éå‘¼å«ä»£ç†å•Ÿå‹•äº‹ä»¶è¿´åœˆ
    agent_event_generator = agent_to_run.run_async(context)

    async for event in agent_event_generator:
        # 3. è™•ç†ç”Ÿæˆçš„äº‹ä»¶ä¸¦æäº¤è®Šæ›´
        session_service.append_event(session, event) # æäº¤ç‹€æ…‹/è£½å“å¢é‡ç­‰
        # memory_service.update_memory(...) # è‹¥é©ç”¨
        # artifact_service å¯èƒ½åœ¨ä»£ç†åŸ·è¡ŒæœŸé–“å·²é€é context è¢«å‘¼å«

        # 4. ç”¢å‡ºäº‹ä»¶ä¾›ä¸Šæ¸¸è™•ç†ï¼ˆä¾‹å¦‚ UI æ¸²æŸ“ï¼‰
        yield event
        # Runner éš±å«åœ°é€šçŸ¥ä»£ç†ç”Ÿæˆå™¨åœ¨ç”¢å‡ºå¾Œå¯ä»¥ç¹¼çºŒ
```

> TypeScript

```typescript
// Runner ä¸»è¿´åœˆé‚è¼¯çš„ç°¡åŒ–è¦–åœ–
async * runAsync(newQuery: Content, ...): AsyncGenerator<Event, void, void> {
    // 1. å°‡ newQuery é™„åŠ åˆ°å·¥ä½œéšæ®µäº‹ä»¶æ­·å²è¨˜éŒ„ï¼ˆé€é SessionServiceï¼‰
    await sessionService.appendEvent({
        session,
        event: createEvent({author: 'user', content: newQuery})
    });

    // 2. é€éå‘¼å«ä»£ç†å•Ÿå‹•äº‹ä»¶è¿´åœˆ
    const agentEventGenerator = agentToRun.runAsync(context);

    for await (const event of agentEventGenerator) {
        // 3. è™•ç†ç”Ÿæˆçš„äº‹ä»¶ä¸¦æäº¤è®Šæ›´
        // æäº¤ç‹€æ…‹/è£½å“å¢é‡ç­‰
        await sessionService.appendEvent({session, event});
        // memoryService.updateMemory(...) // è‹¥é©ç”¨
        // artifactService å¯èƒ½åœ¨ä»£ç†åŸ·è¡ŒæœŸé–“å·²é€é context è¢«å‘¼å«

        // 4. ç”¢å‡ºäº‹ä»¶ä¾›ä¸Šæ¸¸è™•ç†ï¼ˆä¾‹å¦‚ UI æ¸²æŸ“ï¼‰
        yield event;
        // Runner éš±å«åœ°é€šçŸ¥ä»£ç†ç”Ÿæˆå™¨åœ¨ç”¢å‡ºå¾Œå¯ä»¥ç¹¼çºŒ
    }
}
```

> Go

```go
// Go ä¸­ Runner ä¸»è¿´åœˆé‚è¼¯çš„ç°¡åŒ–æ¦‚å¿µè¦–åœ–
func (r *Runner) RunConceptual(ctx context.Context, session *session.Session, newQuery *genai.Content) iter.Seq2[*Event, error] {
    return func(yield func(*Event, error) bool) {
        // 1. å°‡ new_query é™„åŠ åˆ°å·¥ä½œéšæ®µäº‹ä»¶æ­·å²è¨˜éŒ„ï¼ˆé€é SessionServiceï¼‰
        // ...
        userEvent := session.NewEvent(ctx.InvocationID()) // æ¦‚å¿µè¦–åœ–ç°¡åŒ–ç‰ˆ
        userEvent.Author = "user"
        userEvent.LLMResponse = model.LLMResponse{Content: newQuery}

        if _, err := r.sessionService.Append(ctx, &session.AppendRequest{Event: userEvent}); err != nil {
            yield(nil, err)
            return
        }

        // 2. é€éå‘¼å«ä»£ç†å•Ÿå‹•äº‹ä»¶ä¸²æµ
        // å‡è¨­ agent.Run ä¹Ÿè¿”å› iter.Seq2[*Event, error]
        agentEventsAndErrs := r.agent.Run(ctx, &agent.RunRequest{Session: session, Input: newQuery})

        for event, err := range agentEventsAndErrs {
            if err != nil {
                if !yield(event, err) { // å³ä½¿æœ‰éŒ¯èª¤ä¹Ÿç”¢å‡ºäº‹ä»¶ï¼Œç„¶å¾Œåœæ­¢
                    return
                }
                return // ä»£ç†å› éŒ¯èª¤è€ŒçµæŸ
            }

            // 3. è™•ç†ç”Ÿæˆçš„äº‹ä»¶ä¸¦æäº¤è®Šæ›´
            // åƒ…å°‡ééƒ¨åˆ† (non-partial) äº‹ä»¶æäº¤åˆ°å·¥ä½œéšæ®µæœå‹™ï¼ˆå¦‚å¯¦éš›ç¨‹å¼ç¢¼æ‰€ç¤ºï¼‰
            if !event.LLMResponse.Partial {
                if _, err := r.sessionService.Append(ctx, &session.AppendRequest{Event: event}); err != nil {
                    yield(nil, err)
                    return
                }
            }
            // memory_service.update_memory(...) // è‹¥é©ç”¨
            // artifact_service å¯èƒ½åœ¨ä»£ç†åŸ·è¡ŒæœŸé–“å·²é€é context è¢«å‘¼å«

            // 4. ç”¢å‡ºäº‹ä»¶ä¾›ä¸Šæ¸¸è™•ç†
            if !yield(event, nil) {
                return // ä¸Šæ¸¸æ¶ˆè²»è€…å·²åœæ­¢
            }
        }
        // ä»£ç†æˆåŠŸçµæŸ
    }
}
```

> Java

```java
// Java ä¸­ Runner ä¸»è¿´åœˆé‚è¼¯çš„ç°¡åŒ–æ¦‚å¿µè¦–åœ–ã€‚
public Flowable<Event> runConceptual(
    Session session,
    InvocationContext invocationContext,
    Content newQuery
    ) {

    // 1. å°‡ new_query é™„åŠ åˆ°å·¥ä½œéšæ®µäº‹ä»¶æ­·å²è¨˜éŒ„ï¼ˆé€é SessionServiceï¼‰
    // ...
    sessionService.appendEvent(session, userEvent).blockingGet();

    // 2. é€éå‘¼å«ä»£ç†å•Ÿå‹•äº‹ä»¶ä¸²æµ
    Flowable<Event> agentEventStream = agentToRun.runAsync(invocationContext);

    // 3. è™•ç†æ¯å€‹ç”Ÿæˆçš„äº‹ä»¶ï¼Œæäº¤è®Šæ›´ï¼Œä¸¦ã€Œyieldã€æˆ–ã€Œemitã€
    return agentEventStream.map(event -> {
        // é€™æœƒè®Šç•° session ç‰©ä»¶ï¼ˆæ–°å¢äº‹ä»¶ï¼Œå¥—ç”¨ stateDeltaï¼‰ã€‚
        // appendEvent çš„è¿”å›å€¼ (Single<Event>) åœ¨æ¦‚å¿µä¸Š
        // åªæ˜¯è™•ç†å¾Œçš„äº‹ä»¶æœ¬èº«ã€‚
        sessionService.appendEvent(session, event).blockingGet(); // ç°¡åŒ–çš„é˜»å¡å‘¼å«

        // memory_service.update_memory(...) // è‹¥é©ç”¨ - æ¦‚å¿µæ€§
        // artifact_service å¯èƒ½åœ¨ä»£ç†åŸ·è¡ŒæœŸé–“å·²é€é context è¢«å‘¼å«

        // 4. ã€ŒYieldã€äº‹ä»¶ä¾›ä¸Šæ¸¸è™•ç†
        //    åœ¨ RxJava ä¸­ï¼Œåœ¨ map ä¸­è¿”å›äº‹ä»¶å³æœ‰æ•ˆåœ°å°‡å…¶ç”¢å‡ºçµ¦ä¸‹ä¸€å€‹é‹ç®—å­æˆ–è¨‚é–±è€…ã€‚
        return event;
    });
}
```

</details>

### åŸ·è¡Œé‚è¼¯çš„è§’è‰²ï¼ˆä»£ç† (Agent) ã€å·¥å…· (Tool) ã€å›èª¿ (Callback)ï¼‰

æ‚¨åœ¨ä»£ç†ã€å·¥å…·å’Œå›èª¿ä¸­çš„ç¨‹å¼ç¢¼è² è²¬å¯¦éš›çš„é‹ç®—å’Œæ±ºç­–ã€‚å®ƒèˆ‡è¿´åœˆçš„äº’å‹•æ¶‰åŠï¼š

1. **åŸ·è¡Œ (Execute)ï¼š** æ ¹æ“šç•¶å‰çš„ `InvocationContext`ï¼ˆåŒ…æ‹¬æ¢å¾©åŸ·è¡Œæ™‚çš„å·¥ä½œéšæ®µç‹€æ…‹ï¼‰åŸ·è¡Œå…¶é‚è¼¯ã€‚
2. **ç”¢å‡º (Yield)ï¼š** ç•¶é‚è¼¯éœ€è¦é€šè¨Šï¼ˆç™¼é€è¨Šæ¯ã€å‘¼å«å·¥å…·ã€å ±å‘Šç‹€æ…‹è®Šæ›´ï¼‰æ™‚ï¼Œå®ƒæœƒå»ºæ§‹ä¸€å€‹åŒ…å«ç›¸é—œå…§å®¹å’Œå‹•ä½œçš„ `Event`ï¼Œç„¶å¾Œå°‡æ­¤äº‹ä»¶ `yield` å› `Runner`ã€‚
3. **æš«åœ (Pause)ï¼š** è‡³é—œé‡è¦çš„æ˜¯ï¼Œä»£ç†é‚è¼¯çš„åŸ·è¡Œåœ¨ `yield` èªå¥ï¼ˆæˆ– RxJava ä¸­çš„ `return`ï¼‰ä¹‹å¾Œ **ç«‹å³æš«åœ**ã€‚å®ƒç­‰å¾… `Runner` å®Œæˆæ­¥é©Ÿ 3ï¼ˆè™•ç†å’Œæäº¤ï¼‰ã€‚
4. **æ¢å¾© (Resume)ï¼š** *åªæœ‰åœ¨* `Runner` è™•ç†å®Œç”¢å‡ºçš„äº‹ä»¶å¾Œï¼Œä»£ç†é‚è¼¯æ‰æœƒå¾ç·Šæ¥åœ¨ `yield` ä¹‹å¾Œçš„èªå¥æ¢å¾©åŸ·è¡Œã€‚
5. **æŸ¥çœ‹æ›´æ–°ç‹€æ…‹ (See Updated State)ï¼š** æ¢å¾©å¾Œï¼Œä»£ç†é‚è¼¯ç¾åœ¨å¯ä»¥å¯é åœ°å­˜å–å·¥ä½œéšæ®µç‹€æ…‹ (`ctx.session.state`)ï¼Œè©²ç‹€æ…‹åæ˜ äº† `Runner` å¾ *å…ˆå‰ç”¢å‡º (yield) çš„* äº‹ä»¶ä¸­æäº¤çš„è®Šæ›´ã€‚

*æ¦‚å¿µæ€§åŸ·è¡Œé‚è¼¯ï¼š*

<details>
<summary>ç¯„ä¾‹èªªæ˜</summary>

> Python

```py
# Agent.run_asyncã€å›èª¿æˆ–å·¥å…·å…§éƒ¨çš„ç°¡åŒ–é‚è¼¯è¦–åœ–

# ... æ ¹æ“šç•¶å‰ç‹€æ…‹åŸ·è¡Œçš„å…ˆå‰ç¨‹å¼ç¢¼ ...

# 1. ç¢ºå®šéœ€è¦è®Šæ›´æˆ–è¼¸å‡ºï¼Œå»ºæ§‹äº‹ä»¶
# ç¯„ä¾‹ï¼šæ›´æ–°ç‹€æ…‹
update_data = {'field_1': 'value_2'}
event_with_state_change = Event(
    author=self.name,
    actions=EventActions(state_delta=update_data),
    content=types.Content(parts=[types.Part(text="State updated.")])
    # ... å…¶ä»–äº‹ä»¶æ¬„ä½ ...
)

# 2. å°‡äº‹ä»¶ç”¢å‡º (Yield) çµ¦ Runner é€²è¡Œè™•ç†å’Œæäº¤
yield event_with_state_change
# <<<<<<<<<<<< åŸ·è¡Œåœ¨æ­¤æš«åœ >>>>>>>>>>>>

# <<<<<<<<<<<< RUNNER è™•ç†ä¸¦æäº¤äº‹ä»¶ >>>>>>>>>>>>

# 3. åƒ…åœ¨ Runner è™•ç†å®Œä¸Šè¿°äº‹ä»¶å¾Œæ¢å¾©åŸ·è¡Œã€‚
# ç¾åœ¨ï¼Œç”± Runner æäº¤çš„ç‹€æ…‹å·²å¯é åœ°åæ˜ å‡ºä¾†ã€‚
# å¾ŒçºŒç¨‹å¼ç¢¼å¯ä»¥å®‰å…¨åœ°å‡è¨­å·²ç”¢å‡ºäº‹ä»¶ä¸­çš„è®Šæ›´å·²ç™¼ç”Ÿã€‚
val = ctx.session.state['field_1']
# æ­¤è™• `val` ä¿è­‰ç‚º "value_2"ï¼ˆå‡è¨­ Runner æäº¤æˆåŠŸï¼‰
print(f"Resumed execution. Value of field_1 is now: {val}")

# ... å¾ŒçºŒç¨‹å¼ç¢¼ç¹¼çºŒ ...
# ä¹Ÿè¨±ç¨å¾Œç”¢å‡ºå¦ä¸€å€‹äº‹ä»¶...
```

> TypeScript

```typescript
// Agent.runAsyncã€å›èª¿æˆ–å·¥å…·å…§éƒ¨çš„ç°¡åŒ–é‚è¼¯è¦–åœ–

// ... æ ¹æ“šç•¶å‰ç‹€æ…‹åŸ·è¡Œçš„å…ˆå‰ç¨‹å¼ç¢¼ ...

// 1. ç¢ºå®šéœ€è¦è®Šæ›´æˆ–è¼¸å‡ºï¼Œå»ºæ§‹äº‹ä»¶
// ç¯„ä¾‹ï¼šæ›´æ–°ç‹€æ…‹
const updateData = {'field_1': 'value_2'};
const eventWithStateChange = createEvent({
    author: this.name,
    actions: createEventActions({stateDelta: updateData}),
    content: {parts: [{text: "State updated."}]}
    // ... å…¶ä»–äº‹ä»¶æ¬„ä½ ...
});

// 2. å°‡äº‹ä»¶ç”¢å‡º (Yield) çµ¦ Runner é€²è¡Œè™•ç†å’Œæäº¤
yield eventWithStateChange;
// <<<<<<<<<<<< åŸ·è¡Œåœ¨æ­¤æš«åœ >>>>>>>>>>>>

// <<<<<<<<<<<< RUNNER è™•ç†ä¸¦æäº¤äº‹ä»¶ >>>>>>>>>>>>

// 3. åƒ…åœ¨ Runner è™•ç†å®Œä¸Šè¿°äº‹ä»¶å¾Œæ¢å¾©åŸ·è¡Œã€‚
// ç¾åœ¨ï¼Œç”± Runner æäº¤çš„ç‹€æ…‹å·²å¯é åœ°åæ˜ å‡ºä¾†ã€‚
// å¾ŒçºŒç¨‹å¼ç¢¼å¯ä»¥å®‰å…¨åœ°å‡è¨­å·²ç”¢å‡ºäº‹ä»¶ä¸­çš„è®Šæ›´å·²ç™¼ç”Ÿã€‚
const val = ctx.session.state['field_1'];
// æ­¤è™• `val` ä¿è­‰ç‚º "value_2"ï¼ˆå‡è¨­ Runner æäº¤æˆåŠŸï¼‰
console.log(`Resumed execution. Value of field_1 is now: ${val}`);

// ... å¾ŒçºŒç¨‹å¼ç¢¼ç¹¼çºŒ ...
// ä¹Ÿè¨±ç¨å¾Œç”¢å‡ºå¦ä¸€å€‹äº‹ä»¶...
```

> Go

```go
// Agent.Runã€å›èª¿æˆ–å·¥å…·å…§éƒ¨çš„ç°¡åŒ–è¦–åœ–

// ... æ ¹æ“šç•¶å‰ç‹€æ…‹åŸ·è¡Œçš„å…ˆå‰ç¨‹å¼ç¢¼ ...

// 1. ç¢ºå®šéœ€è¦è®Šæ›´æˆ–è¼¸å‡ºï¼Œå»ºæ§‹äº‹ä»¶
// ç¯„ä¾‹ï¼šæ›´æ–°ç‹€æ…‹
updateData := map[string]interface{}{"field_1": "value_2"}
eventWithStateChange := &Event{
    Author: self.Name(),
    Actions: &EventActions{StateDelta: updateData},
    Content: genai.NewContentFromText("State updated.", "model"),
    // ... å…¶ä»–äº‹ä»¶æ¬„ä½ ...
}

// 2. å°‡äº‹ä»¶ç”¢å‡º (Yield) çµ¦ Runner é€²è¡Œè™•ç†å’Œæäº¤
// åœ¨ Go ä¸­ï¼Œé€™æ˜¯é€éå°‡äº‹ä»¶ç™¼é€åˆ°é€šé“ (channel) ä¾†å®Œæˆçš„ã€‚
eventsChan <- eventWithStateChange
// <<<<<<<<<<<< åŸ·è¡Œåœ¨æ­¤æš«åœï¼ˆæ¦‚å¿µä¸Šï¼‰ >>>>>>>>>>>>
// é€šé“å¦ä¸€ç«¯çš„ Runner å°‡æ¥æ”¶ä¸¦è™•ç†è©²äº‹ä»¶ã€‚
// ä»£ç†çš„ goroutine å¯èƒ½æœƒç¹¼çºŒï¼Œä½†é‚è¼¯æµç¨‹æœƒç­‰å¾…ä¸‹ä¸€å€‹è¼¸å…¥æˆ–æ­¥é©Ÿã€‚

// <<<<<<<<<<<< RUNNER è™•ç†ä¸¦æäº¤äº‹ä»¶ >>>>>>>>>>>>

// 3. åƒ…åœ¨ Runner è™•ç†å®Œä¸Šè¿°äº‹ä»¶å¾Œæ¢å¾©åŸ·è¡Œã€‚
// åœ¨å¯¦éš›çš„ Go å¯¦ä½œä¸­ï¼Œé€™å¯èƒ½ç”±ä»£ç†æ¥æ”¶æ–°çš„ RunRequest æˆ–
// æŒ‡ç¤ºä¸‹ä¸€æ­¥é©Ÿçš„ context ä¾†è™•ç†ã€‚æ›´æ–°å¾Œçš„ç‹€æ…‹å°‡æ˜¯è©²æ–°è«‹æ±‚ä¸­
// session ç‰©ä»¶çš„ä¸€éƒ¨åˆ†ã€‚
// å°æ–¼æ­¤æ¦‚å¿µç¯„ä¾‹ï¼Œæˆ‘å€‘åƒ…æª¢æŸ¥ç‹€æ…‹ã€‚
val := ctx.State.Get("field_1")
// æ­¤è™• `val` ä¿è­‰ç‚º "value_2"ï¼Œå› ç‚º Runner åœ¨å†æ¬¡å‘¼å«ä»£ç†ä¹‹å‰
// æœƒæ›´æ–°å·¥ä½œéšæ®µç‹€æ…‹ã€‚
fmt.Printf("Resumed execution. Value of field_1 is now: %v\n", val)

// ... å¾ŒçºŒç¨‹å¼ç¢¼ç¹¼çºŒ ...
// ä¹Ÿè¨±ç¨å¾Œå‘é€šé“ç™¼é€å¦ä¸€å€‹äº‹ä»¶...
```

> Java

```java
// Agent.runAsyncã€å›èª¿æˆ–å·¥å…·å…§éƒ¨çš„ç°¡åŒ–è¦–åœ–
// ... æ ¹æ“šç•¶å‰ç‹€æ…‹åŸ·è¡Œçš„å…ˆå‰ç¨‹å¼ç¢¼ ...

// 1. ç¢ºå®šéœ€è¦è®Šæ›´æˆ–è¼¸å‡ºï¼Œå»ºæ§‹äº‹ä»¶
// ç¯„ä¾‹ï¼šæ›´æ–°ç‹€æ…‹
ConcurrentMap<String, Object> updateData = new ConcurrentHashMap<>();
updateData.put("field_1", "value_2");

EventActions actions = EventActions.builder().stateDelta(updateData).build();
Content eventContent = Content.builder().parts(Part.fromText("State updated.")).build();

Event eventWithStateChange = Event.builder()
    .author(self.name())
    .actions(actions)
    .content(Optional.of(eventContent))
    // ... å…¶ä»–äº‹ä»¶æ¬„ä½ ...
    .build();

// 2. ã€ŒYieldã€äº‹ä»¶ã€‚åœ¨ RxJava ä¸­ï¼Œé€™æ„å‘³è‘—å°‡å…¶ç™¼é€åˆ°ä¸²æµä¸­ã€‚
//    Runnerï¼ˆæˆ–ä¸Šæ¸¸æ¶ˆè²»è€…ï¼‰å°‡è¨‚é–±æ­¤ Flowableã€‚
//    ç•¶ Runner æ¥æ”¶æ­¤äº‹ä»¶æ™‚ï¼Œå®ƒå°‡è™•ç†è©²äº‹ä»¶ï¼ˆä¾‹å¦‚å‘¼å« sessionService.appendEventï¼‰ã€‚
//    Java ADK ä¸­çš„ 'appendEvent' æœƒè®Šç•° 'ctx' (InvocationContext) ä¸­æŒæœ‰çš„ 'Session' ç‰©ä»¶ã€‚

// <<<<<<<<<<<< æ¦‚å¿µä¸Šçš„æš«åœé» >>>>>>>>>>>>
// åœ¨ RxJava ä¸­ï¼Œ'eventWithStateChange' çš„ç™¼é€ç™¼ç”Ÿå¾Œï¼Œä¸²æµ
// å¯èƒ½æœƒç¹¼çºŒé€²è¡Œ 'flatMap' æˆ– 'concatMap' é‹ç®—å­ï¼Œä»£è¡¨
// Runner è™•ç†å®Œæ­¤äº‹ä»¶ *ä¹‹å¾Œ* çš„é‚è¼¯ã€‚

// ç‚ºäº†æ¨¡æ“¬ã€Œåƒ…åœ¨ Runner è™•ç†å®Œæˆå¾Œæ¢å¾©åŸ·è¡Œã€ï¼š
// Runner çš„ `appendEvent` æœ¬èº«é€šå¸¸æ˜¯å€‹éåŒæ­¥æ“ä½œï¼ˆè¿”å› Single<Event>ï¼‰ã€‚
// ä»£ç†çš„æµç¨‹éœ€è¦å»ºæ§‹ç‚ºï¼šä¾è³´æ–¼å·²æäº¤ç‹€æ…‹çš„å¾ŒçºŒé‚è¼¯
// åœ¨è©² `appendEvent` å®Œæˆ *ä¹‹å¾Œ* åŸ·è¡Œã€‚

// é€™é€šå¸¸æ˜¯ Runner å”èª¿å®ƒçš„æ–¹å¼ï¼š
// Runner:
//   agent.runAsync(ctx)
//     .concatMapEager(eventFromAgent ->
//         sessionService.appendEvent(ctx.session(), eventFromAgent) // é€™æœƒæ›´æ–° ctx.session().state()
//             .toFlowable() // åœ¨è™•ç†å¾Œç”¢å‡ºäº‹ä»¶
//     )
//     .subscribe(processedEvent -> { /* UI renders processedEvent */ });

// å› æ­¤ï¼Œåœ¨ä»£ç†è‡ªèº«çš„é‚è¼¯ä¸­ï¼Œå¦‚æœå®ƒéœ€è¦åœ¨å…¶ç”¢å‡ºçš„äº‹ä»¶è¢«è™•ç†
// ä¸”å…¶ç‹€æ…‹è®Šæ›´åæ˜ åœ¨ ctx.session().state() ä¸­ *ä¹‹å¾Œ* åšæŸäº‹ï¼Œ
// è©²å¾ŒçºŒé‚è¼¯é€šå¸¸ä½æ–¼å…¶åæ‡‰éˆçš„å¦ä¸€å€‹æ­¥é©Ÿä¸­ã€‚

// å°æ–¼æ­¤æ¦‚å¿µç¯„ä¾‹ï¼Œæˆ‘å€‘å°‡ç™¼é€äº‹ä»¶ï¼Œç„¶å¾Œæ¨¡æ“¬ã€Œæ¢å¾©ã€
// ä½œç‚º Flowable éˆä¸­çš„å¾ŒçºŒæ“ä½œã€‚

return Flowable.just(eventWithStateChange) // æ­¥é©Ÿ 2ï¼šç”¢å‡ºäº‹ä»¶
    .concatMap(yieldedEvent -> {
        // <<<<<<<<<<<< RUNNER æ¦‚å¿µä¸Šè™•ç†ä¸¦æäº¤äº‹ä»¶ >>>>>>>>>>>>
        // æ­¤æ™‚ï¼Œåœ¨å¯¦éš›çš„ runner ä¸­ï¼ŒRunner æœƒå‘¼å« ctx.session().appendEvent(yieldedEvent)
        // ä¸¦ä¸” ctx.session().state() æœƒè¢«æ›´æ–°ã€‚
        // ç”±æ–¼æˆ‘å€‘ *åœ¨* ä»£ç†çš„æ¦‚å¿µé‚è¼¯ *å…§éƒ¨* è©¦åœ–æ¨¡æ“¬é€™ä¸€é»ï¼Œ
        // æˆ‘å€‘å‡è¨­ Runner çš„å‹•ä½œå·²éš±å«åœ°æ›´æ–°äº†æˆ‘å€‘çš„ 'ctx.session()'ã€‚

        // 3. æ¢å¾©åŸ·è¡Œã€‚
        // ç¾åœ¨ï¼Œç”± Runnerï¼ˆé€é sessionService.appendEventï¼‰æäº¤çš„ç‹€æ…‹
        // å·²å¯é åœ°åæ˜ åœ¨ ctx.session().state() ä¸­ã€‚
        Object val = ctx.session().state().get("field_1");
        // æ­¤è™• `val` ä¿è­‰ç‚º "value_2"ï¼Œå› ç‚º Runner å‘¼å«çš„ `sessionService.appendEvent`
        // æ‡‰è©²å·²æ›´æ–°äº† `ctx` ç‰©ä»¶å…§çš„å·¥ä½œéšæ®µç‹€æ…‹ã€‚

        System.out.println("Resumed execution. Value of field_1 is now: " + val);

        // ... å¾ŒçºŒç¨‹å¼ç¢¼ç¹¼çºŒ ...
        // å¦‚æœæ­¤å¾ŒçºŒç¨‹å¼ç¢¼éœ€è¦ç”¢å‡ºå¦ä¸€å€‹äº‹ä»¶ï¼Œå®ƒå°‡åœ¨æ­¤è™•é€²è¡Œã€‚
```

</details>

é€™ç¨®åœ¨ `Runner` å’Œæ‚¨çš„åŸ·è¡Œé‚è¼¯ä¹‹é–“ï¼Œä»¥ `Event` ç‰©ä»¶ç‚ºåª’ä»‹çš„ç”¢å‡º/æš«åœ/æ¢å¾©çš„å”ä½œå¾ªç’°ï¼Œæ§‹æˆäº† ADK Runtime çš„æ ¸å¿ƒã€‚

## Runtime çš„é—œéµå…ƒä»¶

å¤šå€‹å…ƒä»¶åœ¨ ADK Runtime å…§å”åŒå·¥ä½œä»¥åŸ·è¡Œä»£ç†èª¿ç”¨ã€‚äº†è§£å®ƒå€‘çš„è§’è‰²æœ‰åŠ©æ–¼é‡æ¸…äº‹ä»¶è¿´åœˆå¦‚ä½•é‹ä½œï¼š

1. ### `Runner`

      * **è§’è‰² (Role)ï¼š** å–®æ¬¡ä½¿ç”¨è€…æŸ¥è©¢çš„ä¸»è¦é€²å…¥é»å’Œå”èª¿è€… (`run_async`)ã€‚
      * **åŠŸèƒ½ (Function)ï¼š** ç®¡ç†æ•´é«”äº‹ä»¶è¿´åœˆï¼Œæ¥æ”¶åŸ·è¡Œé‚è¼¯ç”¢å‡ºçš„äº‹ä»¶ï¼Œå”èª¿ Services ä»¥è™•ç†å’Œæäº¤äº‹ä»¶å‹•ä½œï¼ˆç‹€æ…‹/è£½å“è®Šæ›´ï¼‰ï¼Œä¸¦å°‡è™•ç†å¾Œçš„äº‹ä»¶å‘ä¸Šæ¸¸è½‰ç™¼ï¼ˆä¾‹å¦‚è½‰ç™¼è‡³ UIï¼‰ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯æ ¹æ“šç”¢å‡ºçš„äº‹ä»¶é€å›åˆé©…å‹•å°è©±ã€‚ï¼ˆå®šç¾©æ–¼ `google.adk.runners.runner`ï¼‰ã€‚

2. ### åŸ·è¡Œé‚è¼¯å…ƒä»¶ (Execution Logic Components)

      * **è§’è‰² (Role)ï¼š** åŒ…å«æ‚¨çš„è‡ªè¨‚ç¨‹å¼ç¢¼å’Œæ ¸å¿ƒä»£ç†åŠŸèƒ½çš„éƒ¨ä»¶ã€‚
      * **å…ƒä»¶ (Components)ï¼š**
      * `Agent` (`BaseAgent`, `LlmAgent` ç­‰)ï¼šè™•ç†è³‡è¨Šä¸¦æ±ºå®šè¡Œå‹•çš„ä¸»è¦é‚è¼¯å–®å…ƒã€‚å®ƒå€‘å¯¦ä½œäº† `_run_async_impl` æ–¹æ³•ä¾†ç”¢å‡ºäº‹ä»¶ã€‚
      * `Tools` (`BaseTool`, `FunctionTool`, `AgentTool` ç­‰)ï¼šä»£ç†ï¼ˆé€šå¸¸æ˜¯ `LlmAgent`ï¼‰ç”¨ä¾†èˆ‡å¤–ç•Œäº’å‹•æˆ–åŸ·è¡Œç‰¹å®šä»»å‹™çš„å¤–éƒ¨å‡½æ•¸æˆ–åŠŸèƒ½ã€‚å®ƒå€‘åŸ·è¡Œä¸¦è¿”å›çµæœï¼Œé€™äº›çµæœéš¨å¾Œè¢«åŒ…è£¹åœ¨äº‹ä»¶ä¸­ã€‚
      * `Callbacks`ï¼ˆå›èª¿å‡½æ•¸ï¼‰ï¼šé™„åŠ åˆ°ä»£ç†çš„ä½¿ç”¨è€…å®šç¾©å‡½æ•¸ï¼ˆä¾‹å¦‚ `before_agent_callback`, `after_model_callback`ï¼‰ï¼Œæ›é‰¤åˆ°åŸ·è¡Œæµç¨‹ä¸­çš„ç‰¹å®šé»ï¼Œå¯èƒ½æœƒä¿®æ”¹è¡Œç‚ºæˆ–ç‹€æ…‹ï¼Œå…¶æ•ˆæœæœƒè¢«æ•æ‰åœ¨äº‹ä»¶ä¸­ã€‚
      * **åŠŸèƒ½ (Function)ï¼š** åŸ·è¡Œå¯¦éš›çš„æ€è€ƒã€è¨ˆç®—æˆ–å¤–éƒ¨äº’å‹•ã€‚å®ƒå€‘é€é **ç”¢å‡º `Event` ç‰©ä»¶** ä¸¦æš«åœç›´åˆ° Runner è™•ç†å®ƒå€‘ï¼Œä¾†å‚³é”å…¶çµæœæˆ–éœ€æ±‚ã€‚

3. ### `Event`

      * **è§’è‰² (Role)ï¼š** åœ¨ `Runner` å’ŒåŸ·è¡Œé‚è¼¯ä¹‹é–“ä¾†å›å‚³éçš„è¨Šæ¯ã€‚
      * **åŠŸèƒ½ (Function)ï¼š** ä»£è¡¨ä¸€å€‹åŸå­æ€§çš„ç™¼ç”Ÿï¼ˆä½¿ç”¨è€…è¼¸å…¥ã€ä»£ç†æ–‡å­—ã€å·¥å…·å‘¼å«/çµæœã€ç‹€æ…‹è®Šæ›´è«‹æ±‚ã€æ§åˆ¶è¨Šè™Ÿï¼‰ã€‚å®ƒåŒæ™‚æ”œå¸¶ç™¼ç”Ÿçš„å…§å®¹å’Œé æœŸçš„å‰¯ä½œç”¨ï¼ˆå¦‚ `state_delta` ç­‰ `actions`ï¼‰ã€‚

4. ### `Services`

      * **è§’è‰² (Role)ï¼š** è² è²¬ç®¡ç†æŒä¹…æ€§æˆ–å…±ç”¨è³‡æºçš„å¾Œç«¯å…ƒä»¶ã€‚ä¸»è¦ç”± `Runner` åœ¨äº‹ä»¶è™•ç†æœŸé–“ä½¿ç”¨ã€‚
      * **å…ƒä»¶ (Components)ï¼š**
      * `SessionService` (`BaseSessionService`, `InMemorySessionService` ç­‰)ï¼šç®¡ç† `Session` ç‰©ä»¶ï¼ŒåŒ…æ‹¬å„²å­˜/è¼‰å…¥å®ƒå€‘ï¼Œå°‡ `state_delta` å¥—ç”¨åˆ°å·¥ä½œéšæ®µç‹€æ…‹ï¼Œä»¥åŠå°‡äº‹ä»¶é™„åŠ åˆ° `event history`ï¼ˆäº‹ä»¶æ­·å²è¨˜éŒ„ï¼‰ã€‚
      * `ArtifactService` (`BaseArtifactService`, `InMemoryArtifactService`, `GcsArtifactService` ç­‰)ï¼šç®¡ç†äºŒé€²ä½è£½å“è³‡æ–™çš„å„²å­˜å’Œæª¢ç´¢ã€‚é›–ç„¶ `save_artifact` æ˜¯åœ¨åŸ·è¡Œé‚è¼¯æœŸé–“é€é context å‘¼å«çš„ï¼Œä½†äº‹ä»¶ä¸­çš„ `artifact_delta` ç¢ºèªäº† Runner/SessionService çš„å‹•ä½œã€‚
      * `MemoryService` (`BaseMemoryService` ç­‰)ï¼šï¼ˆå¯é¸ï¼‰ç®¡ç†ä½¿ç”¨è€…è·¨å·¥ä½œéšæ®µçš„é•·æœŸèªæ„è¨˜æ†¶ã€‚
      * **åŠŸèƒ½ (Fuction)ï¼š** æä¾›æŒä¹…å±¤ã€‚`Runner` èˆ‡å®ƒå€‘äº’å‹•ï¼Œä»¥ç¢ºä¿ `event.actions` ç™¼å‡ºçš„è®Šæ›´åœ¨åŸ·è¡Œé‚è¼¯æ¢å¾© *ä¹‹å‰* è¢«å¯é åœ°å„²å­˜ã€‚

5. ### `Session`

      * **è§’è‰² (Role)ï¼š** ä¸€å€‹è³‡æ–™å®¹å™¨ï¼Œä¿å­˜ä½¿ç”¨è€…èˆ‡æ‡‰ç”¨ç¨‹å¼ä¹‹é–“ *ä¸€æ¬¡ç‰¹å®šå°è©±* çš„ç‹€æ…‹å’Œæ­·å²è¨˜éŒ„ã€‚
      * **åŠŸèƒ½ (Function)ï¼š** å„²å­˜ç›®å‰çš„ `state` å­—å…¸ã€æ‰€æœ‰éå» `events` çš„åˆ—è¡¨ï¼ˆ`event history`ï¼‰ï¼Œä»¥åŠç›¸é—œè£½å“çš„åƒè€ƒã€‚é€™æ˜¯äº’å‹•çš„ä¸»è¦è¨˜éŒ„ï¼Œç”± `SessionService` ç®¡ç†ã€‚

6. ### `Invocation`

      * **è§’è‰² (Role)ï¼š** ä¸€å€‹æ¦‚å¿µæ€§è¡“èªï¼Œä»£è¡¨å›æ‡‰ *å–®æ¬¡* ä½¿ç”¨è€…æŸ¥è©¢æ‰€ç™¼ç”Ÿçš„ä¸€åˆ‡ï¼Œå¾ `Runner` æ”¶åˆ°æŸ¥è©¢çš„é‚£ä¸€åˆ»èµ·ï¼Œç›´åˆ°ä»£ç†é‚è¼¯å®Œæˆè©²æŸ¥è©¢çš„äº‹ä»¶ç”¢å‡ºç‚ºæ­¢ã€‚
      * **åŠŸèƒ½ (Function)ï¼š** ä¸€æ¬¡èª¿ç”¨å¯èƒ½æ¶‰åŠå¤šæ¬¡ä»£ç†åŸ·è¡Œï¼ˆå¦‚æœä½¿ç”¨ä»£ç†è½‰ç§»æˆ– `AgentTool`ï¼‰ã€å¤šæ¬¡ LLM å‘¼å«ã€å·¥å…·åŸ·è¡Œå’Œå›èª¿åŸ·è¡Œï¼Œæ‰€æœ‰é€™äº›éƒ½ç”± `InvocationContext` ä¸­çš„å–®å€‹ `invocation_id` è¯ç¹«åœ¨ä¸€èµ·ã€‚å‰ç¶´ç‚º `temp:` çš„ç‹€æ…‹è®Šæ•¸åš´æ ¼é™å®šæ–¼å–®æ¬¡èª¿ç”¨ï¼Œä¹‹å¾Œæœƒè¢«ä¸Ÿæ£„ã€‚

é€™äº›åƒèˆ‡è€…é€éäº‹ä»¶è¿´åœˆæŒçºŒäº’å‹•ä»¥è™•ç†ä½¿ç”¨è€…çš„è«‹æ±‚ã€‚

## é‹ä½œæ–¹å¼ï¼šç°¡åŒ–çš„èª¿ç”¨æµç¨‹

è®“æˆ‘å€‘è¿½è¹¤ä¸€å€‹æ¶‰åŠ LLM ä»£ç†å‘¼å«å·¥å…·çš„å…¸å‹ä½¿ç”¨è€…æŸ¥è©¢çš„ç°¡åŒ–æµç¨‹ï¼š

![intro_components.png](https://google.github.io/adk-docs/assets/invocation-flow.png)

### é€æ­¥åˆ†è§£

1. **ä½¿ç”¨è€…è¼¸å…¥ (User Input)ï¼š** ä½¿ç”¨è€…ç™¼é€æŸ¥è©¢ï¼ˆä¾‹å¦‚ã€Œæ³•åœ‹çš„é¦–éƒ½æ˜¯å“ªè£¡ï¼Ÿã€ï¼‰ã€‚
2. **Runner å•Ÿå‹• (Runner Starts)ï¼š** `Runner.run_async` é–‹å§‹ã€‚å®ƒèˆ‡ `SessionService` äº’å‹•ä»¥è¼‰å…¥ç›¸é—œçš„ `Session`ï¼Œä¸¦å°‡ä½¿ç”¨è€…æŸ¥è©¢ä½œç‚ºç¬¬ä¸€å€‹ `Event` æ–°å¢åˆ°å·¥ä½œéšæ®µæ­·å²è¨˜éŒ„ä¸­ã€‚æº–å‚™ä¸€å€‹ `InvocationContext` (`ctx`)ã€‚
3. **ä»£ç†åŸ·è¡Œ (Agent Execution)ï¼š** `Runner` åœ¨æŒ‡å®šçš„æ ¹ä»£ç†ï¼ˆä¾‹å¦‚ `LlmAgent`ï¼‰ä¸Šå‘¼å« `agent.run_async(ctx)`ã€‚
4. **LLM å‘¼å«ï¼ˆç¯„ä¾‹ï¼‰ï¼š** `Agent_Llm` ç¢ºå®šå®ƒéœ€è¦è³‡è¨Šï¼Œå¯èƒ½æ˜¯é€éå‘¼å«å·¥å…·ã€‚å®ƒæº–å‚™ä¸€å€‹ `LLM` è«‹æ±‚ã€‚å‡è¨­ LLM æ±ºå®šå‘¼å« `MyTool`ã€‚
5. **ç”¢å‡º FunctionCall äº‹ä»¶ (Yield FunctionCall Event)ï¼š** `Agent_Llm` æ”¶åˆ°ä¾†è‡ª LLM çš„ `FunctionCall` å›æ‡‰ï¼Œå°‡å…¶åŒ…è£¹åœ¨ `Event(author='Agent_Llm', content=Content(parts=[Part(function_call=...)]))` ä¸­ï¼Œä¸¦ `yields`ï¼ˆç”¢å‡ºï¼‰æˆ– `emits`ï¼ˆç™¼å‡ºï¼‰æ­¤äº‹ä»¶ã€‚
6. **ä»£ç†æš«åœ (Agent Pauses)ï¼š** `Agent_Llm` çš„åŸ·è¡Œåœ¨ `yield` ä¹‹å¾Œç«‹å³æš«åœã€‚
7. **Runner è™•ç† (Runner Processes)ï¼š** `Runner` æ¥æ”¶ FunctionCall äº‹ä»¶ã€‚å®ƒå°‡å…¶å‚³éçµ¦ `SessionService` ä»¥è¨˜éŒ„åœ¨æ­·å²ä¸­ã€‚`Runner` éš¨å¾Œå°‡äº‹ä»¶å‘ä¸Šæ¸¸ç”¢å‡ºçµ¦ `User`ï¼ˆæˆ–æ‡‰ç”¨ç¨‹å¼ï¼‰ã€‚
8. **ä»£ç†æ¢å¾© (Agent Resumes)ï¼š** `Runner` ç™¼å‡ºäº‹ä»¶å·²è™•ç†çš„ä¿¡è™Ÿï¼Œ`Agent_Llm` æ¢å¾©åŸ·è¡Œã€‚
9. **å·¥å…·åŸ·è¡Œ (Tool Execution)ï¼š** `Agent_Llm` çš„å…§éƒ¨æµç¨‹ç¾åœ¨ç¹¼çºŒåŸ·è¡Œè«‹æ±‚çš„ `MyTool`ã€‚å®ƒå‘¼å« `tool.run_async(...)`ã€‚
10. **å·¥å…·è¿”å›çµæœ (Tool Returns Result)ï¼š** `MyTool` åŸ·è¡Œä¸¦è¿”å›å…¶çµæœï¼ˆä¾‹å¦‚ `{'result': 'Paris'}`ï¼‰ã€‚
11. **ç”¢å‡º FunctionResponse äº‹ä»¶ (Yield FunctionResponse Event)ï¼š** ä»£ç† (`Agent_Llm`) å°‡å·¥å…·çµæœåŒ…è£¹é€²åŒ…å« `FunctionResponse` éƒ¨åˆ†çš„ `Event` ä¸­ï¼ˆä¾‹å¦‚ `Event(author='Agent_Llm', content=Content(role='user', parts=[Part(function_response=...)]))`ï¼‰ã€‚å¦‚æœå·¥å…·ä¿®æ”¹äº†ç‹€æ…‹ (`state_delta`) æˆ–å„²å­˜äº†è£½å“ (`artifact_delta`)ï¼Œæ­¤äº‹ä»¶ä¹Ÿå¯èƒ½åŒ…å« `actions`ã€‚ä»£ç† `yield`sï¼ˆç”¢å‡ºï¼‰æ­¤äº‹ä»¶ã€‚
12. **ä»£ç†æš«åœ (Agent Pauses)ï¼š** `Agent_Llm` å†æ¬¡æš«åœã€‚
13. **Runner è™•ç† (Runner Processes)ï¼š** `Runner` æ¥æ”¶ FunctionResponse äº‹ä»¶ã€‚å®ƒå°‡å…¶å‚³éçµ¦ `SessionService`ï¼Œå¾Œè€…å¥—ç”¨ä»»ä½• `state_delta`/`artifact_delta` ä¸¦å°‡äº‹ä»¶æ–°å¢åˆ°æ­·å²ä¸­ã€‚`Runner` å°‡äº‹ä»¶å‘ä¸Šæ¸¸ç”¢å‡ºã€‚
14. **ä»£ç†æ¢å¾© (Agent Resumes)ï¼š** `Agent_Llm` æ¢å¾©ï¼Œç¾åœ¨çŸ¥é“å·¥å…·çµæœä¸”ä»»ä½•ç‹€æ…‹è®Šæ›´å‡å·²æäº¤ã€‚
15. **æœ€çµ‚ LLM å‘¼å«ï¼ˆç¯„ä¾‹ï¼‰ï¼š** `Agent_Llm` å°‡å·¥å…·çµæœç™¼é€å› `LLM` ä»¥ç”Ÿæˆè‡ªç„¶èªè¨€å›æ‡‰ã€‚
16. **ç”¢å‡ºæœ€çµ‚æ–‡å­—äº‹ä»¶ (Yield Final Text Event)ï¼š** `Agent_Llm` æ”¶åˆ°ä¾†è‡ª `LLM` çš„æœ€çµ‚æ–‡å­—ï¼Œå°‡å…¶åŒ…è£¹åœ¨ `Event(author='Agent_Llm', content=Content(parts=[Part(text=...)]))` ä¸­ï¼Œä¸¦ `yield`sï¼ˆç”¢å‡ºï¼‰å®ƒã€‚
17. **ä»£ç†æš«åœ (Agent Pauses)ï¼š** `Agent_Llm` æš«åœã€‚
18. **Runner è™•ç† (Runner Processes)ï¼š** `Runner` æ¥æ”¶æœ€çµ‚æ–‡å­—äº‹ä»¶ï¼Œå°‡å…¶å‚³éçµ¦ `SessionService` é€²è¡Œè¨˜éŒ„ï¼Œä¸¦å°‡å…¶å‘ä¸Šæ¸¸ç”¢å‡ºçµ¦ `User`ã€‚é€™å¯èƒ½è¢«æ¨™è¨˜ç‚º `is_final_response()`ã€‚
19. **ä»£ç†æ¢å¾©èˆ‡çµæŸ (Agent Resumes & Finishes)ï¼š** `Agent_Llm` æ¢å¾©ã€‚ç”±æ–¼å·²å®Œæˆæ­¤èª¿ç”¨çš„ä»»å‹™ï¼Œå…¶ `run_async` ç”Ÿæˆå™¨çµæŸã€‚
20. **Runner å®Œæˆ (Runner Completes)ï¼š** `Runner` çœ‹åˆ°ä»£ç†çš„ç”Ÿæˆå™¨å·²è€—ç›¡ï¼Œä¸¦çµæŸæ­¤èª¿ç”¨çš„è¿´åœˆã€‚

#### æµç¨‹æ•´åˆè¡¨

| æ­¥é©Ÿ | æµç¨‹ | æµç¨‹å°è±¡ | é‡é»èªªæ˜ |
|------|----------|----------|----------|
| 1 | ä½¿ç”¨è€…è¼¸å…¥ (User Input) | User â†’ Runner | ä½¿ç”¨è€…ç™¼é€æŸ¥è©¢(ä¾‹å¦‚ã€Œæ³•åœ‹çš„é¦–éƒ½æ˜¯å“ªè£¡?ã€) |
| 2 | Runner å•Ÿå‹• (Runner Starts) | Runner â†’ SessionService | Runner è¼‰å…¥ Session,å°‡ä½¿ç”¨è€…æŸ¥è©¢ä½œç‚ºé¦–å€‹ Event æ–°å¢è‡³æ­·å²,æº–å‚™ InvocationContext |
| 3 | ä»£ç†åŸ·è¡Œ (Agent Execution) | Runner â†’ Agent | Runner å‘¼å«æ ¹ä»£ç†çš„ `agent.run_async(ctx)` |
| 4 | LLM å‘¼å« (LLM Call) | Agent â†’ LLM | Agent å‘ LLM è«‹æ±‚è³‡è¨Š,LLM æ±ºå®šå‘¼å« MyTool |
| 5 | ç”¢å‡º FunctionCall äº‹ä»¶ (Yield FunctionCall Event) | Agent â†’ Runner | Agent å°‡ FunctionCall åŒ…è£¹æˆ Event ä¸¦ yield |
| 6 | ä»£ç†æš«åœ (Agent Pauses) | Agent | **Agent åŸ·è¡Œåœ¨ yield å¾Œç«‹å³æš«åœ** |
| 7 | Runner è™•ç† (Runner Processes) | Runner â†’ SessionService â†’ User | Runner æ¥æ”¶äº‹ä»¶,è¨˜éŒ„è‡³æ­·å²,å‘ä¸Šæ¸¸ç”¢å‡º |
| 8 | ä»£ç†æ¢å¾© (Agent Resumes) | Runner â†’ Agent | **Runner ç™¼å‡ºè™•ç†å®Œæˆä¿¡è™Ÿ,Agent æ¢å¾©åŸ·è¡Œ** |
| 9 | å·¥å…·åŸ·è¡Œ (Tool Execution) | Agent â†’ MyTool | Agent å‘¼å« `tool.run_async(...)` |
| 10 | å·¥å…·è¿”å›çµæœ (Tool Returns Result) | MyTool â†’ Agent | MyTool åŸ·è¡Œä¸¦è¿”å›çµæœ(ä¾‹å¦‚ `{'result': 'Paris'}`) |
| 11 | ç”¢å‡º FunctionResponse äº‹ä»¶ (Yield FunctionResponse Event) | Agent â†’ Runner | Agent å°‡å·¥å…·çµæœåŒ…è£¹æˆå« FunctionResponse çš„ Event,å¯èƒ½åŒ…å« state_delta/artifact_delta,ä¸¦ yield |
| 12 | ä»£ç†æš«åœ (Agent Pauses) | Agent | **Agent å†æ¬¡æš«åœ** |
| 13 | Runner è™•ç† (Runner Processes) | Runner â†’ SessionService â†’ User | Runner æ¥æ”¶äº‹ä»¶,å¥—ç”¨ state_delta/artifact_delta,è¨˜éŒ„è‡³æ­·å²,å‘ä¸Šæ¸¸ç”¢å‡º |
| 14 | ä»£ç†æ¢å¾© (Agent Resumes) | Runner â†’ Agent | **Agent æ¢å¾©,æ­¤æ™‚ç‹€æ…‹è®Šæ›´å·²æäº¤** |
| 15 | æœ€çµ‚ LLM å‘¼å« (Final LLM Call) | Agent â†’ LLM | Agent å°‡å·¥å…·çµæœç™¼é€å› LLM ä»¥ç”Ÿæˆè‡ªç„¶èªè¨€å›æ‡‰ |
| 16 | ç”¢å‡ºæœ€çµ‚æ–‡å­—äº‹ä»¶ (Yield Final Text Event) | Agent â†’ Runner | Agent å°‡ LLM æœ€çµ‚æ–‡å­—åŒ…è£¹æˆ Event ä¸¦ yield |
| 17 | ä»£ç†æš«åœ (Agent Pauses) | Agent | **Agent æš«åœ** |
| 18 | Runner è™•ç† (Runner Processes) | Runner â†’ SessionService â†’ User | Runner æ¥æ”¶æœ€çµ‚æ–‡å­—äº‹ä»¶,è¨˜éŒ„è‡³æ­·å²,å‘ä¸Šæ¸¸ç”¢å‡º(å¯èƒ½æ¨™è¨˜ç‚º `is_final_response()`) |
| 19 | ä»£ç†æ¢å¾©èˆ‡çµæŸ (Agent Resumes & Finishes) | Runner â†’ Agent | **Agent æ¢å¾©,å®Œæˆä»»å‹™å¾Œå…¶ run_async ç”Ÿæˆå™¨çµæŸ** |
| 20 | Runner å®Œæˆ (Runner Completes) | Runner | Runner æª¢æ¸¬åˆ°ä»£ç†ç”Ÿæˆå™¨å·²è€—ç›¡,çµæŸæ­¤æ¬¡èª¿ç”¨çš„è¿´åœˆ |

æ­¤ç”¢å‡º/æš«åœ/è™•ç†/æ¢å¾©å¾ªç’°ç¢ºä¿ç‹€æ…‹è®Šæ›´è¢«ä¸€è‡´åœ°å¥—ç”¨ï¼Œä¸¦ä¸”åŸ·è¡Œé‚è¼¯åœ¨ç”¢å‡ºäº‹ä»¶å¾Œç¸½æ˜¯åŸºæ–¼æœ€è¿‘æäº¤çš„ç‹€æ…‹é€²è¡Œæ“ä½œã€‚

## é‡è¦çš„ Runtime è¡Œç‚º

äº†è§£ ADK Runtime å¦‚ä½•è™•ç†ç‹€æ…‹ã€ä¸²æµå’ŒéåŒæ­¥æ“ä½œçš„å¹¾å€‹é—œéµæ–¹é¢ï¼Œå°æ–¼å»ºç«‹å¯é æ¸¬ä¸”é«˜æ•ˆçš„ä»£ç†è‡³é—œé‡è¦ã€‚

### ç‹€æ…‹æ›´æ–°èˆ‡æäº¤æ™‚æ©Ÿ

* **è¦å‰‡ï¼š** ç•¶æ‚¨çš„ç¨‹å¼ç¢¼ï¼ˆåœ¨ä»£ç†ã€å·¥å…·æˆ–å›èª¿ä¸­ï¼‰ä¿®æ”¹å·¥ä½œéšæ®µç‹€æ…‹ï¼ˆä¾‹å¦‚ `context.state['my_key'] = 'new_value'`ï¼‰æ™‚ï¼Œæ­¤è®Šæ›´æœ€åˆåƒ…è¨˜éŒ„åœ¨ç•¶å‰ `InvocationContext` çš„æœ¬åœ°ã€‚åªæœ‰åœ¨æ”œå¸¶ç›¸æ‡‰ `state_delta` çš„ `Event` åœ¨å…¶ `actions` ä¸­è¢«æ‚¨çš„ç¨‹å¼ç¢¼ `yield`ï¼ˆç”¢å‡ºï¼‰ä¸¦éš¨å¾Œç”± `Runner` è™•ç† *ä¹‹å¾Œ*ï¼Œè©²è®Šæ›´æ‰ **ä¿è­‰è¢«æŒä¹…åŒ–**ï¼ˆç”± `SessionService` å„²å­˜ï¼‰ã€‚

* **å«ç¾©ï¼š** åœ¨å¾ `yield` æ¢å¾© *ä¹‹å¾Œ* åŸ·è¡Œçš„ç¨‹å¼ç¢¼å¯ä»¥å¯é åœ°å‡è¨­ *å·²ç”¢å‡ºäº‹ä»¶* ä¸­ç™¼å‡ºçš„ç‹€æ…‹è®Šæ›´å·²è¢«æäº¤ã€‚

<details>
<summary>ç¯„ä¾‹èªªæ˜</summary>

> Python

```py
# ä»£ç†é‚è¼¯å…§éƒ¨ï¼ˆæ¦‚å¿µæ€§ï¼‰

# 1. ä¿®æ”¹ç‹€æ…‹
ctx.session.state['status'] = 'processing'
event1 = Event(..., actions=EventActions(state_delta={'status': 'processing'}))

# 2. ç”¢å‡ºå¸¶æœ‰å¢é‡çš„äº‹ä»¶
yield event1
# --- æš«åœ --- Runner è™•ç† event1ï¼ŒSessionService æäº¤ 'status' = 'processing' ---

# 3. æ¢å¾©åŸ·è¡Œ
# ç¾åœ¨å¯ä»¥å®‰å…¨åœ°ä¾è³´å·²æäº¤çš„ç‹€æ…‹
current_status = ctx.session.state['status'] # ä¿è­‰ç‚º 'processing'
print(f"Status after resuming: {current_status}")
```

> TypeScript

```typescript
// ä»£ç†é‚è¼¯å…§éƒ¨ï¼ˆæ¦‚å¿µæ€§ï¼‰

// 1. ä¿®æ”¹ç‹€æ…‹
// åœ¨ TypeScript ä¸­ï¼Œæ‚¨é€é context ä¿®æ”¹ç‹€æ…‹ï¼Œå®ƒæœƒè¿½è¹¤è®Šæ›´ã€‚
ctx.state.set('status', 'processing');
// æ¡†æ¶æœƒè‡ªå‹•å¾ context ä¸­å°‡ç‹€æ…‹å¢é‡å¡«å…¥ actionsã€‚
// ç‚ºäº†èªªæ˜ï¼Œæ­¤è™•é¡¯ç¤ºå¦‚ä¸‹ã€‚
const event1 = createEvent({
    actions: createEventActions({stateDelta: {'status': 'processing'}}),
    // ... å…¶ä»–äº‹ä»¶æ¬„ä½
});

// 2. ç”¢å‡ºå¸¶æœ‰å¢é‡çš„äº‹ä»¶
yield event1;
// --- æš«åœ --- Runner è™•ç† event1ï¼ŒSessionService æäº¤ 'status' = 'processing' ---

// 3. æ¢å¾©åŸ·è¡Œ
// ç¾åœ¨å¯ä»¥å®‰å…¨åœ°ä¾è³´ session ç‰©ä»¶ä¸­çš„å·²æäº¤ç‹€æ…‹ã€‚
const currentStatus = ctx.session.state['status']; // ä¿è­‰ç‚º 'processing'
console.log(`Status after resuming: ${currentStatus}`);
```

> Go

```go
  // ä»£ç†é‚è¼¯å…§éƒ¨ï¼ˆæ¦‚å¿µæ€§ï¼‰

func (a *Agent) RunConceptual(ctx agent.InvocationContext) iter.Seq2[*session.Event, error] {
  // æ•´å€‹é‚è¼¯åŒ…è£¹åœ¨ä¸€å€‹å°‡ä½œç‚ºè¿­ä»£å™¨è¿”å›çš„å‡½æ•¸ä¸­ã€‚
  return func(yield func(*session.Event, error) bool) {
      // ... æ ¹æ“šè¼¸å…¥ `ctx` çš„ç•¶å‰ç‹€æ…‹åŸ·è¡Œçš„å…ˆå‰ç¨‹å¼ç¢¼ ...
      // ä¾‹å¦‚ï¼Œval := ctx.State().Get("field_1") åœ¨æ­¤å¯èƒ½è¿”å› "value_1"ã€‚

      // 1. ç¢ºå®šéœ€è¦è®Šæ›´æˆ–è¼¸å‡ºï¼Œå»ºæ§‹äº‹ä»¶
      updateData := map[string]interface{}{"field_1": "value_2"}
      eventWithStateChange := session.NewEvent(ctx.InvocationID())
      eventWithStateChange.Author = a.Name()
      eventWithStateChange.Actions = &session.EventActions{StateDelta: updateData}
      // ... å…¶ä»–äº‹ä»¶æ¬„ä½ ...


      // 2. å°‡äº‹ä»¶ç”¢å‡º (Yield) çµ¦ Runner é€²è¡Œè™•ç†å’Œæäº¤ã€‚
      // ä»£ç†çš„åŸ·è¡Œåœ¨æ­¤å‘¼å«å¾Œç«‹å³ç¹¼çºŒã€‚
      if !yield(eventWithStateChange, nil) {
          // å¦‚æœ yield è¿”å› falseï¼Œè¡¨ç¤ºæ¶ˆè²»è€… (Runner)
          // å·²åœæ­¢ç›£è½ï¼Œå› æ­¤æˆ‘å€‘æ‡‰è©²åœæ­¢ç”¢ç”Ÿäº‹ä»¶ã€‚
          return
      }

      // <<<<<<<<<<<< RUNNER è™•ç†ä¸¦æäº¤äº‹ä»¶ >>>>>>>>>>>>
      // é€™ç™¼ç”Ÿåœ¨ä»£ç†å¤–éƒ¨ï¼Œåœ¨ä»£ç†çš„è¿­ä»£å™¨ç”¢ç”Ÿäº‹ä»¶ä¹‹å¾Œã€‚

      // 3. ä»£ç† *ä¸èƒ½* ç«‹å³çœ‹åˆ°å®ƒå‰›å‰›ç”¢å‡ºçš„ç‹€æ…‹è®Šæ›´ã€‚
      // åœ¨å–®æ¬¡ `Run` èª¿ç”¨ä¸­ï¼Œç‹€æ…‹æ˜¯ä¸å¯è®Šçš„ã€‚
      val := ctx.State().Get("field_1")
      // æ­¤è™•çš„ `val` *ä»ç„¶* æ˜¯ "value_1"ï¼ˆæˆ–é–‹å§‹æ™‚çš„ä»»ä½•å€¼ï¼‰ã€‚
      // æ›´æ–°å¾Œçš„ç‹€æ…‹ ("value_2") åƒ…åœ¨å¾ŒçºŒå›åˆçš„ *ä¸‹ä¸€æ¬¡* `Run` èª¿ç”¨
      // çš„ `ctx` ä¸­å¯ç”¨ã€‚

      // ... å¾ŒçºŒç¨‹å¼ç¢¼ç¹¼çºŒï¼Œå¯èƒ½ç”¢å‡ºæ›´å¤šäº‹ä»¶ ...
      finalEvent := session.NewEvent(ctx.InvocationID())
      finalEvent.Author = a.Name()
      // ...
      yield(finalEvent, nil)
  }
}
```

> Java

```java
// ä»£ç†é‚è¼¯å…§éƒ¨ï¼ˆæ¦‚å¿µæ€§ï¼‰
// ... æ ¹æ“šç•¶å‰ç‹€æ…‹åŸ·è¡Œçš„å…ˆå‰ç¨‹å¼ç¢¼ ...

// 1. æº–å‚™ç‹€æ…‹ä¿®æ”¹ä¸¦å»ºæ§‹äº‹ä»¶
ConcurrentHashMap<String, Object> stateChanges = new ConcurrentHashMap<>();
stateChanges.put("status", "processing");

EventActions actions = EventActions.builder().stateDelta(stateChanges).build();
Content content = Content.builder().parts(Part.fromText("Status update: processing")).build();

Event event1 = Event.builder()
    .actions(actions)
    // ...
    .build();

// 2. ç”¢å‡ºå¸¶æœ‰å¢é‡çš„äº‹ä»¶
return Flowable.just(event1)
    .map(
        emittedEvent -> {
            // --- æ¦‚å¿µæ€§æš«åœèˆ‡ Runner è™•ç† ---
            // 3. æ¢å¾©åŸ·è¡Œï¼ˆæ¦‚å¿µæ€§ï¼‰
            // ç¾åœ¨å¯ä»¥å®‰å…¨åœ°ä¾è³´å·²æäº¤çš„ç‹€æ…‹ã€‚
            String currentStatus = (String) ctx.session().state().get("status");
            System.out.println("Status after resuming (inside agent logic): " + currentStatus); // ä¿è­‰ç‚º 'processing'

            // äº‹ä»¶æœ¬èº« (event1) è¢«å‚³éä¸‹å»ã€‚
            // å¦‚æœæ­¤ä»£ç†æ­¥é©Ÿä¸­çš„å¾ŒçºŒé‚è¼¯ç”¢ç”Ÿäº† *å¦ä¸€å€‹* äº‹ä»¶ï¼Œ
            // æ‚¨æœƒä½¿ç”¨ concatMap ä¾†ç™¼é€è©²æ–°äº‹ä»¶ã€‚
            return emittedEvent;
        });

// ... å¾ŒçºŒä»£ç†é‚è¼¯å¯èƒ½æ¶‰åŠé€²ä¸€æ­¥çš„åæ‡‰å¼é‹ç®—å­
// æˆ–æ ¹æ“šç¾åœ¨å·²æ›´æ–°çš„ `ctx.session().state()` ç™¼é€æ›´å¤šäº‹ä»¶ã€‚
```

</details>

### å·¥ä½œéšæ®µç‹€æ…‹çš„ã€Œé«’è®€ (Dirty Reads)ã€

* **å®šç¾©ï¼š** é›–ç„¶æäº¤ç™¼ç”Ÿåœ¨ç”¢å‡º *ä¹‹å¾Œ*ï¼Œä½† *åœ¨åŒä¸€æ¬¡èª¿ç”¨å…§* ç¨å¾ŒåŸ·è¡Œï¼Œä½† *åœ¨* æ”¹è®Šç‹€æ…‹çš„äº‹ä»¶å¯¦éš›è¢«ç”¢å‡ºå’Œè™•ç† *ä¹‹å‰* çš„ç¨‹å¼ç¢¼ï¼Œ**é€šå¸¸å¯ä»¥çœ‹åˆ°æœ¬åœ°çš„ã€æœªæäº¤çš„è®Šæ›´**ã€‚é€™æœ‰æ™‚è¢«ç¨±ç‚ºã€Œé«’è®€ (dirty read)ã€ã€‚
* **ç¯„ä¾‹ï¼š**

<details>
<summary>ç¯„ä¾‹èªªæ˜</summary>

> Python

```py
# before_agent_callback ä¸­çš„ç¨‹å¼ç¢¼
callback_context.state['field_1'] = 'value_1'
# ç‹€æ…‹åœ¨æœ¬åœ°è¨­ç½®ç‚º 'value_1'ï¼Œä½†å°šæœªè¢« Runner æäº¤

# ... ä»£ç†åŸ·è¡Œ ...

# ç¨å¾Œ *åœ¨åŒä¸€æ¬¡èª¿ç”¨å…§* å‘¼å«çš„å·¥å…·ä¸­çš„ç¨‹å¼ç¢¼
# å¯è®€å–ï¼ˆé«’è®€ï¼‰ï¼Œä½† 'value_1' å°šæœªä¿è­‰æŒä¹…åŒ–ã€‚
val = tool_context.state['field_1'] # æ­¤è™• 'val' å¯èƒ½ç‚º 'value_1'
print(f"Dirty read value in tool: {val}")

# å‡è¨­æ”œå¸¶ state_delta={'field_1': 'value_1'} çš„äº‹ä»¶
# æ˜¯åœ¨æ­¤å·¥å…·åŸ·è¡Œ *ä¹‹å¾Œ* è¢«ç”¢å‡ºä¸¦ç”± Runner è™•ç†çš„ã€‚
```

> TypeScript

```typescript
// beforeAgentCallback ä¸­çš„ç¨‹å¼ç¢¼
callbackContext.state.set('field_1', 'value_1');
// ç‹€æ…‹åœ¨æœ¬åœ°è¨­ç½®ç‚º 'value_1'ï¼Œä½†å°šæœªè¢« Runner æäº¤

// --- ä»£ç†åŸ·è¡Œ ... ---

// --- ç¨å¾Œ *åœ¨åŒä¸€æ¬¡èª¿ç”¨å…§* å‘¼å«çš„å·¥å…·ä¸­çš„ç¨‹å¼ç¢¼ ---
// å¯è®€å–ï¼ˆé«’è®€ï¼‰ï¼Œä½† 'value_1' å°šæœªä¿è­‰æŒä¹…åŒ–ã€‚
const val = toolContext.state.get('field_1'); // æ­¤è™• 'val' å¯èƒ½ç‚º 'value_1'
console.log(`Dirty read value in tool: ${val}`);

// å‡è¨­æ”œå¸¶ state_delta={'field_1': 'value_1'} çš„äº‹ä»¶
// æ˜¯åœ¨æ­¤å·¥å…·åŸ·è¡Œ *ä¹‹å¾Œ* è¢«ç”¢å‡ºä¸¦ç”± Runner è™•ç†çš„ã€‚
```

> Go

```go
// before_agent_callback ä¸­çš„ç¨‹å¼ç¢¼
// å›èª¿å°‡ç›´æ¥ä¿®æ”¹ context çš„å·¥ä½œéšæ®µç‹€æ…‹ã€‚
// æ­¤è®Šæ›´å°æ–¼ç•¶å‰èª¿ç”¨ context æ˜¯å±€éƒ¨çš„ã€‚
ctx.State.Set("field_1", "value_1")
// ç‹€æ…‹åœ¨æœ¬åœ°è¨­ç½®ç‚º 'value_1'ï¼Œä½†å°šæœªè¢« Runner æäº¤

// ... ä»£ç†åŸ·è¡Œ ...

// ç¨å¾Œ *åœ¨åŒä¸€æ¬¡èª¿ç”¨å…§* å‘¼å«çš„å·¥å…·ä¸­çš„ç¨‹å¼ç¢¼
// å¯è®€å–ï¼ˆé«’è®€ï¼‰ï¼Œä½† 'value_1' å°šæœªä¿è­‰æŒä¹…åŒ–ã€‚
val := ctx.State.Get("field_1") // æ­¤è™• 'val' å¯èƒ½ç‚º 'value_1'
fmt.Printf("Dirty read value in tool: %v\n", val)

// å‡è¨­æ”œå¸¶ state_delta={'field_1': 'value_1'} çš„äº‹ä»¶
// æ˜¯åœ¨æ­¤å·¥å…·åŸ·è¡Œ *ä¹‹å¾Œ* è¢«ç”¢å‡ºä¸¦ç”± Runner è™•ç†çš„ã€‚
```

> Java

```java
// ä¿®æ”¹ç‹€æ…‹ - BeforeAgentCallback ä¸­çš„ç¨‹å¼ç¢¼
// ä¸¦ä¸”å°‡æ­¤è®Šæ›´æš«å­˜åœ¨ callbackContext.eventActions().stateDelta() ä¸­ã€‚
callbackContext.state().put("field_1", "value_1");

// --- ä»£ç†åŸ·è¡Œ ... ---

// --- ç¨å¾Œ *åœ¨åŒä¸€æ¬¡èª¿ç”¨å…§* å‘¼å«çš„å·¥å…·ä¸­çš„ç¨‹å¼ç¢¼ ---
// å¯è®€å–ï¼ˆé«’è®€ï¼‰ï¼Œä½† 'value_1' å°šæœªä¿è­‰æŒä¹…åŒ–ã€‚
Object val = toolContext.state().get("field_1"); // æ­¤è™• 'val' å¯èƒ½ç‚º 'value_1'
System.out.println("Dirty read value in tool: " + val);
// å‡è¨­æ”œå¸¶ state_delta={'field_1': 'value_1'} çš„äº‹ä»¶
// æ˜¯åœ¨æ­¤å·¥å…·åŸ·è¡Œ *ä¹‹å¾Œ* è¢«ç”¢å‡ºä¸¦ç”± Runner è™•ç†çš„ã€‚
```

</details>

* **å«ç¾©ï¼š**
  * **å„ªé»ï¼š** å…è¨±æ‚¨åœ¨å–®å€‹è¤‡é›œæ­¥é©Ÿï¼ˆä¾‹å¦‚åœ¨ä¸‹ä¸€æ¬¡ LLM å›åˆä¹‹å‰çš„å¤šå€‹å›èª¿æˆ–å·¥å…·å‘¼å«ï¼‰å…§çš„ä¸åŒéƒ¨åˆ†é‚è¼¯ä½¿ç”¨ç‹€æ…‹é€²è¡Œå”èª¿ï¼Œè€Œç„¡éœ€ç­‰å¾…å®Œæ•´çš„ç”¢å‡º/æäº¤å¾ªç’°ã€‚
  * **è­¦å‘Šï¼š** åš´é‡ä¾è³´é«’è®€ä¾†åŸ·è¡Œé—œéµé‚è¼¯æ˜¯æœ‰é¢¨éšªçš„ã€‚å¦‚æœèª¿ç”¨åœ¨æ”œå¸¶ `state_delta` çš„äº‹ä»¶è¢«ç”¢å‡ºä¸¦ç”± `Runner` è™•ç† *ä¹‹å‰* å¤±æ•—ï¼Œå‰‡æœªæäº¤çš„ç‹€æ…‹è®Šæ›´å°‡æœƒä¸Ÿå¤±ã€‚å°æ–¼é—œéµçš„ç‹€æ…‹è½‰æ›ï¼Œè«‹ç¢ºä¿å®ƒå€‘èˆ‡æˆåŠŸè™•ç†çš„äº‹ä»¶ç›¸é—œè¯ã€‚

### ä¸²æµèˆ‡éä¸²æµè¼¸å‡º (Streaming vs. Non-Streaming Output) (`partial=True`)

é€™ä¸»è¦èˆ‡å¦‚ä½•è™•ç†ä¾†è‡ª LLM çš„å›æ‡‰æœ‰é—œï¼Œç‰¹åˆ¥æ˜¯åœ¨ä½¿ç”¨ä¸²æµç”Ÿæˆ API æ™‚ã€‚

* **ä¸²æµ (Streaming)ï¼š** LLM é€å€‹ token æˆ–ä»¥å°å¡Šç”Ÿæˆå›æ‡‰ã€‚
  * æ¡†æ¶ï¼ˆé€šå¸¸åœ¨ `BaseLlmFlow` å…§ï¼‰æœƒç‚ºå–®å€‹æ¦‚å¿µæ€§å›æ‡‰ç”¢å‡ºå¤šå€‹ `Event` ç‰©ä»¶ã€‚é€™äº›äº‹ä»¶å¤§å¤šå…·æœ‰ `partial=True`ã€‚
  * `Runner` åœ¨æ”¶åˆ° `partial=True` çš„äº‹ä»¶å¾Œï¼Œé€šå¸¸æœƒ **ç«‹å³å°‡å…¶å‘ä¸Šæ¸¸è½‰ç™¼**ï¼ˆä¾› UI é¡¯ç¤ºï¼‰ï¼Œä½† **è·³éè™•ç†å…¶ `actions`**ï¼ˆå¦‚ `state_delta`ï¼‰ã€‚
  * æœ€çµ‚ï¼Œæ¡†æ¶æœƒç”¢å‡ºè©²å›æ‡‰çš„æœ€çµ‚äº‹ä»¶ï¼Œæ¨™è¨˜ç‚ºééƒ¨åˆ† (`partial=False` æˆ–éš±å«é€é `turn_complete=True`)ã€‚
  * `Runner` **åƒ…å®Œå…¨è™•ç†æ­¤æœ€çµ‚äº‹ä»¶**ï¼Œæäº¤ä»»ä½•ç›¸é—œçš„ `state_delta` æˆ– `artifact_delta`ã€‚
* **éä¸²æµ (Non-Streaming)ï¼š** LLM ä¸€æ¬¡ç”Ÿæˆæ•´å€‹å›æ‡‰ã€‚æ¡†æ¶ç”¢å‡ºä¸€å€‹æ¨™è¨˜ç‚ºééƒ¨åˆ†çš„å–®å€‹äº‹ä»¶ï¼Œ`Runner` å°‡å°å…¶é€²è¡Œå®Œå…¨è™•ç†ã€‚
* **ç‚ºä½•é‡è¦ï¼š** ç¢ºä¿ç‹€æ…‹è®Šæ›´æ˜¯åŸºæ–¼ LLM çš„ *å®Œæ•´* å›æ‡‰åŸå­æ€§åœ°ä¸”åƒ…æ‡‰ç”¨ä¸€æ¬¡ï¼ŒåŒæ™‚ä»å…è¨± UI åœ¨ç”Ÿæˆæ–‡å­—æ™‚é€æ­¥é¡¯ç¤ºã€‚

## éåŒæ­¥ç‚ºä¸» (`run_async`)

* **æ ¸å¿ƒè¨­è¨ˆï¼š** ADK Runtime å¾æ ¹æœ¬ä¸Šå»ºç«‹åœ¨éåŒæ­¥æ¨¡å¼å’Œç¨‹å¼åº«ï¼ˆå¦‚ Python çš„ `asyncio`ï¼ŒJava çš„ `RxJava`ï¼Œä»¥åŠ TypeScript ä¸­çš„åŸç”Ÿ `Promise` å’Œ `AsyncGenerator`ï¼‰ä¹‹ä¸Šï¼Œä»¥é«˜æ•ˆåœ°è™•ç†ä¸¦ç™¼æ“ä½œï¼ˆå¦‚ç­‰å¾… LLM å›æ‡‰æˆ–å·¥å…·åŸ·è¡Œï¼‰è€Œä¸ç™¼ç”Ÿé˜»å¡ã€‚
* **ä¸»è¦é€²å…¥é»ï¼š** `Runner.run_async` æ˜¯åŸ·è¡Œä»£ç†èª¿ç”¨çš„ä¸»è¦æ–¹æ³•ã€‚æ‰€æœ‰æ ¸å¿ƒå¯åŸ·è¡Œå…ƒä»¶ï¼ˆä»£ç†ã€ç‰¹å®šæµç¨‹ï¼‰å…§éƒ¨éƒ½ä½¿ç”¨ `asynchronous` æ–¹æ³•ã€‚
* **åŒæ­¥ä¾¿åˆ©æ€§ (`run`)ï¼š** å­˜åœ¨çš„åŒæ­¥ `Runner.run` æ–¹æ³•ä¸»è¦æ˜¯ç‚ºäº†æ–¹ä¾¿ï¼ˆä¾‹å¦‚ï¼Œåœ¨ç°¡å–®çš„è…³æœ¬æˆ–æ¸¬è©¦ç’°å¢ƒä¸­ï¼‰ã€‚ç„¶è€Œï¼Œåœ¨å…§éƒ¨ï¼Œ`Runner.run` é€šå¸¸åªæ˜¯å‘¼å« `Runner.run_async` ä¸¦ç‚ºæ‚¨ç®¡ç†éåŒæ­¥äº‹ä»¶è¿´åœˆçš„åŸ·è¡Œã€‚
* **é–‹ç™¼è€…é«”é©—ï¼š** æˆ‘å€‘å»ºè­°å°‡æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ï¼ˆä¾‹å¦‚ä½¿ç”¨ ADK çš„ç¶²é ä¼ºæœå™¨ï¼‰è¨­è¨ˆç‚ºéåŒæ­¥ä»¥ç²å¾—æœ€ä½³æ•ˆèƒ½ã€‚åœ¨ Python ä¸­ï¼Œé€™æ„å‘³è‘—ä½¿ç”¨ `asyncio`ï¼›åœ¨ Java ä¸­ï¼Œåˆ©ç”¨ `RxJava` çš„åæ‡‰å¼ç¨‹å¼è¨­è¨ˆæ¨¡å‹ï¼›åœ¨ TypeScript ä¸­ï¼Œé€™æ„å‘³è‘—ä½¿ç”¨åŸç”Ÿ `Promise` å’Œ `AsyncGenerator` é€²è¡Œæ§‹å»ºã€‚
* **åŒæ­¥å›èª¿/å·¥å…·ï¼š** ADK æ¡†æ¶æ”¯æ´å·¥å…·å’Œå›èª¿çš„éåŒæ­¥å’ŒåŒæ­¥å‡½æ•¸ã€‚
    * **é˜»å¡ I/Oï¼š** å°æ–¼é•·æ™‚é–“åŸ·è¡Œçš„åŒæ­¥ I/O æ“ä½œï¼Œæ¡†æ¶æœƒå˜—è©¦é˜²æ­¢åœé “ã€‚Python ADK å¯èƒ½ä½¿ç”¨ asyncio.to_threadï¼Œè€Œ Java ADK é€šå¸¸ä¾è³´é©ç•¶çš„ RxJava èª¿åº¦å™¨æˆ–åŒ…è£å™¨ä¾†é€²è¡Œé˜»å¡å‘¼å«ã€‚åœ¨ TypeScript ä¸­ï¼Œæ¡†æ¶åƒ…ç­‰å¾…å‡½æ•¸ï¼›å¦‚æœåŒæ­¥å‡½æ•¸åŸ·è¡Œé˜»å¡ I/Oï¼Œå®ƒå°‡ä½¿äº‹ä»¶è¿´åœˆåœé “ã€‚é–‹ç™¼è€…æ‡‰ç›¡å¯èƒ½ä½¿ç”¨éåŒæ­¥ I/O APIï¼ˆè¿”å› Promiseï¼‰ã€‚
    * **CPU å¯†é›†å‹å·¥ä½œï¼š** ç´” CPU å¯†é›†å‹çš„åŒæ­¥ä»»å‹™åœ¨å…©ç¨®ç’°å¢ƒä¸­ä»æœƒé˜»å¡å…¶åŸ·è¡ŒåŸ·è¡Œç·’ã€‚

äº†è§£é€™äº›è¡Œç‚ºæœ‰åŠ©æ–¼æ‚¨ç·¨å¯«æ›´ç©©å¥çš„ ADK æ‡‰ç”¨ç¨‹å¼ï¼Œä¸¦å°èˆ‡ç‹€æ…‹ä¸€è‡´æ€§ã€ä¸²æµæ›´æ–°å’ŒéåŒæ­¥åŸ·è¡Œç›¸é—œçš„å•é¡Œé€²è¡Œé™¤éŒ¯ã€‚

## ç¸½çµ

ADK Runtime æ˜¯é©…å‹• AI ä»£ç† (Agent) çš„æ ¸å¿ƒå¼•æ“ï¼Œå®ƒå¦‚åŒä¸€å€‹ç²¾å¯†çš„æŒ‡æ®ç³»çµ±ï¼Œå”èª¿ä»£ç†çš„æ€è€ƒé‚è¼¯ã€å·¥å…·çš„ä½¿ç”¨ä»¥åŠç‹€æ…‹çš„ç®¡ç†ã€‚ç‚ºäº†è®“æ‚¨å¿«é€ŸæŒæ¡ Runtime çš„å…¨è²Œï¼Œæˆ‘å€‘å°‡å…¶ç²¾è¯æ¿ƒç¸®å¦‚ä¸‹ï¼š

### 1. å…¥é–€ï¼šRuntime æ˜¯ä»€éº¼ï¼Ÿ
æƒ³åƒæ‚¨è¨­è¨ˆäº†ä¸€å€‹ AI ä»£ç†ï¼Œå®ƒæœ‰å¤§è…¦ (é‚è¼¯) å’Œæ‰‹è…³ (å·¥å…·)ã€‚**Runtime å°±æ˜¯è®“é€™å€‹ AI æ´»èµ·ä¾†çš„ã€Œä½œæ¥­ç³»çµ±ã€**ã€‚
*   æ‚¨ä¸éœ€è¦æ“”å¿ƒè¨Šæ¯å¦‚ä½•å‚³éã€ç‹€æ…‹å¦‚ä½•ä¿å­˜ã€‚
*   æ‚¨åªéœ€è¦å°ˆæ³¨æ–¼å®šç¾©ã€Œä»£ç†è©²åšä»€éº¼ã€ï¼ŒRuntime æœƒè² è²¬è™•ç†ã€Œå¦‚ä½•è®“å®ƒé‹ä½œã€ã€‚

### 2. æ ¸å¿ƒï¼šäº‹ä»¶è¿´åœˆ (Event Loop) çš„é‹ä½œ
Runtime çš„é‹ä½œå°±åƒæ˜¯ä¸€å ´ **ã€Œæ¥åŠ›è³½è·‘ã€**ï¼Œç”± **Runner (å”èª¿è€…)** å’Œ **Agent (åŸ·è¡Œè€…)** è¼ªæµäº¤æ£’ï¼š
1.  **Runner ç™¼ä»¤ (Start)**ï¼šæ”¶åˆ°ä½¿ç”¨è€…çš„è¨Šæ¯ï¼ŒRunner å•Ÿå‹• Agentã€‚
2.  **Agent è·‘æ£’ (Execute)**ï¼šAgent åŸ·è¡Œé‚è¼¯ï¼Œç›´åˆ°å®ƒæ±ºå®šåšæŸä»¶äº‹ï¼ˆä¾‹å¦‚å›è©±æˆ–ç”¨å·¥å…·ï¼‰ã€‚
3.  **äº¤æ£’ (Yield)**ï¼šAgent ç™¼å‡ºä¸€å€‹ **äº‹ä»¶ (Event)** çµ¦ Runnerï¼Œç„¶å¾Œ **æš«åœ (Pause)** ç­‰å¾…ã€‚
4.  **Runner è™•ç† (Process)**ï¼šRunner æ¥éäº‹ä»¶ï¼ŒåŸ·è¡Œå¿…è¦çš„å‹•ä½œï¼ˆå¦‚å„²å­˜ç‹€æ…‹ã€æ›´æ–°ç•«é¢ï¼‰ã€‚
5.  **Agent æ¥æ£’ (Resume)**ï¼šRunner è™•ç†å®Œç•¢å¾Œï¼ŒAgent **æ¢å¾© (Resume)** åŸ·è¡Œï¼Œä¸¦èƒ½çœ‹åˆ°æœ€æ–°çš„ç‹€æ…‹ã€‚
*é€™å€‹å¾ªç’°æœƒä¸æ–·é‡è¤‡ï¼Œç›´åˆ° Agent å®Œæˆä»»å‹™ã€‚*

### 3. é€²éšï¼šé—œéµé‡é»ç¶±è¦
*   **å››å¤§æ”¯æŸ±**ï¼š
    *   **Runner**ï¼šæ§åˆ¶æµç¨‹çš„ä¸­å¿ƒã€‚
    *   **Agent**ï¼šåŸ·è¡Œé‚è¼¯çš„å¤§è…¦ã€‚
    *   **Event**ï¼šæºé€šçš„è¨Šæ¯è¼‰é«”ã€‚
    *   **Services**ï¼šç®¡ç†è¨˜æ†¶èˆ‡æª”æ¡ˆçš„å¾Œå‹¤ã€‚
*   **é‡è¦ç‰¹æ€§**ï¼š
    *   **ç‹€æ…‹ç¢ºèª (Commit)**ï¼šç‹€æ…‹çš„è®Šæ›´åªæœ‰åœ¨äº‹ä»¶è¢« Runner æˆåŠŸè™•ç†å¾Œæ‰ç®—ã€Œå­˜æª”å®Œæˆã€ã€‚
    *   **éåŒæ­¥æ¶æ§‹ (Async)**ï¼šç‚ºäº†é«˜æ•ˆèƒ½ï¼Œç³»çµ±é è¨­æ¡ç”¨éåŒæ­¥è¨­è¨ˆï¼Œé©åˆè™•ç† LLM ç­‰å¾…èˆ‡ I/O æ“ä½œã€‚
    *   **ä¸²æµæ”¯æ´ (Streaming)**ï¼šæ”¯æ´ LLM çš„ä¸²æµè¼¸å‡ºï¼Œè®“å›æ‡‰èƒ½å³æ™‚å‘ˆç¾çµ¦ä½¿ç”¨è€…ã€‚
