# ç‚º Agent å€’å› (Rewind) æœƒè©±

ğŸ”” `æ›´æ–°æ—¥æœŸï¼š2026 å¹´ 1 æœˆ 5 æ—¥`

ADK çš„æœƒè©±å€’å› (Rewind) åŠŸèƒ½å…è¨±æ‚¨å°‡æœƒè©±é‚„åŸåˆ°ä¹‹å‰çš„è«‹æ±‚ç‹€æ…‹ï¼Œè®“æ‚¨èƒ½å¤ æ’¤éŠ·éŒ¯èª¤ã€æ¢ç´¢æ›¿ä»£è·¯å¾‘ï¼Œæˆ–å¾å·²çŸ¥çš„è‰¯å¥½èµ·é»é‡æ–°é–‹å§‹æµç¨‹ã€‚æœ¬æ–‡ä»¶æä¾›è©²åŠŸèƒ½çš„æ¦‚è¿°ã€ä½¿ç”¨æ–¹æ³•åŠå…¶é™åˆ¶ã€‚

## å€’å›æœƒè©± (Rewind a session)

ç•¶æ‚¨å€’å›æœƒè©±æ™‚ï¼Œéœ€è¦æŒ‡å®šä¸€å€‹æ‚¨æƒ³è¦æ’¤éŠ·çš„ä½¿ç”¨è€…è«‹æ±‚æˆ– **_èª¿ç”¨ (invocation)_**ï¼Œç³»çµ±å°‡æœƒæ’¤éŠ·è©²è«‹æ±‚åŠå…¶ä¹‹å¾Œçš„æ‰€æœ‰è«‹æ±‚ã€‚
ä¾‹å¦‚ï¼šå¦‚æœæ‚¨æœ‰ä¸‰å€‹è«‹æ±‚ (A, B, C)ï¼Œè€Œæ‚¨æƒ³å›åˆ°è«‹æ±‚ A ä¹‹å¾Œçš„ç‹€æ…‹ï¼Œæ‚¨æ‡‰æŒ‡å®š Bï¼Œé€™å°‡æ’¤éŠ·ä¾†è‡ªè«‹æ±‚ B å’Œ C çš„è®Šæ›´ã€‚

æ‚¨å¯ä»¥é€éåœ¨ **_Runner_** å¯¦ä¾‹ä¸Šä½¿ç”¨ `rewind_async` æ–¹æ³•ï¼Œä¸¦æŒ‡å®šä½¿ç”¨è€…ã€æœƒè©±å’Œèª¿ç”¨ ID (invocation id) ä¾†å€’å›æœƒè©±ï¼Œå¦‚ä¸‹åˆ—ç¨‹å¼ç¢¼ç‰‡æ®µæ‰€ç¤ºï¼š

> **é‡é»èªªæ˜**ï¼šå€’å›æ“ä½œæœƒå°‡æœƒè©±å±¤ç´šçš„è³‡æºé‚„åŸåˆ°æŒ‡å®šèª¿ç”¨ ID _ä¹‹å‰_ çš„ç‹€æ…‹ã€‚

```python
# 1. å»ºç«‹ Runner å¯¦ä¾‹
runner = InMemoryRunner(
    agent=agent.root_agent,
    app_name=APP_NAME,
)

# 2. å»ºç«‹æœƒè©± (Session)
session = await runner.session_service.create_session(
    app_name=APP_NAME, user_id=USER_ID
)

# 3. å‘¼å« Agentï¼ˆä¾‹å¦‚ï¼šè¨­å®šç‹€æ…‹é¡è‰²ç‚ºç´…è‰²ï¼‰
await call_agent_async(
    runner, USER_ID, session.id, "set state color to red"
)

# ... åŸ·è¡Œæ›´å¤š Agent å‘¼å« ...

# 4. æ›´æ–°ç‹€æ…‹é¡è‰²ç‚ºè—è‰²ï¼Œä¸¦ç²å–äº‹ä»¶åˆ—è¡¨ä»¥å–å¾—èª¿ç”¨ ID
events_list = await call_agent_async(
    runner, USER_ID, session.id, "update state color to blue"
)

# 5. ç²å–æƒ³è¦å€’å›çš„èª¿ç”¨ ID (æ­¤è™•å‡è¨­è¦å€’å›æ›´æ–°ç‚ºè—è‰²çš„æ“ä½œ)
rewind_invocation_id = events_list[1].invocation_id

# 6. åŸ·è¡Œå€’å›æ“ä½œ (åŸ·è¡Œå¾Œç‹€æ…‹é¡è‰²å°‡å›å¾©ç‚ºï¼šç´…è‰²)
await runner.rewind_async(
    user_id=USER_ID,
    session_id=session.id,
    rewind_before_invocation_id=rewind_invocation_id,
)
```

ç•¶æ‚¨å‘¼å« **_rewind_** æ–¹æ³•æ™‚ï¼Œæ‰€æœ‰ç”± ADK ç®¡ç†çš„ã€Œæœƒè©±å±¤ç´š (session-level)ã€è³‡æºéƒ½æœƒé‚„åŸåˆ°æ‚¨é€é **_invocation id_** æŒ‡å®šçš„è«‹æ±‚*ä¹‹å‰*çš„ç‹€æ…‹ï¼Œåƒè€ƒ[ç¯„ä¾‹é€£çµ](https://github.com/google/adk-python/tree/main/contributing/samples/rewind_session)ã€‚ç„¶è€Œï¼Œå…¨åŸŸè³‡æºï¼ˆä¾‹å¦‚æ‡‰ç”¨ç¨‹å¼å±¤ç´šæˆ–ä½¿ç”¨è€…å±¤ç´šçš„ç‹€æ…‹èˆ‡æˆæœç‰© Artifactsï¼‰å‰‡**ä¸æœƒ**è¢«é‚„åŸï¼Œé™åˆ¶èªªæ˜[é€£çµ](https://google.github.io/adk-docs/sessions/rewind/#how-it-works)ã€‚

## é‹ä½œåŸç†

å€’å›åŠŸèƒ½æœƒå»ºç«‹ä¸€å€‹ç‰¹æ®Šçš„ **_rewind_** è«‹æ±‚ï¼Œå°‡æœƒè©±çš„ç‹€æ…‹å’Œæˆæœç‰©é‚„åŸåˆ°æŒ‡å®šèª¿ç”¨ ID ä¹‹å‰çš„ç‹€æ³ã€‚é€™ç¨®æ–¹å¼æ„å‘³è‘—æ‰€æœ‰è«‹æ±‚ï¼ˆåŒ…æ‹¬è¢«å€’å›çš„è«‹æ±‚ï¼‰éƒ½æœƒä¿ç•™åœ¨æ—¥èªŒä¸­ï¼Œä»¥ä¾¿æ—¥å¾Œé€²è¡ŒåµéŒ¯ã€åˆ†ææˆ–å¯©è¨ˆã€‚

å€’å›å¾Œï¼Œç³»çµ±åœ¨ç‚º AI æ¨¡å‹æº–å‚™ä¸‹ä¸€å€‹è«‹æ±‚æ™‚ï¼Œæœƒå¿½ç•¥å·²å€’å›çš„è«‹æ±‚ã€‚é€™è¡¨ç¤º Agent æ‰€ä½¿ç”¨çš„ AI æ¨¡å‹å¯¦éš›ä¸Šæœƒã€Œå¿˜è¨˜ã€å¾å€’å›é»åˆ°ä¸‹ä¸€å€‹è«‹æ±‚ä¹‹é–“çš„æ‰€æœ‰äº’å‹•ã€‚

## ä½¿ç”¨é™åˆ¶

åœ¨ä½¿ç”¨å€’å›åŠŸèƒ½æ–¼ Agent å·¥ä½œæµæ™‚ï¼Œè«‹ç•™æ„ä»¥ä¸‹é™åˆ¶ï¼š

- **å…¨åŸŸ Agent è³‡æº**ï¼šæ‡‰ç”¨ç¨‹å¼å±¤ç´š (App-level) å’Œä½¿ç”¨è€…å±¤ç´š (User-level) çš„ç‹€æ…‹èˆ‡æˆæœç‰©**ä¸æœƒ**è¢«å€’å›åŠŸèƒ½é‚„åŸã€‚åƒ…é‚„åŸæœƒè©±å±¤ç´š (Session-level) çš„å…§å®¹ã€‚
- **å¤–éƒ¨ä¾è³´é …**ï¼šå€’å›åŠŸèƒ½ä¸ç®¡ç†å¤–éƒ¨ä¾è³´ã€‚å¦‚æœæ‚¨çš„ Agent å·¥å…·èˆ‡å¤–éƒ¨ç³»çµ±äº’å‹•ï¼Œæ‚¨éœ€è¦è‡ªè¡Œè² è²¬å°‡é€™äº›ç³»çµ±é‚„åŸè‡³å…ˆå‰çš„ç‹€æ…‹ã€‚
- **åŸå­æ€§ (Atomicity)**ï¼šç‹€æ…‹æ›´æ–°ã€æˆæœç‰©æ›´æ–°å’Œäº‹ä»¶æŒä¹…åŒ–ä¸¦éåœ¨å–®ä¸€åŸå­äº‹å‹™ä¸­åŸ·è¡Œã€‚å› æ­¤ï¼Œæ‡‰é¿å…å€’å›é€²è¡Œä¸­çš„æ´»èºæœƒè©±ï¼Œæˆ–åœ¨å€’å›æœŸé–“åŒæ™‚æ“ä½œæœƒè©±æˆæœç‰©ï¼Œä»¥é˜²æ­¢æ•¸æ“šä¸ä¸€è‡´ã€‚

## åƒè€ƒè³‡æº

- [rewind_session ç¯„ä¾‹ç¨‹å¼ç¢¼](https://github.com/google/adk-python/tree/main/contributing/samples/rewind_session)
- [é™åˆ¶èªªæ˜](https://google.github.io/adk-docs/sessions/rewind/#how-it-works)