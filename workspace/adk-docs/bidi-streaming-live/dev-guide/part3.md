# ç¬¬ 3 éƒ¨åˆ†ï¼šä½¿ç”¨ run_live() é€²è¡Œäº‹ä»¶è™•ç†

> ğŸ”” `æ›´æ–°æ—¥æœŸï¼š2026-02-01`
>
> ğŸ”— `è³‡æ–™ä¾†æº`ï¼šhttps://google.github.io/adk-docs/streaming/dev-guide/part3/

`run_live()` æ–¹æ³•æ˜¯ ADK é€²è¡Œä¸²æµå°è©±çš„ä¸»è¦é€²å…¥é»ï¼Œå®ƒå¯¦ä½œäº†ä¸€å€‹éåŒæ­¥ç”¢ç”Ÿå™¨ï¼ˆasync generatorï¼‰ï¼Œæœƒåœ¨å°è©±å±•é–‹æ™‚ç”¢ç”Ÿäº‹ä»¶ã€‚æœ¬éƒ¨åˆ†é‡é»åœ¨æ–¼ç†è§£èˆ‡è™•ç†é€™äº›äº‹ä»¶â€”â€”é€™æ˜¯å¯¦ç¾æ‡‰ç”¨ç¨‹å¼ã€ä½¿ç”¨è€…èˆ‡ AI æ¨¡å‹ä¹‹é–“å³æ™‚äº’å‹•çš„æ ¸å¿ƒé€šè¨Šæ©Ÿåˆ¶ã€‚

æ‚¨å°‡å­¸ç¿’å¦‚ä½•è™•ç†ä¸åŒçš„äº‹ä»¶é¡å‹ï¼ˆæ–‡å­—ã€éŸ³è¨Šã€é€å­—ç¨¿ã€å·¥å…·èª¿ç”¨ï¼‰ã€é€éä¸­æ–·å’Œå›åˆå®Œæˆè¨Šè™Ÿç®¡ç†å°è©±æµç¨‹ã€ç‚ºç¶²è·¯å‚³è¼¸åºåˆ—åŒ–äº‹ä»¶ï¼Œä»¥åŠåˆ©ç”¨ ADK çš„è‡ªå‹•å·¥å…·åŸ·è¡ŒåŠŸèƒ½ã€‚ç†è§£äº‹ä»¶è™•ç†å°æ–¼å»ºç«‹è®“ä½¿ç”¨è€…æ„Ÿåˆ°è‡ªç„¶ä¸”å³æ™‚çš„åæ‡‰å¼ä¸²æµæ‡‰ç”¨ç¨‹å¼è‡³é—œé‡è¦ã€‚

> [!NOTE] éœ€è¦éåŒæ­¥ä¸Šä¸‹æ–‡ï¼ˆAsync Context Requiredï¼‰
æ‰€æœ‰ `run_live()` ç¨‹å¼ç¢¼éƒ½éœ€è¦éåŒæ­¥ä¸Šä¸‹æ–‡ã€‚è©³æƒ…èˆ‡å¯¦éš›ç¯„ä¾‹è«‹åƒé–± [ç¬¬ 1 éƒ¨åˆ†ï¼šFastAPI æ‡‰ç”¨ç¨‹å¼ç¯„ä¾‹](part1.md#fastapi-æ‡‰ç”¨ç¨‹å¼ç¯„ä¾‹)ã€‚

## run_live() çš„å·¥ä½œåŸç†

`run_live()` æ˜¯ä¸€å€‹éåŒæ­¥ç”¢ç”Ÿå™¨ï¼Œèƒ½å³æ™‚ä¸²æµå°è©±äº‹ä»¶ã€‚å®ƒåœ¨äº‹ä»¶ç”¢ç”Ÿæ™‚ç«‹å³è¼¸å‡ºâ€”â€”ç„¡éœ€ç·©è¡ã€ç„¡éœ€è¼ªè©¢ã€ç„¡éœ€å›å‘¼ï¼ˆcallbacksï¼‰ã€‚äº‹ä»¶åœ¨ä¸²æµæ™‚ä¸é€²è¡Œå…§éƒ¨ç·©è¡ã€‚æ•´é«”è¨˜æ†¶é«”ä½¿ç”¨é‡å–æ±ºæ–¼å·¥ä½œéšæ®µæŒä¹…åŒ–ï¼ˆä¾‹å¦‚ï¼Œè¨˜æ†¶é«”å…§ vs è³‡æ–™åº«ï¼‰ï¼Œä½¿å…¶é©ç”¨æ–¼å¿«é€Ÿäº¤æµå’Œé•·æ™‚é–“å°è©±ã€‚

### æ–¹æ³•ç°½ç½²èˆ‡æµç¨‹

**ç”¨æ³•ï¼š**

åŸå§‹ç¢¼åƒè€ƒï¼š[runners.py](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/runners.py)

```python
# æ–¹æ³•ç°½ç½²æ­ç¤ºäº†æ·±æ€ç†Ÿæ…®çš„è¨­è¨ˆ
async def run_live(
    self,
    *,                                      # åƒ…é™é—œéµå­—åƒæ•¸
    user_id: Optional[str] = None,          # ä½¿ç”¨è€…è­˜åˆ¥ç¢¼ï¼ˆé™¤éæä¾› sessionï¼Œå¦å‰‡ç‚ºå¿…å¡«ï¼‰
    session_id: Optional[str] = None,       # å·¥ä½œéšæ®µè¿½è¹¤ï¼ˆé™¤éæä¾› sessionï¼Œå¦å‰‡ç‚ºå¿…å¡«ï¼‰
    live_request_queue: LiveRequestQueue,   # é›™å‘é€šè¨Šé€šé“
    run_config: Optional[RunConfig] = None, # ä¸²æµè¡Œç‚ºé…ç½®
    session: Optional[Session] = None,      # å·²æ£„ç”¨ï¼šè«‹æ”¹ç”¨ user_id å’Œ session_id
) -> AsyncGenerator[Event, None]:           # ç”¢ç”Ÿå°è©±äº‹ä»¶çš„ç”¢ç”Ÿå™¨
```

å¦‚å…¶ç°½ç½²æ‰€ç¤ºï¼Œæ¯å€‹ä¸²æµå°è©±éƒ½éœ€è¦èº«ä»½ï¼ˆuser_idï¼‰ã€é€£çºŒæ€§ï¼ˆsession_idï¼‰ã€é€šè¨Šï¼ˆlive_request_queueï¼‰å’Œé…ç½®ï¼ˆrun_configï¼‰ã€‚å›å‚³é¡å‹â€”â€”äº‹ä»¶çš„éåŒæ­¥ç”¢ç”Ÿå™¨â€”â€”æ‰¿è«¾åœ¨ä¸è€—ç›¡ç³»çµ±è³‡æºçš„æƒ…æ³ä¸‹é€²è¡Œå³æ™‚å‚³éã€‚

```mermaid
sequenceDiagram
participant Client
participant Runner
participant Agent
participant LLMFlow
participant Gemini

Client->>Runner: runner.run_live(user_id, session_id, queue, config)
Runner->>Agent: agent.run_live(context)
Agent->>LLMFlow: _llm_flow.run_live(context)
LLMFlow->>Gemini: Connect and stream

loop Continuous Streaming
    Gemini-->>LLMFlow: LlmResponse
    LLMFlow-->>Agent: Event
    Agent-->>Runner: Event
    Runner-->>Client: Event (yield)
end
```

### åŸºæœ¬ä½¿ç”¨æ¨¡å¼

å¾ `run_live()` æ¥æ”¶äº‹ä»¶æœ€ç°¡å–®çš„æ–¹æ³•æ˜¯ä½¿ç”¨ for è¿´åœˆéæ­·éåŒæ­¥ç”¢ç”Ÿå™¨ï¼š

ç¤ºç¯„å¯¦ä½œï¼š[main.py:225-233](https://github.com/google/adk-samples/blob/31847c0723fbf16ddf6eed411eb070d1c76afd1a/python/agents/bidi-demo/app/main.py#L225-L233)

```python
# éæ­· runner.run_live ç”¢ç”Ÿçš„äº‹ä»¶
async for event in runner.run_live(
    user_id=user_id,
    session_id=session_id,
    live_request_queue=live_request_queue,
    run_config=run_config
):
    # å°‡äº‹ä»¶è½‰æ›ç‚º JSON æ ¼å¼ï¼Œæ’é™¤ç©ºå€¼ä¸¦ä½¿ç”¨åˆ¥å
    event_json = event.model_dump_json(exclude_none=True, by_alias=True)
    # è¨˜éŒ„é™¤éŒ¯è¨Šæ¯
    logger.debug(f"[SERVER] Event: {event_json}")
    # é€é WebSocket å‚³é€æ–‡å­—
    await websocket.send_text(event_json)
```

> [!TIP] å·¥ä½œéšæ®µè­˜åˆ¥ç¢¼ï¼ˆSession Identifiersï¼‰
`user_id` å’Œ `session_id` å…©è€…å¿…é ˆèˆ‡æ‚¨é€é `SessionService.create_session()` å»ºç«‹å·¥ä½œéšæ®µæ™‚ä½¿ç”¨çš„è­˜åˆ¥ç¢¼ç›¸ç¬¦ã€‚é€™äº›å¯ä»¥æ˜¯æ ¹æ“šæ‚¨çš„æ‡‰ç”¨ç¨‹å¼éœ€æ±‚è¨­å®šçš„ä»»ä½•å­—ä¸²å€¼ï¼ˆä¾‹å¦‚ UUIDã€é›»å­éƒµä»¶åœ°å€ã€è‡ªè¨‚æ¬Šæ–ï¼‰ã€‚è©³ç´°æŒ‡å—è«‹åƒé–± [ç¬¬ 1 éƒ¨åˆ†ï¼šå–å¾—æˆ–å»ºç«‹å·¥ä½œéšæ®µ](part1.md#ç²å–æˆ–å»ºç«‹å°è©±-session)ã€‚

### run_live() ä¸­çš„é€£ç·šç”Ÿå‘½é€±æœŸ

`run_live()` æ–¹æ³•æœƒè‡ªå‹•ç®¡ç†åº•å±¤ Live API çš„é€£ç·šç”Ÿå‘½é€±æœŸï¼š

**é€£ç·šç‹€æ…‹ï¼š**

1. **åˆå§‹åŒ–**ï¼šå‘¼å« `run_live()` æ™‚å»ºç«‹é€£ç·šã€‚
1. **æ´»å‹•ä¸²æµ**ï¼šé€é `LiveRequestQueue`ï¼ˆå‘ä¸Šæ¸¸å‚³é€è‡³æ¨¡å‹ï¼‰å’Œ `run_live()`ï¼ˆå¾æ¨¡å‹å‘ä¸‹æ¸¸æ¥æ”¶ï¼‰é€²è¡Œé›™å‘é€šè¨Šã€‚
1. **å„ªé›…é—œé–‰**ï¼šå‘¼å« `LiveRequestQueue.close()` æ™‚é€£ç·šé—œé–‰ã€‚
1. **éŒ¯èª¤æ¢å¾©**ï¼šADK æ”¯æ´é€æ˜çš„å·¥ä½œéšæ®µæ¢å¾©ï¼›é€é `RunConfig.session_resumption` å•Ÿç”¨ä»¥è™•ç†æš«æ™‚æ€§æ•…éšœã€‚è©³æƒ…è«‹åƒé–± [ç¬¬ 4 éƒ¨åˆ†ï¼šLive API å·¥ä½œéšæ®µæ¢å¾©](https://google.github.io/adk-docs/streaming/dev-guide/part4/#live-api-session-resumption)ã€‚

#### run_live() ç”¢ç”Ÿçš„å…§å®¹

ç•¶ä»£ç†ç¨‹å¼è™•ç†ä½¿ç”¨è€…è¼¸å…¥ä¸¦ç”¢ç”Ÿå›æ‡‰æ™‚ï¼Œ`run_live()` æ–¹æ³•æœƒå³æ™‚ç”¢ç”Ÿ `Event` ç‰©ä»¶ä¸²æµã€‚ç†è§£ä¸åŒçš„äº‹ä»¶é¡å‹æœ‰åŠ©æ–¼æ‚¨å»ºç«‹èƒ½é©ç•¶è™•ç†æ–‡å­—ã€éŸ³è¨Šã€é€å­—ç¨¿ã€å·¥å…·èª¿ç”¨ã€ä¸­ç¹¼è³‡æ–™å’ŒéŒ¯èª¤çš„éŸ¿æ‡‰å¼ UIã€‚å„å€‹äº‹ä»¶é¡å‹å°‡åœ¨ä¸‹æ–‡è©³ç´°èªªæ˜ã€‚

| äº‹ä»¶é¡å‹                                                 | èªªæ˜                                                                                                                                                        |
| -------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **[æ–‡å­—äº‹ä»¶](#æ–‡å­—äº‹ä»¶)**                             | ä½¿ç”¨ `response_modalities=["TEXT"]` æ™‚æ¨¡å‹çš„æ–‡å­—å›æ‡‰ï¼›åŒ…å«ç”¨æ–¼ä¸²æµ UI ç®¡ç†çš„ `partial`ï¼ˆéƒ¨åˆ†ï¼‰ã€`turn_complete`ï¼ˆå›åˆå®Œæˆï¼‰å’Œ `interrupted`ï¼ˆå·²ä¸­æ–·ï¼‰æ¨™è¨˜ã€‚ |
| **[å«å…§åµŒè³‡æ–™çš„éŸ³è¨Šäº‹ä»¶](#éŸ³è¨Šäº‹ä»¶)**                | ä½¿ç”¨ `response_modalities=["AUDIO"]` æ™‚å³æ™‚ä¸²æµçš„åŸå§‹éŸ³è¨Šä½å…ƒçµ„ï¼ˆ`inline_data`ï¼‰ï¼›å…·å‚™æš«æ™‚æ€§ï¼ˆä¸å„²å­˜è‡³å·¥ä½œéšæ®µï¼‰ã€‚                                          |
| **[å«æª”æ¡ˆè³‡æ–™çš„éŸ³è¨Šäº‹ä»¶](#å«æª”æ¡ˆè³‡æ–™çš„éŸ³è¨Šäº‹ä»¶)** | å½™æ•´æˆæª”æ¡ˆä¸¦å„²å­˜åœ¨æˆå“ï¼ˆartifactsï¼‰ä¸­çš„éŸ³è¨Šï¼›åŒ…å« `file_data` å¼•ç”¨è€ŒéåŸå§‹ä½å…ƒçµ„ï¼›å¯æŒä¹…åŒ–è‡³å·¥ä½œéšæ®µæ­·å²ç´€éŒ„ã€‚                                              |
| **[ä¸­ç¹¼è³‡æ–™äº‹ä»¶](#ä¸­ç¹¼è³‡æ–™äº‹ä»¶)**                     | ç”¨æ–¼æˆæœ¬ç›£æ§å’Œé…é¡è¿½è¹¤çš„æ¬Šæ–ï¼ˆtokenï¼‰ä½¿ç”¨è³‡è¨Šï¼ˆ`prompt_token_count`ã€`candidates_token_count`ã€`total_token_count`ï¼‰ã€‚                                      |
| **[é€å­—ç¨¿äº‹ä»¶](#é€å­—ç¨¿äº‹ä»¶)**                  | åœ¨ `RunConfig` ä¸­å•Ÿç”¨é€å­—ç¨¿åŠŸèƒ½æ™‚ï¼Œä½¿ç”¨è€…è¼¸å…¥ï¼ˆ`input_transcription`ï¼‰å’Œæ¨¡å‹è¼¸å‡ºï¼ˆ`output_transcription`ï¼‰çš„èªéŸ³è½‰æ–‡å­—çµæœã€‚                                |
| **[å·¥å…·èª¿ç”¨äº‹ä»¶](#å·¥å…·èª¿ç”¨äº‹ä»¶)**                    | ä¾†è‡ªæ¨¡å‹çš„å‡½å¼èª¿ç”¨è«‹æ±‚ï¼›ADK æœƒè‡ªå‹•è™•ç†åŸ·è¡Œã€‚                                                                                                                |
| **[éŒ¯èª¤äº‹ä»¶](#éŒ¯èª¤äº‹ä»¶)**                            | æ¨¡å‹éŒ¯èª¤å’Œé€£ç·šå•é¡Œï¼ŒåŒ…å« `error_code` å’Œ `error_message` æ¬„ä½ã€‚                                                                                             |

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`runners.py`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/runners.py) ä¸­å®Œæ•´çš„äº‹ä»¶é¡å‹è™•ç†å¯¦ä½œã€‚

#### run_live() ä½•æ™‚çµæŸ

`run_live()` äº‹ä»¶è¿´åœˆå¯èƒ½åœ¨å¤šç¨®æ¢ä»¶ä¸‹çµæŸã€‚ç†è§£é€™äº›çµæŸæƒ…å¢ƒå°æ–¼é©ç•¶çš„è³‡æºæ¸…ç†å’ŒéŒ¯èª¤è™•ç†è‡³é—œé‡è¦ï¼š

| çµæŸæ¢ä»¶             | è§¸ç™¼åŸå›                                                       | æ˜¯å¦å„ªé›…é—œé–‰ï¼Ÿ | èªªæ˜                                                      |
| -------------------- | ------------------------------------------------------------- | -------------- | --------------------------------------------------------- |
| **æ‰‹å‹•é—œé–‰**         | `live_request_queue.close()`                                  | âœ… æ˜¯           | ä½¿ç”¨è€…æ˜ç¢ºé—œé–‰ä½‡åˆ—ï¼Œå‚³é€ `LiveRequest(close=True)` è¨Šè™Ÿã€‚ |
| **æ‰€æœ‰ä»£ç†ç¨‹å¼å®Œæˆ** | `SequentialAgent` ä¸­çš„æœ€å¾Œä¸€å€‹ä»£ç†ç¨‹å¼å‘¼å« `task_completed()` | âœ… æ˜¯           | ç•¶æ‰€æœ‰é †åºä»£ç†ç¨‹å¼å®Œæˆå…¶ä»»å‹™å¾Œã€‚                          |
| **å·¥ä½œéšæ®µé€¾æ™‚**     | é”åˆ° Live API æŒçºŒæ™‚é–“é™åˆ¶                                    | âš ï¸ é€£ç·šé—œé–‰     | å·¥ä½œéšæ®µè¶…éæœ€å¤§æŒçºŒæ™‚é–“ï¼ˆåƒè¦‹ä¸‹æ–¹çš„é™åˆ¶ï¼‰ã€‚              |
| **æå‰çµæŸ**         | è¨­å®šäº† `end_invocation` æ¨™è¨˜                                  | âœ… æ˜¯           | åœ¨é è™•ç†æœŸé–“æˆ–ç”±å·¥å…·/å›å‘¼è¨­å®šä»¥ææ—©çµæŸã€‚                 |
| **ç©ºäº‹ä»¶**           | ä½‡åˆ—é—œé–‰è¨Šè™Ÿ                                                  | âœ… æ˜¯           | æŒ‡ç¤ºäº‹ä»¶ä¸²æµå·²çµæŸçš„å…§éƒ¨è¨Šè™Ÿã€‚                            |
| **éŒ¯èª¤**             | é€£ç·šéŒ¯èª¤ã€ç•°å¸¸                                                | âŒ å¦           | æœªè™•ç†çš„ç•°å¸¸æˆ–é€£ç·šå¤±æ•—ã€‚                                  |

> [!WARNING] SequentialAgent è¡Œç‚º
åœ¨ä½¿ç”¨ `SequentialAgent` æ™‚ï¼Œ`task_completed()` å‡½å¼**ä¸æœƒ**çµæŸæ‡‰ç”¨ç¨‹å¼çš„ `run_live()` è¿´åœˆã€‚å®ƒåƒ…è¡¨ç¤ºç•¶å‰ä»£ç†ç¨‹å¼çš„å·¥ä½œå·²å®Œæˆï¼Œä¸¦è§¸ç™¼ç„¡ç¸«åˆ‡æ›åˆ°åºåˆ—ä¸­çš„ä¸‹ä¸€å€‹ä»£ç†ç¨‹å¼ã€‚æ‚¨çš„äº‹ä»¶è¿´åœˆå°‡ç¹¼çºŒæ¥æ”¶ä¾†è‡ªå¾ŒçºŒä»£ç†ç¨‹å¼çš„äº‹ä»¶ã€‚è¿´åœˆåƒ…åœ¨åºåˆ—ä¸­çš„**æœ€å¾Œä¸€å€‹**ä»£ç†ç¨‹å¼å®Œæˆæ™‚æ‰æœƒçµæŸã€‚

> [!NOTE] äº†è§£æ›´å¤š
é—œæ–¼å·¥ä½œéšæ®µæ¢å¾©å’Œé€£ç·šä¿®å¾©çš„è©³æƒ…ï¼Œè«‹åƒé–± [ç¬¬ 4 éƒ¨åˆ†ï¼šLive API å·¥ä½œéšæ®µæ¢å¾©](https://google.github.io/adk-docs/streaming/dev-guide/part4/#live-api-session-resumption)ã€‚é—œæ–¼å¤šä»£ç†ç¨‹å¼å·¥ä½œæµç¨‹ï¼Œè«‹åƒé–± [å¤šä»£ç†ç¨‹å¼å·¥ä½œæµç¨‹çš„æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸ç¸½çµè¡¨)ã€‚

#### å„²å­˜è‡³ ADK `Session` çš„äº‹ä»¶

ä¸¦é `run_live()` ç”¢ç”Ÿçš„æ‰€æœ‰äº‹ä»¶éƒ½æœƒæŒä¹…åŒ–åˆ° ADK `Session` ä¸­ã€‚ç•¶ `run_live()` çµæŸæ™‚ï¼Œåªæœ‰ç‰¹å®šäº‹ä»¶æœƒå„²å­˜åˆ°å·¥ä½œéšæ®µï¼Œå…¶ä»–äº‹ä»¶å‰‡æ˜¯æš«æ™‚æ€§çš„ã€‚å°æ–¼ä½¿ç”¨å·¥ä½œéšæ®µæŒä¹…åŒ–ã€æ¢å¾©åŠŸèƒ½æˆ–éœ€è¦å›é¡§å°è©±æ­·å²çš„æ‡‰ç”¨ç¨‹å¼ä¾†èªªï¼Œç†è§£å“ªäº›äº‹ä»¶æœƒè¢«å„²å­˜ã€å“ªäº›æ˜¯æš«æ™‚æ€§çš„è‡³é—œé‡è¦ã€‚

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`runners.py`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/runners.py) ä¸­çš„å·¥ä½œéšæ®µäº‹ä»¶æŒä¹…åŒ–é‚è¼¯ã€‚

**å„²å­˜è‡³ ADK `Session` çš„äº‹ä»¶ï¼š**

é€™äº›äº‹ä»¶æœƒæŒä¹…åŒ–åˆ° ADK `Session` ä¸¦å¯åœ¨å·¥ä½œéšæ®µæ­·å²ç´€éŒ„ä¸­å–å¾—ï¼š

- **å«æª”æ¡ˆè³‡æ–™çš„éŸ³è¨Šäº‹ä»¶**ï¼šåƒ…åœ¨ `RunConfig.save_live_blob` ç‚º `True` æ™‚å„²å­˜è‡³ ADK `Session`ï¼›éŸ³è¨Šè³‡æ–™æœƒå½™æ•´æˆæˆå“ä¸­çš„æª”æ¡ˆï¼Œä¸¦é™„å¸¶ `file_data` å¼•ç”¨ã€‚
- **ä½¿ç”¨é‡ä¸­ç¹¼è³‡æ–™äº‹ä»¶**ï¼šä¸€å¾‹å„²å­˜ï¼Œä»¥è¿½è¹¤æ•´å€‹ ADK `Session` çš„æ¬Šæ–æ¶ˆè€—æƒ…æ³ã€‚
- **ééƒ¨åˆ†é€å­—ç¨¿äº‹ä»¶**ï¼šå„²å­˜æœ€çµ‚é€å­—ç¨¿ï¼›ä¸æŒä¹…åŒ–éƒ¨åˆ†ï¼ˆpartialï¼‰é€å­—ç¨¿ã€‚
- **å‡½å¼èª¿ç”¨èˆ‡å›æ‡‰äº‹ä»¶**ï¼šä¸€å¾‹å„²å­˜ï¼Œä»¥ç¶­è­·å·¥å…·åŸ·è¡Œæ­·å²ã€‚
- **å…¶ä»–æ§åˆ¶äº‹ä»¶**ï¼šå¤§å¤šæ•¸æ§åˆ¶äº‹ä»¶ï¼ˆä¾‹å¦‚ `turn_complete`ã€`finish_reason`ï¼‰éƒ½æœƒå„²å­˜ã€‚

**ä¸å„²å­˜è‡³ ADK `Session` çš„äº‹ä»¶ï¼š**

é€™äº›äº‹ä»¶æ˜¯æš«æ™‚æ€§çš„ï¼Œåƒ…åœ¨æ´»å‹•ä¸²æµæœŸé–“å‚³éçµ¦å‘¼å«è€…ï¼š

- **å«å…§åµŒè³‡æ–™çš„éŸ³è¨Šäº‹ä»¶**ï¼š`inline_data` ä¸­çš„åŸå§‹éŸ³è¨Š `Blob` è³‡æ–™å¾ä¸å„²å­˜è‡³ ADK `Session`ï¼ˆåƒ…ç”¨æ–¼å³æ™‚æ’­æ”¾ï¼‰ã€‚
- **éƒ¨åˆ†é€å­—ç¨¿äº‹ä»¶**ï¼šåƒ…ç”¨æ–¼å³æ™‚é¡¯ç¤ºï¼›å„²å­˜çš„æ˜¯æœ€çµ‚é€å­—ç¨¿ã€‚

> [!NOTE] éŸ³è¨ŠæŒä¹…åŒ–
è‹¥è¦å„²å­˜éŸ³è¨Šå°è©±åˆ° ADK `Session` ä»¥ä¾›å›é¡§æˆ–æ¢å¾©ï¼Œè«‹å•Ÿç”¨ `RunConfig.save_live_blob = True`ã€‚é€™æœƒå°‡éŸ³è¨Šä¸²æµæŒä¹…åŒ–è‡³æˆå“ä¸­ã€‚é…ç½®è©³æƒ…è«‹åƒé–± [ç¬¬ 4 éƒ¨åˆ†ï¼šsave_live_blob](https://google.github.io/adk-docs/streaming/dev-guide/part4/#save_live_blob)ã€‚

## ç†è§£äº‹ä»¶

äº‹ä»¶æ˜¯ ADK é›™å‘ä¸²æµç³»çµ±ä¸­çš„æ ¸å¿ƒé€šè¨Šæ©Ÿåˆ¶ã€‚æœ¬ç¯€æ¢è¨äº‹ä»¶çš„å®Œæ•´ç”Ÿå‘½é€±æœŸâ€”â€”å¾å®ƒå€‘å¦‚ä½•é€éå¤šå±¤ç®¡ç·šç”¢ç”Ÿï¼Œåˆ°æ”¯æ´çœŸæ­£å³æ™‚äº’å‹•çš„ä¸¦è¡Œè™•ç†æ¨¡å¼ï¼Œä»¥åŠå°ä¸­æ–·å’Œå›åˆå®Œæˆçš„å¯¦éš›è™•ç†ã€‚æ‚¨å°‡äº†è§£äº‹ä»¶é¡å‹ï¼ˆæ–‡å­—ã€éŸ³è¨Šã€é€å­—ç¨¿ã€å·¥å…·èª¿ç”¨ï¼‰ã€ç¶²è·¯å‚³è¼¸çš„åºåˆ—åŒ–ç­–ç•¥ï¼Œä»¥åŠç®¡ç†è·¨ Gemini Live API å’Œ Vertex AI Live API å¹³å°ä¸²æµå·¥ä½œéšæ®µçš„é€£ç·šç”Ÿå‘½é€±æœŸã€‚

### Event é¡åˆ¥

ADK çš„ `Event` é¡åˆ¥æ˜¯ä¸€å€‹ Pydantic æ¨¡å‹ï¼Œä»£è¡¨ä¸²æµå°è©±ä¸­çš„æ‰€æœ‰é€šè¨Šã€‚å®ƒç¹¼æ‰¿è‡ª `LlmResponse`ï¼Œä½œç‚ºæ¨¡å‹å›æ‡‰ã€ä½¿ç”¨è€…è¼¸å…¥ã€é€å­—ç¨¿å’Œæ§åˆ¶è¨Šè™Ÿçš„çµ±ä¸€å®¹å™¨ã€‚

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`event.py:30-128`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/events/event.py#L30-L128) å’Œ [`llm_response.py:28-200`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/models/llm_response.py#L28-L200) ä¸­çš„ `Event` é¡åˆ¥å¯¦ä½œã€‚

#### é—œéµæ¬„ä½

**æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼çš„åŸºæœ¬æ¬„ä½ï¼š**

- `content`ï¼šåŒ…å«æ–‡å­—ã€éŸ³è¨Šæˆ–å‡½å¼èª¿ç”¨ï¼ˆä»¥ `Content.parts` å½¢å¼å‘ˆç¾ï¼‰ã€‚
- `author`ï¼šè­˜åˆ¥èª°å»ºç«‹äº†äº‹ä»¶ï¼ˆ`"user"` æˆ–ä»£ç†ç¨‹å¼åç¨±ï¼‰ã€‚
- `partial`ï¼šå€åˆ†å¢é‡å€å¡Šèˆ‡å®Œæ•´æ–‡å­—ã€‚
- `turn_complete`ï¼šè¨Šè™ŸæŒ‡ç¤ºä½•æ™‚å¯å†æ¬¡å•Ÿç”¨ä½¿ç”¨è€…è¼¸å…¥ã€‚
- `interrupted`ï¼šæŒ‡ç¤ºä½•æ™‚åœæ­¢å‘ˆç¾ç•¶å‰è¼¸å‡ºã€‚

**éŸ³è¨Š/èªéŸ³æ‡‰ç”¨ç¨‹å¼æ¬„ä½ï¼š**

- `input_transcription`ï¼šä½¿ç”¨è€…çš„èªªè©±å…§å®¹ï¼ˆåœ¨ `RunConfig` ä¸­å•Ÿç”¨æ™‚ï¼‰ã€‚
- `output_transcription`ï¼šæ¨¡å‹çš„èªªè©±å…§å®¹ï¼ˆåœ¨ `RunConfig` ä¸­å•Ÿç”¨æ™‚ï¼‰ã€‚
- `content.parts[].inline_data`ï¼šç”¨æ–¼æ’­æ”¾çš„éŸ³è¨Šè³‡æ–™ã€‚

**å·¥å…·åŸ·è¡Œæ¬„ä½ï¼š**

- `content.parts[].function_call`ï¼šæ¨¡å‹çš„å·¥å…·èª¿ç”¨è«‹æ±‚ã€‚
- `content.parts[].function_response`ï¼šå·¥å…·åŸ·è¡Œçµæœã€‚
- `long_running_tool_ids`ï¼šè¿½è¹¤éåŒæ­¥å·¥å…·åŸ·è¡Œã€‚

**é™¤éŒ¯èˆ‡è¨ºæ–·æ¬„ä½ï¼š**

- `usage_metadata`ï¼šæ¬Šæ–è¨ˆæ•¸å’Œè¨ˆè²»è³‡è¨Šã€‚
- `cache_metadata`ï¼šä¸Šä¸‹æ–‡å¿«å–å‘½ä¸­/éºå¤±çµ±è¨ˆã€‚
- `finish_reason`ï¼šæ¨¡å‹åœæ­¢ç”¢ç”Ÿçš„åŸå› ï¼ˆä¾‹å¦‚ STOPã€MAX_TOKENSã€SAFETYï¼‰ã€‚
- `error_code` / `error_message`ï¼šå¤±æ•—è¨ºæ–·ã€‚

> [!NOTE] ä½œè€…èªæ„
é€å­—ç¨¿äº‹ä»¶çš„ä½œè€…ç‚º `"user"`ï¼›æ¨¡å‹å›æ‡‰/äº‹ä»¶ä½¿ç”¨ä»£ç†ç¨‹å¼åç¨±ä½œç‚º `author`ï¼ˆè€Œé `"model"`ï¼‰ã€‚è©³æƒ…è«‹åƒé–± [äº‹ä»¶ä½œè€…èº«ä»½](#äº‹ä»¶ä½œè€…èº«ä»½)ã€‚

#### ç†è§£äº‹ä»¶è­˜åˆ¥ç¢¼

äº‹ä»¶æœ‰å…©å€‹é‡è¦çš„ ID æ¬„ä½ï¼š

- **`event.id`**ï¼šæ­¤ç‰¹å®šäº‹ä»¶çš„å”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆæ ¼å¼ï¼šUUIDï¼‰ã€‚æ¯å€‹äº‹ä»¶éƒ½æœƒç²å¾—ä¸€å€‹æ–° IDï¼Œå³ä½¿æ˜¯éƒ¨åˆ†æ–‡å­—å€å¡Šä¹Ÿæ˜¯å¦‚æ­¤ã€‚
- **`event.invocation_id`**ï¼šç•¶å‰èª¿ç”¨ä¸­æ‰€æœ‰äº‹ä»¶å…±äº«çš„è­˜åˆ¥ç¢¼ï¼ˆæ ¼å¼ï¼š`"e-" + UUID`ï¼‰ã€‚åœ¨ `run_live()` ä¸­ï¼Œå–®å€‹ä¸²æµå·¥ä½œéšæ®µä¸­çš„æ‰€æœ‰äº‹ä»¶å…±äº«åŒä¸€å€‹ `invocation_id`ã€‚ï¼ˆé—œæ–¼èª¿ç”¨çš„æ›´å¤šè³‡è¨Šï¼Œè«‹åƒé–± [InvocationContextï¼šåŸ·è¡Œç‹€æ…‹å®¹å™¨](#invocationcontextåŸ·è¡Œç‹€æ…‹å®¹å™¨)ï¼‰

**ç”¨æ³•ï¼š**

```python
# æ­¤ä¸²æµå·¥ä½œéšæ®µä¸­çš„æ‰€æœ‰äº‹ä»¶å°‡å…·æœ‰ç›¸åŒçš„ invocation_id
async for event in runner.run_live(...):
    print(f"äº‹ä»¶ ID: {event.id}")              # æ¯å€‹äº‹ä»¶å”¯ä¸€
    print(f"èª¿ç”¨ ID: {event.invocation_id}")  # å·¥ä½œéšæ®µä¸­çš„æ‰€æœ‰äº‹ä»¶çš†ç›¸åŒ
```

**ä½¿ç”¨æ¡ˆä¾‹ï¼š**

- **event.id**ï¼šåœ¨æ—¥èªŒä¸­è¿½è¹¤å–®å€‹äº‹ä»¶ï¼Œç§»é™¤é‡è¤‡äº‹ä»¶ã€‚
- **event.invocation_id**ï¼šä¾å°è©±å·¥ä½œéšæ®µåˆ†çµ„äº‹ä»¶ï¼Œéæ¿¾å·¥ä½œéšæ®µç‰¹å®šäº‹ä»¶ã€‚

### äº‹ä»¶ä½œè€…èº«ä»½

åœ¨å³æ™‚ä¸²æµæ¨¡å¼ä¸‹ï¼Œ`Event.author` æ¬„ä½éµå¾ªç‰¹æ®Šèªæ„ä»¥ç¶­æŒå°è©±æ¸…æ™°åº¦ï¼š

**æ¨¡å‹å›æ‡‰**ï¼šä½œè€…ç‚º**ä»£ç†ç¨‹å¼åç¨±**ï¼ˆä¾‹å¦‚ `"my_agent"`ï¼‰ï¼Œè€Œéå­—é¢å­—ä¸² `"model"`ã€‚

- é€™ä½¿å¾—åœ¨å¤šä»£ç†ç¨‹å¼å ´æ™¯ä¸­èƒ½å¤ è¿½è¹¤æ˜¯ç”±å“ªå€‹ä»£ç†ç¨‹å¼ç”¢ç”Ÿå›æ‡‰ã€‚
- ç¯„ä¾‹ï¼š`Event(author="customer_service_agent", content=...)`

**ä½¿ç”¨è€…é€å­—ç¨¿**ï¼šç•¶äº‹ä»¶åŒ…å«è½‰éŒ„çš„ä½¿ç”¨è€…éŸ³è¨Šæ™‚ï¼Œä½œè€…ç‚º `"user"`ã€‚

**é‹ä½œåŸç†**ï¼š

1. Gemini Live API å›å‚³ä½¿ç”¨è€…éŸ³è¨Šé€å­—ç¨¿ï¼Œå…¶ `content.role == 'user'`ã€‚
1. ADK çš„ `get_author_for_event()` å‡½å¼æœƒæª¢æŸ¥æ­¤è§’è‰²æ¨™è¨˜ã€‚
1. è‹¥ `content.role == 'user'`ï¼ŒADK å°‡ `Event.author` è¨­ç‚º `"user"`ã€‚
1. å¦å‰‡ï¼ŒADK å°‡ `Event.author` è¨­ç‚ºä»£ç†ç¨‹å¼åç¨±ï¼ˆä¾‹å¦‚ `"my_agent"`ï¼‰ã€‚

æ­¤è½‰æ›ç¢ºä¿è½‰éŒ„çš„ä½¿ç”¨è€…è¼¸å…¥åœ¨æ‡‰ç”¨ç¨‹å¼çš„å°è©±æ­·å²ç´€éŒ„ä¸­è¢«æ­£ç¢ºæ­¸å› æ–¼ä½¿ç”¨è€…ï¼Œå„˜ç®¡å®ƒæµç¶“æ¨¡å‹çš„å›æ‡‰ä¸²æµã€‚

- ç¯„ä¾‹ï¼šè¼¸å…¥éŸ³è¨Šé€å­—ç¨¿ â†’ `Event(author="user", input_transcription=..., content.role="user")`

**ç‚ºä½•é€™å¾ˆé‡è¦**ï¼š

- åœ¨å¤šä»£ç†ç¨‹å¼æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæ‚¨å¯ä»¥ä¾ä»£ç†ç¨‹å¼éæ¿¾äº‹ä»¶ï¼š`events = [e for e in stream if e.author == "my_agent"]`ã€‚
- é¡¯ç¤ºå°è©±æ­·å²æ™‚ï¼Œä½¿ç”¨ `event.author` é¡¯ç¤ºæ˜¯èª°èªªäº†ä»€éº¼ã€‚
- é€å­—ç¨¿äº‹ä»¶æœƒæ­£ç¢ºæ­¸å› æ–¼ä½¿ç”¨è€…ï¼Œå³ä½¿å®ƒå€‘æµç¶“æ¨¡å‹ã€‚

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`base_llm_flow.py:292-326`](https://github.com/google/adk-python/blob/fd2c0f556b786417a9f6add744827b07e7a06b7d/src/google/adk/flows/llm_flows/base_llm_flow.py#L287-L321) ä¸­çš„ä½œè€…æ­¸å±¬é‚è¼¯ã€‚

### äº‹ä»¶é¡å‹èˆ‡è™•ç†

ADK é€é `runner.run_live()` ä¸²æµä¸åŒçš„äº‹ä»¶é¡å‹ï¼Œä»¥æ”¯æ´ä¸åŒçš„äº’å‹•å½¢å¼ï¼šå‚³çµ±èŠå¤©çš„æ–‡å­—å›æ‡‰ã€èªéŸ³è¼¸å‡ºçš„éŸ³è¨Šå€å¡Šã€ç”¨æ–¼ç„¡éšœç¤™å’Œæ—¥èªŒè¨˜éŒ„çš„é€å­—ç¨¿ï¼Œä»¥åŠç”¨æ–¼å‡½å¼åŸ·è¡Œçš„å·¥å…·èª¿ç”¨é€šçŸ¥ã€‚æ¯å€‹äº‹ä»¶éƒ½åŒ…å«æ§åˆ¶ UI ç‹€æ…‹è½‰æ›ä¸¦å¯¦ç¾è‡ªç„¶ã€é¡äººå°è©±æµç¨‹çš„ä¸­ç¹¼è³‡æ–™æ¨™è¨˜ï¼ˆ`partial`ã€`turn_complete`ã€`interrupted`ï¼‰ã€‚ç†è§£å¦‚ä½•è­˜åˆ¥èˆ‡è™•ç†é€™äº›äº‹ä»¶é¡å‹å°æ–¼å»ºç«‹éŸ¿æ‡‰å¼ä¸²æµæ‡‰ç”¨ç¨‹å¼è‡³é—œé‡è¦ã€‚

### æ–‡å­—äº‹ä»¶

æœ€å¸¸è¦‹çš„äº‹ä»¶é¡å‹ï¼Œç•¶æ‚¨åœ¨ `RunConfig` ä¸­æŒ‡å®š `response_modalities` ç‚º `["TEXT"]` æ¨¡å¼æ™‚ï¼ŒåŒ…å«æ¨¡å‹çš„æ–‡å­—å›æ‡‰ï¼š

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    # æª¢æŸ¥äº‹ä»¶æ˜¯å¦åŒ…å«å…§å®¹èˆ‡çµ„ä»¶
    if event.content and event.content.parts:
        # æª¢æŸ¥ç¬¬ä¸€å€‹çµ„ä»¶æ˜¯å¦åŒ…å«æ–‡å­—
        if event.content.parts[0].text:
            text = event.content.parts[0].text

            # å¦‚æœä¸æ˜¯éƒ¨åˆ†å…§å®¹ï¼ˆå³ç‚ºå®Œæ•´å€å¡Šï¼‰
            if not event.partial:
                # æ›´æ–°ä¸²æµé¡¯ç¤ºçš„é‚è¼¯
                update_streaming_display(text)
```
#### é è¨­å›æ‡‰å½¢å¼è¡Œç‚º

ç•¶ `response_modalities` æœªæ˜ç¢ºè¨­å®šï¼ˆå³ç‚º `None`ï¼‰æ™‚ï¼ŒADK æœƒåœ¨ `run_live()` é–‹å§‹æ™‚è‡ªå‹•é è¨­ç‚º `["AUDIO"]` æ¨¡å¼ã€‚é€™æ„å‘³è‘—ï¼š

- **å¦‚æœæ‚¨ä¸æä¾› RunConfig**ï¼šé è¨­ç‚º `["AUDIO"]`ã€‚
- **å¦‚æœæ‚¨æä¾›ä¸å« response_modalities çš„ RunConfig**ï¼šé è¨­ç‚º `["AUDIO"]`ã€‚
- **å¦‚æœæ‚¨æ˜ç¢ºè¨­å®š response_modalities**ï¼šä½¿ç”¨æ‚¨çš„è¨­å®šï¼ˆä¸å¥—ç”¨é è¨­å€¼ï¼‰ã€‚

**ç‚ºä½•å­˜åœ¨æ­¤é è¨­å€¼**ï¼šæŸäº›åŸç”ŸéŸ³è¨Šæ¨¡å‹è¦æ±‚æ˜ç¢ºè¨­å®šå›æ‡‰å½¢å¼ã€‚ç‚ºäº†ç¢ºä¿èˆ‡æ‰€æœ‰æ¨¡å‹ç›¸å®¹ï¼ŒADK é è¨­ç‚º `["AUDIO"]`ã€‚

**å°æ–¼ç´”æ–‡å­—æ‡‰ç”¨ç¨‹å¼**ï¼šè«‹å‹™å¿…åœ¨ `RunConfig` ä¸­æ˜ç¢ºè¨­å®š `response_modalities=["TEXT"]`ï¼Œä»¥é¿å…æ¥æ”¶åˆ°éé æœŸçš„éŸ³è¨Šäº‹ä»¶ã€‚

**ç¯„ä¾‹ï¼š**

```python
# æ˜ç¢ºçš„æ–‡å­—æ¨¡å¼
run_config = RunConfig(
    response_modalities=["TEXT"],
    streaming_mode=StreamingMode.BIDI
)
```

**é—œéµäº‹ä»¶æ¨™è¨˜ï¼š**

é€™äº›æ¨™è¨˜æœ‰åŠ©æ–¼æ‚¨åœ¨ UI ä¸­ç®¡ç†ä¸²æµæ–‡å­—é¡¯ç¤ºå’Œå°è©±æµç¨‹ï¼š

- `event.partial`ï¼šä¸²æµæœŸé–“å¢é‡æ–‡å­—å€å¡Šç‚º `True`ï¼›å®Œæ•´åˆä½µæ–‡å­—ç‚º `False`ã€‚
- `event.turn_complete`ï¼šç•¶æ¨¡å‹å®Œæˆå…¶å®Œæ•´å›æ‡‰æ™‚ç‚º `True`ã€‚
- `event.interrupted`ï¼šç•¶ä½¿ç”¨è€…ä¸­æ–·æ¨¡å‹å›æ‡‰æ™‚ç‚º `True`ã€‚

> [!NOTE] äº†è§£æ›´å¤š
é—œæ–¼ä½¿ç”¨ `partial`ã€`turn_complete` å’Œ `interrupted` æ¨™è¨˜ä¾†ç®¡ç†å°è©±æµç¨‹èˆ‡ UI ç‹€æ…‹çš„è©³ç´°æŒ‡å—ï¼Œè«‹åƒé–± [è™•ç†æ–‡å­—äº‹ä»¶](#æ–‡å­—äº‹ä»¶)ã€‚

### éŸ³è¨Šäº‹ä»¶

ç•¶ `RunConfig` ä¸­çš„ `response_modalities` é…ç½®ç‚º `["AUDIO"]` æ™‚ï¼Œæ¨¡å‹æœƒç”¢ç”ŸéŸ³è¨Šè¼¸å‡ºè€Œéæ–‡å­—ï¼Œæ‚¨å°‡åœ¨äº‹ä»¶ä¸²æµä¸­æ¥æ”¶éŸ³è¨Šè³‡æ–™ï¼š

**é…ç½®ï¼š**

```python
# ç‚ºéŸ³è¨Šå›æ‡‰é…ç½® RunConfig
run_config = RunConfig(
    response_modalities=["AUDIO"],
    streaming_mode=StreamingMode.BIDI
)

# éŸ³è¨Šä»¥ inline_data å½¢å¼å­˜åœ¨æ–¼ event.content.parts ä¸­
async for event in runner.run_live(..., run_config=run_config):
    if event.content and event.content.parts:
        part = event.content.parts[0]
        if part.inline_data:
            # éŸ³è¨Šäº‹ä»¶çµæ§‹ï¼š
            # part.inline_data.data: bytes (åŸå§‹ PCM éŸ³è¨Š)
            # part.inline_data.mime_type: str (ä¾‹å¦‚ "audio/pcm")
            audio_data = part.inline_data.data
            mime_type = part.inline_data.mime_type

            print(f"æ”¶åˆ° {len(audio_data)} ä½å…ƒçµ„çš„ {mime_type}")
            # æ’­æ”¾éŸ³è¨Šçš„é‚è¼¯
            await play_audio(audio_data)
```

> [!NOTE] äº†è§£æ›´å¤š
> - **`response_modalities` æ§åˆ¶æ¨¡å‹å¦‚ä½•ç”¢ç”Ÿè¼¸å‡º**â€”â€”æ¯å€‹å·¥ä½œéšæ®µæ‚¨å¿…é ˆé¸æ“‡ `["TEXT"]`ï¼ˆæ–‡å­—å›æ‡‰ï¼‰æˆ– `["AUDIO"]`ï¼ˆéŸ³è¨Šå›æ‡‰ï¼‰ä¹‹ä¸€ã€‚æ‚¨ä¸èƒ½åŒæ™‚ä½¿ç”¨å…©ç¨®å½¢å¼ã€‚é…ç½®è©³æƒ…è«‹åƒé–± [ç¬¬ 4 éƒ¨åˆ†ï¼šå›æ‡‰å½¢å¼](https://google.github.io/adk-docs/streaming/dev-guide/part4/#response-modalities)ã€‚
> - é—œæ–¼éŸ³è¨Šæ ¼å¼ã€å‚³é€/æ¥æ”¶éŸ³è¨ŠåŠéŸ³è¨Šè™•ç†æµç¨‹çš„å…¨é¢ä»‹ç´¹ï¼Œè«‹åƒé–± [ç¬¬ 5 éƒ¨åˆ†ï¼šå¦‚ä½•ä½¿ç”¨éŸ³è¨Šã€åœ–ç‰‡èˆ‡å½±ç‰‡](part5.md)ã€‚

### å«æª”æ¡ˆè³‡æ–™çš„éŸ³è¨Šäº‹ä»¶

ç•¶éŸ³è¨Šè³‡æ–™è¢«å½™æ•´ä¸¦ä»¥æª”æ¡ˆå½¢å¼å„²å­˜åœ¨æˆå“ä¸­æ™‚ï¼ŒADK æœƒç”¢ç”ŸåŒ…å« `file_data` å¼•ç”¨è€ŒéåŸå§‹ `inline_data` çš„äº‹ä»¶ã€‚é€™å°æ–¼å°‡éŸ³è¨ŠæŒä¹…åŒ–åˆ°å·¥ä½œéšæ®µæ­·å²ç´€éŒ„éå¸¸æœ‰ç”¨ã€‚

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`audio_cache_manager.py:156-178`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/flows/llm_flows/audio_cache_manager.py#L156-L178) ä¸­çš„éŸ³è¨Šæª”æ¡ˆå½™æ•´é‚è¼¯ã€‚

**æ¥æ”¶éŸ³è¨Šæª”æ¡ˆå¼•ç”¨ï¼š**

```python
# æ¥æ”¶åŒ…å«æª”æ¡ˆå¼•ç”¨çš„éŸ³è¨Šäº‹ä»¶
async for event in runner.run_live(
    user_id=user_id,
    session_id=session_id,
    live_request_queue=queue,
    run_config=run_config
):
    if event.content and event.content.parts:
        for part in event.content.parts:
            if part.file_data:
                # éŸ³è¨Šå·²å½™æ•´ç‚ºæª”æ¡ˆä¸¦å„²å­˜åœ¨ Artifact ä¸­
                file_uri = part.file_data.file_uri
                mime_type = part.file_data.mime_type

                print(f"éŸ³è¨Šæª”æ¡ˆå·²å„²å­˜ï¼š{file_uri} ({mime_type})")
                # å¾ Artifact Service å–å¾—éŸ³è¨Šæª”æ¡ˆä»¥ä¾›æ’­æ”¾
```

**æª”æ¡ˆè³‡æ–™ï¼ˆFile Dataï¼‰vs å…§åµŒè³‡æ–™ï¼ˆInline Dataï¼‰ï¼š**

- **å…§åµŒè³‡æ–™**ï¼ˆ`part.inline_data`ï¼‰ï¼šå³æ™‚ä¸²æµçš„åŸå§‹éŸ³è¨Šä½å…ƒçµ„ï¼›å…·æš«æ™‚æ€§ä¸”ä¸å„²å­˜è‡³å·¥ä½œéšæ®µã€‚
- **æª”æ¡ˆè³‡æ–™**ï¼ˆ`part.file_data`ï¼‰ï¼šå„²å­˜åœ¨æˆå“ä¸­çš„éŸ³è¨Šæª”æ¡ˆå¼•ç”¨ï¼›å¯æŒä¹…åŒ–è‡³å·¥ä½œéšæ®µæ­·å²ç´€éŒ„ã€‚

è¼¸å…¥èˆ‡è¼¸å‡ºçš„éŸ³è¨Šè³‡æ–™éƒ½æœƒè¢«å½™æ•´æˆéŸ³è¨Šæª”æ¡ˆä¸¦å„²å­˜åœ¨æˆå“æœå‹™ä¸­ã€‚æª”æ¡ˆå¼•ç”¨ä»¥ `file_data` å½¢å¼åŒ…å«åœ¨äº‹ä»¶ä¸­ï¼Œè®“æ‚¨ç¨å¾Œèƒ½æª¢ç´¢éŸ³è¨Šã€‚

> [!NOTE] å·¥ä½œéšæ®µæŒä¹…åŒ–
è‹¥è¦å°‡å«æª”æ¡ˆè³‡æ–™çš„éŸ³è¨Šäº‹ä»¶å„²å­˜è‡³å·¥ä½œéšæ®µæ­·å²ç´€éŒ„ï¼Œè«‹å•Ÿç”¨ `RunConfig.save_live_blob = True`ã€‚é€™å…è¨±å¾æŒä¹…åŒ–å·¥ä½œéšæ®µå›é¡§æˆ–é‡æ’­éŸ³è¨Šå°è©±ã€‚

### ä¸­ç¹¼è³‡æ–™äº‹ä»¶

ä½¿ç”¨é‡ä¸­ç¹¼è³‡æ–™äº‹ä»¶åŒ…å«ç”¨æ–¼ç›£æ§æˆæœ¬å’Œé…é¡æ¶ˆè€—çš„æ¬Šæ–ä½¿ç”¨è³‡è¨Šã€‚`run_live()` æ–¹æ³•æœƒå°‡é€™äº›äº‹ä»¶èˆ‡å…§å®¹äº‹ä»¶åˆ†é–‹ç”¢ç”Ÿã€‚

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`llm_response.py:105`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/models/llm_response.py#L105) ä¸­çš„ä½¿ç”¨é‡ä¸­ç¹¼è³‡æ–™çµæ§‹ã€‚

**å­˜å–æ¬Šæ–ä½¿ç”¨é‡ (Accessing Token Usage)ï¼š**

```python
# å­˜å–æ¬Šæ–ä½¿ç”¨è³‡è¨Š
async for event in runner.run_live(
    user_id=user_id,
    session_id=session_id,
    live_request_queue=queue,
    run_config=run_config
):
    if event.usage_metadata:
        print(f"æç¤ºï¼ˆPromptï¼‰æ¬Šæ–ï¼š{event.usage_metadata.prompt_token_count}")
        print(f"å›æ‡‰ï¼ˆResponseï¼‰æ¬Šæ–ï¼š{event.usage_metadata.candidates_token_count}")
        print(f"ç¸½æ¬Šæ–ï¼š{event.usage_metadata.total_token_count}")

        # è¿½è¹¤å·¥ä½œéšæ®µä¸­çš„ç´¯ç©ä½¿ç”¨é‡
        total_tokens += event.usage_metadata.total_token_count or 0
```

**å¯ç”¨çš„ä¸­ç¹¼è³‡æ–™æ¬„ä½ï¼š**

- `prompt_token_count`ï¼šè¼¸å…¥ä¸­çš„æ¬Šæ–æ•¸ï¼ˆæç¤ºè©èˆ‡ä¸Šä¸‹æ–‡ï¼‰ã€‚
- `candidates_token_count`ï¼šæ¨¡å‹å›æ‡‰ä¸­çš„æ¬Šæ–æ•¸ã€‚
- `total_token_count`ï¼šæç¤ºè©èˆ‡å›æ‡‰æ¬Šæ–çš„ç¸½å’Œã€‚
- `cached_content_token_count`ï¼šå¾å¿«å–ä¸­æœå‹™çš„æ¬Šæ–æ•¸ï¼ˆä½¿ç”¨ä¸Šä¸‹æ–‡å¿«å–æ™‚ï¼‰ã€‚

> [!NOTE] æˆæœ¬ç›£æ§
ä½¿ç”¨é‡ä¸­ç¹¼è³‡æ–™äº‹ä»¶å…è¨±åœ¨ä¸²æµå·¥ä½œéšæ®µæœŸé–“é€²è¡Œå³æ™‚æˆæœ¬è¿½è¹¤ã€‚æ‚¨å¯ä»¥å¯¦ä½œé…é¡é™åˆ¶ã€å‘ä½¿ç”¨è€…é¡¯ç¤ºä½¿ç”¨é‡ï¼Œæˆ–ç‚ºè¨ˆè²»å’Œåˆ†æè¨˜éŒ„æŒ‡æ¨™ã€‚

### é€å­—ç¨¿äº‹ä»¶

ç•¶åœ¨ `RunConfig` ä¸­å•Ÿç”¨é€å­—ç¨¿åŠŸèƒ½æ™‚ï¼Œæ‚¨æœƒæ”¶åˆ°ç¨ç«‹çš„é€å­—ç¨¿äº‹ä»¶ï¼š

**é…ç½®ï¼š**

```python
async for event in runner.run_live(...):
    # ä½¿ç”¨è€…çš„èªªè©±å…§å®¹ï¼ˆç•¶å•Ÿç”¨ input_audio_transcription æ™‚ï¼‰
    if event.input_transcription:
        # é¡¯ç¤ºä½¿ç”¨è€…é€å­—ç¨¿çš„é‚è¼¯
        display_user_transcription(event.input_transcription)

    # æ¨¡å‹çš„èªªè©±å…§å®¹ï¼ˆç•¶å•Ÿç”¨ output_audio_transcription æ™‚ï¼‰
    if event.output_transcription:
        # é¡¯ç¤ºæ¨¡å‹é€å­—ç¨¿çš„é‚è¼¯
        display_model_transcription(event.output_transcription)
```

é€™äº›äº‹ä»¶å¯åœ¨ç„¡éœ€é¡å¤–é€å­—ç¨¿æœå‹™çš„æƒ…æ³ä¸‹å¯¦ç¾ç„¡éšœç¤™åŠŸèƒ½å’Œå°è©±æ—¥èªŒã€‚

> [!NOTE] äº†è§£æ›´å¤š
é—œæ–¼åœ¨ `RunConfig` ä¸­å•Ÿç”¨é€å­—ç¨¿åŠç†è§£é€å­—ç¨¿å‚³éçš„è©³æƒ…ï¼Œè«‹åƒé–± [ç¬¬ 5 éƒ¨åˆ†ï¼šéŸ³è¨Šé€å­—ç¨¿](part5.md#éŸ³è¨Šé€å­—ç¨¿-audio-transcription)ã€‚

### å·¥å…·èª¿ç”¨äº‹ä»¶

ç•¶æ¨¡å‹è«‹æ±‚åŸ·è¡Œå·¥å…·æ™‚ï¼š

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    if event.content and event.content.parts:
        for part in event.content.parts:
            if part.function_call:
                # æ¨¡å‹æ­£åœ¨è«‹æ±‚å·¥å…·åŸ·è¡Œ
                tool_name = part.function_call.name
                tool_args = part.function_call.args
                # ADK æœƒè‡ªå‹•è™•ç†åŸ·è¡Œ
```

ADK æœƒè‡ªå‹•è™•ç†å·¥å…·èª¿ç”¨â€”â€”é™¤éè¦å¯¦ä½œè‡ªè¨‚å·¥å…·åŸ·è¡Œé‚è¼¯ï¼Œå¦å‰‡æ‚¨é€šå¸¸ä¸éœ€è¦ç›´æ¥è™•ç†é€™äº›äº‹ä»¶ã€‚

> [!NOTE] äº†è§£æ›´å¤š
é—œæ–¼ ADK å¦‚ä½•è‡ªå‹•åŸ·è¡Œå·¥å…·ã€è™•ç†å‡½å¼å›æ‡‰ä»¥åŠæ”¯æ´é•·æ™‚é–“åŸ·è¡Œå’Œä¸²æµå·¥å…·çš„è©³æƒ…ï¼Œè«‹åƒé–± [run_live() ä¸­çš„è‡ªå‹•å·¥å…·åŸ·è¡Œ](#run_live-ä¸­çš„è‡ªå‹•å·¥å…·åŸ·è¡Œ)ã€‚

### éŒ¯èª¤äº‹ä»¶

æ­£å¼ç”Ÿç”¢ç’°å¢ƒçš„æ‡‰ç”¨ç¨‹å¼éœ€è¦å¼·å¥çš„éŒ¯èª¤è™•ç†ï¼Œä»¥å„ªé›…åœ°è™•ç†æ¨¡å‹éŒ¯èª¤èˆ‡é€£ç·šå•é¡Œã€‚ADK é€é `error_code` å’Œ `error_message` æ¬„ä½å‘ˆç¾éŒ¯èª¤ï¼š

**ç”¨æ³•ï¼š**

```python
import logging

logger = logging.getLogger(__name__)

try:
    async for event in runner.run_live(...):
        # è™•ç†ä¾†è‡ªæ¨¡å‹æˆ–é€£ç·šçš„éŒ¯èª¤
        if event.error_code:
            logger.error(f"æ¨¡å‹éŒ¯èª¤ï¼š{event.error_code} - {event.error_message}")

            # å‚³é€éŒ¯èª¤é€šçŸ¥çµ¦ç”¨æˆ¶ç«¯
            await websocket.send_json({
                "type": "error",
                "code": event.error_code,
                "message": event.error_message
            })

            # æ ¹æ“šéŒ¯èª¤åš´é‡æ€§æ±ºå®šæ˜¯å¦ç¹¼çºŒæˆ–ä¸­æ–·
            if event.error_code in ["SAFETY", "PROHIBITED_CONTENT", "BLOCKLIST"]:
                # é•åå…§å®¹åŸå‰‡ - é€šå¸¸ç„¡æ³•é‡è©¦
                break  # çµ‚ç«¯éŒ¯èª¤ - çµæŸè¿´åœˆ
            elif event.error_code == "MAX_TOKENS":
                # é”åˆ°æ¬Šæ–é™åˆ¶ - å¯èƒ½éœ€è¦èª¿æ•´é…ç½®
                break
            # å°æ–¼å…¶ä»–éŒ¯èª¤ï¼Œæ‚¨å¯èƒ½æœƒç¹¼çºŒæˆ–å¯¦ä½œé‡è©¦é‚è¼¯
            continue  # æš«æ™‚æ€§éŒ¯èª¤ - ç¹¼çºŒè™•ç†

        # åƒ…åœ¨ç„¡éŒ¯èª¤æ™‚è™•ç†æ­£å¸¸äº‹ä»¶å…§å®¹
        if event.content and event.content.parts:
            # ... è™•ç†å…§å®¹
            pass
finally:
    queue.close()  # å‹™å¿…æ¸…ç†é€£ç·š
```

>[!NOTE] æ³¨æ„
ä¸Šè¿°ç¯„ä¾‹é¡¯ç¤ºäº†æª¢æŸ¥ `error_code` å’Œ `error_message` çš„åŸºæœ¬çµæ§‹ã€‚é—œæ–¼åŒ…å«ä½¿ç”¨è€…é€šçŸ¥ã€é‡è©¦é‚è¼¯å’Œä¸Šä¸‹æ–‡è¨˜éŒ„çš„ç”Ÿç”¢ç´šéŒ¯èª¤è™•ç†ï¼Œè«‹åƒé–±ä¸‹æ–¹çš„å¯¦éš›å ´æ™¯ã€‚

**ä½•æ™‚ä½¿ç”¨ `break` vs `continue`ï¼š**

é—œéµæ±ºç­–é»åœ¨æ–¼ï¼š*æ¨¡å‹çš„å›ç­”èƒ½å¦æœ‰æ„ç¾©åœ°ç¹¼çºŒï¼Ÿ*

**å ´æ™¯ 1ï¼šé•åå…§å®¹åŸå‰‡ï¼ˆä½¿ç”¨ `break`ï¼‰**

æ‚¨æ­£åœ¨å»ºç«‹ä¸€å€‹å®¢æˆ¶æ”¯æ´èŠå¤©æ©Ÿå™¨äººã€‚ä½¿ç”¨è€…å•äº†ä¸€å€‹ä¸æ°ç•¶çš„å•é¡Œï¼Œè§¸ç™¼äº†å®‰å…¨ï¼ˆSAFETYï¼‰éæ¿¾å™¨ï¼š

**ç¯„ä¾‹ï¼š**

```python
if event.error_code in ["SAFETY", "PROHIBITED_CONTENT", "BLOCKLIST"]:
    # æ¨¡å‹å·²åœæ­¢ç”¢ç”Ÿ - ç„¡æ³•ç¹¼çºŒ
    await websocket.send_json({
        "type": "error",
        "message": "æˆ‘ç„¡æ³•å”åŠ©è™•ç†è©²è«‹æ±‚ã€‚è«‹è©¢å•å…¶ä»–å•é¡Œã€‚"
    })
    break  # çµæŸè¿´åœˆ - æ¨¡å‹ä¸æœƒå†é‡å°æ­¤å›åˆå‚³é€æ›´å¤šäº‹ä»¶
```

**ç‚ºä½•ä½¿ç”¨ `break`ï¼Ÿ** æ¨¡å‹å·²çµ‚æ­¢å›æ‡‰ã€‚æ­¤å›åˆä¸æœƒå†æœ‰æ›´å¤šäº‹ä»¶ã€‚ç¹¼çºŒç­‰å¾…åªæœƒæµªè²»è³‡æºã€‚

---

**å ´æ™¯ 2ï¼šä¸²æµæœŸé–“çš„ç¶²è·¯å°å•é¡Œï¼ˆä½¿ç”¨ `continue`ï¼‰**

æ‚¨æ­£åœ¨å»ºç«‹ä¸€å€‹èªéŸ³é€å­—ç¨¿æœå‹™ã€‚åœ¨è½‰éŒ„ä¸­é€”ï¼Œç¶²è·¯å‡ºç¾çŸ­æš«é–ƒæ–·ï¼š

**ç¯„ä¾‹ï¼š**

```python
if event.error_code == "UNAVAILABLE":
    # æš«æ™‚æ€§ç¶²è·¯å•é¡Œ
    logger.warning(f"ç¶²è·¯ç¬æ–·ï¼š{event.error_message}")
    # å°æ–¼å¯èƒ½è‡ªè¡Œæ¢å¾©çš„çŸ­æš«æš«æ™‚æ€§å•é¡Œï¼Œä¸è¦é€šçŸ¥ä½¿ç”¨è€…
    continue  # ç¹¼çºŒç›£è½ - é€£ç·šå¯èƒ½æ¢å¾©ä¸¦ç¹¼çºŒ
```

**ç‚ºä½•ä½¿ç”¨ `continue`ï¼Ÿ** é€™æ˜¯ä¸€å€‹æš«æ™‚æ€§éŒ¯èª¤ã€‚é€£ç·šå¯èƒ½æœƒæ¢å¾©ï¼Œä¸”æ¨¡å‹å¯èƒ½ç¹¼çºŒä¸²æµé€å­—ç¨¿ã€‚ä½¿ç”¨ `break` æœƒéæ—©çµæŸä¸€å€‹å¯èƒ½å¯æ¢å¾©çš„ä¸²æµã€‚

> [!NOTE] ä½¿ç”¨è€…é€šçŸ¥
å°æ–¼çŸ­æš«çš„æš«æ™‚æ€§éŒ¯èª¤ï¼ˆæŒçºŒæ™‚é–“ < 1 ç§’ï¼‰ï¼Œä¸è¦é€šçŸ¥ä½¿ç”¨è€…â€”â€”ä»–å€‘ä¸æœƒå¯Ÿè¦ºåˆ°é–ƒæ–·ã€‚ä½†è‹¥éŒ¯èª¤æŒçºŒå­˜åœ¨æˆ–å½±éŸ¿ä½¿ç”¨è€…é«”é©—ï¼ˆä¾‹å¦‚ä¸²æµæš«åœ > 3 ç§’ï¼‰ï¼Œè«‹å„ªé›…åœ°é€šçŸ¥ä»–å€‘ï¼šã€Œé€£ç·šå‡ºç¾å•é¡Œï¼Œæ­£åœ¨é‡è©¦ä¸­...ã€

---

**å ´æ™¯ 3ï¼šé”åˆ°æ¬Šæ–é™åˆ¶ï¼ˆä½¿ç”¨ `break`ï¼‰**

æ‚¨æ­£åœ¨ç”¢ç”Ÿé•·ç¯‡æ–‡ç« ä¸¦é”åˆ°äº†æœ€å¤§æ¬Šæ–é™åˆ¶ï¼š

**ç¯„ä¾‹ï¼š**

```python
if event.error_code == "MAX_TOKENS":
    # æ¨¡å‹å·²é”åˆ°è¼¸å‡ºé™åˆ¶
    await websocket.send_json({
        "type": "complete",
        "message": "å›æ‡‰å·²é”æœ€å¤§é•·åº¦",
        "truncated": True
    })
    break  # æ¨¡å‹å·²çµæŸ - ä¸æœƒå†ç”¢ç”Ÿæ›´å¤šæ¬Šæ–
```

**ç‚ºä½•ä½¿ç”¨ `break`ï¼Ÿ** æ¨¡å‹å·²é”åˆ°è¼¸å‡ºé™åˆ¶ä¸¦åœæ­¢ã€‚ç¹¼çºŒç­‰å¾…ä¸æœƒç”¢ç”Ÿæ›´å¤šæ¬Šæ–ã€‚

---

**å ´æ™¯ 4ï¼šå¸¶é‡è©¦é‚è¼¯çš„é€Ÿç‡é™åˆ¶ï¼ˆæ­é…å€’é€€æ©Ÿåˆ¶ä½¿ç”¨ `continue`ï¼‰**

æ‚¨æ­£åœ¨é‹ä½œä¸€å€‹é«˜æµé‡æ‡‰ç”¨ç¨‹å¼ï¼Œå¶çˆ¾æœƒé‡åˆ°é€Ÿç‡é™åˆ¶ï¼š

**ç¯„ä¾‹ï¼š**

```python
retry_count = 0
max_retries = 3

async for event in runner.run_live(...):
    if event.error_code == "RESOURCE_EXHAUSTED":
        retry_count += 1
        if retry_count > max_retries:
            logger.error("è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸")
            break  # å¤šæ¬¡å¤±æ•—å¾Œæ”¾æ£„

        # ç­‰å¾…ä¸¦é‡è©¦
        await asyncio.sleep(2 ** retry_count)  # æŒ‡æ•¸å€’é€€ï¼ˆExponential backoffï¼‰
        continue  # ç¹¼çºŒç›£è½ - é€Ÿç‡é™åˆ¶å¯èƒ½æœƒè§£é™¤

    # æˆåŠŸæ”¶åˆ°äº‹ä»¶å¾Œé‡è¨­è¨ˆæ•¸å™¨
    retry_count = 0
```

**ç‚ºä½•æœ€åˆä½¿ç”¨ `continue`ï¼Ÿ** é€Ÿç‡é™åˆ¶é€šå¸¸æ˜¯æš«æ™‚çš„ã€‚é€éæŒ‡æ•¸å€’é€€æ©Ÿåˆ¶ï¼Œä¸²æµå¯èƒ½æœƒæ¢å¾©ã€‚ä½†åœ¨å¤šæ¬¡å¤±æ•—å¾Œï¼Œè«‹ä½¿ç”¨ `break` ä»¥é¿å…ç„¡é™æœŸç­‰å¾…ã€‚

---

**æ±ºç­–æ¡†æ¶ï¼š**

| éŒ¯èª¤é¡å‹                           | å‹•ä½œ                    | åŸå›                 |
| ---------------------------------- | ----------------------- | ------------------- |
| `SAFETY`, `PROHIBITED_CONTENT`     | `break`                 | æ¨¡å‹çµ‚æ­¢äº†å›æ‡‰      |
| `MAX_TOKENS`                       | `break`                 | æ¨¡å‹å®Œæˆäº†ç”¢ç”Ÿ      |
| `UNAVAILABLE`, `DEADLINE_EXCEEDED` | `continue`              | æš«æ™‚æ€§ç¶²è·¯/é€¾æ™‚å•é¡Œ |
| `RESOURCE_EXHAUSTED` (é€Ÿç‡é™åˆ¶)    | å¸¶é‡è©¦é‚è¼¯çš„ `continue` | çŸ­æš«ç­‰å¾…å¾Œå¯èƒ½æ¢å¾©  |
| æœªçŸ¥éŒ¯èª¤                           | `continue` (è¨˜éŒ„æ—¥èªŒ)   | æ¡å–å¯©æ…æ…‹åº¦        |

**è‡³é—œé‡è¦ï¼šå‹™å¿…ä½¿ç”¨ `finally` é€²è¡Œæ¸…ç†**

**ç”¨æ³•ï¼š**

```python
try:
    async for event in runner.run_live(...):
        # ... éŒ¯èª¤è™•ç† ...
finally:
    queue.close()  # ç„¡è«–æ˜¯ä¸­æ–·æˆ–æ­£å¸¸çµæŸï¼Œéƒ½æœƒåŸ·è¡Œæ¸…ç†
```

ç„¡è«–æ˜¯ä½¿ç”¨ `break` æˆ–æ˜¯è¿´åœˆæ­£å¸¸çµæŸï¼Œ`finally` éƒ½èƒ½ç¢ºä¿é€£ç·šè¢«æ­£ç¢ºé—œé–‰ã€‚

**éŒ¯èª¤ä»£ç¢¼åƒè€ƒï¼š**

ADK éŒ¯èª¤ä»£ç¢¼ä¾†è‡ªåº•å±¤çš„ Gemini APIã€‚ä»¥ä¸‹æ˜¯æ‚¨æœƒé‡åˆ°çš„æœ€å¸¸è¦‹éŒ¯èª¤ä»£ç¢¼ï¼š

| éŒ¯èª¤ä»£ç¢¼             | é¡åˆ¥     | èªªæ˜                 | å»ºè­°å‹•ä½œ                             |
| -------------------- | -------- | -------------------- | ------------------------------------ |
| `SAFETY`             | å…§å®¹åŸå‰‡ | å…§å®¹é•åå®‰å…¨åŸå‰‡     | `break` - é€šçŸ¥ä½¿ç”¨è€…ï¼Œè¨˜éŒ„äº‹ä»¶       |
| `PROHIBITED_CONTENT` | å…§å®¹åŸå‰‡ | å…§å®¹åŒ…å«å—ç¦å…§å®¹     | `break` - é¡¯ç¤ºåŸå‰‡é•åè¨Šæ¯           |
| `BLOCKLIST`          | å…§å®¹åŸå‰‡ | å…§å®¹ç¬¦åˆé»‘åå–®       | `break` - è­¦ç¤ºä½¿ç”¨è€…ï¼Œä¸è¦é‡è©¦       |
| `MAX_TOKENS`         | é™åˆ¶     | è¼¸å‡ºé”åˆ°æœ€å¤§æ¬Šæ–é™åˆ¶ | `break` - å„ªé›…æˆªæ–·ï¼Œé€²è¡Œæ‘˜è¦         |
| `RESOURCE_EXHAUSTED` | é€Ÿç‡é™åˆ¶ | é…é¡æˆ–é€Ÿç‡é™åˆ¶å·²æ»¿   | `continue` å¸¶å€’é€€æ©Ÿåˆ¶ - å»¶é²å¾Œé‡è©¦   |
| `UNAVAILABLE`        | æš«æ™‚æ€§   | æœå‹™æš«æ™‚ä¸å¯ç”¨       | `continue` - é‡è©¦ï¼Œå¯èƒ½è‡ªè¡Œæ¢å¾©      |
| `DEADLINE_EXCEEDED`  | æš«æ™‚æ€§   | è«‹æ±‚é€¾æ™‚             | `continue` - è€ƒæ…®å¸¶å€’é€€æ©Ÿåˆ¶çš„é‡è©¦    |
| `CANCELLED`          | ç”¨æˆ¶ç«¯   | ç”¨æˆ¶ç«¯å–æ¶ˆäº†è«‹æ±‚     | `break` - æ¸…ç†è³‡æº                   |
| `UNKNOWN`            | ç³»çµ±     | ç™¼ç”ŸæœªæŒ‡å®šéŒ¯èª¤       | `continue` å¸¶æ—¥èªŒè¨˜éŒ„ - è¨˜éŒ„ä»¥ä¾›åˆ†æ |

å¦‚éœ€å®Œæ•´çš„éŒ¯èª¤ä»£ç¢¼æ¸…å–®èˆ‡èªªæ˜ï¼Œè«‹åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼š

> [!NOTE] å®˜æ–¹æ–‡ä»¶
> - **FinishReason**ï¼ˆæ¨¡å‹åœæ­¢ç”¢ç”Ÿæ¬Šæ–æ™‚ï¼‰ï¼š[Google AI for Developers](https://ai.google.dev/api/python/google/ai/generativelanguage/Candidate/FinishReason) | [Vertex AI](https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/gemini)
> - **BlockedReason**ï¼ˆæç¤ºè©å› å…§å®¹éæ¿¾è€Œè¢«å°é–æ™‚ï¼‰ï¼š[Google AI for Developers](https://ai.google.dev/api/python/google/ai/generativelanguage/GenerateContentResponse/PromptFeedback/BlockReason) | [Vertex AI](https://cloud.google.com/vertex-ai/generative-ai/docs/multimodal/configure-safety-attributes)
> - **ADK å¯¦ä½œ**ï¼š[`llm_response.py:145-200`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/models/llm_response.py#L145-L200)

**éŒ¯èª¤è™•ç†æœ€ä½³å¯¦è¸ï¼š**

- **å‹™å¿…å…ˆæª¢æŸ¥éŒ¯èª¤**ï¼šåœ¨è™•ç†å…§å®¹ä¹‹å‰å…ˆè™•ç† `error_code`ï¼Œä»¥é¿å…è™•ç†ç„¡æ•ˆäº‹ä»¶ã€‚
- **é™„å¸¶ä¸Šä¸‹æ–‡è¨˜éŒ„éŒ¯èª¤**ï¼šåœ¨éŒ¯èª¤æ—¥èªŒä¸­åŒ…å« `session_id` å’Œ `user_id` ä»¥ä¾¿é™¤éŒ¯ã€‚
- **å°‡éŒ¯èª¤åˆ†é¡**ï¼šå€åˆ†å¯é‡è©¦éŒ¯èª¤ï¼ˆæš«æ™‚æ€§å¤±æ•—ï¼‰èˆ‡çµ‚ç«¯éŒ¯èª¤ï¼ˆé•åå…§å®¹åŸå‰‡ï¼‰ã€‚
- **å„ªé›…åœ°é€šçŸ¥ä½¿ç”¨è€…**ï¼šé¡¯ç¤ºæ˜“æ–¼ç†è§£çš„éŒ¯èª¤è¨Šæ¯ï¼Œè€ŒéåŸå§‹éŒ¯èª¤ä»£ç¢¼ã€‚
- **å¯¦ä½œé‡è©¦é‚è¼¯**ï¼šå°æ–¼æš«æ™‚æ€§éŒ¯èª¤ï¼Œè€ƒæ…®ä½¿ç”¨è‡ªå‹•çš„æŒ‡æ•¸å€’é€€é‡è©¦ã€‚
- **ç›£æ§éŒ¯èª¤ç‡**ï¼šè¿½è¹¤éŒ¯èª¤é¡å‹èˆ‡é »ç‡ï¼Œä»¥è­˜åˆ¥ç³»çµ±æ€§å•é¡Œã€‚
- **è™•ç†å…§å®¹åŸå‰‡éŒ¯èª¤**ï¼šå°æ–¼ `SAFETY`ã€`PROHIBITED_CONTENT` å’Œ `BLOCKLIST` éŒ¯èª¤ï¼Œå‘ŠçŸ¥ä½¿ç”¨è€…å…¶å…§å®¹é•åäº†åŸå‰‡ã€‚

## è™•ç†æ–‡å­—äº‹ä»¶

ç†è§£ `partial`ã€`interrupted` å’Œ `turn_complete` æ¨™è¨˜å°æ–¼å»ºç«‹éŸ¿æ‡‰å¼ä¸²æµ UI è‡³é—œé‡è¦ã€‚é€™äº›æ¨™è¨˜è®“æ‚¨èƒ½åœ¨ä¸²æµæœŸé–“æä¾›å³æ™‚åé¥‹ã€å„ªé›…åœ°è™•ç†ä½¿ç”¨è€…ä¸­æ–·ï¼Œä¸¦åµæ¸¬å°è©±é‚Šç•Œä»¥é€²è¡Œé©ç•¶çš„ç‹€æ…‹ç®¡ç†ã€‚

### è™•ç† `partial`

æ­¤æ¨™è¨˜æœ‰åŠ©æ–¼æ‚¨å€åˆ†å¢é‡æ–‡å­—å€å¡Šèˆ‡å®Œæ•´çš„åˆä½µæ–‡å­—ï¼Œå¯¦ç¾å¹³æ»‘çš„ä¸²æµé¡¯ç¤ºä¸¦é…åˆæ­£ç¢ºçš„æœ€çµ‚ç¢ºèªã€‚

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    if event.content and event.content.parts:
        if event.content.parts[0].text:
            text = event.content.parts[0].text

            if event.partial:
                # æ‚¨çš„ä¸²æµ UI æ›´æ–°é‚è¼¯
                update_streaming_display(text)
            else:
                # æ‚¨çš„å®Œæ•´è¨Šæ¯é¡¯ç¤ºé‚è¼¯
                display_complete_message(text)
```

**`partial` æ¨™è¨˜èªæ„ï¼š**

- `partial=True`ï¼šæ­¤äº‹ä»¶ä¸­çš„æ–‡å­—æ˜¯**å¢é‡**çš„â€”â€”å®ƒåƒ…åŒ…å«è‡ªä¸Šå€‹äº‹ä»¶ä»¥ä¾†çš„æ–°æ–‡å­—ã€‚
- `partial=False`ï¼šæ­¤äº‹ä»¶ä¸­çš„æ–‡å­—æ˜¯**å®Œæ•´**çš„â€”â€”å®ƒåŒ…å«æ­¤å›æ‡‰æ®µè½çš„å®Œæ•´åˆä½µæ–‡å­—ã€‚

æ³¨æ„

`partial` æ¨™è¨˜åƒ…å°æ–‡å­—å…§å®¹ï¼ˆ`event.content.parts[].text`ï¼‰æœ‰æ„ç¾©ã€‚å°æ–¼å…¶ä»–å…§å®¹é¡å‹ï¼š

- **éŸ³è¨Šäº‹ä»¶**ï¼š`inline_data` ä¸­çš„æ¯å€‹éŸ³è¨Šå€å¡Šéƒ½æ˜¯ç¨ç«‹çš„ï¼ˆä¸é€²è¡Œåˆä½µï¼‰ã€‚
- **å·¥å…·èª¿ç”¨**ï¼šå‡½å¼èª¿ç”¨èˆ‡å›æ‡‰ä¸€å¾‹æ˜¯å®Œæ•´çš„ï¼ˆä¸å¥—ç”¨ `partial`ï¼‰ã€‚
- **é€å­—ç¨¿**ï¼šç”¢ç”Ÿæ™‚ï¼Œé€å­—ç¨¿äº‹ä»¶ä¸€å¾‹æ˜¯å®Œæ•´çš„ã€‚

**ä¸²æµç¯„ä¾‹ï¼š**

```text
äº‹ä»¶ 1: partial=True,  text="Hello",        turn_complete=False
äº‹ä»¶ 2: partial=True,  text=" world",       turn_complete=False
äº‹ä»¶ 3: partial=False, text="Hello world",  turn_complete=False
äº‹ä»¶ 4: partial=False, text="",             turn_complete=True  # å›åˆå®Œæˆ
```

**é‡è¦çš„æ™‚åºé—œä¿‚ï¼š**

- `partial=False` å¯èƒ½åœ¨ä¸€å€‹å›åˆä¸­å‡ºç¾**å¤šæ¬¡**ï¼ˆä¾‹å¦‚ï¼Œåœ¨æ¯å€‹å¥å­å¾Œï¼‰ã€‚
- `turn_complete=True` åœ¨æ¨¡å‹å®Œæ•´å›æ‡‰çš„æœ€æœ«ç«¯å‡ºç¾**ä¸€æ¬¡**ï¼Œä¸”æ˜¯åœ¨**ç¨ç«‹çš„äº‹ä»¶**ä¸­ã€‚
- æ‚¨å¯èƒ½æœƒæ”¶åˆ°ï¼š`partial=False`ï¼ˆç¬¬ 1 å¥ï¼‰â†’ `partial=False`ï¼ˆç¬¬ 2 å¥ï¼‰â†’ `turn_complete=True`ã€‚
- åˆä½µæ–‡å­—äº‹ä»¶ï¼ˆå«å…§å®¹çš„ `partial=False`ï¼‰ä¸€å¾‹åœ¨ `turn_complete=True` äº‹ä»¶**ä¹‹å‰**ç”¢ç”Ÿã€‚

> [!NOTE] æ³¨æ„
ADK å…§éƒ¨æœƒç´¯ç©æ‰€æœ‰ä¾†è‡ª `partial=True` äº‹ä»¶çš„æ–‡å­—ã€‚ç•¶æ‚¨æ”¶åˆ° `partial=False` çš„äº‹ä»¶æ™‚ï¼Œæ–‡å­—å…§å®¹ç­‰æ–¼ä¹‹å‰æ‰€æœ‰ `partial=True` å€å¡Šçš„ç¸½å’Œã€‚é€™æ„å‘³è‘—ï¼š
>
> - å¦‚æœæ‚¨ä¸éœ€è¦ä¸²æµé¡¯ç¤ºï¼Œå¯ä»¥å®‰å…¨åœ°å¿½ç•¥æ‰€æœ‰ `partial=True` äº‹ä»¶ï¼Œåƒ…è™•ç† `partial=False` äº‹ä»¶ã€‚
> - å¦‚æœæ‚¨é¡¯ç¤º `partial=True` äº‹ä»¶ï¼Œ`partial=False` äº‹ä»¶å¯æä¾›å®Œæ•´çš„åˆä½µæ–‡å­—ç”¨æ–¼é©—è­‰æˆ–å„²å­˜ã€‚
> - æ­¤ç´¯ç©éç¨‹ç”± ADK çš„ `StreamingResponseAggregator` è‡ªå‹•è™•ç†â€”â€”æ‚¨ä¸éœ€è¦æ‰‹å‹•ä¸²æ¥éƒ¨åˆ†æ–‡å­—å€å¡Šã€‚

#### è™•ç† `interrupted` æ¨™è¨˜

é€™é€éåµæ¸¬ä½¿ç”¨è€…ä½•æ™‚åœ¨ä¸­é€”åˆ‡æ–·æ¨¡å‹å›æ‡‰ä¾†å¯¦ç¾è‡ªç„¶çš„å°è©±æµç¨‹ï¼Œè®“æ‚¨å¯ä»¥ç«‹å³åœæ­¢å‘ˆç¾éæ™‚çš„å…§å®¹ã€‚

ç•¶ä½¿ç”¨è€…åœ¨æ¨¡å‹ä»åœ¨ç”¢ç”Ÿå›æ‡‰æ™‚å‚³é€æ–°è¼¸å…¥ï¼ˆèªéŸ³å°è©±ä¸­å¸¸è¦‹çš„æƒ…æ³ï¼‰ï¼Œæ‚¨æœƒæ”¶åˆ°ä¸€å€‹ `interrupted=True` çš„äº‹ä»¶ï¼š

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    if event.interrupted:
        # åœæ­¢é¡¯ç¤ºéƒ¨åˆ†æ–‡å­—ä¸¦æ¸…é™¤è¼¸å…¥æŒ‡ç¤ºå™¨çš„é‚è¼¯
        stop_streaming_display()

        # åœ¨ UI ä¸­é¡¯ç¤ºä¸­æ–·æŒ‡ç¤ºçš„é‚è¼¯ï¼ˆé¸å¡«ï¼‰
        show_user_interruption_indicator()
```

**ç¯„ä¾‹ - ä¸­æ–·æƒ…å¢ƒï¼š**

```text
æ¨¡å‹ï¼š"èˆŠé‡‘å±±çš„ç›®å‰å¤©æ°£æ˜¯..."
ä½¿ç”¨è€…ï¼š[ä¸­æ–·] "äº‹å¯¦ä¸Šï¼Œæˆ‘æŒ‡çš„æ˜¯è–åœ°ç‰™å“¥"
â†’ æ”¶åˆ° event.interrupted=True
â†’ æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ï¼šåœæ­¢å‘ˆç¾æ¨¡å‹å›æ‡‰ï¼Œæ¸…é™¤ UI
â†’ æ¨¡å‹è™•ç†æ–°è¼¸å…¥
æ¨¡å‹ï¼š"è–åœ°ç‰™å“¥çš„å¤©æ°£æ˜¯..."
```

**ä½•æ™‚ä½¿ç”¨ä¸­æ–·è™•ç†ï¼š**

- **èªéŸ³å°è©±**ï¼šç•¶ä½¿ç”¨è€…é–‹å§‹èªªè©±æ™‚ï¼Œç«‹å³åœæ­¢éŸ³è¨Šæ’­æ”¾ã€‚
- **æ¸…é™¤ UI ç‹€æ…‹**ï¼šç§»é™¤è¼¸å…¥æŒ‡ç¤ºå™¨ï¼ˆtyping indicatorsï¼‰èˆ‡éƒ¨åˆ†æ–‡å­—é¡¯ç¤ºã€‚
- **å°è©±æ—¥èªŒè¨˜éŒ„**ï¼šæ¨™è¨˜å“ªäº›å›æ‡‰æ˜¯è¢«ä¸­æ–·çš„ï¼ˆä¸å®Œæ•´çš„ï¼‰ã€‚
- **ä½¿ç”¨è€…åé¥‹**ï¼šæä¾›è¦–è¦ºæŒ‡ç¤ºï¼Œé¡¯ç¤ºå·²è¾¨è­˜åˆ°ä¸­æ–·ã€‚

#### è™•ç† `turn_complete` æ¨™è¨˜

é€™æŒ‡ç¤ºäº†å°è©±é‚Šç•Œï¼Œè®“æ‚¨å¯ä»¥æ›´æ–° UI ç‹€æ…‹ï¼ˆå•Ÿç”¨è¼¸å…¥æ§åˆ¶ã€éš±è—æŒ‡ç¤ºå™¨ï¼‰ï¼Œä¸¦åœ¨æ—¥èªŒèˆ‡åˆ†æä¸­æ¨™è¨˜æ­£ç¢ºçš„å›åˆé‚Šç•Œã€‚

ç•¶æ¨¡å‹å®Œæˆå…¶å®Œæ•´å›æ‡‰å¾Œï¼Œæ‚¨æœƒæ”¶åˆ°ä¸€å€‹ `turn_complete=True` çš„äº‹ä»¶ï¼š

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    if event.turn_complete:
        # æ›´æ–° UI ä»¥é¡¯ç¤ºã€Œæº–å‚™å¥½æ¥æ”¶è¼¸å…¥ã€ç‹€æ…‹çš„é‚è¼¯
        enable_user_input()
        # éš±è—è¼¸å…¥æŒ‡ç¤ºå™¨çš„é‚è¼¯
        hide_typing_indicator()

        # åœ¨æ—¥èªŒä¸­æ¨™è¨˜å°è©±é‚Šç•Œçš„é‚è¼¯
        log_turn_boundary()
```

**äº‹ä»¶æ¨™è¨˜çµ„åˆï¼š**

ç†è§£ `turn_complete` èˆ‡ `interrupted` çš„çµ„åˆæœ‰åŠ©æ–¼æ‚¨è™•ç†æ‰€æœ‰å°è©±ç‹€æ…‹ï¼š

| æƒ…å¢ƒ                   | turn_complete | interrupted | æ‚¨çš„æ‡‰ç”¨ç¨‹å¼æ‡‰...            |
| ---------------------- | ------------- | ----------- | ---------------------------- |
| æ­£å¸¸å®Œæˆ               | True          | False       | å•Ÿç”¨è¼¸å…¥ï¼Œé¡¯ç¤ºã€Œå°±ç·’ã€ç‹€æ…‹ã€‚ |
| ä½¿ç”¨è€…åœ¨ä¸­é€”å›æ‡‰æ™‚ä¸­æ–· | False         | True        | åœæ­¢é¡¯ç¤ºï¼Œæ¸…é™¤éƒ¨åˆ†å…§å®¹ã€‚     |
| åœ¨çµæŸæ™‚ä¸­æ–·           | True          | True        | åŒæ­£å¸¸å®Œæˆï¼ˆå›åˆå·²çµæŸï¼‰ã€‚   |
| å›æ‡‰ä¸­ï¼ˆéƒ¨åˆ†æ–‡å­—ï¼‰     | False         | False       | ç¹¼çºŒé¡¯ç¤ºä¸²æµæ–‡å­—ã€‚           |

**å¯¦ä½œï¼š**

```python
async for event in runner.run_live(...):
    # è™•ç†ä¸²æµæ–‡å­—
    if event.content and event.content.parts and event.content.parts[0].text:
        if event.partial:
            # é¡¯ç¤ºè¼¸å…¥æŒ‡ç¤ºå™¨ä¸¦æ›´æ–°éƒ¨åˆ†æ–‡å­—çš„é‚è¼¯
            update_streaming_text(event.content.parts[0].text)
        else:
            # é¡¯ç¤ºå®Œæ•´æ–‡å­—å€å¡Šçš„é‚è¼¯
            display_text(event.content.parts[0].text)

    # è™•ç†ä¸­æ–·
    if event.interrupted:
        # åœæ­¢éŸ³è¨Šæ’­æ”¾ä¸¦æ¸…é™¤æŒ‡ç¤ºå™¨çš„é‚è¼¯
        stop_audio_playback()
        clear_streaming_indicators()

    # è™•ç†å›åˆå®Œæˆ
    if event.turn_complete:
        # å•Ÿç”¨ä½¿ç”¨è€…è¼¸å…¥çš„é‚è¼¯
        show_input_ready_state()
        enable_microphone()
```

**å¸¸è¦‹ä½¿ç”¨æ¡ˆä¾‹ï¼š**

- **UI ç‹€æ…‹ç®¡ç†**ï¼šé¡¯ç¤º/éš±è—ã€Œæº–å‚™è¼¸å…¥ã€æŒ‡ç¤ºå™¨ã€è¼¸å…¥å‹•ç•«ã€éº¥å…‹é¢¨ç‹€æ…‹ã€‚
- **éŸ³è¨Šæ’­æ”¾æ§åˆ¶**ï¼šå¾—çŸ¥ä½•æ™‚åœæ­¢å‘ˆç¾ä¾†è‡ªæ¨¡å‹çš„éŸ³è¨Šå€å¡Šã€‚
- **å°è©±æ—¥èªŒè¨˜éŒ„**ï¼šåœ¨æ­·å²ç´€éŒ„/åˆ†æä¸­æ¨™è¨˜æ¸…æ¥šçš„å›åˆé‚Šç•Œã€‚
- **ä¸²æµæœ€ä½³åŒ–**ï¼šç•¶å›åˆå®Œæˆæ™‚åœæ­¢ç·©è¡ã€‚

**å›åˆå®Œæˆèˆ‡å¿«å–**ï¼šéŸ³è¨Š/é€å­—ç¨¿å¿«å–æœƒåœ¨ä¸²æµæœŸé–“çš„ç‰¹å®šé»è‡ªå‹•æ’ç©ºï¼ˆflushï¼‰ï¼š

- **ç•¶å›åˆå®Œæˆæ™‚**ï¼ˆ`turn_complete=True`ï¼‰ï¼šä½¿ç”¨è€…èˆ‡æ¨¡å‹çš„éŸ³è¨Šå¿«å–éƒ½æœƒè¢«æ’ç©ºã€‚
- **ç•¶ä¸­æ–·æ™‚**ï¼ˆ`interrupted=True`ï¼‰ï¼šæ¨¡å‹çš„éŸ³è¨Šå¿«å–æœƒè¢«æ’ç©ºã€‚
- **ç•¶ç”¢ç”Ÿå®Œæˆæ™‚**ï¼šæ¨¡å‹çš„éŸ³è¨Šå¿«å–æœƒè¢«æ’ç©ºã€‚

## å°‡äº‹ä»¶åºåˆ—åŒ–ç‚º JSON

ADK çš„ `Event` ç‰©ä»¶æ˜¯ Pydantic æ¨¡å‹ï¼Œé€™æ„å‘³è‘—å®ƒå€‘å…·å‚™å¼·å¤§çš„åºåˆ—åŒ–èƒ½åŠ›ã€‚`model_dump_json()` æ–¹æ³•å°æ–¼é€é WebSocket æˆ–ä¼ºæœå™¨å‚³é€äº‹ä»¶ï¼ˆSSEï¼‰ç­‰ç¶²è·¯å”å®šä¸²æµäº‹ä»¶ç‰¹åˆ¥æœ‰ç”¨ã€‚

### ä½¿ç”¨ event.model_dump_json()

é€™æä¾›äº†ç°¡å–®çš„ä¸€è¡Œç¨‹å¼ç¢¼ï¼Œå°‡ ADK äº‹ä»¶è½‰æ›ç‚º JSON æ ¼å¼ï¼Œä»¥ä¾¿é€é WebSocket æˆ– SSE ç­‰ç¶²è·¯å”å®šå‚³é€ã€‚

`model_dump_json()` æ–¹æ³•å°‡ `Event` ç‰©ä»¶åºåˆ—åŒ–ç‚º JSON å­—ä¸²ï¼š

ç¤ºç¯„å¯¦ä½œï¼š[main.py:219-234](https://github.com/google/adk-samples/blob/31847c0723fbf16ddf6eed411eb070d1c76afd1a/python/agents/bidi-demo/app/main.py#L219-L234)

```python
async def downstream_task() -> None:
    """æ¥æ”¶ä¾†è‡ª run_live() çš„äº‹ä»¶ä¸¦å‚³é€è‡³ WebSocketã€‚"""
    async for event in runner.run_live(
        user_id=user_id,
        session_id=session_id,
        live_request_queue=live_request_queue,
        run_config=run_config
    ):
        # åºåˆ—åŒ–äº‹ä»¶
        event_json = event.model_dump_json(exclude_none=True, by_alias=True)
        await websocket.send_text(event_json)
```

**æœƒè¢«åºåˆ—åŒ–çš„å…§å®¹ï¼š**

- äº‹ä»¶ä¸­ç¹¼è³‡æ–™ï¼ˆauthorã€server_content æ¬„ä½ï¼‰ã€‚
- å…§å®¹ï¼ˆæ–‡å­—ã€éŸ³è¨Šè³‡æ–™ã€å‡½å¼èª¿ç”¨ï¼‰ã€‚
- äº‹ä»¶æ¨™è¨˜ï¼ˆpartialã€turn_completeã€interruptedï¼‰ã€‚
- é€å­—ç¨¿è³‡æ–™ï¼ˆinput_transcriptionã€output_transcriptionï¼‰ã€‚
- å·¥å…·åŸ·è¡Œè³‡è¨Šã€‚

**ä½•æ™‚ä½¿ç”¨ `model_dump_json()`ï¼š**

- âœ… é€éç¶²è·¯ä¸²æµäº‹ä»¶ï¼ˆWebSocketã€SSEï¼‰ã€‚
- âœ… è¨˜éŒ„æ—¥èªŒ/æŒä¹…åŒ–åˆ° JSON æª”æ¡ˆã€‚
- âœ… é™¤éŒ¯èˆ‡æª¢æŸ¥ã€‚
- âœ… èˆ‡åŸºæ–¼ JSON çš„ API æ•´åˆã€‚

**ä½•æ™‚ã€Œä¸ã€ä½¿ç”¨å®ƒï¼š**

- âŒ è¨˜æ†¶é«”å…§è™•ç†ï¼ˆç›´æ¥ä½¿ç”¨äº‹ä»¶ç‰©ä»¶ï¼‰ã€‚
- âŒ åºåˆ—åŒ–é–‹éŠ·æœƒé€ æˆå½±éŸ¿çš„é«˜é »äº‹ä»¶ã€‚
- âŒ ç•¶æ‚¨åªéœ€è¦å°‘æ•¸æ¬„ä½æ™‚ï¼ˆç›´æ¥æ“·å–æ‰€éœ€æ¬„ä½ï¼‰ã€‚

> [!WARNING] æ•ˆèƒ½è­¦å‘Š
`event.content.parts[].inline_data` ä¸­çš„äºŒé€²ä½éŸ³è¨Šè³‡æ–™åœ¨åºåˆ—åŒ–ç‚º JSON æ™‚æœƒè¢« base64 ç·¨ç¢¼ï¼Œé€™æœƒé¡¯è‘—å¢åŠ é…¬è¼‰å¤§å°ï¼ˆç´„ 133% çš„é–‹éŠ·ï¼‰ã€‚å°æ–¼åŒ…å«éŸ³è¨Šçš„ç”Ÿç”¢ç’°å¢ƒæ‡‰ç”¨ç¨‹å¼ï¼Œè«‹ä½¿ç”¨ WebSocket äºŒé€²ä½æ¡†æ¶æˆ– multipart HTTP åˆ†é–‹å‚³é€äºŒé€²ä½è³‡æ–™ã€‚è©³æƒ…è«‹åƒé–± [éŸ³è¨Šå‚³è¼¸å„ªåŒ–](#éŸ³è¨Šå‚³è¼¸å„ªåŒ–)ã€‚

### åºåˆ—åŒ–é¸é …

é€™å…è¨±æ‚¨é€éæ’é™¤ä¸éœ€è¦çš„æ¬„ä½ä¾†ç¸®æ¸›é…¬è¼‰å¤§å°ï¼Œé€²è€Œæå‡ç¶²è·¯æ•ˆèƒ½èˆ‡ç”¨æˆ¶ç«¯è™•ç†é€Ÿåº¦ã€‚

Pydantic çš„ `model_dump_json()` æ”¯æ´å¤šå€‹å¯¦ç”¨çš„åƒæ•¸ï¼š

**ç”¨æ³•ï¼š**

```python
# æ’é™¤ç©ºå€¼ä»¥ç¸®æ¸›é…¬è¼‰ï¼ˆä¸¦ä½¿ç”¨ camelCase æ¬„ä½åç¨±ï¼‰
event_json = event.model_dump_json(exclude_none=True, by_alias=True)

# è‡ªè¨‚æ’é™¤ï¼ˆä¾‹å¦‚ï¼šè·³éé¾å¤§çš„äºŒé€²ä½éŸ³è¨Šï¼‰
event_json = event.model_dump_json(
    exclude={'content': {'parts': {'__all__': {'inline_data'}}}},
    by_alias=True
)

# åƒ…åŒ…å«ç‰¹å®šæ¬„ä½
event_json = event.model_dump_json(
    include={'content', 'author', 'turn_complete', 'interrupted'},
    by_alias=True
)

# ç¸®æ’ JSONï¼ˆç”¨æ–¼é™¤éŒ¯ï¼‰
event_json = event.model_dump_json(indent=2, by_alias=True)
```

bidi-demo ä½¿ç”¨ `exclude_none=True`ï¼Œè—‰ç”±çœç•¥ None å€¼çš„æ¬„ä½ä¾†æœ€å°åŒ– payload å¤§å°ã€‚

### åœ¨ç”¨æˆ¶ç«¯é€²è¡Œååºåˆ—åŒ–

é€™å±•ç¤ºäº†å¦‚ä½•åœ¨ç”¨æˆ¶ç«¯è§£æä¸¦è™•ç†åºåˆ—åŒ–çš„äº‹ä»¶ï¼Œé€²è€Œæ ¹æ“šå›åˆå®Œæˆå’Œä¸­æ–·ç­‰äº‹ä»¶å±¬æ€§é€²è¡ŒéŸ¿æ‡‰å¼ UI æ›´æ–°ã€‚

åœ¨ç”¨æˆ¶ç«¯ï¼ˆJavaScript/TypeScriptï¼‰ï¼Œå°‡ JSON è§£æå›ç‰©ä»¶ï¼š

ç¤ºç¯„å¯¦ä½œï¼š[app.js:339-688](https://github.com/google/adk-samples/blob/2f7b82f182659e0990bfb86f6ef400dd82633c07/python/agents/bidi-demo/app/static/js/app.js#L341-L690)

```javascript
// è™•ç†å‚³å…¥è¨Šæ¯
websocket.onmessage = function (event) {
    // è§£æå‚³å…¥çš„ ADK äº‹ä»¶
    const adkEvent = JSON.parse(event.data);

    // è™•ç†å›åˆå®Œæˆäº‹ä»¶
    if (adkEvent.turnComplete === true) {
        // å¾ç•¶å‰è¨Šæ¯ç§»é™¤è¼¸å…¥æŒ‡ç¤ºå™¨
        if (currentBubbleElement) {
            const textElement = currentBubbleElement.querySelector(".bubble-text");
            const typingIndicator = textElement.querySelector(".typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        currentMessageId = null;
        currentBubbleElement = null;
        return;
    }

    // è™•ç†ä¸­æ–·äº‹ä»¶
    if (adkEvent.interrupted === true) {
        // å¦‚æœæ­£åœ¨æ’­æ”¾éŸ³è¨Šï¼Œå‰‡åœæ­¢æ’­æ”¾
        if (audioPlayerNode) {
            audioPlayerNode.port.postMessage({ command: "endOfAudio" });
        }

        // ä¿ç•™éƒ¨åˆ†è¨Šæ¯ä½†æ¨™è¨˜ç‚ºå·²ä¸­æ–·
        if (currentBubbleElement) {
            const textElement = currentBubbleElement.querySelector(".bubble-text");

            // ç§»é™¤è¼¸å…¥æŒ‡ç¤ºå™¨
            const typingIndicator = textElement.querySelector(".typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove();
            }

            // åŠ å…¥ä¸­æ–·æ¨™è¨˜
            currentBubbleElement.classList.add("interrupted");
        }

        currentMessageId = null;
        currentBubbleElement = null;
        return;
    }

    // è™•ç†å…§å®¹äº‹ä»¶ï¼ˆæ–‡å­—æˆ–éŸ³è¨Šï¼‰
    if (adkEvent.content && adkEvent.content.parts) {
        const parts = adkEvent.content.parts;

        for (const part of parts) {
            // è™•ç†æ–‡å­—
            if (part.text) {
                // ç‚ºæ–°å›åˆåŠ å…¥æ–°çš„è¨Šæ¯å°è©±æ³¡æ³¡
                if (currentMessageId == null) {
                    currentMessageId = Math.random().toString(36).substring(7);
                    currentBubbleElement = createMessageBubble(part.text, false, true);
                    currentBubbleElement.id = currentMessageId;
                    messagesDiv.appendChild(currentBubbleElement);
                } else {
                    // ä»¥ç´¯ç©æ–‡å­—æ›´æ–°ç¾æœ‰çš„è¨Šæ¯å°è©±æ³¡æ³¡
                    const existingText = currentBubbleElement.querySelector(".bubble-text").textContent;
                    const cleanText = existingText.replace(/\.\.\.$/, '');
                    updateMessageBubble(currentBubbleElement, cleanText + part.text, true);
                }

                scrollToBottom();
            }
        }
    }
};
```

> [!NOTE] ç¤ºç¯„å¯¦ä½œ
è«‹åƒé–± [`app.js:339-688`](https://github.com/google/adk-samples/blob/2f7b82f182659e0990bfb86f6ef400dd82633c07/python/agents/bidi-demo/app/static/js/app.js#L341-L690) ä¸­å®Œæ•´çš„ WebSocket è¨Šæ¯è™•ç†å™¨ã€‚

### éŸ³è¨Šå‚³è¼¸å„ªåŒ–

JSON ä¸­çš„ Base64 ç·¨ç¢¼äºŒé€²ä½éŸ³è¨Šæœƒé¡¯è‘—å¢åŠ é…¬è¼‰ã€‚å°æ–¼ç”Ÿç”¢ç’°å¢ƒæ‡‰ç”¨ç¨‹å¼ï¼Œè«‹ä½¿ç”¨å–®å€‹ WebSocket é€£ç·šï¼ŒåŒæ™‚åŒ…å«äºŒé€²ä½æ¡†æ¶ï¼ˆç”¨æ–¼éŸ³è¨Šï¼‰å’Œæ–‡å­—æ¡†æ¶ï¼ˆç”¨æ–¼ä¸­ç¹¼è³‡æ–™ï¼‰ï¼š

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    # æª¢æŸ¥æ˜¯å¦å«æœ‰äºŒé€²ä½éŸ³è¨Š
    has_audio = (
        event.content and
        event.content.parts and
        any(p.inline_data for p in event.content.parts)
    )

    if has_audio:
        # é€é WebSocket äºŒé€²ä½æ¡†æ¶å‚³é€éŸ³è¨Š
        for part in event.content.parts:
            if part.inline_data:
                await websocket.send_bytes(part.inline_data.data)

        # åƒ…å‚³é€ä¸­ç¹¼è³‡æ–™ï¼ˆé«”ç©å°å¾—å¤šï¼‰
        metadata_json = event.model_dump_json(
            exclude={'content': {'parts': {'__all__': {'inline_data'}}}},
            by_alias=True
        )
        await websocket.send_text(metadata_json)
    else:
        # ç´”æ–‡å­—äº‹ä»¶å¯ç›´æ¥ä»¥ JSON å‚³é€
        await websocket.send_text(event.model_dump_json(exclude_none=True, by_alias=True))
```

æ­¤æ–¹æ³•å¯ç‚ºéŸ³è¨Šå¯†é›†å‹ä¸²æµç¯€çœç´„ 75% çš„é »å¯¬ï¼ŒåŒæ™‚ç¶­æŒå®Œæ•´çš„äº‹ä»¶ä¸­ç¹¼è³‡æ–™ã€‚

## run_live() ä¸­çš„è‡ªå‹•å·¥å…·åŸ·è¡Œ

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`functions.py`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/flows/llm_flows/functions.py) ä¸­çš„è‡ªå‹•å·¥å…·åŸ·è¡Œå¯¦ä½œã€‚

ADK `run_live()` æœ€å¼·å¤§çš„åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯**è‡ªå‹•å·¥å…·åŸ·è¡Œ**ã€‚èˆ‡åŸå§‹çš„ Gemini Live API ä¸åŒï¼ˆå¾Œè€…éœ€è¦æ‚¨æ‰‹å‹•è™•ç†å·¥å…·èª¿ç”¨èˆ‡å›æ‡‰ï¼‰ï¼ŒADK å®Œå…¨æŠ½è±¡åŒ–äº†æ­¤è¤‡é›œæ€§ã€‚

### åŸå§‹ Live API çš„æŒ‘æˆ°

ç›´æ¥ä½¿ç”¨ Gemini Live APIï¼ˆä¸ä½¿ç”¨ ADKï¼‰æ™‚ï¼Œå·¥å…·ä½¿ç”¨éœ€è¦æ‰‹å‹•ç·¨æ’ï¼š

1. **æ¥æ”¶**ä¾†è‡ªæ¨¡å‹çš„å‡½å¼èª¿ç”¨ã€‚
1. **è‡ªè¡ŒåŸ·è¡Œ**å·¥å…·ã€‚
1. **æ­£ç¢ºæ ¼å¼åŒ–**å‡½å¼å›æ‡‰ã€‚
1. **å°‡å›æ‡‰å‚³å›**æ¨¡å‹ã€‚

é€™æœƒé€ æˆå·¨å¤§çš„å¯¦ä½œé–‹éŠ·ï¼Œå°¤å…¶æ˜¯åœ¨ä¸²æµæƒ…å¢ƒä¸­ï¼Œæ‚¨éœ€è¦è™•ç†å¤šå€‹ä¸¦ç™¼çš„å·¥å…·èª¿ç”¨ã€ç®¡ç†éŒ¯èª¤ï¼Œä¸¦èˆ‡é€²è¡Œä¸­çš„éŸ³è¨Š/æ–‡å­—ä¸²æµé€²è¡Œå”èª¿ã€‚

### ADK å¦‚ä½•ç°¡åŒ–å·¥å…·ä½¿ç”¨

ä½¿ç”¨ ADKï¼Œå·¥å…·åŸ·è¡Œè®Šå¾—å®£å‘Šå¼ã€‚åªéœ€åœ¨ä»£ç†ç¨‹å¼ä¸Šå®šç¾©å·¥å…·å³å¯ï¼š

ç¤ºç¯„å¯¦ä½œï¼š[agent.py:11-16](https://github.com/google/adk-samples/blob/31847c0723fbf16ddf6eed411eb070d1c76afd1a/python/agents/bidi-demo/app/google_search_agent/agent.py#L11-L16)


```python
import os
from google.adk.agents import Agent
from google.adk.tools import google_search

# å®šç¾©å…·æœ‰æœå°‹åŠŸèƒ½çš„ä»£ç†ç¨‹å¼
agent = Agent(
    name="google_search_agent",
    model=os.getenv("DEMO_AGENT_MODEL", "gemini-2.5-flash-native-audio-preview-12-2025"),
    tools=[google_search],
    instruction="æ‚¨æ˜¯ä¸€å€‹èƒ½æœå°‹ç¶²é çš„å¾—åŠ›åŠ©æ‰‹ã€‚"
)
```

ç•¶æ‚¨å‘¼å« `runner.run_live()` æ™‚ï¼ŒADK æœƒè‡ªå‹•ï¼š

- **(Detects) åµæ¸¬**æ¨¡å‹ä½•æ™‚åœ¨ä¸²æµå›æ‡‰ä¸­å›å‚³å‡½å¼èª¿ç”¨ã€‚
- **(Executes) ä¸¦è¡ŒåŸ·è¡Œ**å·¥å…·ä»¥ç²å¾—æœ€ä½³æ•ˆèƒ½ã€‚
- **(Handles) è™•ç†**å·¥å…·åŸ·è¡Œå‰å¾Œçš„å›å‘¼ï¼Œä»¥åŸ·è¡Œè‡ªè¨‚é‚è¼¯ã€‚
- **(Formats) æ ¹æ“š Live API è¦æ±‚æ ¼å¼åŒ–**å‡½å¼å›æ‡‰ã€‚
- **(Sends) ç„¡ç¸«åœ°å°‡å›æ‡‰å‚³å›**æ¨¡å‹ã€‚
- **(Yields) å°‡å‡½å¼èª¿ç”¨èˆ‡å›æ‡‰äº‹ä»¶éƒ½ç”¢ç”Ÿ**çµ¦æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€‚

### å·¥å…·åŸ·è¡Œäº‹ä»¶

ç•¶å·¥å…·åŸ·è¡Œæ™‚ï¼Œæ‚¨æœƒé€é `run_live()` éåŒæ­¥ç”¢ç”Ÿå™¨æ¥æ”¶äº‹ä»¶ï¼š

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    # å‡½å¼èª¿ç”¨äº‹ä»¶ - æ¨¡å‹è«‹æ±‚åŸ·è¡Œå·¥å…·
    if event.get_function_calls():
        print(f"æ¨¡å‹æ­£åœ¨èª¿ç”¨ï¼š{event.get_function_calls()[0].name}")

    # å‡½å¼å›æ‡‰äº‹ä»¶ - å·¥å…·åŸ·è¡Œçµæœ
    if event.get_function_responses():
        print(f"å·¥å…·çµæœï¼š{event.get_function_responses()[0].response}")
```

æ‚¨ä¸éœ€è¦è¦ªè‡ªè™•ç†åŸ·è¡Œâ€”â€”ADK æœƒè‡ªå‹•å®Œæˆã€‚æ‚¨åªéœ€è§€å¯Ÿéš¨è‘—å°è©±æµå‹•çš„äº‹ä»¶å³å¯ã€‚

> [!NOTE] äº†è§£æ›´å¤š
bidi-demo æœƒå°‡æ‰€æœ‰äº‹ä»¶ï¼ˆåŒ…æ‹¬å‡½å¼èª¿ç”¨èˆ‡å›æ‡‰ï¼‰ç›´æ¥å‚³é€åˆ° WebSocket ç”¨æˆ¶ç«¯ï¼Œä¸é€²è¡Œä¼ºæœå™¨ç«¯éæ¿¾ã€‚é€™è®“ç”¨æˆ¶ç«¯èƒ½é€éäº‹ä»¶ä¸²æµå³æ™‚è§€å¯Ÿå·¥å…·åŸ·è¡Œæƒ…æ³ã€‚è«‹åƒé–± [`main.py:219-234`](https://github.com/google/adk-samples/blob/31847c0723fbf16ddf6eed411eb070d1c76afd1a/python/agents/bidi-demo/app/main.py#L219-L234) ä¸­çš„ä¸‹æ¸¸ä»»å‹™ã€‚

### é•·æ™‚é–“åŸ·è¡Œèˆ‡ä¸²æµå·¥å…·

ADK æ”¯æ´èˆ‡ `run_live()` ç„¡ç¸«æ•´åˆçš„é«˜éšå·¥å…·æ¨¡å¼ï¼š

**é•·æ™‚é–“åŸ·è¡Œå·¥å…·**ï¼šéœ€è¦äººå·¥å¯©æ ¸æˆ–éœ€è¼ƒé•·æ™‚é–“å®Œæˆçš„å·¥å…·ã€‚è«‹æ¨™è¨˜ `is_long_running=True`ã€‚åœ¨å¯æ¢å¾©çš„éåŒæ­¥æµä¸­ï¼ŒADK å¯åœ¨é•·æ™‚èª¿ç”¨å¾Œæš«åœã€‚åœ¨å³æ™‚æµä¸­ï¼Œä¸²æµæœƒç¹¼çºŒï¼›`long_running_tool_ids` æŒ‡ç¤ºå¾…è™•ç†çš„æ“ä½œï¼Œç”¨æˆ¶ç«¯å¯é¡¯ç¤ºç›¸æ‡‰çš„ UIã€‚

**ä¸²æµå·¥å…·**ï¼šæ¥å—é¡å‹ç‚º `LiveRequestQueue` çš„ `input_stream` åƒæ•¸çš„å·¥å…·ï¼Œå¯åœ¨åŸ·è¡ŒæœŸé–“å°‡å³æ™‚æ›´æ–°å‚³å›æ¨¡å‹ï¼Œé€²è€Œå¯¦ç¾æ¼¸é€²å¼å›æ‡‰ã€‚

> [!NOTE] ä¸²æµå·¥å…·çš„å·¥ä½œåŸç†
> ç•¶æ‚¨å‘¼å« `runner.run_live()` æ™‚ï¼ŒADK æœƒåœ¨åˆå§‹åŒ–æ™‚ï¼ˆ`runners.py` ç¬¬ 828-865 è¡Œï¼‰æª¢æŸ¥ä»£ç†ç¨‹å¼çš„å·¥å…·ï¼Œé€éåƒæ•¸é¡å‹è¨»è§£ä¾†è­˜åˆ¥å…·æœ‰ `LiveRequestQueue` çš„ä¸²æµå·¥å…·ã€‚
>
> **ä½‡åˆ—å»ºç«‹èˆ‡ç”Ÿå‘½é€±æœŸ**ï¼š
> 1. **å»ºç«‹**ï¼šADK æœƒåœ¨ `run_live()` é–‹å§‹æ™‚ï¼ˆè™•ç†ä»»ä½•äº‹ä»¶ä¹‹å‰ï¼‰ï¼Œç‚ºæ¯å€‹ä¸²æµå·¥å…·å»ºç«‹ä¸€å€‹å°ˆç”¨çš„ `ActiveStreamingTool` åŠå…¶ `LiveRequestQueue`ã€‚
> 2. **å„²å­˜**ï¼šé€™äº›ä½‡åˆ—åœ¨èª¿ç”¨æœŸé–“å„²å­˜åœ¨ `invocation_context.active_streaming_tools[tool_name]` ä¸­ã€‚
> 3. **æ³¨å…¥**ï¼šç•¶æ¨¡å‹èª¿ç”¨è©²å·¥å…·æ™‚ï¼ŒADK æœƒè‡ªå‹•å°‡è©²å·¥å…·çš„ä½‡åˆ—æ³¨å…¥ç‚º `input_stream` åƒæ•¸ï¼ˆ`function_tool.py` ç¬¬ 238-253 è¡Œï¼‰ã€‚
> 4. **ä½¿ç”¨**ï¼šå·¥å…·å¯åœ¨åŸ·è¡ŒæœŸé–“ä½¿ç”¨æ­¤ä½‡åˆ—å°‡å³æ™‚æ›´æ–°å‚³å›æ¨¡å‹ã€‚
> 5. **ç”Ÿå‘½é€±æœŸ**ï¼šé€™äº›ä½‡åˆ—åœ¨æ•´å€‹ `run_live()` èª¿ç”¨æœŸé–“æŒçºŒå­˜åœ¨ï¼ˆä¸€å€‹ InvocationContext = ä¸€æ¬¡ `run_live()` å‘¼å«ï¼‰ï¼Œä¸¦åœ¨ `run_live()` çµæŸæ™‚éŠ·æ¯€ã€‚
>
> **ä½‡åˆ—å€åˆ†**ï¼š
>
> - **ä¸»ä½‡åˆ—**ï¼ˆ`live_request_queue` åƒæ•¸ï¼‰ï¼šç”±æ‚¨çš„æ‡‰ç”¨ç¨‹å¼å»ºç«‹ï¼Œç”¨æ–¼ç”¨æˆ¶ç«¯åˆ°æ¨¡å‹çš„é€šè¨Šã€‚
> - **å·¥å…·ä½‡åˆ—**ï¼ˆ`active_streaming_tools[tool_name].stream`ï¼‰ï¼šç”± ADK è‡ªå‹•å»ºç«‹ï¼Œç”¨æ–¼åŸ·è¡ŒæœŸé–“å·¥å…·åˆ°æ¨¡å‹çš„é€šè¨Šã€‚
> å…©ç¨®é¡å‹çš„ä½‡åˆ—çš†ç‚º `LiveRequestQueue` å¯¦ä¾‹ï¼Œä½†å®ƒå€‘åœ¨ä¸²æµæ¶æ§‹ä¸­æ“”è² ä¸åŒçš„è·è²¬ã€‚
> é€™è®“å·¥å…·èƒ½åœ¨é•·æ™‚é–“é‹è¡Œçš„æ“ä½œæœŸé–“æä¾›å¢é‡æ›´æ–°ã€é€²åº¦é€šçŸ¥æˆ–éƒ¨åˆ†çµæœã€‚
> **ç¨‹å¼ç¢¼åƒè€ƒ**ï¼šå¯¦ä½œç´°ç¯€è«‹åƒé–± `runners.py:828-865`ï¼ˆå·¥å…·åµæ¸¬ï¼‰èˆ‡ `function_tool.py:238-253`ï¼ˆåƒæ•¸æ³¨å…¥ï¼‰ã€‚
>
> å¯¦ä½œç¯„ä¾‹è«‹åƒé–± [å·¥å…·æŒ‡å—](../../tools-for-agents/index.md)ã€‚

### é—œéµè¦é»

åŸå§‹ Live API å·¥å…·ä½¿ç”¨èˆ‡ ADK çš„å€åˆ¥é¡¯è€Œæ˜“è¦‹ï¼š

| é¢å‘           | åŸå§‹ Live API           | ADK `run_live()`       |
| -------------- | ----------------------- | ---------------------- |
| **å·¥å…·å®£å‘Š**   | æ‰‹å‹•å®šç¾© Schema         | å¾ Python å‡½å¼è‡ªå‹•ç”¢ç”Ÿ |
| **å·¥å…·åŸ·è¡Œ**   | åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­æ‰‹å‹•è™•ç†    | è‡ªå‹•ä¸¦è¡ŒåŸ·è¡Œ           |
| **å›æ‡‰æ ¼å¼åŒ–** | æ‰‹å‹•å»ºæ§‹ JSON           | è‡ªå‹•è™•ç†               |
| **éŒ¯èª¤è™•ç†**   | æ‰‹å‹• try/catch èˆ‡æ ¼å¼åŒ– | è‡ªå‹•æ“·å–ä¸¦å›å ±         |
| **ä¸²æµæ•´åˆ**   | æ‰‹å‹•å”èª¿                | è‡ªå‹•ç”¢ç”Ÿäº‹ä»¶           |
| **é–‹ç™¼è€…é«”é©—** | è¤‡é›œä¸”æ˜“å‡ºéŒ¯            | å®£å‘Šå¼ä¸”ç°¡å–®           |

é€™ç¨®è‡ªå‹•è™•ç†æ˜¯ ADK çš„æ ¸å¿ƒåƒ¹å€¼ä¸»å¼µä¹‹ä¸€â€”â€”å®ƒå°‡ Live API å·¥å…·ä½¿ç”¨çš„è¤‡é›œæ€§è½‰æ›ç‚ºç°¡å–®ã€å®£å‘Šå¼çš„é–‹ç™¼é«”é©—ã€‚

## InvocationContextï¼šåŸ·è¡Œç‹€æ…‹å®¹å™¨

åŸå§‹ç¢¼åƒè€ƒ

è«‹åƒé–± [`invocation_context.py`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/agents/invocation_context.py) ä¸­çš„ `InvocationContext` å¯¦ä½œã€‚

é›–ç„¶ `run_live()` å›å‚³ç”¨æ–¼æ¥æ”¶äº‹ä»¶çš„ `AsyncGenerator`ï¼Œä½†å…¶å…§éƒ¨æœƒå»ºç«‹ä¸¦ç®¡ç† `InvocationContext`â€”â€”é€™æ˜¯ ADK çµ±ä¸€çš„ç‹€æ…‹è¼‰é«”ï¼Œå°è£äº†å®Œæ•´å°è©±èª¿ç”¨æ‰€éœ€çš„ä¸€åˆ‡ã€‚**ä¸€å€‹ InvocationContext å°æ‡‰ä¸€å€‹ `run_live()` è¿´åœˆ**â€”â€”å®ƒåœ¨æ‚¨å‘¼å« `run_live()` æ™‚å»ºç«‹ï¼Œä¸¦åœ¨æ•´å€‹ä¸²æµå·¥ä½œéšæ®µæœŸé–“æŒçºŒå­˜åœ¨ã€‚

æ‚¨å¯ä»¥å°‡å…¶æƒ³åƒæˆä¸€æœ¬éš¨å°è©±å¾é ­åˆ°å°¾éš¨è¡Œçš„ç­†è¨˜æœ¬ï¼Œåœ¨éç¨‹ä¸­æ”¶é›†è³‡è¨Šã€è¿½è¹¤é€²åº¦ä¸¦ç‚ºæ¯å€‹çµ„ä»¶æä¾›ä¸Šä¸‹æ–‡ã€‚å®ƒæ˜¯ ADK å°ã€ŒContextã€æ¦‚å¿µçš„é‹è¡Œæ™‚å¯¦ä½œï¼Œæä¾›äº†å³æ™‚å°è©±æœŸé–“æ‰€éœ€çš„åŸ·è¡Œæ™‚ç‹€æ…‹èˆ‡æœå‹™ã€‚é—œæ–¼ ADK ä¸­ Context çš„æ›´å»£æ³›æ¦‚è¿°ï¼Œè«‹åƒé–± [ADK ä¸­çš„ Context](../../context/index.md)ã€‚

### ä»€éº¼æ˜¯ã€Œèª¿ç”¨ã€ï¼ˆInvocationï¼‰ï¼Ÿ

ä¸€å€‹**èª¿ç”¨**ä»£è¡¨ä¸€å€‹å®Œæ•´çš„äº’å‹•é€±æœŸï¼š

- ä»¥ä½¿ç”¨è€…è¼¸å…¥ï¼ˆæ–‡å­—ã€éŸ³è¨Šæˆ–æ§åˆ¶è¨Šè™Ÿï¼‰é–‹å§‹ã€‚
- å¯èƒ½æ¶‰åŠä¸€æˆ–å¤šæ¬¡ä»£ç†ç¨‹å¼èª¿ç”¨ã€‚
- ç•¶ç”¢ç”Ÿæœ€çµ‚å›æ‡‰æˆ–æ˜ç¢ºçµ‚æ­¢æ™‚çµæŸã€‚
- ç”± `runner.run_live()` æˆ– `runner.run_async()` ç·¨æ’ã€‚

é€™æœ‰åˆ¥æ–¼**ä»£ç†ç¨‹å¼èª¿ç”¨**ï¼ˆåŸ·è¡Œå–®å€‹ä»£ç†ç¨‹å¼çš„é‚è¼¯ï¼‰èˆ‡**æ­¥é©Ÿ**ï¼ˆå–®æ¬¡ LLM å‘¼å«åŠ ä¸Šä»»ä½•ç”¢ç”Ÿçš„å·¥å…·åŸ·è¡Œï¼‰ã€‚

å±¤ç´šçµæ§‹å¦‚ä¸‹ï¼š

```text
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ èª¿ç”¨ (invocation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä»£ç†ç¨‹å¼èª¿ç”¨_1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€ ä»£ç†ç¨‹å¼èª¿ç”¨_2 â”€â”
   â”Œâ”€â”€â”€â”€ æ­¥é©Ÿ_1 â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€ æ­¥é©Ÿ_2 â”€â”€â”€â”€â”€â”€â”
   [å‘¼å« LLM] [å‘¼å«å·¥å…·] [å‘¼å« LLM] [è½‰ç§»]
```

### èª°ä½¿ç”¨ InvocationContextï¼Ÿ

InvocationContext æœå‹™æ–¼ä¸åŒå±¤ç´šçš„å°è±¡ï¼š

- **ADK å…§éƒ¨çµ„ä»¶**ï¼ˆä¸»è¦ä½¿ç”¨è€…ï¼‰ï¼šRunnerã€Agentã€LLMFlow èˆ‡ GeminiLlmConnection éƒ½åœ¨å…¶æµç¶“å †ç–Šæ™‚æ¥æ”¶ã€è®€å–ä¸¦å¯«å…¥ InvocationContextã€‚æ­¤å…±äº«ä¸Šä¸‹æ–‡å¯¦ç¾äº†ç„¡ç¸«å”ä½œè€Œç„¡éœ€ç·Šå¯†è€¦åˆã€‚
- **æ‡‰ç”¨ç¨‹å¼é–‹ç™¼è€…**ï¼ˆé–“æ¥å—ç›Šè€…ï¼‰ï¼šæ‚¨é€šå¸¸ä¸éœ€è¦åœ¨æ‡‰ç”¨ç¨‹å¼ç¨‹å¼ç¢¼ä¸­ç›´æ¥å»ºç«‹æˆ–æ“ä½œ `InvocationContext`ã€‚ç›¸ååœ°ï¼Œæ‚¨å—ç›Šæ–¼ `InvocationContext` åœ¨å¹•å¾Œå¯¦ç¾çš„ç°¡æ½”ã€å„ªé›…çš„ APIâ€”â€”ä¾‹å¦‚ `async for event in runner.run_live()` æ¨¡å¼ã€‚
- **å·¥å…·èˆ‡å›å‘¼é–‹ç™¼è€…**ï¼ˆç›´æ¥å­˜å–ï¼‰ï¼šç•¶æ‚¨å¯¦ä½œè‡ªè¨‚å·¥å…·æˆ–å›å‘¼æ™‚ï¼Œæœƒæ¥æ”¶åˆ° `InvocationContext` ä½œç‚ºåƒæ•¸ã€‚é€™è®“æ‚¨èƒ½ç›´æ¥å­˜å–å°è©±ç‹€æ…‹ã€å·¥ä½œéšæ®µæœå‹™èˆ‡æ§åˆ¶æ¨™è¨˜ï¼ˆå¦‚ `end_invocation`ï¼‰ä»¥å¯¦ç¾è¤‡é›œçš„è¡Œç‚ºã€‚

#### InvocationContext åŒ…å«ä»€éº¼

ç•¶æ‚¨å¯¦ä½œè‡ªè¨‚å·¥å…·æˆ–å›å‘¼æ™‚ï¼Œæœƒæ¥æ”¶åˆ° `InvocationContext` ä½œç‚ºåƒæ•¸ã€‚ä»¥ä¸‹æ˜¯æ‚¨å¯ä»¥å–å¾—çš„è³‡è¨Šï¼š

**å·¥å…·/å›å‘¼é–‹ç™¼è€…çš„é‡è¦æ¬„ä½ï¼š**

- **`context.invocation_id`**ï¼šç•¶å‰èª¿ç”¨è­˜åˆ¥ç¢¼ï¼ˆæ¯æ¬¡ `run_live()` å‘¼å«å”¯ä¸€ï¼‰ã€‚
- **`context.session`**ï¼š
- **`context.session.events`**ï¼šå·¥ä½œéšæ®µæ­·å²ä¸­çš„æ‰€æœ‰äº‹ä»¶ï¼ˆè·¨æ‰€æœ‰èª¿ç”¨ï¼‰ã€‚
- **`context.session.state`**ï¼šå·¥ä½œéšæ®µè³‡æ–™çš„æŒä¹…æ€§éµå€¼å„²å­˜ã€‚
- **`context.session.user_id`**ï¼šä½¿ç”¨è€…èº«ä»½ã€‚
- **`context.run_config`**ï¼šç•¶å‰ä¸²æµé…ç½®ï¼ˆå›æ‡‰å½¢å¼ã€é€å­—ç¨¿è¨­å®šã€æˆæœ¬é™åˆ¶ï¼‰ã€‚
- **`context.end_invocation`**ï¼šå°‡æ­¤è¨­ç‚º `True` å¯ç«‹å³çµ‚æ­¢å°è©±ï¼ˆç”¨æ–¼éŒ¯èª¤è™•ç†æˆ–åŸå‰‡åŸ·è¡Œï¼‰ã€‚

**å·¥å…·é–‹ç™¼ä¸­çš„ç¯„ä¾‹æ¡ˆä¾‹ï¼š**

```python
# ç¤ºç¯„å¸¸è¦‹ InvocationContext æ¨¡å¼çš„ç¶œåˆå·¥å…·å¯¦ä½œç¯„ä¾‹
def my_tool(context: InvocationContext, query: str):
    # å­˜å–ä½¿ç”¨è€…èº«ä»½
    user_id = context.session.user_id

    # æª¢æŸ¥é€™æ˜¯å¦ç‚ºä½¿ç”¨è€…çš„ç¬¬ä¸€å‰‡è¨Šæ¯
    event_count = len(context.session.events)
    if event_count == 0:
        return "æ­¡è¿ï¼é€™æ˜¯æ‚¨çš„ç¬¬ä¸€å‰‡è¨Šæ¯ã€‚"

    # å­˜å–å°è©±æ­·å²
    recent_events = context.session.events[-5:]  # æœ€å¾Œ 5 å€‹äº‹ä»¶

    # å­˜å–æŒä¹…æ€§çš„å·¥ä½œéšæ®µç‹€æ…‹
    # å·¥ä½œéšæ®µç‹€æ…‹æœƒè·¨èª¿ç”¨æŒä¹…åŒ–ï¼ˆè€Œä¸åƒ…åƒ…æ˜¯æ­¤æ¬¡ä¸²æµå·¥ä½œéšæ®µï¼‰
    user_preferences = context.session.state.get('user_preferences', {})

    # æ›´æ–°å·¥ä½œéšæ®µç‹€æ…‹ï¼ˆå°‡æœƒè¢«æŒä¹…åŒ–ï¼‰
    context.session.state['last_query_time'] = datetime.now().isoformat()

    # å­˜å–æŒä¹…åŒ–æœå‹™
    if context.artifact_service:
        # å„²å­˜å¤§å‹æª”æ¡ˆ/éŸ³è¨Š
        await context.artifact_service.save_artifact(
            app_name=context.session.app_name,
            user_id=context.session.user_id,
            session_id=context.session.id,
            filename="result.bin",
            artifact=types.Part(inline_data=types.Blob(mime_type="application/octet-stream", data=data)),
        )

    # çµåˆä¸Šä¸‹æ–‡è™•ç†æŸ¥è©¢
    result = process_query(query, context=recent_events, preferences=user_preferences)

    # åœ¨ç‰¹å®šå ´æ™¯ä¸‹çµ‚æ­¢å°è©±
    if result.get('error'):
        # è™•ç†éŒ¯èª¤ - åœæ­¢å°è©±
        context.end_invocation = True

    return result
```

ç†è§£ `InvocationContext` å°æ–¼æŒæ¡ ADK å¦‚ä½•ç¶­æŒç‹€æ…‹ã€å”èª¿åŸ·è¡Œä»¥åŠå¯¦ç¾å¤šä»£ç†ç¨‹å¼å·¥ä½œæµç¨‹èˆ‡å¯æ¢å¾©æ€§ç­‰é€²éšåŠŸèƒ½è‡³é—œé‡è¦ã€‚å³ä½¿æ‚¨å¾ä¸ç›´æ¥è§¸ç¢°å®ƒï¼Œäº†è§£å…¶åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­çš„æµå‹•ä¹Ÿèƒ½å¹«åŠ©æ‚¨è¨­è¨ˆå‡ºæ›´å¥½çš„ä»£ç†ç¨‹å¼ä¸¦æ›´æœ‰æ•ˆåœ°æ’é™¤å•é¡Œã€‚

## å¤šä»£ç†ç¨‹å¼å·¥ä½œæµç¨‹çš„æœ€ä½³å¯¦è¸

ADK çš„é›™å‘ä¸²æµæ”¯æ´ä¸‰ç¨®ä»£ç†ç¨‹å¼æ¶æ§‹ï¼š**å–®ä»£ç†ç¨‹å¼**ï¼ˆç”±ä¸€å€‹ä»£ç†ç¨‹å¼è™•ç†æ•´å€‹å°è©±ï¼‰ã€**å…·å­ä»£ç†ç¨‹å¼çš„å¤šä»£ç†ç¨‹å¼**ï¼ˆå”èª¿å“¡ä»£ç†ç¨‹å¼ä½¿ç”¨ `transfer_to_agent` å‹•æ…‹è·¯ç”±è‡³å°ˆå®¶ä»£ç†ç¨‹å¼ï¼‰ï¼Œä»¥åŠ**é †åºå·¥ä½œæµç¨‹ä»£ç†ç¨‹å¼**ï¼ˆä»£ç†ç¨‹å¼ä½¿ç”¨ `task_completed` åœ¨å›ºå®šç®¡ç·šä¸­åŸ·è¡Œï¼‰ã€‚æœ¬ç¯€é‡é»ä»‹ç´¹é †åºå·¥ä½œæµç¨‹çš„æœ€ä½³å¯¦è¸ï¼Œå…¶ä¸­ç†è§£ä»£ç†ç¨‹å¼åˆ‡æ›èˆ‡ç‹€æ…‹å…±äº«å°æ–¼é †æš¢çš„ BIDI é€šè¨Šè‡³é—œé‡è¦ã€‚

> [!NOTE] äº†è§£æ›´å¤š
é—œæ–¼å¤šä»£ç†ç¨‹å¼æ¨¡å¼çš„å…¨é¢ä»‹ç´¹ï¼Œè«‹åƒé–± ADK æ–‡ä»¶ä¸­çš„ [ä½œç‚ºç·¨æ’è€…çš„å·¥ä½œæµç¨‹ä»£ç†ç¨‹å¼](../../agents/multi-agents.md#12-ä½œç‚ºç·¨æ’è€…çš„å·¥ä½œæµä»£ç†-workflow-agents-as-orchestrators)ã€‚

åœ¨å»ºç«‹å¤šä»£ç†ç¨‹å¼ç³»çµ±æ™‚ï¼Œç†è§£ä»£ç†ç¨‹å¼å¦‚ä½•åœ¨å³æ™‚ä¸²æµæœŸé–“åˆ‡æ›èˆ‡å…±äº«ç‹€æ…‹ï¼Œå°æ–¼ç¢ºä¿é †æš¢çš„ BIDI é€šè¨Šè‡³é—œé‡è¦ã€‚

### çµåˆ BIDI ä¸²æµçš„ SequentialAgent

`SequentialAgent` è®“å·¥ä½œæµç¨‹ç®¡ç·šä¸­çš„ä»£ç†ç¨‹å¼èƒ½æ¥çºŒåŸ·è¡Œã€‚æ¯å€‹ä»£ç†ç¨‹å¼åœ¨ä¸‹ä¸€å€‹ä»£ç†ç¨‹å¼é–‹å§‹å‰å®Œæˆå…¶ä»»å‹™ã€‚å³æ™‚ä¸²æµçš„æŒ‘æˆ°åœ¨æ–¼åˆ¤æ–·ä»£ç†ç¨‹å¼ä½•æ™‚å·²å®Œæˆå°é€£çºŒéŸ³è¨Šæˆ–å½±ç‰‡è¼¸å…¥çš„è™•ç†ã€‚

> [!NOTE] åŸå§‹ç¢¼åƒè€ƒ
è«‹åƒé–± [`sequential_agent.py:119-158`](https://github.com/google/adk-python/blob/29c1115959b0084ac1169748863b35323da3cf50/src/google/adk/agents/sequential_agent.py#L119-L158) ä¸­çš„ `SequentialAgent` å¯¦ä½œã€‚

**é‹ä½œåŸç†ï¼š**

ADK æœƒè‡ªå‹•ç‚ºåºåˆ—ä¸­çš„æ¯å€‹ä»£ç†ç¨‹å¼åŠ å…¥ `task_completed()` å‡½å¼ã€‚ç•¶æ¨¡å‹å‘¼å«æ­¤å‡½å¼æ™‚ï¼Œå®ƒè¡¨ç¤ºå®Œæˆä¸¦è§¸ç™¼åˆ‡æ›åˆ°ä¸‹ä¸€å€‹ä»£ç†ç¨‹å¼ï¼š

**ç”¨æ³•ï¼š**

```python
# SequentialAgent è‡ªå‹•ç‚ºæ¯å€‹å­ä»£ç†ç¨‹å¼åŠ å…¥æ­¤å·¥å…·
def task_completed():
    """
    è¡¨ç¤ºä»£ç†ç¨‹å¼å·²æˆåŠŸå®Œæˆä½¿ç”¨è€…çš„å•é¡Œæˆ–ä»»å‹™ã€‚
    """
    return 'å·²æ”¶åˆ°ä»»å‹™å®Œæˆè¨Šè™Ÿã€‚'
```

### å»ºè­°æ¨¡å¼ï¼šé€æ˜çš„é †åºæµ

é—œéµé»åœ¨æ–¼ï¼Œ**ä»£ç†ç¨‹å¼åˆ‡æ›æ˜¯åœ¨åŒä¸€å€‹ `run_live()` äº‹ä»¶ä¸²æµä¸­é€æ˜åœ°ç™¼ç”Ÿ**ã€‚æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ä¸éœ€è¦æ‰‹å‹•ç®¡ç†åˆ‡æ›â€”â€”åªéœ€çµ±ä¸€æ¥æ”¶äº‹ä»¶å³å¯ï¼š

**ç”¨æ³•ï¼š**

```python
async def handle_sequential_workflow():
    """çµåˆ BIDI ä¸²æµä½¿ç”¨ SequentialAgent çš„å»ºè­°æ¨¡å¼ã€‚"""

    # 1. åºåˆ—ä¸­æ‰€æœ‰ä»£ç†ç¨‹å¼å…±ç”¨å–®ä¸€ä½‡åˆ—
    queue = LiveRequestQueue()

    # 2. èƒŒæ™¯ä»»å‹™æŒçºŒæ“·å–ä½¿ç”¨è€…è¼¸å…¥
    async def capture_user_input():
        while True:
            # è®€å–éº¥å…‹é¢¨éŸ³è¨Šçš„é‚è¼¯
            audio_chunk = await microphone.read()
            queue.send_realtime(
                blob=types.Blob(data=audio_chunk, mime_type="audio/pcm")
            )

    input_task = asyncio.create_task(capture_user_input())

    try:
        # 3. å–®ä¸€äº‹ä»¶è¿´åœˆç„¡ç¸«è™•ç†ã€Œæ‰€æœ‰ã€ä»£ç†ç¨‹å¼
        async for event in runner.run_live(
            user_id="user_123",
            session_id="session_456",
            live_request_queue=queue,
        ):
            # äº‹ä»¶åœ¨ä»£ç†ç¨‹å¼åˆ‡æ›é–“ç„¡ç¸«æµå‹•
            current_agent = event.author

            # è™•ç†éŸ³è¨Šèˆ‡æ–‡å­—è¼¸å‡º
            if event.content and event.content.parts:
                for part in event.content.parts:
                    # æª¢æŸ¥éŸ³è¨Šè³‡æ–™
                    if part.inline_data and part.inline_data.mime_type.startswith("audio/"):
                        # æ’­æ”¾éŸ³è¨Šçš„é‚è¼¯
                        await play_audio(part.inline_data.data)

                    # æª¢æŸ¥æ–‡å­—è³‡æ–™
                    if part.text:
                        await display_text(f"[{current_agent}] {part.text}")

            # ä¸éœ€è¦ç‰¹æ®Šçš„åˆ‡æ›è™•ç†ï¼

    finally:
        input_task.cancel()
        queue.close()
```

### ä»£ç†ç¨‹å¼åˆ‡æ›æœŸé–“çš„äº‹ä»¶æµ

ä»¥ä¸‹æ˜¯æ‚¨çš„æ‡‰ç”¨ç¨‹å¼åœ¨ä»£ç†ç¨‹å¼åˆ‡æ›æ™‚æœƒçœ‹åˆ°çš„å…§å®¹ï¼š

```text
# ä»£ç†ç¨‹å¼ 1 (ç ”ç©¶å“¡) å®Œæˆå·¥ä½œ
äº‹ä»¶: author="researcher", text="æˆ‘å·²è’é›†æ‰€æœ‰è³‡æ–™ã€‚"
äº‹ä»¶: author="researcher", function_call: task_completed()
äº‹ä»¶: author="researcher", function_response: task_completed

# --- è‡ªå‹•åˆ‡æ›ï¼ˆå°æ‚¨çš„ç¨‹å¼ç¢¼æ˜¯é€æ˜çš„ï¼‰ ---

# ä»£ç†ç¨‹å¼ 2 (æ’°ç¨¿å“¡) é–‹å§‹
äº‹ä»¶: author="writer", text="è®“æˆ‘æ ¹æ“šç ”ç©¶å…§å®¹æ’°å¯«å ±å‘Š..."
äº‹ä»¶: author="writer", text=" ç ”ç©¶çµæœé¡¯ç¤º..."
äº‹ä»¶: author="writer", function_call: task_completed()
äº‹ä»¶: author="writer", function_response: task_completed

# --- è‡ªå‹•åˆ‡æ› ---

# ä»£ç†ç¨‹å¼ 3 (å¯©æ ¸å“¡) é–‹å§‹ - åºåˆ—ä¸­çš„æœ€å¾Œä¸€å€‹ä»£ç†ç¨‹å¼
äº‹ä»¶: author="reviewer", text="è®“æˆ‘å¯©æ ¸é€™ä»½å ±å‘Š..."
äº‹ä»¶: author="reviewer", text="å ±å‘Šçœ‹èµ·ä¾†ä¸éŒ¯ã€‚å…¨éƒ¨å®Œæˆï¼"
äº‹ä»¶: author="reviewer", function_call: task_completed()
äº‹ä»¶: author="reviewer", function_response: task_completed

# --- æœ€å¾Œä¸€å€‹ä»£ç†ç¨‹å¼å®Œæˆï¼šrun_live() çµæŸ ---
# æ‚¨çš„ async for è¿´åœˆåœ¨æ­¤çµæŸ
```

### è¨­è¨ˆåŸå‰‡

#### 1. å–®ä¸€äº‹ä»¶è¿´åœˆ

å°åºåˆ—ä¸­çš„æ‰€æœ‰ä»£ç†ç¨‹å¼ä½¿ç”¨åŒä¸€å€‹äº‹ä»¶è¿´åœˆï¼š

**ç”¨æ³•ï¼š**

```python
# âœ… æ­£ç¢ºï¼šå–®ä¸€è¿´åœˆè™•ç†æ‰€æœ‰ä»£ç†ç¨‹å¼
async for event in runner.run_live(...):
    # æ‚¨çš„äº‹ä»¶è™•ç†é‚è¼¯
    await handle_event(event)  # é©ç”¨æ–¼ Agent1, Agent2, Agent3...

# âŒ éŒ¯èª¤ï¼šä¸è¦ä¸­æ–·è¿´åœˆæˆ–å»ºç«‹å¤šå€‹è¿´åœˆ
for agent in agents:
    async for event in runner.run_live(...):  # éŒ¯èª¤ï¼
        ...
```

#### 2. æŒä¹…æ€§ä½‡åˆ—

åŒä¸€å€‹ `LiveRequestQueue` ç‚ºæ‰€æœ‰ä»£ç†ç¨‹å¼æœå‹™ï¼š

```text
# ä½¿ç”¨è€…è¼¸å…¥æµå‘ç•¶å‰æ´»å‹•çš„ä»£ç†ç¨‹å¼
ä½¿ç”¨è€…èªªè©± â†’ ä½‡åˆ— â†’ ä»£ç†ç¨‹å¼ 1 (ç ”ç©¶å“¡)
                â†“
ä½¿ç”¨è€…èªªè©± â†’ ä½‡åˆ— â†’ ä»£ç†ç¨‹å¼ 2 (æ’°ç¨¿å“¡)
                â†“
ä½¿ç”¨è€…èªªè©± â†’ ä½‡åˆ— â†’ ä»£ç†ç¨‹å¼ 3 (å¯©æ ¸å“¡)
```

**ä¸è¦ç‚ºæ¯å€‹ä»£ç†ç¨‹å¼å»ºç«‹æ–°ä½‡åˆ—ï¼š**

```python
# âŒ éŒ¯èª¤ï¼šæ¯å€‹ä»£ç†ç¨‹å¼ä¸€å€‹æ–°ä½‡åˆ—
for agent in agents:
    new_queue = LiveRequestQueue()  # éŒ¯èª¤ï¼

# âœ… æ­£ç¢ºï¼šæ•´å€‹å·¥ä½œæµç¨‹ä½¿ç”¨å–®ä¸€ä½‡åˆ—
queue = LiveRequestQueue()
async for event in runner.run_live(live_request_queue=queue):
    ...
```

#### 3. å…·å‚™ä»£ç†ç¨‹å¼æ„è­˜çš„ UIï¼ˆé¸å¡«ï¼‰

è¿½è¹¤ç•¶å‰æ´»å‹•çš„ä»£ç†ç¨‹å¼ï¼Œä»¥æä¾›æ›´å¥½çš„ä½¿ç”¨è€…é«”é©—ï¼š

**ç”¨æ³•ï¼š**

```python
current_agent_name = None

async for event in runner.run_live(...):
    # åµæ¸¬ä»£ç†ç¨‹å¼åˆ‡æ›
    if event.author and event.author != current_agent_name:
        current_agent_name = event.author
        # æ›´æ–° UI æŒ‡ç¤ºå™¨çš„é‚è¼¯
        await update_ui_indicator(f"ç•¶å‰ä»£ç†ç¨‹å¼ï¼š{current_agent_name}")

    # æ‚¨çš„äº‹ä»¶è™•ç†é‚è¼¯
    await handle_event(event)
```

#### 4. åˆ‡æ›é€šçŸ¥

é¸æ“‡æ€§åœ°åœ¨ä»£ç†ç¨‹å¼äº¤æ¥æ™‚é€šçŸ¥ä½¿ç”¨è€…ï¼š

**ç”¨æ³•ï¼š**

```python
async for event in runner.run_live(...):
    # åµæ¸¬ä»»å‹™å®Œæˆï¼ˆåˆ‡æ›è¨Šè™Ÿï¼‰
    if event.content and event.content.parts:
        for part in event.content.parts:
            if (part.function_response and
                part.function_response.name == "task_completed"):
                # é¡¯ç¤ºåˆ‡æ›é€šçŸ¥çš„é‚è¼¯
                await display_notification(
                    f"âœ“ {event.author} å·²å®Œæˆã€‚äº¤æ¥çµ¦ä¸‹ä¸€å€‹ä»£ç†ç¨‹å¼..."
                )
                continue

    # æ‚¨çš„äº‹ä»¶è™•ç†é‚è¼¯
    await handle_event(event)
```

### é—œéµå·®ç•°ï¼štransfer_to_agent vs task_completed

ç†è§£é€™å…©å€‹å‡½å¼æœ‰åŠ©æ–¼æ‚¨é¸æ“‡æ­£ç¢ºçš„å¤šä»£ç†ç¨‹å¼æ¨¡å¼ï¼š

| å‡½å¼                | ä»£ç†ç¨‹å¼æ¨¡å¼       | `run_live()` ä½•æ™‚çµæŸ                                                  | ä½¿ç”¨æ¡ˆä¾‹                         |
| ------------------- | ------------------ | ---------------------------------------------------------------------- | -------------------------------- |
| `transfer_to_agent` | å”èª¿å“¡ï¼ˆå‹•æ…‹è·¯ç”±ï¼‰ | `LiveRequestQueue.close()`                                             | æ ¹æ“šæ„åœ–å°‡ä½¿ç”¨è€…è·¯ç”±è‡³å°ˆå®¶       |
| `task_completed`    | é †åºï¼ˆç®¡ç·šï¼‰       | `LiveRequestQueue.close()` æˆ–åºåˆ—ä¸­æœ€å¾Œä¸€å€‹ä»£ç†ç¨‹å¼çš„ `task_completed` | å›ºå®šå·¥ä½œæµç¨‹ï¼šç ”ç©¶ â†’ æ’°å¯« â†’ å¯©æ ¸ |

**transfer_to_agent ç¯„ä¾‹ï¼š**

```text
# å”èª¿å“¡æ ¹æ“šä½¿ç”¨è€…æ„åœ–é€²è¡Œè·¯ç”±
ä½¿ç”¨è€…ï¼š"æˆ‘éœ€è¦å¸³å‹™æ–¹é¢çš„å”åŠ©"
äº‹ä»¶: author="coordinator", function_call: transfer_to_agent(agent_name="billing")
# ä¸²æµç¹¼çºŒï¼Œç”±å¸³å‹™ä»£ç†ç¨‹å¼æ¥æ‰‹ - åŒä¸€å€‹ run_live() è¿´åœˆ
äº‹ä»¶: author="billing", text="æˆ‘å¯ä»¥å”åŠ©æ‚¨çš„å¸³å‹™å•é¡Œ..."
```

**task_completed ç¯„ä¾‹ï¼š**

```text
# é †åºå·¥ä½œæµç¨‹ä¾ç®¡ç·šé€²å±•
äº‹ä»¶: author="researcher", function_call: task_completed()
# ç•¶å‰ä»£ç†ç¨‹å¼çµæŸï¼Œåºåˆ—ä¸­çš„ä¸‹ä¸€å€‹ä»£ç†ç¨‹å¼é–‹å§‹
äº‹ä»¶: author="writer", text="æ ¹æ“šç ”ç©¶å…§å®¹..."
```

### æœ€ä½³å¯¦è¸ç¸½çµè¡¨

| å¯¦è¸                             | åŸå›                            |
| -------------------------------- | ------------------------------ |
| ä½¿ç”¨å–®ä¸€äº‹ä»¶è¿´åœˆ                 | ADK åœ¨å…§éƒ¨è™•ç†åˆ‡æ›             |
| ä½‡åˆ—åœ¨ä»£ç†ç¨‹å¼é–“ä¿æŒå•Ÿç”¨         | åŒä¸€ä½‡åˆ—æœå‹™æ–¼æ‰€æœ‰é †åºä»£ç†ç¨‹å¼ |
| è¿½è¹¤ `event.author`              | å¾—çŸ¥ç•¶å‰æ˜¯ç”±å“ªå€‹ä»£ç†ç¨‹å¼å›æ‡‰   |
| ä¸è¦é‡è¨­å·¥ä½œéšæ®µ/ä¸Šä¸‹æ–‡          | å°è©±ç‹€æ…‹è·¨ä»£ç†ç¨‹å¼æŒä¹…åŒ–       |
| çµ±ä¸€è™•ç†äº‹ä»¶                     | æ‰€æœ‰ä»£ç†ç¨‹å¼ç”¢ç”Ÿç›¸åŒçš„äº‹ä»¶é¡å‹ |
| è®“ `task_completed` ç™¼é€åˆ‡æ›è¨Šè™Ÿ | ä¸è¦æ‰‹å‹•ç®¡ç†é †åºæµ             |

`SequentialAgent` çš„è¨­è¨ˆç¢ºä¿äº†é †æš¢çš„åˆ‡æ›â€”â€”æ‚¨çš„æ‡‰ç”¨ç¨‹å¼åªéœ€çœ‹åˆ°ä¾†è‡ªä¸åŒä»£ç†ç¨‹å¼æŒ‰é †åºç”¢ç”Ÿçš„é€£çºŒäº‹ä»¶æµï¼Œè‡ªå‹•äº¤æ¥ç”± ADK ç®¡ç†ã€‚

## ç¸½çµ

åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæ‚¨æŒæ¡äº† ADK é›™å‘ä¸²æµæ¶æ§‹ä¸­çš„äº‹ä»¶è™•ç†ã€‚æˆ‘å€‘æ¢è¨äº†ä»£ç†ç¨‹å¼ç”¢ç”Ÿçš„ä¸åŒäº‹ä»¶é¡å‹â€”â€”æ–‡å­—å›æ‡‰ã€éŸ³è¨Šå€å¡Šã€é€å­—ç¨¿ã€å·¥å…·èª¿ç”¨å’Œæ§åˆ¶è¨Šè™Ÿâ€”â€”ä¸¦å­¸ç¿’äº†å¦‚ä½•æœ‰æ•ˆè™•ç†æ¯ç¨®äº‹ä»¶ã€‚æ‚¨ç¾åœ¨äº†è§£å¦‚ä½•è™•ç†ä¸­æ–·å’Œå›åˆå®Œæˆè¨Šè™Ÿä»¥å¯¦ç¾è‡ªç„¶çš„å°è©±æµã€ä½¿ç”¨ Pydantic çš„æ¨¡å‹åºåˆ—åŒ–ç‚ºç¶²è·¯å‚³è¼¸é€²è¡Œäº‹ä»¶åºåˆ—åŒ–ã€åˆ©ç”¨ ADK çš„è‡ªå‹•å·¥å…·åŸ·è¡Œä¾†ç°¡åŒ–ä»£ç†ç¨‹å¼å·¥ä½œæµç¨‹ï¼Œä»¥åŠåœ¨é€²éšç‹€æ…‹ç®¡ç†å ´æ™¯ä¸‹å­˜å– `InvocationContext`ã€‚æœ‰äº†é€™äº›äº‹ä»¶è™•ç†æ¨¡å¼ï¼Œæ‚¨å·²å…·å‚™å»ºç«‹èƒ½å‘ä½¿ç”¨è€…æä¾›å³æ™‚åé¥‹çš„éŸ¿æ‡‰å¼ä¸²æµæ‡‰ç”¨ç¨‹å¼çš„èƒ½åŠ›ã€‚æ¥ä¸‹ä¾†ï¼Œæ‚¨å°‡å­¸ç¿’å¦‚ä½•é€é `RunConfig` é…ç½®è¤‡é›œçš„ä¸²æµè¡Œç‚ºï¼ŒåŒ…æ‹¬å¤šæ¨¡æ…‹äº’å‹•ã€å·¥ä½œéšæ®µæ¢å¾©ä»¥åŠæˆæœ¬æ§åˆ¶ã€‚

---

â† [ä¸Šä¸€é ï¼šç¬¬ 2 éƒ¨åˆ†ï¼šä½¿ç”¨ LiveRequestQueue å‚³é€è¨Šæ¯](part2.md) | [ä¸‹ä¸€é ï¼šç¬¬ 4 éƒ¨åˆ†ï¼šç†è§£ RunConfig](part4.md) â†’
